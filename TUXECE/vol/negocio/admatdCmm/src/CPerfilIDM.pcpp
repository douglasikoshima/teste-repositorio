#undef SQLCA
#define SQLCA_NONE
#include<sqlca.h>
#include<sqlda.h>
#include <tuxfw.h>
#include "../include/CPerfilIDM.h"
#include "../include/CSafePointer.h"

#define endOraStr(varstr)      varstr.arr[varstr.len]= '\0'
#define oraToStr(bstr,vchar)   if(!bstr) strncpy(bstr,vchar.arr,vchar.len)
#define strToOra(vchar,bstr)   vchar.len = strlen(bstr);strncpy((char *)vchar.arr,bstr,vchar.len);vchar.arr[vchar.len] = 0
#define strconv(buffer,fonte)  sprintf(buffer,"%d",fonte)


CPerfilIDM::CPerfilIDM()
{
}

CPerfilIDM::~CPerfilIDM()
{
}

void CPerfilIDM::ListaPerfil( XMLGen * xml_g )
{
    ULOG_START("ListaPerfil()");

	int    iCont = 0;
	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
       VARCHAR   idPerfil[64];
       short     i_idPerfil = -1;
       VARCHAR   nmPerfil[256];
       short     i_nmPerfil = -1;
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
		EXEC SQL WHENEVER NOT FOUND DO break;
		EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
		sqlca.sqlcode=0;

   		EXEC SQL DECLARE CursorPerfil CURSOR FOR
        select
           idPerfilIDM ,
           TRIM(nmPerfilIDM)
        from
           contatoadm.perfilidm
        where
           idPerfilIDM > 0
        order by TRIM(upper(nmPerfilIDM));

		EXEC SQL OPEN CursorPerfil;

        //Caso inexista registros sair do loop
        xml_g->createTag("Disponivel");
        for(;;)
        {
            EXEC SQL FETCH CursorPerfil INTO :idPerfil:i_idPerfil ,
                                             :nmPerfil:i_nmPerfil ;
            endOraStr(idPerfil);
            endOraStr(nmPerfil);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idPerfil.arr );
                xml_g->addItem("ds", (char*)nmPerfil.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        xml_g->createTag("Selecionado");
        xml_g->closeTag();
        EXEC SQL CLOSE CursorPerfil;

		ULOG_END("ListaPerfil()");
        
        return ;
	}
	catch(...)
	{
		throw;
	}

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::GrupoPerfil( char * idPerfilPrm, XMLGen * xml_g )
{
    ULOG_START("GrupoPerfil()");

	int    iCont = 0;
	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
       char      idPerfil[64];
       
       VARCHAR   idGrupo[64];
       short     i_idGrupo = -1;
       VARCHAR   nmGrupo[256];
       short     i_nmGrupo = -1;
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
        sprintf( idPerfil, "%s", idPerfilPrm );
        
		EXEC SQL WHENEVER NOT FOUND DO break;
		EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
		sqlca.sqlcode=0;

   		EXEC SQL DECLARE crSelPerfilGrupo CURSOR FOR
        SELECT
           GRUPO.IDGRUPO ,
           TRIM(GRUPO.NMGRUPO)
        FROM
           ACESSO.GRUPO                GRUPO ,
           CONTATOADM.GRUPOPERFILIDM   GRUPOPERFILIDM
        WHERE
           GRUPO.IDGRUPO = GRUPOPERFILIDM.IDGRUPO
        AND
           GRUPOPERFILIDM.IDPERFILIDM = :idPerfil
        ORDER BY TRIM(UPPER(GRUPO.NMGRUPO));

		EXEC SQL OPEN crSelPerfilGrupo;

        xml_g->createTag("Selecionado");
        for(;;)
        {
            EXEC SQL FETCH crSelPerfilGrupo INTO :idGrupo:i_idGrupo ,
                                                 :nmGrupo:i_nmGrupo ;
            endOraStr(idGrupo);
            endOraStr(nmGrupo);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idGrupo.arr );
                xml_g->addItem("ds", (char*)nmGrupo.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        EXEC SQL CLOSE crSelPerfilGrupo;

		EXEC SQL WHENEVER NOT FOUND DO break;
		EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
		sqlca.sqlcode=0;
   		EXEC SQL DECLARE crPerfilGrupo CURSOR FOR
        SELECT
           GRUPO.IDGRUPO ,
           TRIM(GRUPO.NMGRUPO)
        FROM
           ACESSO.GRUPO   GRUPO
        WHERE
           IDGRUPO > 0
        AND
           IDGRUPO NOT IN
        (
           SELECT IDGRUPO FROM CONTATOADM.GRUPOPERFILIDM WHERE GRUPOPERFILIDM.IDPERFILIDM = :idPerfil
        )
        ORDER BY TRIM(UPPER(GRUPO.NMGRUPO)); 

		EXEC SQL OPEN crPerfilGrupo;

        xml_g->createTag("Disponivel");
        for(;;)
        {
            EXEC SQL FETCH crPerfilGrupo INTO :idGrupo:i_idGrupo ,
                                              :nmGrupo:i_nmGrupo ;
            endOraStr(idGrupo);
            endOraStr(nmGrupo);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idGrupo.arr );
                xml_g->addItem("ds", (char*)nmGrupo.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        EXEC SQL CLOSE crPerfilGrupo;

		ULOG_END("GrupoPerfil()");
        
        return ;
	}
	catch(...)
	{
		throw;
	}

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::InsereGrupoPerfil( char * idUsuarioPrm, char * idUsuarioNovoPrm, DOMNode * dnode, XMLGen * xml_g )
{
    ULOG_START("InsereGrupoPerfil()");
    DOMNode * subnode;
    DOMNode * nodeSelec;
    int    ctLista = 0;
    char * p = 0x0;
    char * buffer;
    TuxHelper tx;
 
    struct sqlca sqlca;
    
    EXEC SQL BEGIN DECLARE SECTION;
        
        int       ct;
        char      idUsuarioNovo[64];
        char      idGrupo[64];
        char      idUsuario[64];

	EXEC SQL END DECLARE SECTION;
 
	//Processamento Principal
	try
	{
        int j;
        while ( subnode = tx.walkDOM(dnode,"Lista",ctLista++) )
        {
            ULOG( "Achou Lista");
            
            buffer = oSafePointer.getTag(subnode,"nmSelect",0);
            if ( strcmp("Grupo",buffer) )
               continue;
            j=0;
            while ( nodeSelec = tx.walkDOM(subnode,"Selecionado",j++) )
            {
                ULOG( "Achou Grupo");
                if ( p = tx.walkTree( nodeSelec, "id", 0 ),p ) 
                {
                    strcpy( idGrupo,       p );
                    strcpy( idUsuarioNovo, idUsuarioNovoPrm );
                    strcpy( idUsuario,     idUsuarioPrm );
                    
                    ULOG( "idGrupo       [%s]", idGrupo);
                    ULOG( "idUsuarioNovo [%s]", idUsuarioNovo);
                    ULOG( "idUsuario     [%s]", idUsuario);
                    
                    XMLString::release(&p);
                }
            }
        }

        
		EXEC SQL WHENEVER NOT FOUND CONTINUE;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;

        /*
        sprintf( idPerfilRemove,"%s",idPerfilPrm );
        EXEC SQL DELETE FROM CONTATOADM.GRUPOPERFILIDM WHERE IDPERFILIDM = :idPerfilRemove;
        */
        
        /*
        EXEC SQL FOR :ct
        INSERT INTO
        CONTATOADM.GRUPOPERFILIDM
        (
          IDGRUPO ,
          IDPERFILIDM ,
          IDUSUARIOALTERACAO 
        )
        VALUES
        (
          :idGrupo ,
          :idPerfil ,
          :idUsuario
        );
        */

        EXEC SQL
        UPDATE ACESSO.USUARIOGRUPO
        SET IDPESSOAUSUARIO = :idUsuarioNovo ,
            IDGRUPO = :idGrupo ,
            IDUSUARIOALTERACAO = :idUsuario ,
            DTULTIMAALTERACAO = SYSDATE
        WHERE
            IDPESSOAUSUARIO = :idUsuarioNovo 
        AND
            IDGRUPO = :idGrupo ;
        
        if ( sqlca.sqlerrd[2] == 0 )
        {
            EXEC SQL
            INSERT INTO
            ACESSO.USUARIOGRUPO
            (
                IDUSUARIOGRUPO ,
                IDPESSOAUSUARIO ,
                IDGRUPO ,
                IDUSUARIOALTERACAO ,
                DTULTIMAALTERACAO 
            )
            VALUES
            (
              ACESSO.USUARIOGRUPOSQ.NEXTVAL ,
              :idUsuarioNovo ,
              :idGrupo ,
              :idUsuario ,
              SYSDATE
            );
        }

		ULOG_END("InsereGrupoPerfil()");
        
        return ;
	}
	catch(...)
	{
		throw;
	}

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::OperadoraPerfil( char * idPerfilPrm, XMLGen * xml_g )
{
    ULOG_START("OperadoraPerfil()");

	int    iCont = 0;
	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
       char      idPerfil[64];
       
       VARCHAR   idOperadora[64];
       short     i_idOperadora = -1;
       VARCHAR   nmOperadora[256];
       short     i_nmOperadora = -1;
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
        sprintf( idPerfil, "%s", idPerfilPrm );
        
		EXEC SQL WHENEVER NOT FOUND DO break;
		EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
		sqlca.sqlcode=0;

   		EXEC SQL DECLARE crSelPerfilOperadora CURSOR FOR
        SELECT
           UFOPERADORA.IDUFOPERADORA ,
           TRIM(PESSOA.NMPESSOA)
        FROM
           CUSTOMER.UFOPERADORA            UFOPERADORA ,
		   CUSTOMER.PESSOADEPARA           PESSOADEPARA ,
		   CUSTOMER.PESSOA                 PESSOA ,
           CONTATOADM.OPERADORAPERFILIDM   OPERADORAPERFILIDM
        WHERE
           UFOPERADORA.IDUFOPERADORA = OPERADORAPERFILIDM.IDUFOPERADORA
		AND
		   UFOPERADORA.IDPESSOADEPARAOPERADORA = PESSOADEPARA.IDPESSOADEPARA
		AND
		   PESSOA.IDPESSOA = PESSOADEPARA.IDPESSOA
        AND
           OPERADORAPERFILIDM.IDPERFILIDM = :idPerfil
        ORDER BY TRIM(UPPER(PESSOA.NMPESSOA));
        
		EXEC SQL OPEN crSelPerfilOperadora;

        xml_g->createTag("Selecionado");
        for(;;)
        {
            EXEC SQL FETCH crSelPerfilOperadora INTO :idOperadora:i_idOperadora ,
                                                     :nmOperadora:i_nmOperadora ;
            endOraStr(idOperadora);
            endOraStr(nmOperadora);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idOperadora.arr );
                xml_g->addItem("ds", (char*)nmOperadora.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        EXEC SQL CLOSE crSelPerfilOperadora;

		sqlca.sqlcode=0;
   		EXEC SQL DECLARE crPerfilOperadora CURSOR FOR
        SELECT
           UFOPERADORA.IDUFOPERADORA ,
           TRIM(PESSOA.NMPESSOA)
        FROM
           CUSTOMER.UFOPERADORA            UFOPERADORA ,
           CUSTOMER.PESSOADEPARA           PESSOADEPARA ,
           CUSTOMER.PESSOA                 PESSOA 
        WHERE
           UFOPERADORA.IDPESSOADEPARAOPERADORA = PESSOADEPARA.IDPESSOADEPARA
        AND
           UFOPERADORA.IDUF = PESSOA.IDUF
        AND
           PESSOA.IDPESSOA = PESSOADEPARA.IDPESSOA
        AND
           IDUFOPERADORA NOT IN
        (
           SELECT IDUFOPERADORA FROM CONTATOADM.OPERADORAPERFILIDM WHERE IDPERFILIDM = :idPerfil
        )
        ORDER BY TRIM(UPPER(PESSOA.NMPESSOA)); 

        EXEC SQL OPEN crPerfilOperadora;

        xml_g->createTag("Disponivel");
        for(;;)
        {
            EXEC SQL FETCH crPerfilOperadora INTO :idOperadora:i_idOperadora ,
                                                  :nmOperadora:i_nmOperadora ;
            endOraStr(idOperadora);
            endOraStr(nmOperadora);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idOperadora.arr );
                xml_g->addItem("ds", (char*)nmOperadora.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        EXEC SQL CLOSE crPerfilOperadora;

        ULOG_END("OperadoraPerfil()");
        
        return ;
    }
    catch(...)
    {
        throw;
    }

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::InsereOperadoraPerfil( char * idUsuarioPrm, char * idUsuarioNovoPrm, DOMNode * dnode, XMLGen * xml_g )
{
    ULOG_START("InsereOperadoraPerfil()");
    DOMNode * subnode;
    DOMNode * nodeSelec;
    int    ctLista = 0;
    char * p = 0x0;
    char * buffer;
    TuxHelper tx;


	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
        
        int       ct;
        char      idUsuarioNovo[64];
        char      idOperadora[64];
        char      idPerfil[64];
        char      idUsuario[64];
       
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
        int j;
        while ( subnode = tx.walkDOM(dnode,"Lista",ctLista++) )
        {
            buffer = oSafePointer.getTag(subnode,"nmSelect",0);
            if ( strcmp("Operadora",buffer) )
               continue;
            j=0;
            while ( nodeSelec = tx.walkDOM(subnode,"Selecionado",j++) )
            {
                if ( p = tx.walkTree( nodeSelec, "id", 0 ),p ) 
                {
                    strcpy( idOperadora, p );
                    strcpy( idUsuarioNovo, idUsuarioNovoPrm );
                    strcpy( idUsuario, idUsuarioPrm );
                    XMLString::release(&p);

                    ULOG( "idOperadora   [%s]", idOperadora);
                    ULOG( "idPerfil      [%s]", idPerfil);
                    ULOG( "idUsuario     [%s]", idUsuario);
                    ULOG( "idUsuarioNovo [%s]", idUsuarioNovo);
                }
            }
        }
        
		EXEC SQL WHENEVER NOT FOUND CONTINUE;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
        //sprintf( idUsuarioNovo,"%s",idUsuarioNovoPrm );
        //EXEC SQL DELETE FROM CONTATOADM.OPERADORAPERFILIDM WHERE IDPERFILIDM = :idPerfilRemove;
        /*
        EXEC SQL FOR :ct
        INSERT INTO
        CONTATOADM.OPERADORAPERFILIDM
        (
          IDUFOPERADORA ,
          IDPERFILIDM ,
          IDUSUARIOALTERACAO 
        )
        VALUES
        (
          :idOperadora ,
          :idPerfil ,
          :idUsuario
        );
        */
        
        EXEC SQL
        UPDATE ACESSO.USUARIOUFOPERADORA
        SET IDPESSOAUSUARIO = :idUsuarioNovo ,
            IDUFOPERADORA = :idOperadora,
            IDUSUARIOALTERACAO = :idUsuario ,
            DTULTIMAALTERACAO = SYSDATE
        WHERE
            IDPESSOAUSUARIO = :idUsuarioNovo 
        AND
            IDUFOPERADORA = :idOperadora ;
        
        if ( sqlca.sqlerrd[2] == 0 )
        {
            EXEC SQL
            INSERT INTO
            ACESSO.USUARIOUFOPERADORA
            (
                IDUSUARIOUFOPERADORA ,
                IDPESSOAUSUARIO ,
                IDUFOPERADORA ,
                IDUSUARIOALTERACAO ,
                DTULTIMAALTERACAO 
            )
            VALUES
            (
              ACESSO.USUARIOUFOPERADORASQ.NEXTVAL ,
              :idUsuarioNovo ,
              :idOperadora ,
              :idUsuario ,
              SYSDATE
            );
        }
        
        ULOG_END("InsereOperadoraPerfil()");
        
        return ;
	}
	catch(...)
	{
		throw;
	}

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::ItemMenuPerfil( char * idPerfilPrm, XMLGen * xml_g )
{
    ULOG_START("ItemMenuPerfil()");

	int    iCont = 0;
	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
       char      idPerfil[64];
       
       VARCHAR   idMenu[64];
       short     i_idMenu = -1;
       VARCHAR   nmMenu[256];
       short     i_nmMenu = -1;
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
        sprintf( idPerfil, "%s", idPerfilPrm );
        
		EXEC SQL WHENEVER NOT FOUND DO break;
		EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
		sqlca.sqlcode=0;

   		EXEC SQL DECLARE crSelPerfilMenu CURSOR FOR
        SELECT
           ITEMMENU.IDITEMMENU ,
           TRIM(ITEMMENU.NMITEM)
        FROM
		   ACESSO.ITEMMENU                ITEMMENU ,
           CONTATOADM.ITEMMENUPERFILIDM   ITEMMENUPERFILIDM
        WHERE
           ITEMMENU.IDITEMMENU = ITEMMENUPERFILIDM.IDITEMMENU
		AND
           ITEMMENUPERFILIDM.IDPERFILIDM = :idPerfil
        ORDER BY TRIM(UPPER(ITEMMENU.NMITEM));
        
		EXEC SQL OPEN crSelPerfilMenu;

        xml_g->createTag("Selecionado");
        for(;;)
        {
            EXEC SQL FETCH crSelPerfilMenu INTO :idMenu:i_idMenu ,
                                                :nmMenu:i_nmMenu ;
            endOraStr(idMenu);
            endOraStr(nmMenu);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idMenu.arr );
                xml_g->addItem("ds", (char*)nmMenu.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        EXEC SQL CLOSE crSelPerfilMenu;

		sqlca.sqlcode=0;
   		EXEC SQL DECLARE crPerfilMenu CURSOR FOR
        SELECT
           ITEMMENU.IDITEMMENU ,
           TRIM(ITEMMENU.NMITEM)
        FROM
		   ACESSO.ITEMMENU   ITEMMENU 
        WHERE
		   ITEMMENU.IDITEMMENU > 0
        AND
           ITEMMENU.IDITEMMENU NOT IN
        (
           SELECT IDITEMMENU FROM CONTATOADM.ITEMMENUPERFILIDM WHERE IDPERFILIDM = :idPerfil
        )
        ORDER BY TRIM(UPPER(ITEMMENU.NMITEM)); 
        
		EXEC SQL OPEN crPerfilMenu;

        xml_g->createTag("Disponivel");
        for(;;)
        {
            EXEC SQL FETCH crPerfilMenu INTO :idMenu:i_idMenu ,
                                             :nmMenu:i_nmMenu ;
            endOraStr(idMenu);
            endOraStr(nmMenu);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idMenu.arr );
                xml_g->addItem("ds", (char*)nmMenu.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        EXEC SQL CLOSE crPerfilMenu;

		ULOG_END("ItemMenuPerfil()");
        
        return ;
	}
	catch(...)
	{
		throw;
	}

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::InsereItemMenuPerfil( char * idUsuarioPrm, char * idUsuarioNovoPrm, DOMNode * dnode, XMLGen * xml_g )
{
    ULOG_START("InsereItemMenuPerfil()");
    TuxHelper     tx;
    DOMNode * subnode;
    DOMNode * nodeSelec;
    int    ctLista = 0;
    char * p = 0x0;
    char * buffer;

	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
        
        int       ct;
        char      idItemMenu[64];
        char      idUsuarioNovo[64];
        char      idUsuario[64];
       
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
        int j;
        while ( subnode = tx.walkDOM(dnode,"Lista",ctLista++) )
        {
            buffer = oSafePointer.getTag(subnode,"nmSelect",0);
            if ( strcmp("ItemMenu",buffer) )
               continue;
            j=0;
            while ( nodeSelec = tx.walkDOM(subnode,"Selecionado",j++) )
            {
                if ( p = tx.walkTree( nodeSelec, "id", 0 ),p ) 
                {
                    strcpy( idItemMenu, p );
                    strcpy( idUsuarioNovo, idUsuarioNovoPrm );
                    strcpy( idUsuario, idUsuarioPrm );
                    XMLString::release(&p);

                    ULOG( "idItemMenu    [%s]", idItemMenu);
                    ULOG( "idUsuarioNovo [%s]", idUsuarioNovo);
                    ULOG( "idUsuario     [%s]", idUsuario);
                }
            }
        }
        
		EXEC SQL WHENEVER NOT FOUND CONTINUE;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
        /*
        sprintf( idPerfilRemove,"%s",idPerfilPrm );
        EXEC SQL DELETE FROM CONTATOADM.ITEMMENUPERFILIDM WHERE IDPERFILIDM = :idPerfilRemove;
        */
        
        /*
        EXEC SQL FOR :ct
        INSERT INTO
        CONTATOADM.ITEMMENUPERFILIDM
        (
          IDITEMMENU ,
          IDPERFILIDM ,
          IDUSUARIOALTERACAO 
        )
        VALUES
        (
          :idItemMenu ,
          :idPerfil ,
          :idUsuario
        );
        */
        
        EXEC SQL
        UPDATE ACESSO.USUARIOITEMMENU
        SET IDPESSOAUSUARIO = :idUsuarioNovo ,
            IDITEMMENU = :idItemMenu ,
            IDUSUARIOALTERACAO = :idUsuario ,
            DTULTIMAALTERACAO = SYSDATE
        WHERE
            IDPESSOAUSUARIO = :idUsuarioNovo 
        AND
            IDITEMMENU = :idItemMenu ;
        
        if ( sqlca.sqlerrd[2] == 0 )
        {
            EXEC SQL
            INSERT INTO
            ACESSO.USUARIOITEMMENU
            (
                IDUSUARIOITEMMENU ,
                IDPESSOAUSUARIO ,
                IDITEMMENU ,
                IDUSUARIOALTERACAO ,
                DTULTIMAALTERACAO 
            )
            VALUES
            (
              ACESSO.USUARIOITEMMENUSQ.NEXTVAL ,
              :idUsuarioNovo ,
              :idItemMenu ,
              :idUsuario ,
              SYSDATE
            );
        }
        
        ULOG_END("InsereItemMenuPerfil()");
        
        return ;
	}
	catch(...)
	{
		throw;
	}

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::PerfilFO( char * idPerfilPrm, XMLGen * xml_g )
{
    ULOG_START("PerfilFO()");

	int    iCont = 0;
	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
       char      idPerfil[64];
       
       VARCHAR   idPerfilFO[64];
       short     i_idPerfilFO = -1;
       VARCHAR   nmPerfilFO[256];
       short     i_nmPerfilFO = -1;
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
        sprintf( idPerfil, "%s", idPerfilPrm );
        
		EXEC SQL WHENEVER NOT FOUND DO break;
		EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
		sqlca.sqlcode=0;

   		EXEC SQL DECLARE crSelPerfilFO CURSOR FOR
        SELECT
           PERFIL.IDROLE ,
           TRIM(PERFIL.NMROLE)
        FROM
		   ACESSO.ROLE                  PERFIL ,
           CONTATOADM.ROLEPERFILIDM   ROLEPERFILIDM
        WHERE
           ROLEPERFILIDM.IDROLE = PERFIL.IDROLE
		AND
           ROLEPERFILIDM.IDPERFILIDM = :idPerfil
        ORDER BY TRIM(UPPER(PERFIL.NMROLE));
        
		EXEC SQL OPEN crSelPerfilFO;

        xml_g->createTag("Selecionado");
        for(;;)
        {
            EXEC SQL FETCH crSelPerfilFO INTO :idPerfilFO:i_idPerfilFO ,
                                              :nmPerfilFO:i_nmPerfilFO ;
            endOraStr(idPerfilFO);
            endOraStr(nmPerfilFO);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idPerfilFO.arr );
                xml_g->addItem("ds", (char*)nmPerfilFO.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        EXEC SQL CLOSE crSelPerfilFO;

		sqlca.sqlcode=0;
   		EXEC SQL DECLARE crPerfilFO CURSOR FOR
        SELECT
           PERFIL.IDROLE ,
           TRIM(PERFIL.NMROLE)
        FROM
		   ACESSO.ROLE   PERFIL 
        WHERE
		   PERFIL.IDROLE > 0
        AND
           PERFIL.IDROLE NOT IN
        (
           SELECT IDROLE FROM CONTATOADM.ROLEPERFILIDM WHERE IDPERFILIDM = :idPerfil
        )
        ORDER BY TRIM(UPPER(PERFIL.NMROLE)); 
        
		EXEC SQL OPEN crPerfilFO;

        xml_g->createTag("Disponivel");
        for(;;)
        {
            EXEC SQL FETCH crPerfilFO INTO :idPerfilFO:i_idPerfilFO ,
                                           :nmPerfilFO:i_nmPerfilFO ;
            endOraStr(idPerfilFO);
            endOraStr(nmPerfilFO);
            xml_g->createTag("It");
                xml_g->addItem("id", (char*)idPerfilFO.arr );
                xml_g->addItem("ds", (char*)nmPerfilFO.arr );
            xml_g->closeTag();
        }
        xml_g->closeTag();
        EXEC SQL CLOSE crPerfilFO;

		ULOG_END("PerfilFO()");
        
        return ;
	}
	catch(...)
	{
		throw;
	}

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::RelacionaPerfil( char * idUsuarioPrm, char * idUsuarioNovoPrm, DOMNode * dnode, XMLGen * xml_g )
{
    ULOG_START("RelacionaPerfil()");
    DOMNode * subnode;
    DOMNode * nodeSelec;
    int    ctLista = 0;
    TuxHelper     tx;
    char * p = 0x0;
    char * buffer;

	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
        
        int       ct;
        char      idRole[64];
        char      idUsuarioNovo[64];
        char      idUsuario[64];
       
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
        int j;
        while ( subnode = tx.walkDOM(dnode,"Lista",ctLista++) )
        {
            buffer = oSafePointer.getTag(subnode,"nmSelect",0);
            if ( strcmp("Perfil",buffer) )
               continue;
            j=0;
            while ( nodeSelec = tx.walkDOM(subnode,"Selecionado",j++) )
            {
                if ( p = tx.walkTree( nodeSelec, "id", 0 ),p ) 
                {
                    strcpy( idRole, p );
                    strcpy( idUsuarioNovo, idUsuarioNovoPrm );
                    strcpy( idUsuario, idUsuarioPrm );
                    XMLString::release(&p);

                    ULOG( "idRole        [%s]", idRole);
                    ULOG( "idUsuarioNovo [%s]", idUsuarioNovo);
                    ULOG( "idUsuario     [%s]", idUsuario);
                }
            }
        }
        
		EXEC SQL WHENEVER NOT FOUND CONTINUE;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
        /*
        sprintf( idPerfilRemove,"%s",idPerfilPrm );
        EXEC SQL DELETE FROM CONTATOADM.ROLEPERFILIDM WHERE IDPERFILIDM = :idPerfilRemove;
        */
        
        /*
        EXEC SQL FOR :ct
        INSERT INTO
        CONTATOADM.ROLEPERFILIDM
        (
          IDROLE ,
          IDPERFILIDM ,
          IDUSUARIOALTERACAO 
        )
        VALUES
        (
          :idPerfilFO ,
          :idPerfil ,
          :idUsuario
        );
        */
        
        EXEC SQL
        UPDATE ACESSO.USUARIOROLE
        SET
            IDPESSOAUSUARIO = :idUsuarioNovo ,
            IDROLE = :idRole ,
            IDUSUARIOALTERACAO = :idUsuario ,
            DTULTIMAALTERACAO = SYSDATE
        WHERE
            IDPESSOAUSUARIO = :idUsuarioNovo
        AND
            IDROLE = :idRole ;
        
        if ( sqlca.sqlerrd[2] == 0 )
        {
            EXEC SQL
            INSERT INTO
            ACESSO.USUARIOROLE
            (
                IDUSUARIOROLE ,
                IDPESSOAUSUARIO ,
                IDROLE ,
                IDUSUARIOALTERACAO ,
                DTULTIMAALTERACAO 
            )
            VALUES
            (
              ACESSO.USUARIOROLESQ.NEXTVAL ,
              :idUsuarioNovo ,
              :idRole ,
              :idUsuario ,
              SYSDATE
            );
        }
        
        ULOG_END("RelacionaPerfil()");
        
        return ;
    }
    catch(...)
    {
        throw;
    }

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::InserePerfilIDM( char * idUsuarioPrm, char * idPerfilIDM, char * nmPerfilIDM, int * ct )
{
    ULOG_START("InserePerfilIDM()");

	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
        
        int       ctRegistros;
        VARCHAR   idPerfil[64];
        char      nmPerfil[256];
        char      idUsuario[64];
       
	EXEC SQL END DECLARE SECTION;

	//Processamento Principal
	try
	{
        
        strcpy( nmPerfil, nmPerfilIDM );
        strcpy( idUsuario, idUsuarioPrm );
        
        ULOG( "*** Gravando Novo Perfil IDM" );
        ULOG( ">>> nmPerfilIDM [%s]",nmPerfilIDM );
        ULOG( ">>> idUsuario   [%s]",idUsuario );
        
		EXEC SQL WHENEVER NOT FOUND CONTINUE;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;
        
        EXEC SQL 
        SELECT 
           COUNT(IDPERFILIDM) INTO :ctRegistros 
        FROM 
           CONTATOADM.PERFILIDM 
        WHERE 
           UPPER(TRIM(NMPERFILIDM)) = UPPER(TRIM(:nmPerfil));
        ULOG( "Foram encontrados [%d] registros para o nome de perfil solicitado.", ctRegistros );
        
        if ( ctRegistros > 0 )
        {
           *ct = ctRegistros;
           ULOG( "Já existe o nome de perfil na base." );
           ULOG_END("ERRO!!! - InserePerfilIDM()");
           return;
        }
        
        EXEC SQL SELECT CONTATOADM.PERFILIDMSQ.NEXTVAL INTO :idPerfil FROM DUAL;
        endOraStr(idPerfil);
        
        EXEC SQL 
        INSERT INTO
        CONTATOADM.PERFILIDM
        (
          IDPERFILIDM ,
          NMPERFILIDM ,
          INATIVO ,
          IDUSUARIOALTERACAO
        )
        VALUES
        (
          TO_NUMBER(:idPerfil) ,
          :nmPerfil ,
          1 ,
          :idUsuario
        );

        //oraToStr( idPerfilIDM,idPerfil);
        sprintf( idPerfilIDM,"%.*s",idPerfil.len,idPerfil.arr);
        ULOG( "*** Novo idPerfilIDM gerado [%s]", idPerfilIDM );
        
		ULOG_END("InserePerfilIDM()");
        
        return ;
	}
	catch(...)
	{
		throw;
	}

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	throw TuxBasicOraException(sqlca.sqlcode);

}



void CPerfilIDM::RelacionaPerfilIDM( char * cidUserPrm,char * idUsuarioNovoPrm,char * idPerfilIDMPrm )
{
    ULOG_START( "RelacUsuarioRole()" );

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;

        char * idUsuario = cidUserPrm;
        char * idUsuarioNovo = idUsuarioNovoPrm;
        char * idPerfilIDM = idPerfilIDMPrm;
        VARCHAR idRole[64]; short i_idRole;
        VARCHAR idGrupo[64]; short i_idGrupo;
        VARCHAR idUFOperadora[64]; short i_idUFOperadora;
        VARCHAR idItemMenu[64]; short i_idItemMenu;
       
    EXEC SQL END DECLARE SECTION;

    //Processamento Principal
    try
    {
        
        ULOG( ">>> idUsuario         [%s]",idUsuario );
        ULOG( ">>> idUsuarioNovo     [%s]",idUsuarioNovo );
        ULOG( ">>> idPerfilIDM       [%s]",idPerfilIDM );
        
        /*------- Usuario Grupo -------*/
        EXEC SQL WHENEVER NOT FOUND DO break;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;

        EXEC SQL DECLARE crGrupo CURSOR FOR
        SELECT
           IDGRUPO
        FROM
           CONTATOADM.GRUPOPERFILIDM
        WHERE
           IDPERFILIDM = :idPerfilIDM ;
           
        EXEC SQL OPEN crGrupo;

        for(;;)
        {
            i_idGrupo = -1;
            EXEC SQL 
            FETCH crGrupo INTO :idGrupo:i_idGrupo ;
            if ( i_idGrupo != -1 )
            {
                endOraStr(idGrupo);
                EXEC SQL WHENEVER NOT FOUND CONTINUE;

                EXEC SQL 
                INSERT INTO
                ACESSO.USUARIOGRUPO
                (
                    IDUSUARIOGRUPO ,
                    IDPESSOAUSUARIO ,
                    IDGRUPO ,
                    IDUSUARIOALTERACAO ,
                    DTULTIMAALTERACAO 
                )
                VALUES
                (
                  ACESSO.USUARIOGRUPOSQ.NEXTVAL ,
                  :idUsuarioNovo ,
                  :idGrupo ,
                  :idUsuario ,
                  SYSDATE
                );
                
                EXEC SQL WHENEVER NOT FOUND DO break;
            }
        }
        
        EXEC SQL CLOSE crGrupo;
        
        /*------- Usuario UFOperadora -------*/
        EXEC SQL WHENEVER NOT FOUND DO break;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;

        EXEC SQL DECLARE crUFOper CURSOR FOR
        SELECT
           IDUFOPERADORA
        FROM
           CONTATOADM.OPERADORAPERFILIDM
        WHERE
           IDPERFILIDM = :idPerfilIDM ;
           
        EXEC SQL OPEN crUFOper;

        for(;;)
        {
            i_idGrupo = -1;
            EXEC SQL 
            FETCH crUFOper INTO :idUFOperadora:i_idUFOperadora ;
            if ( i_idUFOperadora != -1 )
            {
                endOraStr(idUFOperadora);
                EXEC SQL WHENEVER NOT FOUND CONTINUE;

                EXEC SQL 
                INSERT INTO
                ACESSO.USUARIOUFOPERADORA
                (
                    IDUSUARIOUFOPERADORA ,
                    IDPESSOAUSUARIO ,
                    IDUFOPERADORA ,
                    IDUSUARIOALTERACAO ,
                    DTULTIMAALTERACAO 
                )
                VALUES
                (
                  ACESSO.USUARIOUFOPERADORASQ.NEXTVAL ,
                  :idUsuarioNovo ,
                  :idUFOperadora ,
                  :idUsuario ,
                  SYSDATE
                );
                
                EXEC SQL WHENEVER NOT FOUND DO break;
            }
        }
        
        EXEC SQL CLOSE crUFOper;

        /*------- Usuario ItemMenu -------*/
        EXEC SQL WHENEVER NOT FOUND DO break;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;

        EXEC SQL DECLARE crItemMenu CURSOR FOR
        SELECT
           IDITEMMENU
        FROM
           CONTATOADM.ITEMMENUPERFILIDM
        WHERE
           IDPERFILIDM = :idPerfilIDM ;
           
        EXEC SQL OPEN crItemMenu;

        for(;;)
        {
            i_idGrupo = -1;
            EXEC SQL 
            FETCH crItemMenu INTO :idItemMenu:i_idItemMenu ;
            if ( i_idItemMenu != -1 )
            {
                endOraStr(idItemMenu);
                EXEC SQL WHENEVER NOT FOUND CONTINUE;

                EXEC SQL 
                INSERT INTO
                ACESSO.USUARIOITEMMENU
                (
                    IDUSUARIOITEMMENU ,
                    IDPESSOAUSUARIO ,
                    IDITEMMENU ,
                    IDUSUARIOALTERACAO ,
                    DTULTIMAALTERACAO 
                )
                VALUES
                (
                  ACESSO.USUARIOITEMMENUSQ.NEXTVAL ,
                  :idUsuarioNovo ,
                  :idItemMenu ,
                  :idUsuario ,
                  SYSDATE
                );
                
                EXEC SQL WHENEVER NOT FOUND DO break;
            }
        }
        
        EXEC SQL CLOSE crItemMenu;

        /*------- Usuario Role -------*/
        EXEC SQL WHENEVER NOT FOUND DO break;
        EXEC SQL WHENEVER SQLERROR GOTO GotoListAll;

        EXEC SQL DECLARE crRole CURSOR FOR
        SELECT
           IDROLE
        FROM
           CONTATOADM.ROLEPERFILIDM
        WHERE
           IDPERFILIDM = :idPerfilIDM ;
           
        EXEC SQL OPEN crRole;

        for(;;)
        {
            i_idRole = -1;
            EXEC SQL 
            FETCH crRole INTO :idRole:i_idRole ;
            if ( i_idRole != -1 )
            {
                endOraStr(idRole);
                EXEC SQL WHENEVER NOT FOUND CONTINUE;

                EXEC SQL 
                INSERT INTO
                ACESSO.USUARIOROLE
                (
                    IDUSUARIOROLE ,
                    IDPESSOAUSUARIO ,
                    IDROLE ,
                    IDUSUARIOALTERACAO ,
                    DTULTIMAALTERACAO 
                )
                VALUES
                (
                  ACESSO.USUARIOROLESQ.NEXTVAL ,
                  :idUsuarioNovo ,
                  :idRole ,
                  :idUsuario ,
                  SYSDATE
                );
                
                EXEC SQL WHENEVER NOT FOUND DO break;
            }
        }
        
        EXEC SQL CLOSE crRole;
        
        
        
        ULOG_END( "RelacUsuarioRole()" );
        
        return ;
    }
    catch(...)
    {
        throw;
    }

GotoListAll:
    ULOGE( "ERRO ORACLE:sqlcode = [%d],sqlerrmc = [%.80s]",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    throw TuxBasicOraException(sqlca.sqlcode);
}
