///////////////////////////////////////////////////////////////////////////////
/**
 * @modulo  Sincronismo
 * @usecase PessoaEndereco
 * @author  Renato Striitzel Russo
 * @author  Carlos Eduardo Barbosa Braga
 * @author  Eder Martins
 * @version $Revision: 1.1.2.1 $
 * @CVS     $Author: a5110702 $  $Date: 2010/01/11 21:27:16 $
 **/
///////////////////////////////////////////////////////////////////////////////

#undef SQLCA
#define SQLCA_NONE
#include<sqlca.h>
#include<sqlda.h>

#include "tuxfw.h"
#include "PessoaEnderecopc.h"
#include <memory.h>

#define strToOra(vchar,bstr)   vchar.len = strlen(bstr);strncpy((char *)vchar.arr,bstr,vchar.len);vchar.arr[vchar.len] = 0


EXEC SQL BEGIN DECLARE SECTION;
#include "Global.h"
EXEC SQL END DECLARE SECTION;

/****************************************************************************************/
void CPessoaEnderecopc::proCInserePessoaEndereco(TPessoaEndereco* ptPessoaEndereco)
{
    ULOG_START("CPessoaEnderecopc::proCInserePessoaEndereco");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
        VARCHAR oszIdPessoa[LEN_IDPESSOA];
        VARCHAR oszNrSequencia[LEN_NRSEQUENCIA];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszNmMunicipio[LEN_NMMUNICIPIO];
        VARCHAR oszNmLocalidade[LEN_NMLOCALIDADE];
        VARCHAR oszNmBairro[LEN_NMBAIRRO];
        VARCHAR oszNmTipoLogradouro[LEN_NMTIPOLOGRADOURO];
        VARCHAR oszNmTituloLogradouro[LEN_NMTITULOLOGRADOURO];
        VARCHAR oszNmLogradouro[LEN_NMLOGRADOURO];
        VARCHAR oszNrEndereco[LEN_NRENDERECO];
        VARCHAR oszDsEnderecoComplemento[LEN_DSENDERECOCOMPLEMENTO];
        VARCHAR oszInEnderecoPreferencial[LEN_INENDERECOPREFERENCIAL];
        VARCHAR oszNrCep[LEN_NRCEP];
        VARCHAR oszDtCadastro[LEN_DTCADASTRO];
        VARCHAR oszIdTipoEndereco[LEN_IDTIPOENDERECO];
        VARCHAR oszTsSincronismo[LEN_TSSINCRONISMO];
        VARCHAR oszDtExpiracao[LEN_DTEXPIRACAO];
        VARCHAR oszSqSincronismo[LEN_SQSINCRONISMO];
        VARCHAR oszIdUf[LEN_IDUF];
        VARCHAR oszDsAosCuidados[LEN_DSAOSCUIDADOS];
        VARCHAR oszCdCaixaPostal[LEN_CDCAIXAPOSTAL];
        VARCHAR oszIdSistemaOrigem[LEN_IDSISTEMAORIGEM];
        VARCHAR oszIdEnderecoSistemaOrigem[LEN_IDENDERECOSISTEMAORIGEM];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;

    STRCPY_TO_ORA( oszIdPessoaEndereco          , ptPessoaEndereco->szIdPessoaEndereco          );
    STRCPY_TO_ORA( oszIdPessoa                  , ptPessoaEndereco->szIdPessoa                  );
    STRCPY_TO_ORA( oszNrSequencia               , ptPessoaEndereco->szNrSequencia               );
    STRCPY_TO_ORA( oszIdPais                    , ptPessoaEndereco->szIdPais                    );
    STRCPY_TO_ORA( oszNmMunicipio               , ptPessoaEndereco->szNmMunicipio               );
    STRCPY_TO_ORA( oszNmLocalidade              , ptPessoaEndereco->szNmLocalidade              );
    STRCPY_TO_ORA( oszNmBairro                  , ptPessoaEndereco->szNmBairro                  );
    STRCPY_TO_ORA( oszNmTipoLogradouro          , ptPessoaEndereco->szNmTipoLogradouro          );
    STRCPY_TO_ORA( oszNmTituloLogradouro        , ptPessoaEndereco->szNmTituloLogradouro        );
    STRCPY_TO_ORA( oszNmLogradouro              , ptPessoaEndereco->szNmLogradouro              );
    STRCPY_TO_ORA( oszNrEndereco                , ptPessoaEndereco->szNrEndereco                );
    STRCPY_TO_ORA( oszDsEnderecoComplemento     , ptPessoaEndereco->szDsEnderecoComplemento     );

    if ( *(ptPessoaEndereco->szInEnderecoPreferencial)==0 ) {
        STRCPY_TO_ORA( oszInEnderecoPreferencial, "0"                                           );
    }
    else {
        STRCPY_TO_ORA( oszInEnderecoPreferencial, ptPessoaEndereco->szInEnderecoPreferencial    );
    }

    STRCPY_TO_ORA( oszNrCep                     , ptPessoaEndereco->szNrCep                     );
    STRCPY_TO_ORA( oszDtCadastro                , ptPessoaEndereco->szDtCadastro                );
    STRCPY_TO_ORA( oszIdTipoEndereco            , ptPessoaEndereco->szIdTipoEndereco            );
    STRCPY_TO_ORA( oszTsSincronismo             , ptPessoaEndereco->szTsSincronismo             );
    STRCPY_TO_ORA( oszDtExpiracao               , ptPessoaEndereco->szDtExpiracao               );
    STRCPY_TO_ORA( oszSqSincronismo             , ptPessoaEndereco->szSqSincronismo             );
    STRCPY_TO_ORA( oszIdUf                      , ptPessoaEndereco->szIdUf                      );
    STRCPY_TO_ORA( oszDsAosCuidados             , ptPessoaEndereco->szDsAosCuidados             );
    STRCPY_TO_ORA( oszCdCaixaPostal             , ptPessoaEndereco->szCdCaixaPostal             );
    STRCPY_TO_ORA( oszIdSistemaOrigem           , ptPessoaEndereco->szIdSistemaOrigem           );
    STRCPY_TO_ORA( oszIdEnderecoSistemaOrigem   , ptPessoaEndereco->szIdEnderecoSistemaOrigem   );
    STRCPY_TO_ORA( oszIdUsuarioAlteracao        , ptPessoaEndereco->szIdUsuarioAlteracao        );


    EXEC SQL SELECT Customer.PessoaEnderecoSq.nextval
               INTO :oszIdPessoaEndereco FROM DUAL;

    STRCPY_FROM_ORA(ptPessoaEndereco->szIdPessoaEndereco, oszIdPessoaEndereco);
    STRCPY_FROM_ORA(ptPessoaEndereco->szIdEnderecoSistemaOrigem, oszIdPessoaEndereco);

    EXEC SQL INSERT INTO Customer.PessoaEndereco
                       ( idpessoaendereco
                       , idpessoa
                       , nrsequencia
                       , idpais
                       , nmmunicipio
                       , nmlocalidade
                       , nmbairro
                       , nmtipologradouro
                       , nmtitulologradouro
                       , nmlogradouro
                       , nrendereco
                       , dsenderecocomplemento
                       , inenderecopreferencial
                       , nrcep
                       , dtcadastro
                       , idtipoendereco
                       , tssincronismo
                       , dtexpiracao
                       , sqsincronismo
                       , iduf
                       , dsaoscuidados
                       , cdcaixapostal
                       , idsistemaorigem
                       , idenderecosistemaorigem
                       , idusuarioalteracao
                       , dtultimaalteracao )
                VALUES ( :oszIdPessoaEndereco
                       , :oszIdPessoa
                       , :oszNrSequencia
                       , :oszIdPais
                       , :oszNmMunicipio
                       , :oszNmLocalidade
                       , :oszNmBairro
                       , :oszNmTipoLogradouro
                       , :oszNmTituloLogradouro
                       , :oszNmLogradouro
                       , :oszNrEndereco
                       , :oszDsEnderecoComplemento
                       , :oszInEnderecoPreferencial
                       , :oszNrCep
                       , TO_DATE(:oszDtCadastro,'YYYYMMDDHH24MISS')
                       , :oszIdTipoEndereco
                       , :oszTsSincronismo
                       , TO_DATE( decode( length( :oszDtExpiracao ),  0, NULL
                                                                   ,  8, :oszDtExpiracao || TO_CHAR(SYSDATE,'hhMIss')
                                                                   , 14, :oszDtExpiracao
                                                                   , NULL ), 'YYYYMMDDHH24MISS' )
                       , :oszSqSincronismo
                       , :oszIdUf
                       , :oszDsAosCuidados
                       , :oszCdCaixaPostal
                       , :oszIdSistemaOrigem
                       , :oszIdPessoaEndereco
                       , :oszIdUsuarioAlteracao
                       , SYSDATE );


    ULOGI("Finalizando proCInserePessoaEndereco <OK>");
    ULOG_END("CPessoaEnderecopc::proCInserePessoaEndereco");
    return;

    erro:
        ULOGE("Finalizando proCInserePessoaEndereco <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

/****************************************************************************************/
void CPessoaEnderecopc::proCEnderecoSujo(TPessoaEndereco* ptPessoaEndereco)
{
    ULOG_START("CPessoaEnderecopc::proCEnderecoSujo");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
        VARCHAR oszInEnderecoSujo[LEN_INENDERECOSUJO];
    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;

    STRCPY_TO_ORA( oszIdPessoaEndereco  , ptPessoaEndereco->szIdPessoaEndereco);
    STRCPY_TO_ORA( oszInEnderecoSujo, ptPessoaEndereco->szInEnderecoSujo);

	EXEC SQL UPDATE Customer.PessoaEndereco
                SET inenderecosujo      = :oszInEnderecoSujo
                  , dtultimaalteracao   = SYSDATE
              WHERE idpessoaendereco    = :oszIdPessoaEndereco;

    ULOGI("Finalizando proCEnderecoSujo <OK>");
    ULOG_END("CPessoaEnderecopc::proCEnderecoSujo");
    return;

    erro:
        ULOGE("Finalizando proCEnderecoSujo <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

/****************************************************************************************/
void CPessoaEnderecopc::proCApagaPessoaEndereco(TPessoaEndereco* ptPessoaEndereco)
{
    ULOG_START("CPessoaEnderecopc::proCApagaPessoaEndereco");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
        VARCHAR oszSqSincronismo[LEN_SQSINCRONISMO];
        VARCHAR oszTsSincronismo[LEN_TSSINCRONISMO];
    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;

    STRCPY_TO_ORA( oszIdPessoaEndereco  , ptPessoaEndereco->szIdPessoaEndereco);
    STRCPY_TO_ORA( oszSqSincronismo     , ptPessoaEndereco->szSqSincronismo   );
    STRCPY_TO_ORA( oszTsSincronismo     , ptPessoaEndereco->szTsSincronismo   );
    STRCPY_TO_ORA( oszIdUsuarioAlteracao, ptPessoaEndereco->szIdUsuarioAlteracao);

	EXEC SQL UPDATE Customer.PessoaEndereco
                SET dtexpiracao         = SYSDATE
                  , idusuarioalteracao  = :oszIdUsuarioAlteracao
                  , sqsincronismo       = TO_NUMBER(:oszSqSincronismo)
                  , tssincronismo       = TO_NUMBER(:oszTsSincronismo)
                  , dtultimaalteracao   = SYSDATE
              WHERE idpessoaendereco    = :oszIdPessoaEndereco;

    ULOGI("Finalizando proCApagaPessoaEndereco <OK>");
    ULOG_END("CPessoaEnderecopc::proCApagaPessoaEndereco");
    return;

    erro:
        ULOGE("Finalizando proCApagaPessoaEndereco <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

/****************************************************************************************/
void CPessoaEnderecopc::proCAtualizaPessoaEndereco(TPessoaEndereco* ptPessoaEndereco)
{
    ULOG_START("CPessoaEnderecopc::proCAtualizaPessoaEndereco");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
        VARCHAR oszIdPessoa[LEN_IDPESSOA];
        VARCHAR oszNrSequencia[LEN_NRSEQUENCIA];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszNmMunicipio[LEN_NMMUNICIPIO];
        VARCHAR oszNmLocalidade[LEN_NMLOCALIDADE];
        VARCHAR oszNmBairro[LEN_NMBAIRRO];
        VARCHAR oszNmTipoLogradouro[LEN_NMTIPOLOGRADOURO];
        VARCHAR oszNmTituloLogradouro[LEN_NMTITULOLOGRADOURO];
        VARCHAR oszNmLogradouro[LEN_NMLOGRADOURO];
        VARCHAR oszNrEndereco[LEN_NRENDERECO];
        VARCHAR oszDsEnderecoComplemento[LEN_DSENDERECOCOMPLEMENTO];
        VARCHAR oszInEnderecoPreferencial[LEN_INENDERECOPREFERENCIAL];
        VARCHAR oszNrCep[LEN_NRCEP];
        VARCHAR oszDtCadastro[LEN_DTCADASTRO];
        VARCHAR oszIdTipoEndereco[LEN_IDTIPOENDERECO];
        VARCHAR oszTsSincronismo[LEN_TSSINCRONISMO];
        VARCHAR oszDtExpiracao[LEN_DTEXPIRACAO];
        VARCHAR oszSqSincronismo[LEN_SQSINCRONISMO];
        VARCHAR oszIdUf[LEN_IDUF];
        VARCHAR oszDsAosCuidados[LEN_DSAOSCUIDADOS];
        VARCHAR oszCdCaixaPostal[LEN_CDCAIXAPOSTAL];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND goto erro;

    STRCPY_TO_ORA( oszIdPessoaEndereco         , ptPessoaEndereco->szIdPessoaEndereco          );
    STRCPY_TO_ORA( oszIdPessoa                 , ptPessoaEndereco->szIdPessoa                  );
    STRCPY_TO_ORA( oszNrSequencia              , ptPessoaEndereco->szNrSequencia               );
    STRCPY_TO_ORA( oszIdPais                   , ptPessoaEndereco->szIdPais                    );
    STRCPY_TO_ORA( oszNmMunicipio              , ptPessoaEndereco->szNmMunicipio               );
    STRCPY_TO_ORA( oszNmLocalidade             , ptPessoaEndereco->szNmLocalidade              );
    STRCPY_TO_ORA( oszNmBairro                 , ptPessoaEndereco->szNmBairro                  );
    STRCPY_TO_ORA( oszNmTipoLogradouro         , ptPessoaEndereco->szNmTipoLogradouro          );
    STRCPY_TO_ORA( oszNmTituloLogradouro       , ptPessoaEndereco->szNmTituloLogradouro        );
    STRCPY_TO_ORA( oszNmLogradouro             , ptPessoaEndereco->szNmLogradouro              );
    STRCPY_TO_ORA( oszNrEndereco               , ptPessoaEndereco->szNrEndereco                );
    STRCPY_TO_ORA( oszDsEnderecoComplemento    , ptPessoaEndereco->szDsEnderecoComplemento     );
    STRCPY_TO_ORA( oszInEnderecoPreferencial   , ptPessoaEndereco->szInEnderecoPreferencial    );
    STRCPY_TO_ORA( oszNrCep                    , ptPessoaEndereco->szNrCep                     );
    STRCPY_TO_ORA( oszDtCadastro               , ptPessoaEndereco->szDtCadastro                );
    STRCPY_TO_ORA( oszIdTipoEndereco           , ptPessoaEndereco->szIdTipoEndereco            );
    STRCPY_TO_ORA( oszTsSincronismo            , ptPessoaEndereco->szTsSincronismo             );
    STRCPY_TO_ORA( oszDtExpiracao              , ptPessoaEndereco->szDtExpiracao               );
    STRCPY_TO_ORA( oszSqSincronismo            , ptPessoaEndereco->szSqSincronismo             );
    STRCPY_TO_ORA( oszIdUf                     , ptPessoaEndereco->szIdUf                      );
    STRCPY_TO_ORA( oszDsAosCuidados            , ptPessoaEndereco->szDsAosCuidados             );
    STRCPY_TO_ORA( oszCdCaixaPostal            , ptPessoaEndereco->szCdCaixaPostal             );
    STRCPY_TO_ORA( oszIdUsuarioAlteracao       , ptPessoaEndereco->szIdUsuarioAlteracao        );

	EXEC SQL UPDATE Customer.PessoaEndereco
                SET idpessoaendereco          = :oszIdPessoaEndereco
                  , idpessoa                  = :oszIdPessoa
                  , nrsequencia               = :oszNrSequencia
                  , idpais                    = :oszIdPais
                  , nmmunicipio               = :oszNmMunicipio
                  , nmlocalidade              = :oszNmLocalidade
                  , nmbairro                  = :oszNmBairro
                  , nmtipologradouro          = :oszNmTipoLogradouro
                  , nmtitulologradouro        = :oszNmTituloLogradouro
                  , nmlogradouro              = :oszNmLogradouro
                  , nrendereco                = :oszNrEndereco
                  , dsenderecocomplemento     = :oszDsEnderecoComplemento
                  , inenderecopreferencial    = :oszInEnderecoPreferencial
                  , nrcep                     = :oszNrCep
                  , dtcadastro                = TO_DATE( :oszDtCadastro,'YYYYMMDDHH24MISS' )
                  , idtipoendereco            = :oszIdTipoEndereco
                  , tssincronismo             = :oszTsSincronismo
                  , dtexpiracao              = TO_DATE( decode( length( :oszDtExpiracao ),  0, NULL
                                                                      ,  8, :oszDtExpiracao || TO_CHAR(SYSDATE,'hhMIss')
                                                                      , 14, :oszDtExpiracao
                                                                      , NULL ), 'YYYYMMDDHH24MISS' )
                  , sqsincronismo             = :oszSqSincronismo
                  , iduf                      = :oszIdUf
                  , dsaoscuidados             = :oszDsAosCuidados
                  , cdcaixapostal             = :oszCdCaixaPostal
                  , idusuarioalteracao        = :oszIdUsuarioAlteracao
                  , dtultimaalteracao         = SYSDATE
              WHERE idpessoaendereco          = TO_NUMBER( :oszIdPessoaEndereco );

    ULOGI("Finalizando proCAtualizaPessoaEndereco <OK>");
    ULOG_END("CPessoaEnderecopc::proCAtualizaPessoaEndereco");
    return;

    erro:
        ULOGE("Finalizando proCAtualizaPessoaEndereco <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

/****************************************************************************************/
void CPessoaEnderecopc::proCAtualizaIdTipoEndereco(TPessoaEndereco* ptPessoaEndereco)
{
    ULOG_START("CPessoaEnderecopc::proCAtualizaIdTipoEndereco");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
        VARCHAR oszIdTipoEndereco[LEN_IDTIPOENDERECO];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;

    STRCPY_TO_ORA( oszIdPessoaEndereco  , ptPessoaEndereco->szIdPessoaEndereco   );
    STRCPY_TO_ORA( oszIdTipoEndereco    , ptPessoaEndereco->szIdTipoEndereco     );
    STRCPY_TO_ORA( oszIdUsuarioAlteracao, ptPessoaEndereco->szIdUsuarioAlteracao );

	EXEC SQL UPDATE Customer.PessoaEndereco
                SET idtipoendereco            = :oszIdTipoEndereco
                  , idusuarioalteracao        = :oszIdUsuarioAlteracao
                  , dtultimaalteracao         = SYSDATE
              WHERE idpessoaendereco          = :oszIdPessoaEndereco;

    ULOGI("Finalizando proCAtualizaIdTipoEnderecoPessoaEndereco <OK>");
    ULOG_END("CPessoaEnderecopc::proCAtualizaIdTipoEndereco");
    return;

    erro:
        ULOGE("Finalizando proCAtualizaIdTipoEnderecoPessoaEndereco <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

/****************************************************************************************/
bool CPessoaEnderecopc::proCBuscaPessoaEndereco(TPessoaEndereco* ptPessoaEndereco)
{
    ULOG_START("CPessoaEnderecopc::proCBuscaPessoaEndereco");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
        VARCHAR oszIdPessoa[LEN_IDPESSOA];
        VARCHAR oszNrSequencia[LEN_NRSEQUENCIA];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszNmMunicipio[LEN_NMMUNICIPIO];
        VARCHAR oszNmLocalidade[LEN_NMLOCALIDADE];
        VARCHAR oszNmBairro[LEN_NMBAIRRO];
        VARCHAR oszNmTipoLogradouro[LEN_NMTIPOLOGRADOURO];
        VARCHAR oszNmTituloLogradouro[LEN_NMTITULOLOGRADOURO];
        VARCHAR oszNmLogradouro[LEN_NMLOGRADOURO];
        VARCHAR oszNrEndereco[LEN_NRENDERECO];
        VARCHAR oszDsEnderecoComplemento[LEN_DSENDERECOCOMPLEMENTO];
        VARCHAR oszInEnderecoPreferencial[LEN_INENDERECOPREFERENCIAL];
        VARCHAR oszNrCep[LEN_NRCEP];
        VARCHAR oszDtCadastro[LEN_DTCADASTRO];
        VARCHAR oszIdTipoEndereco[LEN_IDTIPOENDERECO];
        VARCHAR oszTsSincronismo[LEN_TSSINCRONISMO];
        VARCHAR oszDtExpiracao[LEN_DTEXPIRACAO];
        VARCHAR oszSqSincronismo[LEN_SQSINCRONISMO];
        VARCHAR oszIdUf[LEN_IDUF];
        VARCHAR oszDsAosCuidados[LEN_DSAOSCUIDADOS];
        VARCHAR oszCdCaixaPostal[LEN_CDCAIXAPOSTAL];
        VARCHAR oszIdSistemaOrigem[LEN_IDSISTEMAORIGEM];
        VARCHAR oszIdEnderecoSistemaOrigem[LEN_IDENDERECOSISTEMAORIGEM];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
        VARCHAR oszDtUltimaAlteracao[LEN_DTULTIMAALTERACAO];

        short iIdPessoaEndereco = 0;
        short iIdPessoa = 0;
        short iNrSequencia = 0;
        short iIdPais = 0;
        short iNmMunicipio = 0;
        short iNmLocalidade = 0;
        short iNmBairro = 0;
        short iNmTipoLogradouro = 0;
        short iNmTituloLogradouro = 0;
        short iNmLogradouro = 0;
        short iNrEndereco = 0;
        short iDsEnderecoComplemento = 0;
        short iInEnderecoPreferencial = 0;
        short iNrCep = 0;
        short iDtCadastro = 0;
        short iIdTipoEndereco = 0;
        short iTsSincronismo = 0;
        short iDtExpiracao = 0;
        short iSqSincronismo = 0;
        short iIdUf = 0;
        short iDsAosCuidados = 0;
        short iCdCaixaPostal = 0;
        short iIdSistemaOrigem = 0;
        short iIdEnderecoSistemaOrigem = 0;
        short iIdUsuarioAlteracao = 0;
        short iDtUltimaAlteracao = 0;
    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;


    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND goto naoexiste;

    STRCPY_TO_ORA( oszIdEnderecoSistemaOrigem, ptPessoaEndereco->szIdEnderecoSistemaOrigem );
    STRCPY_TO_ORA( oszIdSistemaOrigem        , ptPessoaEndereco->szIdSistemaOrigem         );
    STRCPY_TO_ORA( oszIdPessoa               , ptPessoaEndereco->szIdPessoa                );

	EXEC SQL 
        SELECT
              idpessoaendereco
            , idpessoa
            , nrsequencia
            , idpais
            , nmmunicipio
            , nmlocalidade
            , nmbairro
            , nmtipologradouro
            , nmtitulologradouro
            , nmlogradouro
            , nrendereco
            , dsenderecocomplemento
            , inenderecopreferencial
            , nrcep
            , TO_CHAR( dtcadastro, 'DD/MM/YYYY' )
            , idtipoendereco
            , tssincronismo
            , TO_CHAR( dtexpiracao, 'DD/MM/YYYY' )
            , sqsincronismo
            , iduf
            , dsaoscuidados
            , cdcaixapostal
            , idsistemaorigem
            , idenderecosistemaorigem
            , idusuarioalteracao
            , TO_CHAR( dtultimaalteracao, 'DD/MM/YYYY' )
        INTO 
            :oszIdPessoaEndereco:iIdPessoaEndereco
          , :oszIdPessoa:iIdPessoa
          , :oszNrSequencia:iNrSequencia
          , :oszIdPais:iIdPais
          , :oszNmMunicipio:iNmMunicipio
          , :oszNmLocalidade:iNmLocalidade
          , :oszNmBairro:iNmBairro
          , :oszNmTipoLogradouro:iNmTipoLogradouro
          , :oszNmTituloLogradouro:iNmTituloLogradouro
          , :oszNmLogradouro:iNmLogradouro
          , :oszNrEndereco:iNrEndereco
          , :oszDsEnderecoComplemento:iDsEnderecoComplemento
          , :oszInEnderecoPreferencial:iInEnderecoPreferencial
          , :oszNrCep:iNrCep
          , :oszDtCadastro:iDtCadastro
          , :oszIdTipoEndereco:iIdTipoEndereco
          , :oszTsSincronismo:iTsSincronismo
          , :oszDtExpiracao:iDtExpiracao
          , :oszSqSincronismo:iSqSincronismo
          , :oszIdUf:iIdUf
          , :oszDsAosCuidados:iDsAosCuidados
          , :oszCdCaixaPostal:iCdCaixaPostal
          , :oszIdSistemaOrigem:iIdSistemaOrigem
          , :oszIdEnderecoSistemaOrigem:iIdEnderecoSistemaOrigem
          , :oszIdUsuarioAlteracao:iIdUsuarioAlteracao
          , :oszDtUltimaAlteracao:iDtUltimaAlteracao
        FROM
            Customer.PessoaEndereco
        WHERE 
            idpessoa                = TO_NUMBER( :oszIdPessoa )
        AND idsistemaorigem         = TO_NUMBER( :oszIdSistemaOrigem )
        AND idenderecosistemaorigem = :oszIdEnderecoSistemaOrigem
        //NVL() é mais rápido do que o OR. Cassio - Maio,2007
        //AND ((dtexpiracao is null) OR (dtexpiracao >= SYSDATE))
        AND NVL(dtexpiracao,SYSDATE) >= SYSDATE
        AND ROWNUM < 2;

	/* copia os dados obtidos para a estrutura passada como parametro */
    if(iIdPessoaEndereco != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szIdPessoaEndereco, oszIdPessoaEndereco);
    }
    if(iIdPessoa != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szIdPessoa, oszIdPessoa);
    }
    if(iNrSequencia != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNrSequencia, oszNrSequencia);
    }
    if(iIdPais != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szIdPais, oszIdPais);
    }
    if(iNmMunicipio != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNmMunicipio, oszNmMunicipio);
    }
    if(iNmLocalidade != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNmLocalidade, oszNmLocalidade);
    }
    if(iNmBairro != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNmBairro, oszNmBairro);
    }
    if(iNmTipoLogradouro != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNmTipoLogradouro, oszNmTipoLogradouro);
    }
    if(iNmTituloLogradouro != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNmTituloLogradouro, oszNmTituloLogradouro);
    }
    if(iNmLogradouro != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNmLogradouro, oszNmLogradouro);
    }
    if(iNrEndereco != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNrEndereco, oszNrEndereco);
    }
    if(iDsEnderecoComplemento != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szDsEnderecoComplemento, oszDsEnderecoComplemento);
    }
    if(iInEnderecoPreferencial != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szInEnderecoPreferencial, oszInEnderecoPreferencial);
    }
    if(iNrCep != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szNrCep, oszNrCep);
    }
    if(iDtCadastro != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szDtCadastro, oszDtCadastro);
    }
    if(iIdTipoEndereco != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szIdTipoEndereco, oszIdTipoEndereco);
    }
    if(iTsSincronismo != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szTsSincronismo, oszTsSincronismo);
    }
    if(iDtExpiracao != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szDtExpiracao, oszDtExpiracao);
    }
    if(iSqSincronismo != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szSqSincronismo, oszSqSincronismo);
    }
    if(iIdUf != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szIdUf, oszIdUf);
    }
    if(iDsAosCuidados != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szDsAosCuidados, oszDsAosCuidados);
    }
    if(iCdCaixaPostal != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szCdCaixaPostal, oszCdCaixaPostal);
    }
    if(iIdSistemaOrigem != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szIdSistemaOrigem, oszIdSistemaOrigem);
    }
    if(iIdEnderecoSistemaOrigem != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szIdEnderecoSistemaOrigem, oszIdEnderecoSistemaOrigem);
    }
    if(iIdUsuarioAlteracao != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szIdUsuarioAlteracao, oszIdUsuarioAlteracao);
    }
    if(iDtUltimaAlteracao != -1) {
        STRCPY_FROM_ORA(ptPessoaEndereco->szDtUltimaAlteracao, oszDtUltimaAlteracao);
    }

    ULOGI("Finalizando proCBuscaPessoaEndereco <FOUND>");
    ULOG_END("CPessoaEnderecopc::proCBuscaPessoaEndereco");
    return true;

    naoexiste:
        ULOGI("Finalizando proCBuscaPessoaEndereco <NOT FOUND>");
        ULOG_END("CPessoaEnderecopc::proCBuscaPessoaEndereco");
        return false;

    erro:
        ULOGE("Finalizando proCBuscaPessoaEndereco <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}

/****************************************************************************************/
bool CPessoaEnderecopc::proCBuscaPessoaEnderecoPorIdPessoa(TPessoaEnderecoArr* ptPessoaEnderecoArr, TPessoaEndereco* ptPessoaEndereco)
{
    ULOG_START("CPessoaEnderecopc::proCBuscaPessoaEnderecoPorIdPessoa");

	bool blRet;
    EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR oszIdPessoa[LEN_IDPESSOA]; 
		struct
		{
			VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
			VARCHAR oszIdPessoa[LEN_IDPESSOA];
			VARCHAR oszNrSequencia[LEN_NRSEQUENCIA];
			VARCHAR oszIdPais[LEN_IDPAIS];
			VARCHAR oszNmMunicipio[LEN_NMMUNICIPIO];
			VARCHAR oszNmLocalidade[LEN_NMLOCALIDADE];
			VARCHAR oszNmBairro[LEN_NMBAIRRO];
			VARCHAR oszNmTipoLogradouro[LEN_NMTIPOLOGRADOURO];
			VARCHAR oszNmTituloLogradouro[LEN_NMTITULOLOGRADOURO];
			VARCHAR oszNmLogradouro[LEN_NMLOGRADOURO];
			VARCHAR oszNrEndereco[LEN_NRENDERECO];
			VARCHAR oszDsEnderecoComplemento[LEN_DSENDERECOCOMPLEMENTO];
			VARCHAR oszInEnderecoPreferencial[LEN_INENDERECOPREFERENCIAL];
			VARCHAR oszNrCep[LEN_NRCEP];
			VARCHAR oszDtCadastro[LEN_DTCADASTRO];
			VARCHAR oszIdTipoEndereco[LEN_IDTIPOENDERECO];
			VARCHAR oszTsSincronismo[LEN_TSSINCRONISMO];
			VARCHAR oszDtExpiracao[LEN_DTEXPIRACAO];
			VARCHAR oszSqSincronismo[LEN_SQSINCRONISMO];
			VARCHAR oszIdUf[LEN_IDUF];
			VARCHAR oszDsAosCuidados[LEN_DSAOSCUIDADOS];
			VARCHAR oszCdCaixaPostal[LEN_CDCAIXAPOSTAL];
			VARCHAR oszIdSistemaOrigem[LEN_IDSISTEMAORIGEM];
			VARCHAR oszIdEnderecoSistemaOrigem[LEN_IDENDERECOSISTEMAORIGEM];
			VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
			VARCHAR oszDtUltimaAlteracao[LEN_DTULTIMAALTERACAO];
		} stPessoaEndereco;
		struct
		{
			short iIdPessoaEndereco;
			short iIdPessoa;
			short iNrSequencia;
			short iIdPais;
			short iNmMunicipio;
			short iNmLocalidade;
			short iNmBairro;
			short iNmTipoLogradouro;
			short iNmTituloLogradouro;
			short iNmLogradouro;
			short iNrEndereco;
			short iDsEnderecoComplemento;
			short iInEnderecoPreferencial;
			short iNrCep;
			short iDtCadastro;
			short iIdTipoEndereco;
			short iTsSincronismo;
			short iDtExpiracao;
			short iSqSincronismo;
			short iIdUf;
			short iDsAosCuidados;
			short iCdCaixaPostal;
			short iIdSistemaOrigem;
			short iIdEnderecoSistemaOrigem;
			short iIdUsuarioAlteracao;
			short iDtUltimaAlteracao;
		}stPessoaEnderecoInd;
    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND DO break;

	//Antes de mais nada zera a estrutura ptPessoaEnderecoArr
	desaloca( ptPessoaEnderecoArr );

    STRCPY_TO_ORA( oszIdPessoa, ptPessoaEndereco->szIdPessoa );

	EXEC SQL 
		DECLARE 
			CursorPorIdPessoa CURSOR FOR
		 SELECT IDPESSOAENDERECO
              , IDPESSOA
              , NRSEQUENCIA
              , IDPAIS
              , NMMUNICIPIO
              , NMLOCALIDADE
              , NMBAIRRO
              , NMTIPOLOGRADOURO
              , NMTITULOLOGRADOURO
              , NMLOGRADOURO
              , NRENDERECO
              , DSENDERECOCOMPLEMENTO
              , INENDERECOPREFERENCIAL
              , NRCEP
              , TO_CHAR( DTCADASTRO, 'DD/MM/YYYY' )
              , IDTIPOENDERECO
              , TSSINCRONISMO
              , TO_CHAR( DTEXPIRACAO, 'DD/MM/YYYY' )
              , SQSINCRONISMO
              , IDUF
              , DSAOSCUIDADOS
              , CDCAIXAPOSTAL
              , IDSISTEMAORIGEM
              , IDENDERECOSISTEMAORIGEM
              , IDUSUARIOALTERACAO
              , TO_CHAR( DTULTIMAALTERACAO, 'DD/MM/YYYY' )
           FROM CUSTOMER.PESSOAENDERECO
          WHERE IDPESSOA IN (SELECT IDPESSOAORIGEM
                               FROM CUSTOMER.PESSOADEPARA
                              WHERE IDPESSOA = TO_NUMBER(:oszIdPessoa))
            //NVL() é mais rápido do que o OR. Cassio - Maio,2007
            //AND ((DTEXPIRACAO IS NULL) OR (DTEXPIRACAO >= SYSDATE))
            AND NVL(PESSOAENDERECO.dtexpiracao,SYSDATE) >= SYSDATE
			ORDER BY PESSOAENDERECO.idtipoendereco,
            PESSOAENDERECO.nrcep,
			PESSOAENDERECO.nrendereco,
            PESSOAENDERECO.nmlogradouro,
			PESSOAENDERECO.dsenderecocomplemento,
            PESSOAENDERECO.nmtipologradouro,
			PESSOAENDERECO.nmtitulologradouro,
			PESSOAENDERECO.nmbairro,
			PESSOAENDERECO.nmmunicipio,
			PESSOAENDERECO.iduf,
			PESSOAENDERECO.idpais;

	EXEC SQL OPEN CursorPorIdPessoa;

	//Laco infinito para recuper os registros do cursor
	for(;;)
	{
		//Zera a estrutura que ira armazenar, temporariamente, registro a registro
		memset( &stPessoaEndereco, 0, sizeof( stPessoaEndereco ) );
		//Captura registro a registro
		EXEC SQL FETCH CursorPorIdPessoa INTO :stPessoaEndereco:stPessoaEnderecoInd;

		//Aloca um regitro na matriz dinamica
		aloca( ptPessoaEnderecoArr );

		/* copia os dados obtidos para a estrutura passada como parametro */
		if(stPessoaEnderecoInd.iIdPessoaEndereco != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPessoaEndereco
						  , stPessoaEndereco.oszIdPessoaEndereco);
		}
		if(stPessoaEnderecoInd.iIdPessoa != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPessoa
							, stPessoaEndereco.oszIdPessoa);
		}
		if(stPessoaEnderecoInd.iNrSequencia != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrSequencia
							, stPessoaEndereco.oszNrSequencia);
		}
		if(stPessoaEnderecoInd.iIdPais != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPais
							, stPessoaEndereco.oszIdPais);
		}
		if(stPessoaEnderecoInd.iNmMunicipio != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmMunicipio
							, stPessoaEndereco.oszNmMunicipio);
		}
		if(stPessoaEnderecoInd.iNmLocalidade != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmLocalidade
							, stPessoaEndereco.oszNmLocalidade);
		}
		if(stPessoaEnderecoInd.iNmBairro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmBairro
							, stPessoaEndereco.oszNmBairro);
		}
		if(stPessoaEnderecoInd.iNmTipoLogradouro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmTipoLogradouro
							, stPessoaEndereco.oszNmTipoLogradouro);
		}
		if(stPessoaEnderecoInd.iNmTituloLogradouro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmTituloLogradouro
							, stPessoaEndereco.oszNmTituloLogradouro);
		}
		if(stPessoaEnderecoInd.iNmLogradouro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmLogradouro
							, stPessoaEndereco.oszNmLogradouro);
		}
		if(stPessoaEnderecoInd.iNrEndereco != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrEndereco
				, stPessoaEndereco.oszNrEndereco);
		}
		if(stPessoaEnderecoInd.iDsEnderecoComplemento != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDsEnderecoComplemento
							, stPessoaEndereco.oszDsEnderecoComplemento);
		}
		if(stPessoaEnderecoInd.iInEnderecoPreferencial != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szInEnderecoPreferencial
							, stPessoaEndereco.oszInEnderecoPreferencial);
		}
		if(stPessoaEnderecoInd.iNrCep != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrCep
				, stPessoaEndereco.oszNrCep);
		}
		if(stPessoaEnderecoInd.iDtCadastro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtCadastro
							, stPessoaEndereco.oszDtCadastro);
		}
		if(stPessoaEnderecoInd.iIdTipoEndereco != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdTipoEndereco
							, stPessoaEndereco.oszIdTipoEndereco);
		}
		if(stPessoaEnderecoInd.iTsSincronismo != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szTsSincronismo
							, stPessoaEndereco.oszTsSincronismo);
		}
		if(stPessoaEnderecoInd.iDtExpiracao != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtExpiracao
							, stPessoaEndereco.oszDtExpiracao);
		}
		if(stPessoaEnderecoInd.iSqSincronismo != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szSqSincronismo
							, stPessoaEndereco.oszSqSincronismo);
		}
		if(stPessoaEnderecoInd.iIdUf != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdUf
							, stPessoaEndereco.oszIdUf);
		}
		if(stPessoaEnderecoInd.iDsAosCuidados != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDsAosCuidados
							, stPessoaEndereco.oszDsAosCuidados);
		}
		if(stPessoaEnderecoInd.iCdCaixaPostal != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szCdCaixaPostal
							, stPessoaEndereco.oszCdCaixaPostal);
		}
		if(stPessoaEnderecoInd.iIdSistemaOrigem != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdSistemaOrigem
							, stPessoaEndereco.oszIdSistemaOrigem);
		}
		if(stPessoaEnderecoInd.iIdEnderecoSistemaOrigem != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdEnderecoSistemaOrigem
							, stPessoaEndereco.oszIdEnderecoSistemaOrigem);
		}
		if(stPessoaEnderecoInd.iIdUsuarioAlteracao != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdUsuarioAlteracao
							, stPessoaEndereco.oszIdUsuarioAlteracao);
		}
		if(stPessoaEnderecoInd.iDtUltimaAlteracao != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtUltimaAlteracao
							, stPessoaEndereco.oszDtUltimaAlteracao);
		}
	}//for(;;)

	EXEC SQL CLOSE CursorPorIdPessoa;

	if( ( blRet = ( ptPessoaEnderecoArr->iQuantidade > 0 ? 1 : 0 ) ) == 1 ) {
		ULOGI("Finalizando proCBuscaPessoaEnderecoPorIdPessoa <FOUND>");
    }
	else
    {
        ULOGI("Finalizando proCBuscaPessoaEnderecoPorIdPessoa <NOT FOUND>");
    }

    ULOG_END("CPessoaEnderecopc::proCBuscaPessoaEnderecoPorIdPessoa");
	return blRet;

    erro:
        ULOGE("Finalizando proCBuscaPessoaEnderecoPorIdPessoa <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}


bool CPessoaEnderecopc::proCBuscaPessoaEnderecoContaPorIdPessoa(TPessoaEnderecoArr* ptPessoaEnderecoArr, TPessoaEndereco* ptPessoaEndereco, char* pzcIdConta)
{
    ULOG_START("CPessoaEnderecopc::proCBuscaPessoaEnderecoContaPorIdPessoa");

	bool blRet;
    EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR oszIdPessoa[LEN_IDPESSOA]; 
		char pzcIdContaAux[21+1];
		struct
		{
			VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
			VARCHAR oszIdPessoa[LEN_IDPESSOA];
			VARCHAR oszNrSequencia[LEN_NRSEQUENCIA];
			VARCHAR oszIdPais[LEN_IDPAIS];
			VARCHAR oszNmMunicipio[LEN_NMMUNICIPIO];
			VARCHAR oszNmLocalidade[LEN_NMLOCALIDADE];
			VARCHAR oszNmBairro[LEN_NMBAIRRO];
			VARCHAR oszNmTipoLogradouro[LEN_NMTIPOLOGRADOURO];
			VARCHAR oszNmTituloLogradouro[LEN_NMTITULOLOGRADOURO];
			VARCHAR oszNmLogradouro[LEN_NMLOGRADOURO];
			VARCHAR oszNrEndereco[LEN_NRENDERECO];
			VARCHAR oszDsEnderecoComplemento[LEN_DSENDERECOCOMPLEMENTO];
			VARCHAR oszInEnderecoPreferencial[LEN_INENDERECOPREFERENCIAL];
			VARCHAR oszNrCep[LEN_NRCEP];
			VARCHAR oszDtCadastro[LEN_DTCADASTRO];
			VARCHAR oszIdTipoEndereco[LEN_IDTIPOENDERECO];
			VARCHAR oszTsSincronismo[LEN_TSSINCRONISMO];
			VARCHAR oszDtExpiracao[LEN_DTEXPIRACAO];
			VARCHAR oszSqSincronismo[LEN_SQSINCRONISMO];
			VARCHAR oszIdUf[LEN_IDUF];
			VARCHAR oszDsAosCuidados[LEN_DSAOSCUIDADOS];
			VARCHAR oszCdCaixaPostal[LEN_CDCAIXAPOSTAL];
			VARCHAR oszIdSistemaOrigem[LEN_IDSISTEMAORIGEM];
			VARCHAR oszIdEnderecoSistemaOrigem[LEN_IDENDERECOSISTEMAORIGEM];
			VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
			VARCHAR oszDtUltimaAlteracao[LEN_DTULTIMAALTERACAO];
		} stPessoaEndereco;
		struct
		{
			short iIdPessoaEndereco;
			short iIdPessoa;
			short iNrSequencia;
			short iIdPais;
			short iNmMunicipio;
			short iNmLocalidade;
			short iNmBairro;
			short iNmTipoLogradouro;
			short iNmTituloLogradouro;
			short iNmLogradouro;
			short iNrEndereco;
			short iDsEnderecoComplemento;
			short iInEnderecoPreferencial;
			short iNrCep;
			short iDtCadastro;
			short iIdTipoEndereco;
			short iTsSincronismo;
			short iDtExpiracao;
			short iSqSincronismo;
			short iIdUf;
			short iDsAosCuidados;
			short iCdCaixaPostal;
			short iIdSistemaOrigem;
			short iIdEnderecoSistemaOrigem;
			short iIdUsuarioAlteracao;
			short iDtUltimaAlteracao;
		}stPessoaEnderecoInd;
    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND DO break;

	//Antes de mais nada zera a estrutura ptPessoaEnderecoArr
	desaloca( ptPessoaEnderecoArr );

    // Copia os valores chaves para as variáveis ProC.
	memset( pzcIdContaAux, 0, sizeof( pzcIdContaAux ) );
    STRCPY_TO_ORA( oszIdPessoa, ptPessoaEndereco->szIdPessoa );
	strcpy( pzcIdContaAux, pzcIdConta );


	//Cria um cursor para recuperar todos os enderecos validos de uma pessoa
	EXEC SQL 
		DECLARE  CursorPorIdPessoaConta CURSOR FOR
            SELECT 
                  PESSOAENDERECO.IDPESSOAENDERECO
                , PESSOAENDERECO.IDPESSOA
                , PESSOAENDERECO.NRSEQUENCIA
                , PESSOAENDERECO.IDPAIS
                , PESSOAENDERECO.NMMUNICIPIO
                , PESSOAENDERECO.NMLOCALIDADE
                , PESSOAENDERECO.NMBAIRRO
                , PESSOAENDERECO.NMTIPOLOGRADOURO
                , PESSOAENDERECO.NMTITULOLOGRADOURO
                , PESSOAENDERECO.NMLOGRADOURO
                , PESSOAENDERECO.NRENDERECO
                , PESSOAENDERECO.DSENDERECOCOMPLEMENTO
                , PESSOAENDERECO.INENDERECOPREFERENCIAL
                , PESSOAENDERECO.NRCEP
                , TO_CHAR( PESSOAENDERECO.DTCADASTRO, 'DD/MM/YYYY' ) AS DTCADASTRO
                , PESSOAENDERECO.IDTIPOENDERECO
                , PESSOAENDERECO.TSSINCRONISMO
                , TO_CHAR( PESSOAENDERECO.DTEXPIRACAO, 'DD/MM/YYYY' ) AS DTEXPIRACAO
                , PESSOAENDERECO.SQSINCRONISMO
                , PESSOAENDERECO.IDUF
                , PESSOAENDERECO.DSAOSCUIDADOS
                , PESSOAENDERECO.CDCAIXAPOSTAL
                , PESSOAENDERECO.IDSISTEMAORIGEM
                , PESSOAENDERECO.IDENDERECOSISTEMAORIGEM
                , PESSOAENDERECO.IDUSUARIOALTERACAO
                , TO_CHAR( PESSOAENDERECO.DTULTIMAALTERACAO, 'DD/MM/YYYY' ) AS DTULTIMAALTERACAO
            FROM
                  CUSTOMER.CONTAENDERECO  CONTAENDERECO
                , CUSTOMER.PESSOAENDERECO PESSOAENDERECO
            WHERE 
                CONTAENDERECO.IDPESSOAENDERECO = PESSOAENDERECO.IDPESSOAENDERECO
            AND PESSOAENDERECO.IDPESSOA        = :oszIdPessoa
            AND CONTAENDERECO.IDCONTA          = :pzcIdContaAux
            AND PESSOAENDERECO.DTEXPIRACAO IS NULL; 

	EXEC SQL OPEN CursorPorIdPessoaConta;

	//Laco infinito para recuper os registros do cursor
	for(;;)
	{
		//Zera a estrutura que ira armazenar, temporariamente, registro a registro
		memset( &stPessoaEndereco, 0, sizeof( stPessoaEndereco ) );
		//Captura registro a registro
		EXEC SQL FETCH CursorPorIdPessoaConta INTO :stPessoaEndereco:stPessoaEnderecoInd;

		//Aloca um regitro na matriz dinamica
		aloca( ptPessoaEnderecoArr );

		/* copia os dados obtidos para a estrutura passada como parametro */
		if(stPessoaEnderecoInd.iIdPessoaEndereco != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPessoaEndereco
						  , stPessoaEndereco.oszIdPessoaEndereco);
		}
		if(stPessoaEnderecoInd.iIdPessoa != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPessoa
							, stPessoaEndereco.oszIdPessoa);
		}
		if(stPessoaEnderecoInd.iNrSequencia != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrSequencia
							, stPessoaEndereco.oszNrSequencia);
		}
		if(stPessoaEnderecoInd.iIdPais != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPais
							, stPessoaEndereco.oszIdPais);
		}
		if(stPessoaEnderecoInd.iNmMunicipio != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmMunicipio
							, stPessoaEndereco.oszNmMunicipio);
		}
		if(stPessoaEnderecoInd.iNmLocalidade != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmLocalidade
							, stPessoaEndereco.oszNmLocalidade);
		}
		if(stPessoaEnderecoInd.iNmBairro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmBairro
							, stPessoaEndereco.oszNmBairro);
		}
		if(stPessoaEnderecoInd.iNmTipoLogradouro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmTipoLogradouro
							, stPessoaEndereco.oszNmTipoLogradouro);
		}
		if(stPessoaEnderecoInd.iNmTituloLogradouro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmTituloLogradouro
							, stPessoaEndereco.oszNmTituloLogradouro);
		}
		if(stPessoaEnderecoInd.iNmLogradouro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmLogradouro
							, stPessoaEndereco.oszNmLogradouro);
		}
		if(stPessoaEnderecoInd.iNrEndereco != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrEndereco
				, stPessoaEndereco.oszNrEndereco);
		}
		if(stPessoaEnderecoInd.iDsEnderecoComplemento != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDsEnderecoComplemento
							, stPessoaEndereco.oszDsEnderecoComplemento);
		}
		if(stPessoaEnderecoInd.iInEnderecoPreferencial != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szInEnderecoPreferencial
							, stPessoaEndereco.oszInEnderecoPreferencial);
		}
		if(stPessoaEnderecoInd.iNrCep != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrCep
				, stPessoaEndereco.oszNrCep);
		}
		if(stPessoaEnderecoInd.iDtCadastro != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtCadastro
							, stPessoaEndereco.oszDtCadastro);
		}
		if(stPessoaEnderecoInd.iIdTipoEndereco != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdTipoEndereco
							, stPessoaEndereco.oszIdTipoEndereco);
		}
		if(stPessoaEnderecoInd.iTsSincronismo != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szTsSincronismo
							, stPessoaEndereco.oszTsSincronismo);
		}
		if(stPessoaEnderecoInd.iDtExpiracao != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtExpiracao
							, stPessoaEndereco.oszDtExpiracao);
		}
		if(stPessoaEnderecoInd.iSqSincronismo != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szSqSincronismo
							, stPessoaEndereco.oszSqSincronismo);
		}
		if(stPessoaEnderecoInd.iIdUf != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdUf
							, stPessoaEndereco.oszIdUf);
		}
		if(stPessoaEnderecoInd.iDsAosCuidados != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDsAosCuidados
							, stPessoaEndereco.oszDsAosCuidados);
		}
		if(stPessoaEnderecoInd.iCdCaixaPostal != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szCdCaixaPostal
							, stPessoaEndereco.oszCdCaixaPostal);
		}
		if(stPessoaEnderecoInd.iIdSistemaOrigem != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdSistemaOrigem
							, stPessoaEndereco.oszIdSistemaOrigem);
		}
		if(stPessoaEnderecoInd.iIdEnderecoSistemaOrigem != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdEnderecoSistemaOrigem
							, stPessoaEndereco.oszIdEnderecoSistemaOrigem);
		}
		if(stPessoaEnderecoInd.iIdUsuarioAlteracao != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdUsuarioAlteracao
							, stPessoaEndereco.oszIdUsuarioAlteracao);
		}
		if(stPessoaEnderecoInd.iDtUltimaAlteracao != -1) {
			STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtUltimaAlteracao
							, stPessoaEndereco.oszDtUltimaAlteracao);
		}
	}//for(;;)

	EXEC SQL CLOSE CursorPorIdPessoaConta;

	if( ( blRet = ( ptPessoaEnderecoArr->iQuantidade > 0 ? 1 : 0 ) ) == 1 ) {
		ULOGI("Finalizando proCBuscaPessoaEnderecoContaPorIdPessoa <FOUND>");
    }
	else
    {
        ULOGI("Finalizando proCBuscaPessoaEnderecoContaPorIdPessoa <NOT FOUND>");
    }

    ULOG_END("CPessoaEnderecopc::proCBuscaPessoaEnderecoContaPorIdPessoa");
	return blRet;

    erro:
        ULOGE("Finalizando proCBuscaPessoaEnderecoContaPorIdPessoa <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}



bool CPessoaEnderecopc::proCBuscaEnderecoContaPorIdPessoa(TPessoaEnderecoArr* ptPessoaEnderecoArr, TPessoaEndereco* ptPessoaEndereco,char* pzcIdConta)
{
    ULOG_START("CPessoaEnderecopc::proCBuscaEnderecoContaPorIdPessoa");

	bool blRet;
    EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR oszIdPessoa[LEN_IDPESSOA]; 
        char pzcIdContaAux[21+1];
		struct
		{
			VARCHAR oszIdPessoaEndereco[LEN_IDPESSOAENDERECO];
			VARCHAR oszIdPessoa[LEN_IDPESSOA];
			VARCHAR oszNrSequencia[LEN_NRSEQUENCIA];
			VARCHAR oszIdPais[LEN_IDPAIS];
			VARCHAR oszNmMunicipio[LEN_NMMUNICIPIO];
			VARCHAR oszNmLocalidade[LEN_NMLOCALIDADE];
			VARCHAR oszNmBairro[LEN_NMBAIRRO];
			VARCHAR oszNmTipoLogradouro[LEN_NMTIPOLOGRADOURO];
			VARCHAR oszNmTituloLogradouro[LEN_NMTITULOLOGRADOURO];
			VARCHAR oszNmLogradouro[LEN_NMLOGRADOURO];
			VARCHAR oszNrEndereco[LEN_NRENDERECO];
			VARCHAR oszDsEnderecoComplemento[LEN_DSENDERECOCOMPLEMENTO];
			VARCHAR oszInEnderecoPreferencial[LEN_INENDERECOPREFERENCIAL];
			VARCHAR oszNrCep[LEN_NRCEP];
			VARCHAR oszDtCadastro[LEN_DTCADASTRO];
			VARCHAR oszIdTipoEndereco[LEN_IDTIPOENDERECO];
			VARCHAR oszTsSincronismo[LEN_TSSINCRONISMO];
			VARCHAR oszDtExpiracao[LEN_DTEXPIRACAO];
			VARCHAR oszSqSincronismo[LEN_SQSINCRONISMO];
			VARCHAR oszIdUf[LEN_IDUF];
			VARCHAR oszDsAosCuidados[LEN_DSAOSCUIDADOS];
			VARCHAR oszCdCaixaPostal[LEN_CDCAIXAPOSTAL];
			VARCHAR oszIdSistemaOrigem[LEN_IDSISTEMAORIGEM];
			VARCHAR oszIdEnderecoSistemaOrigem[LEN_IDENDERECOSISTEMAORIGEM];
			VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
			VARCHAR oszDtUltimaAlteracao[LEN_DTULTIMAALTERACAO];
		} stPessoaEndereco;
		struct
		{
			short iIdPessoaEndereco;
			short iIdPessoa;
			short iNrSequencia;
			short iIdPais;
			short iNmMunicipio;
			short iNmLocalidade;
			short iNmBairro;
			short iNmTipoLogradouro;
			short iNmTituloLogradouro;
			short iNmLogradouro;
			short iNrEndereco;
			short iDsEnderecoComplemento;
			short iInEnderecoPreferencial;
			short iNrCep;
			short iDtCadastro;
			short iIdTipoEndereco;
			short iTsSincronismo;
			short iDtExpiracao;
			short iSqSincronismo;
			short iIdUf;
			short iDsAosCuidados;
			short iCdCaixaPostal;
			short iIdSistemaOrigem;
			short iIdEnderecoSistemaOrigem;
			short iIdUsuarioAlteracao;
			short iDtUltimaAlteracao;
		}stPessoaEnderecoInd;

    EXEC SQL END DECLARE SECTION;

	struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR GOTO erro;
    EXEC SQL WHENEVER NOT FOUND CONTINUE;

	//Antes de mais nada zera a estrutura ptPessoaEnderecoArr
	desaloca( ptPessoaEnderecoArr );

    // Copia os valores chaves para as variáveis ProC.
    STRCPY_TO_ORA( oszIdPessoa, ptPessoaEndereco->szIdPessoa );
	strcpy( pzcIdContaAux, pzcIdConta );

	//Zera a estrutura que ira armazenar, temporariamente, registro a registro
	memset( &stPessoaEndereco, 0, sizeof( stPessoaEndereco ) );
	memset( &stPessoaEnderecoInd, -1, sizeof( stPessoaEnderecoInd ) );

	//Cria um cursor para recuperar todos os enderecos validos de uma pessoa
	EXEC SQL 
        SELECT
              IDPESSOAENDERECO
            , IDPESSOA
            , NRSEQUENCIA
            , IDPAIS
            , NMMUNICIPIO
            , NMLOCALIDADE
            , NMBAIRRO
            , NMTIPOLOGRADOURO
            , NMTITULOLOGRADOURO
            , NMLOGRADOURO
            , NRENDERECO
            , DSENDERECOCOMPLEMENTO
            , INENDERECOPREFERENCIAL
            , NRCEP
            , DTCADASTRO
            , IDTIPOENDERECO
            , TSSINCRONISMO
            , DTEXPIRACAO
            , SQSINCRONISMO
            , IDUF
            , DSAOSCUIDADOS
            , CDCAIXAPOSTAL
            , IDSISTEMAORIGEM
            , IDENDERECOSISTEMAORIGEM
            , IDUSUARIOALTERACAO
            , DTULTIMAALTERACAO
        INTO
            :stPessoaEndereco:stPessoaEnderecoInd
        FROM
            (
                SELECT
                      PESSOAENDERECO.IDPESSOAENDERECO
                    , PESSOAENDERECO.IDPESSOA
                    , PESSOAENDERECO.NRSEQUENCIA
                    , PESSOAENDERECO.IDPAIS
                    , PESSOAENDERECO.NMMUNICIPIO
                    , PESSOAENDERECO.NMLOCALIDADE
                    , PESSOAENDERECO.NMBAIRRO
                    , PESSOAENDERECO.NMTIPOLOGRADOURO
                    , PESSOAENDERECO.NMTITULOLOGRADOURO
                    , PESSOAENDERECO.NMLOGRADOURO
                    , PESSOAENDERECO.NRENDERECO
                    , PESSOAENDERECO.DSENDERECOCOMPLEMENTO
                    , PESSOAENDERECO.INENDERECOPREFERENCIAL
                    , PESSOAENDERECO.NRCEP
                    , TO_CHAR( PESSOAENDERECO.DTCADASTRO, 'DD/MM/YYYY' ) AS DTCADASTRO
                    , PESSOAENDERECO.IDTIPOENDERECO
                    , PESSOAENDERECO.TSSINCRONISMO
                    , TO_CHAR( PESSOAENDERECO.DTEXPIRACAO, 'DD/MM/YYYY' ) AS DTEXPIRACAO
                    , PESSOAENDERECO.SQSINCRONISMO
                    , PESSOAENDERECO.IDUF
                    , PESSOAENDERECO.DSAOSCUIDADOS
                    , PESSOAENDERECO.CDCAIXAPOSTAL
                    , PESSOAENDERECO.IDSISTEMAORIGEM
                    , PESSOAENDERECO.IDENDERECOSISTEMAORIGEM
                    , PESSOAENDERECO.IDUSUARIOALTERACAO
                    , TO_CHAR( PESSOAENDERECO.DTULTIMAALTERACAO, 'DD/MM/YYYY' ) AS DTULTIMAALTERACAO
                FROM
                    CUSTOMER.PESSOADEPARA PESSOADEPARA,
                    CUSTOMER.PESSOACONTA PESSOACONTA,
                    CUSTOMER.CONTAENDERECO CONTAENDERECO,
                    CUSTOMER.PESSOAENDERECO PESSOAENDERECO
                WHERE
                    PESSOADEPARA.IDPESSOA = :oszIdPessoa
                AND PESSOACONTA.IDPESSOADEPARA = PESSOADEPARA.IDPESSOADEPARA
                AND PESSOACONTA.IDCONTA = CONTAENDERECO.IDCONTA
                AND CONTAENDERECO.IDPESSOAENDERECO = PESSOAENDERECO.IDPESSOAENDERECO
                AND CONTAENDERECO.IDCONTA = :pzcIdContaAux
                AND NVL(CONTAENDERECO.DTEXPIRACAO,SYSDATE) >= SYSDATE
                AND NVL(PESSOAENDERECO.DTEXPIRACAO,SYSDATE) >= SYSDATE
                AND NVL(PESSOACONTA.DTEXPIRACAO,SYSDATE) >= SYSDATE
			    ORDER BY PESSOACONTA.DTULTIMAALTERACAO DESC
            )
            WHERE ROWNUM < 2;

    if ( 0 == sqlca.sqlcode )
    {
	    //Aloca um regitro na matriz dinamica
	    aloca( ptPessoaEnderecoArr );

	    /* copia os dados obtidos para a estrutura passada como parametro */
	    if(stPessoaEnderecoInd.iIdPessoaEndereco != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPessoaEndereco
					      , stPessoaEndereco.oszIdPessoaEndereco);
	    }
	    if(stPessoaEnderecoInd.iIdPessoa != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPessoa
						    , stPessoaEndereco.oszIdPessoa);
	    }
	    if(stPessoaEnderecoInd.iNrSequencia != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrSequencia
						    , stPessoaEndereco.oszNrSequencia);
	    }
	    if(stPessoaEnderecoInd.iIdPais != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdPais
						    , stPessoaEndereco.oszIdPais);
	    }
	    if(stPessoaEnderecoInd.iNmMunicipio != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmMunicipio
						    , stPessoaEndereco.oszNmMunicipio);
	    }
	    if(stPessoaEnderecoInd.iNmLocalidade != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmLocalidade
						    , stPessoaEndereco.oszNmLocalidade);
	    }
	    if(stPessoaEnderecoInd.iNmBairro != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmBairro
						    , stPessoaEndereco.oszNmBairro);
	    }
	    if(stPessoaEnderecoInd.iNmTipoLogradouro != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmTipoLogradouro
						    , stPessoaEndereco.oszNmTipoLogradouro);
	    }
	    if(stPessoaEnderecoInd.iNmTituloLogradouro != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmTituloLogradouro
						    , stPessoaEndereco.oszNmTituloLogradouro);
	    }
	    if(stPessoaEnderecoInd.iNmLogradouro != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNmLogradouro
						    , stPessoaEndereco.oszNmLogradouro);
	    }
	    if(stPessoaEnderecoInd.iNrEndereco != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrEndereco
			    , stPessoaEndereco.oszNrEndereco);
	    }
	    if(stPessoaEnderecoInd.iDsEnderecoComplemento != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDsEnderecoComplemento
						    , stPessoaEndereco.oszDsEnderecoComplemento);
	    }
	    if(stPessoaEnderecoInd.iInEnderecoPreferencial != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szInEnderecoPreferencial
						    , stPessoaEndereco.oszInEnderecoPreferencial);
	    }
	    if(stPessoaEnderecoInd.iNrCep != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szNrCep
			    , stPessoaEndereco.oszNrCep);
	    }
	    if(stPessoaEnderecoInd.iDtCadastro != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtCadastro
						    , stPessoaEndereco.oszDtCadastro);
	    }
	    if(stPessoaEnderecoInd.iIdTipoEndereco != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdTipoEndereco
						    , stPessoaEndereco.oszIdTipoEndereco);
	    }
	    if(stPessoaEnderecoInd.iTsSincronismo != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szTsSincronismo
						    , stPessoaEndereco.oszTsSincronismo);
	    }
	    if(stPessoaEnderecoInd.iDtExpiracao != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtExpiracao
						    , stPessoaEndereco.oszDtExpiracao);
	    }
	    if(stPessoaEnderecoInd.iSqSincronismo != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szSqSincronismo
						    , stPessoaEndereco.oszSqSincronismo);
	    }
	    if(stPessoaEnderecoInd.iIdUf != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdUf
						    , stPessoaEndereco.oszIdUf);
	    }
	    if(stPessoaEnderecoInd.iDsAosCuidados != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDsAosCuidados
						    , stPessoaEndereco.oszDsAosCuidados);
	    }
	    if(stPessoaEnderecoInd.iCdCaixaPostal != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szCdCaixaPostal
						    , stPessoaEndereco.oszCdCaixaPostal);
	    }
	    if(stPessoaEnderecoInd.iIdSistemaOrigem != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdSistemaOrigem
						    , stPessoaEndereco.oszIdSistemaOrigem);
	    }
	    if(stPessoaEnderecoInd.iIdEnderecoSistemaOrigem != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdEnderecoSistemaOrigem
						    , stPessoaEndereco.oszIdEnderecoSistemaOrigem);
	    }
	    if(stPessoaEnderecoInd.iIdUsuarioAlteracao != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szIdUsuarioAlteracao
						    , stPessoaEndereco.oszIdUsuarioAlteracao);
	    }
	    if(stPessoaEnderecoInd.iDtUltimaAlteracao != -1) {
		    STRCPY_FROM_ORA(ptPessoaEnderecoArr->pztPessoaEndereco[ptPessoaEnderecoArr->iQuantidade-1].szDtUltimaAlteracao
						    , stPessoaEndereco.oszDtUltimaAlteracao);
	    }
    } // if ( 0 == sqlca.sqlcode )

	if( ( blRet = ( ptPessoaEnderecoArr->iQuantidade > 0 ? 1 : 0 ) ) == 1 ) {
		ULOGI("Finalizando proCBuscaEnderecoContaPorIdPessoa <FOUND>");
    }
	else
    {
        ULOGI("Finalizando proCBuscaEnderecoContaPorIdPessoa <NOT FOUND>");
    }

    ULOG_END("CPessoaEnderecopc::proCBuscaEnderecoContaPorIdPessoa");
	return blRet;

    erro:
        ULOGE("Finalizando proCBuscaEnderecoContaPorIdPessoa <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}

///////////////////////////////////////////////////////////////////////////////
// Métodos para manipular o tipo TPessoaEnderecoArr
///////////////////////////////////////////////////////////////////////////////
void CPessoaEnderecopc::desaloca( TPessoaEnderecoArr* pztPessoaEnderecoArrAux )
{
	if( pztPessoaEnderecoArrAux != NULL )
	{
		if( pztPessoaEnderecoArrAux->iQuantidade > 0 )
		{
			free( pztPessoaEnderecoArrAux->pztPessoaEndereco );
			pztPessoaEnderecoArrAux->pztPessoaEndereco = 0;
		}

		pztPessoaEnderecoArrAux->iQuantidade = 0;
	}
}

void CPessoaEnderecopc::aloca( TPessoaEnderecoArr* pztPessoaEnderecoArrAux )
{
	pztPessoaEnderecoArrAux->iQuantidade++;
	pztPessoaEnderecoArrAux->pztPessoaEndereco = (TPessoaEndereco*) realloc( pztPessoaEnderecoArrAux->pztPessoaEndereco, sizeof(TPessoaEndereco)*pztPessoaEnderecoArrAux->iQuantidade );
	memset( &pztPessoaEnderecoArrAux->pztPessoaEndereco[pztPessoaEnderecoArrAux->iQuantidade-1], 0, sizeof(TPessoaEndereco) );
}



bool CPessoaEnderecopc::buscaInfSPED( 
                                    char * szcdCEP, 
                                    char * sznmLogradouro,
                                    char * sznmBairro,
                                    char * szMunicipio,
                                    char * szCdLogradouro ,
                                    char * szInCNL ,
                                    char * szCdIBGE
                                  )
{
    ULOG_START("CPessoaEnderecopc::buscaInfSPED()");
    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszcdCEP[11];
        VARCHAR osznmLogradouro[61];
        VARCHAR osznmBairro[51];
        VARCHAR oszMunicipio[51];

        VARCHAR oszcdLogradouro[40];
        VARCHAR oszInCNL[9];
        VARCHAR oszcdIBGE[8];
        short i_oszcdLogradouro = -1;
        short i_oszInCNL = -1;
        short i_oszcdIBGE = -1;
        short st_cep = -1;
        short st_nmLograd = -1;
        short st_nmBairro = -1;
        short st_nmCidade = -1;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND goto naoexiste;
    
    memset( &oszcdLogradouro,0x0,sizeof(oszcdLogradouro));
    memset( &oszInCNL,0x0,sizeof(oszInCNL));
    memset( &oszcdIBGE,0x0,sizeof(oszcdIBGE));

    //memset( oszcdCEP, 0x00, sizeof(oszcdCEP) );
    //memset( osznmLogradouro, 0x00, sizeof(osznmLogradouro) );
    //memset( osznmBairro, 0x00, sizeof(osznmBairro) );
    //memset( oszMunicipio, 0x00, sizeof(oszMunicipio) );
    
    ULOG( "szcdCEP [%s], sznmLogradouro [%s], sznmBairro [%s], szMunicipio [%s]", szcdCEP, sznmLogradouro, sznmBairro, szMunicipio );

    if ( szcdCEP[0] != NULL )
    {
        st_cep = 0;
    }
    if ( sznmLogradouro[0] != NULL )
    {
        st_nmLograd = 0;
    }
    if ( sznmBairro[0] != NULL )
    {
        st_nmBairro = 0;
    }
    if ( szMunicipio[0] != NULL )
    {
        st_nmCidade = 0;
    }
    
    strToOra( oszcdCEP, szcdCEP );
    ULOG( "str [%s] len[%d]",(char*)oszcdCEP.arr,oszcdCEP.len );
    
    strToOra( osznmLogradouro, sznmLogradouro );
    ULOG( "str [%s] len[%d]",(char*)osznmLogradouro.arr,osznmLogradouro.len );

    strToOra( osznmBairro, sznmBairro );
    ULOG( "str [%s] len[%d]",(char*)osznmBairro.arr,osznmBairro.len );

    strToOra( oszMunicipio, szMunicipio );
    ULOG( "str [%s] len[%d]",(char*)oszMunicipio.arr,oszMunicipio.len );

    /*
    EXEC SQL
    SELECT 
        CDLOGRADOURO,
        INCNL,
        CDIBGE
    INTO
        :oszcdLogradouro:i_oszcdLogradouro ,
        :oszInCNL:i_oszInCNL ,
        :oszcdIBGE:i_oszcdIBGE 
    FROM 
        ENDERECO.DE_ENDERECO_PARA_APOIOV01
    WHERE
        (CODCEP = :oszcdCEP)
    AND
        (NOMLOGRADOURO = UPPER( :osznmLogradouro ) OR -1 = :st_nmLograd)
    AND
        (NOMBAIRRO = UPPER( :osznmBairro ) OR -1 = :st_nmBairro)
    AND
        (DSCLOCALIDADE = UPPER( :oszMunicipio ) OR -1 = :st_nmCidade)
    AND
        ROWNUM < 2;        
        */
    
    EXEC SQL
    SELECT 
        CDLOGRADOURO,
        INCNL,
        CDIBGE
    INTO
        :oszcdLogradouro:i_oszcdLogradouro ,
        :oszInCNL:i_oszInCNL ,
        :oszcdIBGE:i_oszcdIBGE 
    FROM 
        ENDERECO.DE_ENDERECO_PARA_APOIOV01
    WHERE
        (CODCEP = :oszcdCEP)
    AND
        ROWNUM < 2;        



    ULOG( "Passou..." );
    
    if ( i_oszcdLogradouro != -1 ) 
    	oszcdLogradouro.arr[oszcdLogradouro.len] = 0x0;
    if ( i_oszInCNL != -1 ) 
        oszInCNL.arr[oszInCNL.len] = 0x0;
    if ( i_oszcdIBGE != -1 ) 
        oszcdIBGE.arr[oszcdIBGE.len] = 0x0;
    
    if ( i_oszcdLogradouro != -1 ) 
	    STRCPY_FROM_ORA( szCdLogradouro, oszcdLogradouro );
    if ( i_oszInCNL != -1 ) 
	    STRCPY_FROM_ORA( szInCNL, oszInCNL );
    if ( i_oszcdIBGE != -1 ) 
	    STRCPY_FROM_ORA( szCdIBGE, oszcdIBGE );
    
    ULOG( "szCdLogradouro [%s], szInCNL [%s], szCdIBGE [%s]", szCdLogradouro, szInCNL, szCdIBGE );

    ULOG_END("CPessoaEnderecopc::buscaInfSPED() <FOUND>");

    return true;

    erro:
        ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
        ULOG_END("CPessoaEnderecopc::buscaInfSPED()");
        //throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
        return false;

    naoexiste:
        ULOG("Registro nao encontrado");
        ULOG_END("CPessoaEnderecopc::buscaInfSPED() <NOT FOUND>");
        return false;
}
