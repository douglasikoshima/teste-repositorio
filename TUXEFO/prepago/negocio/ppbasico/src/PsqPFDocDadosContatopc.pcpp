///////////////////////////////////////////////////////////////////////////////
/**
 * @modulo  PrePago
 * @usecase Pesquisa Dados de Pessoa Fisica Por Documento
 * @version $Revision: 1.1 $
 * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:33:23 $
 **/
///////////////////////////////////////////////////////////////////////////////

#undef SQLCA
#define SQLCA_NONE
#include<sqlca.h>
#include<sqlda.h>

#include <tuxfw.h>

EXEC SQL BEGIN DECLARE SECTION;
#include <Global.h>
#include "../include/PsqPFDocDdsCttpc.h"
EXEC SQL END DECLARE SECTION;

/************************************************************************************/
bool proCBuscarPFContato(const char *ptIdPessoa,
                         DadosPFContato *ptDadosPFContato,
                         StatusPFContato *ptStatusPFContato,
                         XMLGen *xml_g)
{
    ULOG_START("proCBuscarPFContato");

    EXEC SQL BEGIN DECLARE SECTION;
        const char *ptSqlIdPessoa = ptIdPessoa;
        struct DadosPFContato *ptSqlDadosPFContato = ptDadosPFContato;
        struct StatusPFContato *ptSqlStatusPFContato = ptStatusPFContato;
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND goto naoexiste;

    EXEC SQL
        SELECT
            PESSOACOMUNICACAO.IDPESSOACOMUNICACAO,
            PESSOACOMUNICACAO.DSCONTATO,
            PESSOACOMUNICACAO.NMCONTATO,
            TIPOCOMUNICACAO.IDTIPOCOMUNICACAO,
            TIPOCOMUNICACAO.SGTIPOCOMUNICACAO,
            TIPOCOMUNICACAO.DSTIPOCOMUNICACAO,
            TIPOCOMUNICACAO.IDFORMARETORNO,
            TO_CHAR(MAX(PESSOACOMUNICACAO.DTCADASTRO),'DD/MM/YYYY') AS DTCADASTRO
        INTO
            :ptSqlDadosPFContato:ptSqlStatusPFContato
        FROM
            CUSTOMER.PESSOACOMUNICACAO PESSOACOMUNICACAO,
            APOIO.TIPOCOMUNICACAO TIPOCOMUNICACAO 
        WHERE
            PESSOACOMUNICACAO.IDPESSOA IN (SELECT PESSOADEPARA.IDPESSOAORIGEM 
                                             FROM CUSTOMER.PESSOADEPARA 
                                            WHERE PESSOADEPARA.IDPESSOA = :ptSqlIdPessoa)
        AND NVL(PESSOACOMUNICACAO.DTEXPIRACAO,SYSDATE) >= SYSDATE
        // AND NVL(PESSOACOMUNICACAO.INCOMUNICACAOPREFERENCIAL,1) = 1
        AND PESSOACOMUNICACAO.IDTIPOCOMUNICACAO = TIPOCOMUNICACAO.IDTIPOCOMUNICACAO
        AND TIPOCOMUNICACAO.SGCLASSIFICACAO = 'TELEFONE'
        GROUP BY
            PESSOACOMUNICACAO.IDPESSOACOMUNICACAO,
            PESSOACOMUNICACAO.DSCONTATO,
            PESSOACOMUNICACAO.NMCONTATO,
            TIPOCOMUNICACAO.IDTIPOCOMUNICACAO,
            TIPOCOMUNICACAO.SGTIPOCOMUNICACAO,
            TIPOCOMUNICACAO.DSTIPOCOMUNICACAO,
            TIPOCOMUNICACAO.IDFORMARETORNO;

	    xml_g->createTag("Contato");
	        xml_g->createTag("ListCont");
		        xml_g->addItem("idContato", ptSqlDadosPFContato->oszIDPESSOACOMUNICACAO);
		        xml_g->addItem("idTipoContatoSelecionado", ptSqlDadosPFContato->oszIDTIPOCOMUNICACAO);
		        xml_g->addItem("dsContato", ptSqlDadosPFContato->oszDSCONTATO);
		        xml_g->addItem("nmContato", ptSqlDadosPFContato->oszNMCONTATO);
		        xml_g->addItem("sgContato", ptSqlDadosPFContato->oszSGTIPOCOMUNICACAO);
	        xml_g->closeTag();
	    xml_g->closeTag();

    ULOGI("Finalizando proCBuscarPFContato <FOUND>");
    ULOG_END("proCBuscarPFContato");
    return true;

    naoexiste:
        ULOGI("Finalizando proCBuscarPFContato <NOT FOUND>");
        ULOG_END("proCBuscarPFContato");
        return false;

    erro:
        ULOGE("Finalizando proCBuscarPFContato <ERROR>");
        ULOGE("sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}
