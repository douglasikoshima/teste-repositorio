///////////////////////////////////////////////////////////////////////////////
/**
 * @modulo  Sincronismo
 * @usecase PessoaFisica
 * @author  Renato Striitzel Russo
 * @author  Carlos Eduardo Barbosa Braga
 * @version $Revision: 1.1 $
 * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:33:22 $
 **/
///////////////////////////////////////////////////////////////////////////////

#undef SQLCA
#define SQLCA_NONE
#include<sqlca.h>
#include<sqlda.h>

#include "tuxfw.h"
#include "PessoaFisicapc.h"
#include <memory.h>

EXEC SQL BEGIN DECLARE SECTION;
#include "Global.h"
EXEC SQL END DECLARE SECTION;

/************************************************************************************/
void CPessoaFisicapc::proCInserePessoaFisica(TPessoaFisica *ptPessoaFisica)
{
    ULOG_START("CPessoaFisicapc::proCInserePessoaFisica");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoa[LEN_IDPESSOA];
        VARCHAR oszDtNascimento[LEN_DTNASCIMENTO];
        VARCHAR oszNmMae[LEN_NMMAE];
        VARCHAR oszNmPai[LEN_NMPAI];
        VARCHAR oszIdTratamento[LEN_IDTRATAMENTO];
        VARCHAR oszIdEstadoCivil[LEN_IDESTADOCIVIL];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszIdSexo[LEN_IDSEXO];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    STRCPY_TO_ORA(oszIdPessoa, ptPessoaFisica->szIdPessoa);
    STRCPY_TO_ORA(oszDtNascimento, ptPessoaFisica->szDtNascimento);
    STRCPY_TO_ORA(oszNmMae, ptPessoaFisica->szNmMae);
    STRCPY_TO_ORA(oszNmPai, ptPessoaFisica->szNmPai);
    STRCPY_TO_ORA(oszIdTratamento, ptPessoaFisica->szIdTratamento);
    STRCPY_TO_ORA(oszIdEstadoCivil, ptPessoaFisica->szIdEstadoCivil);
    STRCPY_TO_ORA(oszIdPais, ptPessoaFisica->szIdPais);
    STRCPY_TO_ORA(oszIdSexo, ptPessoaFisica->szIdSexo);
    STRCPY_TO_ORA(oszIdUsuarioAlteracao, ptPessoaFisica->szIdUsuarioAlteracao);

    EXEC SQL WHENEVER SQLERROR goto erro;

    EXEC SQL INSERT INTO Customer.PessoaFisica
                       ( idpessoa
                       , dtnascimento
                       , nmmae
                       , nmpai
                       , idtratamento
                       , idestadocivil
                       , idpais
                       , idsexo
                       , idusuarioalteracao
                       , dtultimaalteracao ) 
                VALUES ( :oszIdPessoa
                       , to_date(:oszDtNascimento, 'YYYYMMDDHH24MISS')
                       , :oszNmMae
                       , :oszNmPai
                       , :oszIdTratamento
                       , :oszIdEstadoCivil
                       , :oszIdPais
                       , :oszIdSexo
                       , :oszIdUsuarioAlteracao
                       , SYSDATE );

    ULOGI("Finalizando proCInserePessoaFisica <OK>");
    ULOG_END("CPessoaFisicapc::proCInserePessoaFisica");
    return;

    erro:
        ULOGE("Finalizando proCInserePessoaFisica <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

/************************************************************************************/
void CPessoaFisicapc::proCAtualizaPessoaFisica(TPessoaFisica tPessoaFisica)
{
    ULOG_START("CPessoaFisicapc::proCAtualizaPessoaFisica");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoa[LEN_IDPESSOA];
        VARCHAR oszDtNascimento[LEN_DTNASCIMENTO];
        VARCHAR oszNmMae[LEN_NMMAE];
        VARCHAR oszNmPai[LEN_NMPAI];
        VARCHAR oszIdTratamento[LEN_IDTRATAMENTO];
        VARCHAR oszIdEstadoCivil[LEN_IDESTADOCIVIL];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszIdSexo[LEN_IDSEXO];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    STRCPY_TO_ORA(oszIdPessoa, tPessoaFisica.szIdPessoa);
    STRCPY_TO_ORA(oszDtNascimento, tPessoaFisica.szDtNascimento);
    STRCPY_TO_ORA(oszNmMae, tPessoaFisica.szNmMae);
    STRCPY_TO_ORA(oszNmPai, tPessoaFisica.szNmPai);
    STRCPY_TO_ORA(oszIdTratamento, tPessoaFisica.szIdTratamento);
    STRCPY_TO_ORA(oszIdEstadoCivil, tPessoaFisica.szIdEstadoCivil);
    STRCPY_TO_ORA(oszIdPais, tPessoaFisica.szIdPais);
    STRCPY_TO_ORA(oszIdSexo, tPessoaFisica.szIdSexo);
    STRCPY_TO_ORA(oszIdUsuarioAlteracao, tPessoaFisica.szIdUsuarioAlteracao);

    EXEC SQL WHENEVER SQLERROR goto erro;

    EXEC SQL UPDATE Customer.PessoaFisica
                SET idpessoa            = :oszIdPessoa
                  , dtnascimento        = TO_DATE(:oszDtNascimento, 'YYYYMMDDHH24MISS')
                  , nmmae               = :oszNmMae
                  , nmpai               = :oszNmPai
                  , idtratamento        = :oszIdTratamento
                  , idestadocivil       = :oszIdEstadoCivil
                  , idpais              = :oszIdPais
                  , idsexo              = :oszIdSexo
                  , idusuarioalteracao  = :oszIdUsuarioAlteracao
                  , dtultimaalteracao   = SYSDATE
              WHERE idpessoa            = :oszIdPessoa;

    ULOGI("Finalizando proCAtualizaPessoaFisica <OK>");
    ULOG_END("CPessoaFisicapc::proCAtualizaPessoaFisica");
    return;

    erro:
        ULOGE("Finalizando proCAtualizaPessoaFisica <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

/************************************************************************************/
bool CPessoaFisicapc::proCBuscaPessoaFisica(TPessoaFisica *ptPessoaFisica)
{
    ULOG_START("CPessoaFisicapc::proCBuscaPessoaFisica");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoa[LEN_IDPESSOA];
        VARCHAR oszDtNascimento[LEN_DTNASCIMENTO];
        VARCHAR oszNmMae[LEN_NMMAE];
        VARCHAR oszNmPai[LEN_NMPAI];
        VARCHAR oszIdTratamento[LEN_IDTRATAMENTO];
        VARCHAR oszIdEstadoCivil[LEN_IDESTADOCIVIL];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszIdSexo[LEN_IDSEXO];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
        VARCHAR oszDtUltimaAlteracao[LEN_DTULTIMAALTERACAO];

        short iIdPessoa = 0;
        short iDtNascimento = 0;
        short iNmMae = 0;
        short iNmPai = 0;
        short iIdTratamento = 0;
        short iIdEstadoCivil = 0;
        short iIdPais = 0;
        short iIdSexo = 0;
        short iIdUsuarioAlteracao = 0;
        short iDtUltimaAlteracao = 0;
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND goto naoexiste;

    STRCPY_TO_ORA(oszIdPessoa, ptPessoaFisica->szIdPessoa);

    EXEC SQL SELECT TO_CHAR( idpessoa )
                  , TO_CHAR( dtnascimento, 'DD/MM/YYYY' )
                  , TO_CHAR( nmmae              )
                  , TO_CHAR( nmpai              )
                  , TO_CHAR( idtratamento       )
                  , TO_CHAR( idestadocivil      )
                  , TO_CHAR( idpais             )
                  , TO_CHAR( idsexo             )
                  , TO_CHAR( idusuarioalteracao )
                  , TO_CHAR( dtultimaalteracao  , 'DD/MM/YYYY' )
               INTO :oszIdPessoa:iIdPessoa
                  , :oszDtNascimento:iDtNascimento
                  , :oszNmMae:iNmMae
                  , :oszNmPai:iNmPai
                  , :oszIdTratamento:iIdTratamento
                  , :oszIdEstadoCivil:iIdEstadoCivil
                  , :oszIdPais:iIdPais
                  , :oszIdSexo:iIdSexo
                  , :oszIdUsuarioAlteracao:iIdUsuarioAlteracao
                  , :oszDtUltimaAlteracao:iDtUltimaAlteracao
               FROM Customer.PessoaFisica
              WHERE idPessoa = TO_NUMBER(:oszIdPessoa);

    if(iIdPessoa != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szIdPessoa, oszIdPessoa);
    }
    if(iDtNascimento != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szDtNascimento, oszDtNascimento);
    }
    if(iNmMae != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szNmMae, oszNmMae);
    }
    if(iNmPai != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szNmPai, oszNmPai);
    }
    if(iIdTratamento != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szIdTratamento, oszIdTratamento);
    }
    if(iIdEstadoCivil != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szIdEstadoCivil, oszIdEstadoCivil);
    }
    if(iIdPais != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szIdPais, oszIdPais);
    }
    if(iIdSexo != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szIdSexo, oszIdSexo);
    }
    if(iIdUsuarioAlteracao != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szIdUsuarioAlteracao, oszIdUsuarioAlteracao);
    }
    if(iDtUltimaAlteracao != -1) {
        STRCPY_FROM_ORA(ptPessoaFisica->szDtUltimaAlteracao, oszDtUltimaAlteracao);
    }

    ULOGI("Finalizando proCBuscaPessoaFisica <FOUND>");
    ULOG_END("CPessoaFisicapc::proCBuscaPessoaFisica");
    return true;

    naoexiste:
        ULOGI("Finalizando proCBuscaPessoaFisica <NOT FOUND>");
        ULOG_END("CPessoaFisicapc::proCBuscaPessoaFisica");
        return false;

    erro:
        ULOGE("Finalizando proCBuscaPessoaFisica <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}
