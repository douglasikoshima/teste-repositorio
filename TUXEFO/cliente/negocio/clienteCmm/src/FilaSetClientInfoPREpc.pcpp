///////////////////////////////////////////////////////////////////////////////
/**
 * @modulo  Prepago
 * @usecase FilaSetClientInfo
 * @author  Renato Striitzel Russo
 * @author  Carlos Eduardo Barbosa Braga
 * @version $Revision: 1.1.130.1 $
 * @CVS     $Author: a5114878 $ - $Date: 2013/09/04 20:26:06 $
 **/
///////////////////////////////////////////////////////////////////////////////

#undef SQLCA
#define SQLCA_NONE
#include <sqlca.h>
#include <sqlda.h>

#include <memory.h>

#include <tuxfw.h>
#include "../include/Global.h"
#include "../include/FilaSetClientInfoPREpc.h"

EXEC SQL BEGIN DECLARE SECTION;
#include "../include/Global.h"
EXEC SQL END DECLARE SECTION;

/****************************************************************************************/
bool CFilaSetClientInfopc::proCExisteFilaSetClientInfo(TFilaSetClientInfoPRE tFilaSetClientInfo)
{
    ULOG_START("CFilaSetClientInfopc::proCExisteFilaSetClientInfo");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA];
        int iCount;
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;


    /* atribui valores para as variaveis ProC */
    STRCPY_TO_ORA(oszIdLinhaTelefonica, tFilaSetClientInfo.szIdLinhaTelefonica);

    EXEC SQL
        SELECT
            COUNT(1)
        INTO
            :iCount
        FROM
            infra.filasetclientinfo
        WHERE
            idlinhatelefonica = :oszIdLinhaTelefonica;


    ULOG("iCount(%d)", iCount);
    ULOG_END("CFilaSetClientInfopc::proCExisteFilaSetClientInfo");

    if(iCount > 0)
        return true;
     else
        return false;

    erro:
        ULOGE("Finalizando proCExisteFilaSetClientInfo <ERROR>");
        throw TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}

/****************************************************************************************/
void CFilaSetClientInfopc::proCIncluiFilaSetClientInfo(TFilaSetClientInfoPRE *ptFilaSetClientInfo)
{
    ULOG_START("CFilaSetClientInfopc::proCIncluiFilaSetClientInfo");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA];
        VARCHAR oszIdFilaSetClientInfo[LEN_IDFILASETCLIENTINFO];
        VARCHAR oszXml1[LEN_XML];
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;

    /* obtem sequence */
    EXEC SQL SELECT infra.filasetclientinfosq.nextval
               INTO :oszIdFilaSetClientInfo
               FROM DUAL;

    STRCPY_FROM_ORA(ptFilaSetClientInfo->szIdFilaSetClientInfo, oszIdFilaSetClientInfo);
    STRCPY_TO_ORA(oszIdLinhaTelefonica, ptFilaSetClientInfo->szIdLinhaTelefonica);
    STRCPY_TO_ORA(oszXml1, ptFilaSetClientInfo->szXml);


    EXEC SQL INSERT INTO infra.filasetclientinfo
        (
            idfilasetclientinfo,
            idlinhatelefonica,
            dttimestamp,
            xml1
        )
        VALUES
        (
            :oszIdFilaSetClientInfo,
            :oszIdLinhaTelefonica,
            SYSDATE,
            :oszXml1
        );


    ULOGI("Finalizando proCIncluiFilaSetClientInfo <OK>");
    ULOG_END("CFilaSetClientInfopc::proCIncluiFilaSetClientInfo");
    return;

    erro:
        ULOGE("Finalizando proCIncluiFilaSetClientInfo <ERROR>");
        throw TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}

/****************************************************************************************/
void CFilaSetClientInfopc::proCAtualizaXmlFilaSetClientInfo(TFilaSetClientInfoPRE tFilaSetClientInfo)
{
    ULOG_START("CFilaSetClientInfopc::proCAtualizaXmlFilaSetClientInfo");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA];
        VARCHAR oszXml1[LEN_XML];
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;


    /* atribui valores para as variaveis ProC */
    STRCPY_TO_ORA(oszIdLinhaTelefonica, tFilaSetClientInfo.szIdLinhaTelefonica);
    STRCPY_TO_ORA(oszXml1, tFilaSetClientInfo.szXml);

    EXEC SQL UPDATE infra.filasetclientinfo
        SET
            dttimestamp = SYSDATE,
            cderro = NULL,
            dserro = NULL,
            dterro = NULL,
            xml1 = :oszXml1
        WHERE
            idlinhatelefonica = :oszIdLinhaTelefonica;


    ULOGI("Finalizando proCAtualizaXmlFilaSetClientInfo <OK>");
    ULOG_END("CFilaSetClientInfopc::proCAtualizaXmlFilaSetClientInfo");
    return;

    erro:
        ULOGE("Finalizando proCAtualizaXmlFilaSetClientInfo <ERROR>");
        throw TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}



/****************************************************************************************/
// RECADASTRAMENTO
void CFilaSetClientInfopc::proCIncluiFilaSetClientInfo_4(TFilaSetClientInfoPRE *ptFilaSetClientInfo)
{
    ULOG_START("CFilaSetClientInfopc::proCIncluiFilaSetClientInfo_4");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA];
        VARCHAR oszIdFilaSetClientInfo[LEN_IDFILASETCLIENTINFO];
        VARCHAR oszXml1[LEN_XML];
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;

    /* obtem sequence */
    EXEC SQL SELECT infra.filasetclientinfosq.nextval
               INTO :oszIdFilaSetClientInfo
               FROM DUAL;

    STRCPY_FROM_ORA(ptFilaSetClientInfo->szIdFilaSetClientInfo, oszIdFilaSetClientInfo);
    STRCPY_TO_ORA(oszIdLinhaTelefonica, ptFilaSetClientInfo->szIdLinhaTelefonica);
    STRCPY_TO_ORA(oszXml1, ptFilaSetClientInfo->szXml);


    EXEC SQL 
    INSERT INTO infra.filasetclientinfo
    (
        idfilasetclientinfo ,
        idlinhatelefonica ,
        interceptado ,
        dttimestamp ,
        xml1
    )
    VALUES
    (
        :oszIdFilaSetClientInfo ,
        :oszIdLinhaTelefonica ,
        1 ,
        SYSDATE ,
        :oszXml1
    );


    ULOGI("Finalizando proCIncluiFilaSetClientInfo_4 <OK>");
    ULOG_END("CFilaSetClientInfopc::proCIncluiFilaSetClientInfo_4");
    return;

    erro:
        ULOGE("Finalizando proCIncluiFilaSetClientInfo_4 <ERROR>");
        throw TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}
