// Prospect.pcpp: implementation for the 
// CProspect class.
//////////////////////////////////////////////////////////////////////

#undef SQLCA
#define SQLCA_NONE

#include <sqlca.h>
#include <tuxfw.h>

#define SAFE_STRNCPY(dst,src) strncpy(dst,src?src:"",sizeof(dst)-1);dst[sizeof(dst)-1]=0;

#define MSG_NONE
#include "../include/Messages.h"
#undef MSG_NONE

EXEC SQL INCLUDE "../include/Prospect.h";
EXEC SQL INCLUDE "../include/UF.h";
EXEC SQL INCLUDE "../include/SistemaOrigem.h";
EXEC SQL INCLUDE "../include/TipoCarteira.h";

#include "../include/Funcoes.h"

//
// Construtor e Destrutor
CProspect::CProspect() {

	poListaCont = NULL;
	iNrContatos = 0;

    memset(cdAreaRegistro,0,sizeof(cdAreaRegistro));
    memset(cdCaixaPostal,0,sizeof(cdCaixaPostal));
    memset(cDocto,0,sizeof(cDocto));
    memset(cDsCont,0,sizeof(cDsCont));
    memset(cDtExp,0,sizeof(cDtExp));
    memset(cMeioNmProspect,0,sizeof(cMeioNmProspect));
    memset(cNmProspect,0,sizeof(cNmProspect));
    memset(cOrgaoExp,0,sizeof(cOrgaoExp));
    memset(cPriNmProspect,0,sizeof(cPriNmProspect));
    memset(cSobNmProspect,0,sizeof(cSobNmProspect));
    memset(dsAosCuidados,0,sizeof(dsAosCuidados));
    memset(dsEnderecoComplemento,0,sizeof(dsEnderecoComplemento));
    memset(idPais,0,sizeof(idPais));
    memset(idTipoEndereco,0,sizeof(idTipoEndereco));
    memset(idUF,0,sizeof(idUF));
    memset(nmBairro,0,sizeof(nmBairro));
    memset(nmLocalidade,0,sizeof(nmLocalidade));
    memset(nmLogradouro,0,sizeof(nmLogradouro));
    memset(nmMunicipio,0,sizeof(nmMunicipio));
    memset(nmTipoLogradouro,0,sizeof(nmTipoLogradouro));
    memset(nmTituloLogradouro,0,sizeof(nmTituloLogradouro));
    memset(nrCEP,0,sizeof(nrCEP));
    memset(nrEndereco,0,sizeof(nrEndereco));
    memset(nrLinha,0,sizeof(nrLinha));
    memset(sIdUsuarioAlteracao,0,sizeof(sIdUsuarioAlteracao));
    memset(sSgTpPessoa,0,sizeof(sSgTpPessoa));
    memset(&cSgClassificacao,0,sizeof(cSgClassificacao));

    iIdCont = 0L;
    iIdDocto = 0L;
    iIdPais = 0L;
    iIdProspect = -1;
    iIdProspectDePara = 0L;
    iIdTpDocto = 0L;
    iIdTpPessoa = 0L;
    iIdUFDoc = 0L;

    icDtExp = -1;
    icIdDocumento = -1;
    icIdPessoaDocumento = -1;
    icOrgaoExp = -1;

}

CProspect::CProspect(long iId) {

	struct sqlca sqlca;

 	EXEC SQL BEGIN DECLARE SECTION;
		long iOraId;
	    short i_iIdProspect = -1;
	    short i_cNmProspect = -1;
	    short i_iIdTpDocto = -1;
	    short i_cDocto = -1;
	    short i_iIdDocto = -1;
	    short i_sSgTpPessoa = -1;
	    short i_iIdProspectDePara = -1;

	EXEC SQL END DECLARE SECTION;

	ULOG("CProspect::CProspect(long iId) iId(idPessoa)=%ld",iId);

	iOraId = iId;

    memset(cdAreaRegistro,0,sizeof(cdAreaRegistro));
    memset(cdCaixaPostal,0,sizeof(cdCaixaPostal));
    memset(cDocto,0,sizeof(cDocto));
    memset(cDsCont,0,sizeof(cDsCont));
    memset(cDtExp,0,sizeof(cDtExp));
    memset(cMeioNmProspect,0,sizeof(cMeioNmProspect));
    memset(cNmProspect,0,sizeof(cNmProspect));
    memset(cOrgaoExp,0,sizeof(cOrgaoExp));
    memset(cPriNmProspect,0,sizeof(cPriNmProspect));
    memset(cSobNmProspect,0,sizeof(cSobNmProspect));
    memset(dsAosCuidados,0,sizeof(dsAosCuidados));
    memset(dsEnderecoComplemento,0,sizeof(dsEnderecoComplemento));
    memset(idPais,0,sizeof(idPais));
    memset(idTipoEndereco,0,sizeof(idTipoEndereco));
    memset(idUF,0,sizeof(idUF));
    memset(nmBairro,0,sizeof(nmBairro));
    memset(nmLocalidade,0,sizeof(nmLocalidade));
    memset(nmLogradouro,0,sizeof(nmLogradouro));
    memset(nmMunicipio,0,sizeof(nmMunicipio));
    memset(nmTipoLogradouro,0,sizeof(nmTipoLogradouro));
    memset(nmTituloLogradouro,0,sizeof(nmTituloLogradouro));
    memset(nrCEP,0,sizeof(nrCEP));
    memset(nrEndereco,0,sizeof(nrEndereco));
    memset(nrLinha,0,sizeof(nrLinha));
    memset(sIdUsuarioAlteracao,0,sizeof(sIdUsuarioAlteracao));
    memset(sSgTpPessoa,0,sizeof(sSgTpPessoa));
    memset(&cSgClassificacao,0,sizeof(cSgClassificacao));

    iIdCont = 0L;
    iIdDocto = 0L;
    iIdPais = 0L;
    iIdProspect = 0L;
    iIdProspectDePara = 0L;
    iIdTpDocto = 0L;
    iIdTpPessoa = 0L;
    iIdUFDoc = 0L;

    icDtExp = -1;
    icIdDocumento = -1;
    icIdPessoaDocumento = -1;
    icOrgaoExp = -1;

	// Marca ponto de controle de erro
    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorConst;

	EXEC SQL
        SELECT PESSOA.IDPESSOA
             , PESSOA.NMPESSOA
             , DOCUMENTO.IDTIPODOCUMENTO
             , DOCUMENTO.NRDOCUMENTO
             , DOCUMENTO.IDDOCUMENTO
             , TIPOPESSOA.SGTIPOPESSOA
             , PESSOADEPARA.IDPESSOADEPARA
          INTO :iIdProspect:i_iIdProspect
	         , :cNmProspect:i_cNmProspect
	         , :iIdTpDocto:i_iIdTpDocto
	         , :cDocto:i_cDocto
	         , :iIdDocto:i_iIdDocto
	         , :sSgTpPessoa:i_sSgTpPessoa
	         , :iIdProspectDePara:i_iIdProspectDePara
          FROM CUSTOMER.PESSOA PESSOA
             , CUSTOMER.PESSOADOCUMENTO PESSOADOCUMENTO
             , CUSTOMER.DOCUMENTO DOCUMENTO
             , APOIO.TIPOPESSOA TIPOPESSOA
             , CUSTOMER.PESSOADEPARA PESSOADEPARA
             , APOIO.TIPODOCUMENTO TIPODOCUMENTO
         WHERE PESSOA.IDPESSOA = PESSOADOCUMENTO.IDPESSOA (+)
           AND PESSOADEPARA.IDPESSOAORIGEM = PESSOA.IDPESSOA
           AND PESSOADOCUMENTO.IDDOCUMENTO = DOCUMENTO.IDDOCUMENTO (+)
           AND PESSOA.IDTIPOPESSOA = TIPOPESSOA.IDTIPOPESSOA
           AND DOCUMENTO.IDTIPODOCUMENTO = TIPODOCUMENTO.IDTIPODOCUMENTO (+)
           AND NVL(TIPODOCUMENTO.NRPRIORIDADE, 9999) = 
                                ( SELECT NVL(MIN(TIPODOCUMENTO1.NRPRIORIDADE),9999)
                                    FROM CUSTOMER.PESSOADOCUMENTO PESSOADOCUMENTO1
                                       , CUSTOMER.DOCUMENTO DOCUMENTO1
                                       , APOIO.TIPODOCUMENTO TIPODOCUMENTO1
                                   WHERE PESSOADOCUMENTO1.IDPESSOA = :iOraId
                                     AND PESSOADOCUMENTO1.IDDOCUMENTO = DOCUMENTO1.IDDOCUMENTO
                                     AND DOCUMENTO1.IDTIPODOCUMENTO = TIPODOCUMENTO1.IDTIPODOCUMENTO
                                )
           AND PESSOA.IDPESSOA = :iOraId
           AND ROWNUM < 2;

	if (sqlca.sqlcode == 1403)
		iIdProspect = -1;

    ULOG_END("CProspect::CProspect()");

	return;

sqlErrorConst:
        ULOG("sqlca.sqlcode(%d) sqlca.sqlerrm.sqlerrmc[%s]", sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
        ULOG_END("CProspect::CProspect()");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

CProspect::~CProspect() {
}

//
// getters
long CProspect::getIdProspect() {
	return iIdProspect;
}

char* CProspect::getNmProspect() {
	return cNmProspect;
}

char* CProspect::getPriNmProspect() {
	return cPriNmProspect;
}

char* CProspect::getMeioNmProspect() {
	return cMeioNmProspect;
}

char* CProspect::getSobNmProspect() {
	return cSobNmProspect;
}

long CProspect::getIdTpPessoa() {
	return iIdTpPessoa;
}

long CProspect::getIdTpDocto() {
	return iIdTpDocto;
}

long CProspect::getIdDocto() {
	return iIdDocto;
}

char* CProspect::getDocto() {
	return cDocto;
}

char* CProspect::getSgTpPessoa() {
	return sSgTpPessoa;
}

long CProspect::getIdPais() {
	return iIdPais;
}

char* CProspect::getOrgaoExp() {
	if (icOrgaoExp < 0)
		return NULL;
	else
		return cOrgaoExp;
}

char* CProspect::getDtExp() {
	if (icDtExp < 0)
		return NULL;
	else
		return cDtExp;
}

long CProspect::getIdUFDoc() {
	return iIdUFDoc;
}

long CProspect::getIdProspectDePara() {
	return iIdProspectDePara;
}
//
// Metodos setter
void CProspect::setUsuarioAlteracao(const char *value) {
    SAFE_STRNCPY(sIdUsuarioAlteracao,value);
}

void CProspect::setNmProspect(const char *value) {
    SAFE_STRNCPY(cNmProspect,value);
}

void CProspect::setPriNmProspect(const char *value) {
    SAFE_STRNCPY(cPriNmProspect,value);
}

void CProspect::setMeioNmProspect(const char *value) {
    SAFE_STRNCPY(cMeioNmProspect,value);
}

void CProspect::setSobNmProspect(const char *value) {
    SAFE_STRNCPY(cSobNmProspect,value);
}

void CProspect::setIdTpPessoa(long value) {
	iIdTpPessoa = value;
}

void CProspect::setIdTpDocto(long value) {
	iIdTpDocto = value;
}

void CProspect::setDocto(const char *value) {
    SAFE_STRNCPY(cDocto,value);
}

void CProspect::setCdAreaRegistro(const char *value) {
    SAFE_STRNCPY(cdAreaRegistro,value);
}

void CProspect::setNrLinha(const char *value) {
    SAFE_STRNCPY(nrLinha,value);
}

void CProspect::setIdPais(long value) {
	iIdPais = value;
}

void CProspect::setOrgaoExp(const char *value) {
	if (value == NULL)
		icOrgaoExp = -1;
	else {
        SAFE_STRNCPY(cOrgaoExp,value);
		icOrgaoExp = strlen(value);
	}
}

void CProspect::setDtExp(const char *value) {
	if (value == NULL)
		icDtExp = -1;
	else {
        SAFE_STRNCPY(cDtExp,value);
		icDtExp = strlen(value);
	}
}

void CProspect::setIdUFDoc(long value) {
	iIdUFDoc = value;
}

void CProspect::setIdProspectDePara(long value) {
	iIdProspectDePara = value;
}

void CProspect::setCdCaixaPostal(const char *value) {
    SAFE_STRNCPY(cdCaixaPostal,value);
}

void CProspect::setDsAosCuidados(const char *value) {
    SAFE_STRNCPY(dsAosCuidados,value);
}

void CProspect::setDsEnderecoComplemento(const char *value) {
    SAFE_STRNCPY(dsEnderecoComplemento,value);
}

void CProspect::setIdPais(const char *value) {
    SAFE_STRNCPY(idPais,value);
}

void CProspect::setIdTipoEndereco(const char *value) {
    SAFE_STRNCPY(idTipoEndereco,value);
}

void CProspect::setIdUF(const char *value) {
    SAFE_STRNCPY(idUF,value);
}

void CProspect::setNmBairro(const char *value) {
    SAFE_STRNCPY(nmBairro,value);
}

void CProspect::setNmLocalidade(const char *value) {
    SAFE_STRNCPY(nmLocalidade,value);
}

void CProspect::setNmLogradouro(const char *value) {
    SAFE_STRNCPY(nmLogradouro,value);
}

void CProspect::setNmMunicipio(const char *value) {
    SAFE_STRNCPY(nmMunicipio,value);
}

void CProspect::setNmTipoLogradouro(const char *value) {
    SAFE_STRNCPY(nmTipoLogradouro,value);
}

void CProspect::setNmTituloLogradouro(const char *value) {
    SAFE_STRNCPY(nmTituloLogradouro,value);
}

void CProspect::setNrCEP(const char *value) {
    SAFE_STRNCPY(nrCEP,value);
}

void CProspect::setNrEndereco(const char *value) {
    SAFE_STRNCPY(nrEndereco,value);
}

void CProspect::inclui() {

    ULOG_START("CProspect::inclui()");

    struct sqlca sqlca;
    long iAux = 0;

    EXEC SQL BEGIN DECLARE SECTION;
        long iIdSistemaOrigem;
        long iIdTipoCarteira;
        long iIdPessoa;
        long iIdPessoaDePara;
        long iIdDocumento;
        long iIdPessoaDocumento;
        long iIdPessoaComunicacao;
        long iIdTipoRelacionamento;

        const char *pCdAreaRegistro = cdAreaRegistro;
        const char *pNrLinha = nrLinha;

        short i_pCdAreaRegistro = (pCdAreaRegistro&&*pCdAreaRegistro)?0:-1;
        short i_pNrLinha = (nrLinha&&*nrLinha)?0:-1;

        const char *pOraCdCaixaPostal = cdCaixaPostal;
        const char *pOraDsAosCuidados = dsAosCuidados;
        const char *pOraDsEnderecoComplemento = dsEnderecoComplemento;
        const char *pOraIdPais = idPais;
        const char *pOraIdTipoEndereco = idTipoEndereco;
        const char *pOraIdUF = idUF;
        const char *pOraNmBairro = nmBairro;
        const char *pOraNmLocalidade = nmLocalidade;
        const char *pOraNmLogradouro = nmLogradouro;
        const char *pOraNmMunicipio = nmMunicipio;
        const char *pOraNmTipoLogradouro = nmTipoLogradouro;
        const char *pOraNmTituloLogradouro = nmTituloLogradouro;
        const char *pOraNrCEP = nrCEP;
        const char *pOraNrEndereco = nrEndereco;

        short statOraCdCaixaPostal =  (pOraCdCaixaPostal && *pOraCdCaixaPostal)?0:-1;
        short statOraDsAosCuidados =  (pOraDsAosCuidados && *pOraDsAosCuidados)?0:-1;
        short statOraDsEnderecoComplemento =  (pOraDsEnderecoComplemento && *pOraDsEnderecoComplemento)?0:-1;
        short statOraIdPais =  (pOraIdPais && *pOraIdPais)?0:-1;
        short statOraIdTipoEndereco =  (pOraIdTipoEndereco && *pOraIdTipoEndereco)?0:-1;
        short statOraIdUF =  (pOraIdUF && *pOraIdUF)?0:-1;
        short statOraNmBairro =  (pOraNmBairro && *pOraNmBairro)?0:-1;
        short statOraNmLocalidade =  (pOraNmLocalidade && *pOraNmLocalidade)?0:-1;
        short statOraNmLogradouro =  (pOraNmLogradouro && *pOraNmLogradouro)?0:-1;
        short statOraNmMunicipio =  (pOraNmMunicipio && *pOraNmMunicipio)?0:-1;
        short statOraNmTipoLogradouro =  (pOraNmTipoLogradouro && *pOraNmTipoLogradouro)?0:-1;
        short statOraNmTituloLogradouro =  (pOraNmTituloLogradouro && *pOraNmTituloLogradouro)?0:-1;
        short statOraNrCEP =  (pOraNrCEP && *pOraNrCEP)?0:-1;
        short statOraNrEndereco =  (pOraNrEndereco && *pOraNrEndereco)?0:-1;

    EXEC SQL END DECLARE SECTION;

    iIdSistemaOrigem = CSistemaOrigem::getIdSistemaFO();
    ULOG("iIdSistemaOrigem(%d)", iIdSistemaOrigem);

    iIdTipoCarteira = CTipoCarteira::getIdTipoNaoDefinido();
    ULOG("iIdTipoCarteira(%d)", iIdTipoCarteira);

    //  iIdUF = CUF::getIdFakeUF();
    
    // Insere primeiro na tabela de Pessoa
    ULOG("vai inserir em CUSTOMER.PESSOA...");
    
    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorIns;

    EXEC SQL
    UPDATE CUSTOMER.PESSOA
    SET    CDAREAREGISTROPROSPECT = NULL,
           NRLINHAPROSPECT = NULL
    WHERE  CDAREAREGISTROPROSPECT = :pCdAreaRegistro
    AND    NRLINHAPROSPECT = :pNrLinha;
    
    
    EXEC SQL 
        SELECT CUSTOMER.PESSOASQ.NEXTVAL
        INTO :iIdPessoa
        FROM DUAL;

    EXEC SQL
        INSERT INTO CUSTOMER.PESSOA
        (
            IDPESSOA,
            IDSISTEMAORIGEM,
            IDUF,
            IDTIPOPESSOA,
            IDTIPOCARTEIRA,
            NMPESSOA,
            NMNOME,
            NMNOMEMEIO,
            NMSOBRENOME,
            DTCADASTRO,
            INFALECIMENTOINFORMADO,
            IDPROBINADIMPLENCIA,
            IDCHURNPROBABILIDADE,
            IDPESSOASISTEMAORIGEM,
            IDUSUARIOALTERACAO,
            DTULTIMAALTERACAO,
            CDAREAREGISTROPROSPECT,
            NRLINHAPROSPECT
        )
        VALUES
        (
            :iIdPessoa,
            :iIdSistemaOrigem,
            :iIdUFDoc,
            :iIdTpPessoa,
            :iIdTipoCarteira,
            :cNmProspect,
            :cPriNmProspect,
            :cMeioNmProspect,
            :cSobNmProspect,
            SYSDATE,
            0,
            1,
            1,
            :iIdPessoa,
            :sIdUsuarioAlteracao,
            SYSDATE,
            :pCdAreaRegistro:i_pCdAreaRegistro,
            :pNrLinha:i_pNrLinha
        );

    // Insere na pessoa física OU pessoa jurídica
    if (iIdTpPessoa == 1) {
        ULOG("vai inserir em CUSTOMER.PESSOAFISICA...");
        
        EXEC SQL
            INSERT INTO CUSTOMER.PESSOAFISICA
            (
                IDPESSOA, 
                DTNASCIMENTO, 
                NMMAE, 
                NMPAI, 
                IDTRATAMENTO, 
                IDESTADOCIVIL, 
                IDPAIS, 
                IDSEXO, 
                IDUSUARIOALTERACAO, 
                DTULTIMAALTERACAO
            )
            VALUES
            (
                :iIdPessoa,
                NULL,
                NULL,
                NULL,
                0,
                0,
                :iIdPais,
                0,
                :sIdUsuarioAlteracao,
                SYSDATE
            );

    } else if (iIdTpPessoa == 2) {
        ULOG("vai inserir em CUSTOMER.PESSOAJURIDICA...");

        EXEC SQL
            INSERT INTO CUSTOMER.PESSOAJURIDICA
            (
                IDPESSOA, 
                NMPESSOAFILIAL, 
                NMFANTASIA, 
                IDUSUARIOALTERACAO, 
                DTULTIMAALTERACAO, 
                DTFUNDACAO,
                IDCFOP
            )
            VALUES 
            (
                :iIdPessoa,
                NULL,
                :cNmProspect,
                :sIdUsuarioAlteracao,
                SYSDATE,
                NULL,
                0
            );
    }

    // Insere na tabela de pessoa de para
    ULOG("vai inserir em CUSTOMER.PESSOADEPARA...");

    EXEC SQL
        SELECT CUSTOMER.PESSOADEPARASQ.NEXTVAL
        INTO :iIdPessoaDePara
        FROM DUAL;

    EXEC SQL
        INSERT INTO CUSTOMER.PESSOADEPARA
        (
            IDPESSOADEPARA,
            IDPESSOA,
            IDPESSOAORIGEM,
            IDUSUARIOALTERACAO,
            DTULTIMAALTERACAO
        )
        VALUES
        (
            :iIdPessoaDePara,
            :iIdPessoa,
            :iIdPessoa,
            :sIdUsuarioAlteracao,
            SYSDATE
        );

    if ( statOraIdPais >=0 && statOraIdTipoEndereco >=0 && statOraIdUF >=0 )
    {
        // Insere na tabela endereço
        ULOG("vai inserir em CUSTOMER.PESSOAENDERECO...");

        EXEC SQL
            INSERT INTO CUSTOMER.PESSOAENDERECO
            (
                IDPESSOAENDERECO,
                IDPESSOA,
                CDCAIXAPOSTAL,
                DSAOSCUIDADOS,
                DSENDERECOCOMPLEMENTO,
                DTCADASTRO,
                DTEXPIRACAO,
                DTULTIMAALTERACAO,
                IDENDERECOSISTEMAORIGEM,
                IDPAIS,
                IDSISTEMAORIGEM,
                IDTIPOENDERECO,
                IDUF,
                IDUSUARIOALTERACAO,
                INENDERECOPREFERENCIAL,
                INENDERECOSUJO,
                NMBAIRRO,
                NMLOCALIDADE,
                NMLOGRADOURO,
                NMMUNICIPIO,
                NMTIPOLOGRADOURO,
                NMTITULOLOGRADOURO,
                NRCEP,
                NRENDERECO,
                NRSEQUENCIA,
                SQSINCRONISMO,
                TSSINCRONISMO
            )
            VALUES
            (
                CUSTOMER.PESSOAENDERECOSQ.NEXTVAL,
                :iIdPessoa,
                :pOraCdCaixaPostal:statOraCdCaixaPostal,
                :pOraDsAosCuidados:statOraDsAosCuidados,
                :pOraDsEnderecoComplemento:statOraDsEnderecoComplemento,
                SYSDATE, --//DTCADASTRO
                NULL, --//DTEXPIRACAO
                SYSDATE, --//DTULTIMAALTERACAO
                NULL, --//IDENDERECOSISTEMAORIGEM
                :pOraIdPais:statOraIdPais,
                7, --//IDSISTEMAORIGEM
                :pOraIdTipoEndereco:statOraIdTipoEndereco,
                :pOraIdUF:statOraIdUF,
                :sIdUsuarioAlteracao,
                1, --//INENDERECOPREFERENCIAL
                0, --//INENDERECOSUJO
                :pOraNmBairro:statOraNmBairro,
                :pOraNmLocalidade:statOraNmLocalidade,
                :pOraNmLogradouro:statOraNmLogradouro,
                :pOraNmMunicipio:statOraNmMunicipio,
                :pOraNmTipoLogradouro:statOraNmTipoLogradouro,
                :pOraNmTituloLogradouro:statOraNmTituloLogradouro,
                :pOraNrCEP:statOraNrCEP,
                :pOraNrEndereco:statOraNrEndereco,
                0, --//NRSEQUENCIA
                NULL, --//SQSINCRONISMO
                NULL  --//TSSINCRONISMO
            );
    }

	// Realiza busca em Documento
    ULOG("vai buscar em CUSTOMER.DOCUMENTO...");
	
    ULOG("iIdUFDoc(%d)", iIdUFDoc);
    ULOG("cDtExp[%s]", cDtExp);
    ULOG("cOrgaoExp[%s]", cOrgaoExp);
    ULOG("iIdTpDocto(%d)", iIdTpDocto);
    ULOG("cDocto[%s]", cDocto);
	
    EXEC SQL
        SELECT
            IDDOCUMENTO
        INTO
            :iIdDocumento:icIdDocumento
        FROM
            CUSTOMER.DOCUMENTO
        WHERE
            IDTIPODOCUMENTO = :iIdTpDocto
        AND IDUF = :iIdUFDoc
        AND NRDOCUMENTO  = :cDocto
        AND (DTEMISSAO IS NULL OR DTEMISSAO = TO_DATE(:cDtExp, 'DD/MM/YYYY'))
        AND (SGORGAOEXPEDIDOR IS NULL OR SGORGAOEXPEDIDOR = :cOrgaoExp);

    ULOG("sqlca.sqlcode=%d", sqlca.sqlcode);
    ULOG("icIdDocumento=%d", icIdDocumento);
    ULOG(" iIdDocumento=%d", iIdDocumento);

    if(sqlca.sqlcode == 1403)
    {
        // Insere na Documento
        ULOG("vai inserir em CUSTOMER.DOCUMENTO...");
        
    	EXEC SQL
    	    SELECT CUSTOMER.DOCUMENTOSQ.NEXTVAL
    	    INTO :iIdDocumento
    	    FROM DUAL;
    
        ULOG("iIdDocumento(%d)", iIdDocumento);
        ULOG("iIdUFDoc(%d)", iIdUFDoc);
        ULOG("iIdPais(%d)", iIdPais);
        ULOG("iIdTpDocto(%d)", iIdTpDocto);
        ULOG("cDocto[%s]", cDocto);
        ULOG("cOrgaoExp[%s]", cOrgaoExp);
        ULOG("cDtExp[%s]", cDtExp);
        ULOG("sIdUsuarioAlteracao[%s]", sIdUsuarioAlteracao);
    
    	EXEC SQL
            INSERT INTO CUSTOMER.DOCUMENTO
            (
                IDDOCUMENTO,
                IDUF,
                IDPAIS,
                IDTIPODOCUMENTO,
                NRDOCUMENTO,
                SGORGAOEXPEDIDOR,
                DTEMISSAO,
                IDUSUARIOALTERACAO,
                DTULTIMAALTERACAO
            )
            VALUES
            (
                :iIdDocumento,
                :iIdUFDoc,
                :iIdPais,
                :iIdTpDocto,
                :cDocto,
                :cOrgaoExp:icOrgaoExp,
                TO_DATE(:cDtExp:icDtExp,'DD/MM/YYYY'),
                :sIdUsuarioAlteracao,
                SYSDATE
            );
    }

    ULOG("BuscaPessoaDocumento - iIdTpDocto(%d)", iIdTpDocto);
    ULOG("BuscaPessoaDocumento - iIdPessoa(%d)", iIdPessoa);

	// Realiza busca em PessoaDocumento
    ULOG("vai buscar em CUSTOMER.PESSOADOCUMENTO...");
	
    EXEC SQL 
        SELECT PESSOADOCUMENTO.IDPESSOADOCUMENTO
         INTO :iIdPessoaDocumento:icIdPessoaDocumento
         FROM CUSTOMER.PESSOA PESSOA                             
            , CUSTOMER.DOCUMENTO DOCUMENTO                       
            , CUSTOMER.PESSOADOCUMENTO PESSOADOCUMENTO           
        WHERE PESSOADOCUMENTO.IDDOCUMENTO = DOCUMENTO.IDDOCUMENTO
          AND PESSOADOCUMENTO.IDPESSOA    = PESSOA.IDPESSOA         
          AND PESSOA.IDPESSOA = :iIdPessoa
          AND DOCUMENTO.IDTIPODOCUMENTO = :iIdTpDocto
          AND NVL(PESSOADOCUMENTO.DTEXPIRACAO,SYSDATE) >= SYSDATE
          AND ROWNUM = 1;

    ULOG("sqlca.sqlcode(%d)", sqlca.sqlcode);
    ULOG("icIdPessoaDocumento(%d)", icIdPessoaDocumento);
    ULOG("BUSCA iIdPessoaDocumento(%d)", iIdPessoaDocumento);

    if(sqlca.sqlcode == 1403)
    {
    	// Insere na Pessoa Documento
        ULOG("vai buscar em APOIO.TIPODOCUMENTO...");

        EXEC SQL 
            SELECT SGCLASSIFICACAO
            INTO :cSgClassificacao
            FROM APOIO.TIPODOCUMENTO
            WHERE IDTIPODOCUMENTO = :iIdTpDocto;

    	EXEC SQL
    	SELECT CUSTOMER.PESSOADOCUMENTOSQ.NEXTVAL
    	INTO :iIdPessoaDocumento
    	FROM DUAL;
    
        ULOG("iIdPessoaDocumento(%d)", iIdPessoaDocumento);
        ULOG("iIdPessoa(%d)", iIdPessoa);
        ULOG("iIdDocumento(%d)", iIdDocumento);
        ULOG("iIdSistemaOrigem(%d)", iIdSistemaOrigem);
        ULOG("sIdUsuarioAlteracao[%s]", sIdUsuarioAlteracao);
        ULOG("cSgClassificacao.arr[%s]", cSgClassificacao.arr);

        ULOG("vai inserir em CUSTOMER.PESSOADOCUMENTO...");

    	EXEC SQL
            INSERT INTO CUSTOMER.PESSOADOCUMENTO
            (
                IDPESSOADOCUMENTO,
                IDPESSOA,
                IDDOCUMENTO,
                IDSISTEMAORIGEM,
                IDDOCUMENTOSISTEMAORIGEM,
                IDUSUARIOALTERACAO,
                DTULTIMAALTERACAO
            )
    	    VALUES
    	(
            :iIdPessoaDocumento,
            :iIdPessoa,
            :iIdDocumento,
            :iIdSistemaOrigem,
            :cSgClassificacao,
            :sIdUsuarioAlteracao,
            SYSDATE
        );
    }

	// Insere na Pessoa Comunicacao
    ULOG("vai inserir %d contatos em CUSTOMER.PESSOACOMUNICACAO...",iNrContatos);

	for (iAux=0; iAux < iNrContatos; iAux++)
    {
		EXEC SQL
		    SELECT CUSTOMER.PESSOACOMUNICACAOSQ.NEXTVAL
		    INTO :iIdPessoaComunicacao
		    FROM DUAL;

		iIdCont = poListaCont[iAux].iIdTpContato;
		strncpy(cDsCont, poListaCont[iAux].cDsContato, 255);

		EXEC SQL
		    INSERT INTO CUSTOMER.PESSOACOMUNICACAO
		    (
			    IDPESSOACOMUNICACAO,
			    IDCOMUNICACAOSISTEMAORIGEM,
			    IDPESSOA,
			    IDTIPOCOMUNICACAO,
			    DSCONTATO,
			    IDSISTEMAORIGEM,
			    DTCADASTRO,
			    IDUSUARIOALTERACAO,
			    DTULTIMAALTERACAO
		    )
		    VALUES
		    (
			    :iIdPessoaComunicacao,
			    :iIdPessoaComunicacao,
			    :iIdPessoa,
			    :iIdCont,
			    :cDsCont,
			    :iIdSistemaOrigem,
			    SYSDATE,
			    :sIdUsuarioAlteracao,
			    SYSDATE
		    );
	}

	iIdProspect = iIdPessoa;
	iIdProspectDePara = iIdPessoaDePara;
	
	ULOG("      idPessoa=%d",iIdProspect);
	ULOG("idPessoaDePara=%d",iIdPessoaDePara);
	
	ULOG_END("CProspect::inclui()");

	return;

	// Tratamento de erro - Lança excessão com o código oracle do erro.
	sqlErrorIns:
        ULOGE("sqlca.sqlcode(%d) sqlca.sqlerrm.sqlerrmc[%s]", sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
        ULOG_END("CProspect::inclui()");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}

void CProspect::adicionaContato(long iIdAdic, char* pcAdic) {

    ULOG_START("CProspect::adicionaContato()");

	if ((poListaCont = (SContato*) realloc((void *)poListaCont, (sizeof(SContato) * (iNrContatos+1)))) != NULL) {		
		// Coloca os dados do objeto atual.
		strncpy(poListaCont[iNrContatos].cDsContato, pcAdic, 255);
		poListaCont[iNrContatos].cDsContato[255] = '\0';
		poListaCont[iNrContatos].iIdTpContato = iIdAdic;

		iNrContatos++;

	} else {
		if (poListaCont)
			free(poListaCont);
		ERROR(NRO_MEMORIA);
		ULOG_END("CProspect::adicionaContato()");
	    throw new TuxBasicSvcException(sNrMsg, MSG_MEMORIA);
	}
	ULOG_END("CProspect::adicionaContato()");
}

char* CProspect::buscaFoneContato() {

	ULOG_START("CProspect::buscaFoneContato()");
	
	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
		char sCont[256];
	EXEC SQL END DECLARE SECTION;

	memset(sCont, 0, 256);

	ULOG("iIdProspect(%d)", iIdProspect);

    // Marca ponto de controle de erro
    //         AND    tipocomunicacao.sgtipocomunicacao in ('CELULAR', 'TEL COM', 'TEL REC', 'TEL RES', 'HM', 'WK', 'BS', 'BC')

    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorCont;

	EXEC SQL 
        SELECT NVL(dscontato, ' ')
        into   :sCont
        FROM   customer.pessoacomunicacao,
               apoio.tipocomunicacao
        WHERE  pessoacomunicacao.idtipocomunicacao = tipocomunicacao.idtipocomunicacao
        AND    UPPER(tipocomunicacao.sgclassificacao) IN ('SMS', 'TELEFONE')
        AND    pessoacomunicacao.idpessoa = :iIdProspect
        AND    ROWNUM = 1;

/*
	EXEC SQL 
	SELECT NVL(DSCONTATO,' ')
	  into :sCont
	  FROM CUSTOMER.PESSOACOMUNICACAO
	 WHERE IDTIPOCOMUNICACAO IN (1, 2, 3, 7) 
	   AND ROWNUM = 1 
	   AND IDPESSOA = :iIdProspect;
*/

    ULOG_END("CProspect::buscaFoneContato()");
    
	if (sqlca.sqlcode == 1403)
		return "";
	else
		return rtrim(sCont);

sqlErrorCont:
    ULOGE("sqlca.sqlcode(%d) sqlca.sqlerrm.sqlerrmc[%s]", sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
    ULOG_END("CProspect::buscaFoneContato()");
    throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}
