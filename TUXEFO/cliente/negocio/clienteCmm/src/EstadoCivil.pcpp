/**
  * @modulo  Cliente
  * @usecase EstadoCivil
  * @author  Robinson Vieira
  * @version $Revision: 1.1 $
  * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:33:17 $
  **/

#undef SQLCA
#define SQLCA_NONE

#include <sqlca.h>
#include <tuxfw.h>
#include "../include/Global.h"
EXEC SQL INCLUDE "../include/EstadoCivil.h";

//
// Construtor e Destrutor
CEstadoCivil::CEstadoCivil() {
}

CEstadoCivil::~CEstadoCivil() {
}
//
// Metodos getter
int CEstadoCivil::getId(){
	return iId;
}

char* CEstadoCivil::getDs(){
	if (iId < 0)
		return NULL;
	else
		return cDs;
}

//
// Metodos setter
void CEstadoCivil::setId(int value){
	iId = value;
}

void CEstadoCivil::setDs(char* value){
	if (value != NULL) {
		strncpy(cDs, value, 255);
		cDs[255]='\0';
	}
}
// Metodos para acessar a base de dados
CEstadoCivil* CEstadoCivil::lista(int* iNroObjetos)
{
    
	ULOG_START("CEstadoCivil::lista()");
	
	struct sqlca sqlca;
	CEstadoCivil* listaTipo = NULL;
	int iNroObjLocal = 1;

	EXEC SQL BEGIN DECLARE SECTION;
		int iIdt;
		char cDst[256];
	EXEC SQL END DECLARE SECTION;
	// Marca ponto de controle de erro
	EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;

	// Declara e abre o cursor
	EXEC SQL DECLARE tabTemp CURSOR FOR
	SELECT
	 IdEstadoCivil,
	 DsEstadoCivil
	FROM
	 apoio.estadocivil
	WHERE
	 IdEstadoCivil > 0
	ORDER BY 2;

	EXEC SQL OPEN tabTemp;

	// Corre os dados e monta a lista de objetos
	EXEC SQL WHENEVER NOT FOUND DO break;
	for (;; iNroObjLocal++) {
		
		EXEC SQL FETCH tabTemp INTO
		 :iIdt,
		 :cDst;

		// Aloca memória para o objeto atual.
		if ((listaTipo = (CEstadoCivil*) realloc((void *)listaTipo, 
			(sizeof(CEstadoCivil) * iNroObjLocal))) != NULL) {
			// Coloca os dados do objeto atual.
			listaTipo[iNroObjLocal-1].setId(iIdt);
			listaTipo[iNroObjLocal-1].setDs(cDst);
		} else {
			if (listaTipo)
				free(listaTipo);
			throw new TuxBasicSvcException(NRO_ERR_MEMORIA,MSG_ERR_MEMORIA);
		}
	}

	*iNroObjetos = iNroObjLocal - 1;
	ULOG_END("CEstadoCivil::lista()");
	return listaTipo;

	// Tratamento de erro - Lança excessão com o código oracle do erro.
	sqlErrorLista:
	    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
	    ULOG_END("CEstadoCivil::lista()");
		throw TuxBasicOraException(sqlca.sqlcode);
}
