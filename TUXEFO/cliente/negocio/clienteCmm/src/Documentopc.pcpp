///////////////////////////////////////////////////////////////////////////////
/**
 * @modulo  Sincronismo
 * @usecase Documento
 * @author  Renato Striitzel Russo
 * @author  Carlos Eduardo Barbosa Braga
 * @version $Revision: 1.1 $
 * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:33:18 $
 **/
///////////////////////////////////////////////////////////////////////////////

#undef SQLCA
#define SQLCA_NONE
#include <sqlca.h>
#include <sqlda.h>

#include <memory.h>
#include <tuxfw.h>
#include "../include/Documentopc.h"

EXEC SQL BEGIN DECLARE SECTION;
#include "../include/Global.h"
EXEC SQL END DECLARE SECTION;

/*************************************************************************************/
void CDocumentopc::proCInsereDocumento(TDocumento *ptDocumento)
{
    ULOG_START("CDocumentopc::proCInsereDocumento()");
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdDocumento[LEN_IDDOCUMENTO];
        VARCHAR oszCdCpfCnpjBase[LEN_CDCPFCNPJBASE];
        VARCHAR oszCdCnpjFilial[LEN_CDCNPJFILIAL];
        VARCHAR oszCdCpfCnpjControle[LEN_CDCPFCNPJCONTROLE];
        VARCHAR oszNrDocumento[LEN_NRDOCUMENTO];
        VARCHAR oszSgOrgaoExpedidor[LEN_SGORGAOEXPEDIDOR];
        VARCHAR oszDtEmissao[LEN_DTEMISSAO];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszIdUf[LEN_IDUF];
        VARCHAR oszIdTipoDocumento[LEN_IDTIPODOCUMENTO];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    // STRCPY_TO_ORA(oszIdDocumento, ptDocumento->szIdDocumento);
    STRCPY_TO_ORA(oszCdCpfCnpjBase, ptDocumento->szCdCpfCnpjBase);
    STRCPY_TO_ORA(oszCdCnpjFilial, ptDocumento->szCdCnpjFilial);
    STRCPY_TO_ORA(oszCdCpfCnpjControle, ptDocumento->szCdCpfCnpjControle);
    STRCPY_TO_ORA(oszNrDocumento, ptDocumento->szNrDocumento);
    STRCPY_TO_ORA(oszSgOrgaoExpedidor, ptDocumento->szSgOrgaoExpedidor);
    STRCPY_TO_ORA(oszDtEmissao, ptDocumento->szDtEmissao);
    STRCPY_TO_ORA(oszIdPais, ptDocumento->szIdPais);
    STRCPY_TO_ORA(oszIdUf, ptDocumento->szIdUf);
    STRCPY_TO_ORA(oszIdTipoDocumento, ptDocumento->szIdTipoDocumento);
    STRCPY_TO_ORA(oszIdUsuarioAlteracao, ID_USUARIO_ALTERACAO);

    EXEC SQL WHENEVER SQLERROR goto erro;

    EXEC SQL SELECT to_char(Customer.DocumentoSq.nextval) into :oszIdDocumento FROM DUAL;

    STRCPY_FROM_ORA(ptDocumento->szIdDocumento, oszIdDocumento);


    EXEC SQL INSERT
        INTO Customer.Documento
        (
            iddocumento,
            cdcpfcnpjbase,
            cdcnpjfilial,
            cdcpfcnpjcontrole,
            nrdocumento,
            sgorgaoexpedidor,
            dtemissao,
            idpais,
            iduf,
            idtipodocumento,
            idusuarioalteracao,
            dtultimaalteracao
        )
        VALUES
        (
            to_number(:oszIdDocumento),
            :oszCdCpfCnpjBase,
            :oszCdCnpjFilial,
            :oszCdCpfCnpjControle,
            :oszNrDocumento,
            :oszSgOrgaoExpedidor,
            to_date(:oszDtEmissao, 'DD/MM/YYYY'),
            to_number(:oszIdPais),
            to_number(:oszIdUf),
            to_number(:oszIdTipoDocumento),
            to_number(:oszIdUsuarioAlteracao),
            sysdate
        );

    ULOG_END("CDocumentopc::proCInsereDocumento()");
    return;

    erro:
    	ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    	ULOG_END("CDocumentopc::proCInsereDocumento()");
        throw new TuxBasicOraException(sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);
}
 
/*************************************************************************************/
void CDocumentopc::proCAtualizaDocumento(TDocumento tDocumento)
{
    ULOG_START("CDocumentopc::proCAtualizaDocumento()");
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdDocumento[LEN_IDDOCUMENTO];
        VARCHAR oszCdCpfCnpjBase[LEN_CDCPFCNPJBASE];
        VARCHAR oszCdCnpjFilial[LEN_CDCNPJFILIAL];
        VARCHAR oszCdCpfCnpjControle[LEN_CDCPFCNPJCONTROLE];
        VARCHAR oszNrDocumento[LEN_NRDOCUMENTO];
        VARCHAR oszSgOrgaoExpedidor[LEN_SGORGAOEXPEDIDOR];
        VARCHAR oszDtEmissao[LEN_DTEMISSAO];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszIdUf[LEN_IDUF];
        VARCHAR oszIdTipoDocumento[LEN_IDTIPODOCUMENTO];
        VARCHAR oszIdUsuarioAlteracao[LEN_IDUSUARIOALTERACAO];
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    

    STRCPY_TO_ORA(oszIdDocumento, tDocumento.szIdDocumento);
    STRCPY_TO_ORA(oszCdCpfCnpjBase, tDocumento.szCdCpfCnpjBase);
    STRCPY_TO_ORA(oszCdCnpjFilial, tDocumento.szCdCnpjFilial);
    STRCPY_TO_ORA(oszCdCpfCnpjControle, tDocumento.szCdCpfCnpjControle);
    STRCPY_TO_ORA(oszNrDocumento, tDocumento.szNrDocumento);
    STRCPY_TO_ORA(oszSgOrgaoExpedidor, tDocumento.szSgOrgaoExpedidor);
    STRCPY_TO_ORA(oszDtEmissao, tDocumento.szDtEmissao);
    STRCPY_TO_ORA(oszIdPais, tDocumento.szIdPais);
    STRCPY_TO_ORA(oszIdUf, tDocumento.szIdUf);
    STRCPY_TO_ORA(oszIdTipoDocumento, tDocumento.szIdTipoDocumento);
    STRCPY_TO_ORA(oszIdUsuarioAlteracao, ID_USUARIO_ALTERACAO);
  STRCPY_TO_ORA(oszIdDocumento, tDocumento.szIdDocumento);

    EXEC SQL WHENEVER SQLERROR goto erro;

    EXEC SQL UPDATE Customer.Documento
        SET
//            iddocumento = :oszIdDocumento,
            cdcpfcnpjbase = :oszCdCpfCnpjBase,
            cdcnpjfilial = :oszCdCnpjFilial,
            cdcpfcnpjcontrole = :oszCdCpfCnpjControle,
            nrdocumento = :oszNrDocumento,
            sgorgaoexpedidor = :oszSgOrgaoExpedidor,
            dtemissao = TO_DATE(:oszDtEmissao, 'DD/MM/YYYY'),
            idpais = TO_NUMBER(:oszIdPais),
            iduf = TO_NUMBER(:oszIdUf),
            idtipodocumento = TO_NUMBER(:oszIdTipoDocumento),
            idusuarioalteracao = to_number(:oszIdUsuarioAlteracao),
            dtultimaalteracao = SYSDATE
        WHERE iddocumento = TO_NUMBER(:oszIdDocumento);

    ULOG_END("CDocumentopc::proCAtualizaDocumento()");
    return;

    erro:
    	ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    	ULOG_END("CDocumentopc::proCAtualizaDocumento()");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}

/*************************************************************************************/
bool CDocumentopc::proCBuscaDocumento(TDocumento *ptDocumento)
{
    ULOG_START("CDocumentopc::proCBuscaDocumento()");
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdDocumento[LEN_IDDOCUMENTO];
        VARCHAR oszCdCpfCnpjBase[LEN_CDCPFCNPJBASE];
        VARCHAR oszCdCnpjFilial[LEN_CDCNPJFILIAL];
        VARCHAR oszCdCpfCnpjControle[LEN_CDCPFCNPJCONTROLE];
        VARCHAR oszNrDocumento[LEN_NRDOCUMENTO];
        VARCHAR oszSgOrgaoExpedidor[LEN_SGORGAOEXPEDIDOR];
        VARCHAR oszDtEmissao[LEN_DTEMISSAO];
        VARCHAR oszIdPais[LEN_IDPAIS];
        VARCHAR oszIdUf[LEN_IDUF];
        VARCHAR oszIdTipoDocumento[LEN_IDTIPODOCUMENTO];

        short iIdDocumento = 0;
        short iCdCpfCnpjBase = 0;
        short iCdCnpjFilial = 0;
        short iCdCpfCnpjControle = 0;
        short iNrDocumento = 0;
        short iSgOrgaoExpedidor = 0;
        short iDtEmissao = 0;
        short iIdPais = 0;
        short iIdUf = 0;
        short iIdTipoDocumento = 0;
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    
    STRCPY_TO_ORA(oszNrDocumento, ptDocumento->szNrDocumento);
    STRCPY_TO_ORA(oszIdTipoDocumento, ptDocumento->szIdTipoDocumento);

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND goto naoexiste;

    EXEC SQL SELECT
        to_char(iddocumento),
        cdcpfcnpjbase,
        cdcnpjfilial,
        cdcpfcnpjcontrole,
        nrdocumento,
        sgorgaoexpedidor,
        to_char(dtemissao, 'YYYYMMDDHH24MISS'),
        to_char(idpais),
        to_char(iduf),
        to_char(idtipodocumento)
    INTO
        :oszIdDocumento:iIdDocumento,
        :oszCdCpfCnpjBase:iCdCpfCnpjBase,
        :oszCdCnpjFilial:iCdCnpjFilial,
        :oszCdCpfCnpjControle:iCdCpfCnpjControle,
        :oszNrDocumento:iNrDocumento,
        :oszSgOrgaoExpedidor:iSgOrgaoExpedidor,
        :oszDtEmissao:iDtEmissao,
        :oszIdPais:iIdPais,
        :oszIdUf:iIdUf,
        :oszIdTipoDocumento:iIdTipoDocumento
    FROM Customer.Documento
    WHERE nrdocumento = :oszNrDocumento
    AND   idtipodocumento = TO_NUMBER(:oszIdTipoDocumento);

    if(iIdDocumento != -1) {
        STRCPY_FROM_ORA(ptDocumento->szIdDocumento, oszIdDocumento);
    }

    if(iCdCpfCnpjBase != -1) {
        STRCPY_FROM_ORA(ptDocumento->szCdCpfCnpjBase, oszCdCpfCnpjBase);
    }

    if(iCdCnpjFilial != -1) {
        STRCPY_FROM_ORA(ptDocumento->szCdCnpjFilial, oszCdCnpjFilial);
    }

    if(iCdCpfCnpjControle != -1) {
        STRCPY_FROM_ORA(ptDocumento->szCdCpfCnpjControle, oszCdCpfCnpjControle);
    }

    if(iNrDocumento != -1) {
        STRCPY_FROM_ORA(ptDocumento->szNrDocumento, oszNrDocumento);
    }

    if(iSgOrgaoExpedidor != -1) {
        STRCPY_FROM_ORA(ptDocumento->szSgOrgaoExpedidor, oszSgOrgaoExpedidor);
    }

    if(iDtEmissao != -1) {
        STRCPY_FROM_ORA(ptDocumento->szDtEmissao, oszDtEmissao);
    }

    if(iIdPais != -1) {
        STRCPY_FROM_ORA(ptDocumento->szIdPais, oszIdPais);
    }

    if(iIdUf != -1) {
        STRCPY_FROM_ORA(ptDocumento->szIdUf, oszIdUf);
    }

    if(iIdTipoDocumento != -1) {
        STRCPY_FROM_ORA(ptDocumento->szIdTipoDocumento, oszIdTipoDocumento);
    }

    ULOG_END("CDocumentopc::proCBuscaDocumento()");
    return true;

    naoexiste:
        ULOGI ("Finalizando proCBuscaDocumento <NOT FOUND>");
        ULOG_END("CDocumentopc::proCBuscaDocumento()");
        return false;

    erro:
    	ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    	ULOG_END("CDocumentopc::proCBuscaDocumento()");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}

/*************************************************************************************/
bool CDocumentopc::proCBuscaCPFCNPJPorIdPessoa(const char *idPessoa,TDocumento *ptDocumento)
{
    ULOG_START("CDocumentopc::proCBuscaCPFCNPJPorIdPessoa");

    EXEC SQL BEGIN DECLARE SECTION;
		const char *pszOraIdPessoa = idPessoa;

		struct
		{
			VARCHAR oszIdDocumento[LEN_IDDOCUMENTO + LEN_EOS];
			VARCHAR oszCdCpfCnpjBase[LEN_CDCPFCNPJBASE + LEN_EOS];
			VARCHAR oszCdCnpjFilial[LEN_CDCNPJFILIAL + LEN_EOS];
			VARCHAR oszCdCpfCnpjControle[LEN_CDCPFCNPJCONTROLE + LEN_EOS];
			VARCHAR oszNrDocumento[LEN_NRDOCUMENTO + LEN_EOS];
			VARCHAR oszSgOrgaoExpedidor[LEN_SGORGAOEXPEDIDOR + LEN_EOS];
			VARCHAR oszDtEmissao[LEN_DTEMISSAO + LEN_EOS];
			VARCHAR oszIdPais[LEN_IDPAIS + LEN_EOS];
			VARCHAR oszIdUf[LEN_IDUF + LEN_EOS];
			VARCHAR oszIdTipoDocumento[LEN_IDTIPODOCUMENTO + LEN_EOS];
			VARCHAR oszDsTipoDocumento[LEN_DSTIPODOCUMENTO + LEN_EOS];
            VARCHAR oszNmPessoa[LEN_NMPESSOA + LEN_EOS];
		}stRegistro;
		struct
		{
			short iIdDocumento;
			short iCdCpfCnpjBase;
			short iCdCnpjFilial;
			short iCdCpfCnpjControle;
			short iNrDocumento;
			short iSgOrgaoExpedidor;
			short iDtEmissao;
			short iIdPais;
			short iIdUf;
			short iIdTipoDocumento;
			short iDsTipoDocumento;
            short iNmPessoa;
		}stRegistroInd;
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND CONTINUE;

	memset( &stRegistro, 0, sizeof(stRegistro) );
	memset( &stRegistroInd,-1, sizeof(stRegistroInd) );

	ULOG("idPessoa='%s'",pszOraIdPessoa);

	EXEC SQL
		SELECT
			TO_CHAR(DOCUMENTO.IDDOCUMENTO) AS IDDOCUMENTO
			, DOCUMENTO.CDCPFCNPJBASE
			, DOCUMENTO.CDCNPJFILIAL
			, DOCUMENTO.CDCPFCNPJCONTROLE
			, DOCUMENTO.NRDOCUMENTO
			, DOCUMENTO.SGORGAOEXPEDIDOR
			, TO_CHAR(DOCUMENTO.DTEMISSAO, 'DD/MM/YYYY') AS DTEMISSAO
			, TO_CHAR(DOCUMENTO.IDPAIS) AS IDPAIS
			, TO_CHAR(DOCUMENTO.IDUF) AS IDUF
			, TO_CHAR(DOCUMENTO.IDTIPODOCUMENTO) AS IDTIPODOCUMENTO
			, TIPODOCUMENTO.DSTIPODOCUMENTO
			, PESSOA.NMPESSOA
		INTO
			:stRegistro:stRegistroInd
		FROM
			CUSTOMER.PESSOA PESSOA,
			CUSTOMER.PESSOADOCUMENTO PESSOADOCUMENTO,
			CUSTOMER.DOCUMENTO DOCUMENTO,
			APOIO.TIPODOCUMENTO TIPODOCUMENTO
		WHERE
			DOCUMENTO.IDDOCUMENTO = PESSOADOCUMENTO.IDDOCUMENTO
		AND DOCUMENTO.IDTIPODOCUMENTO = TIPODOCUMENTO.IDTIPODOCUMENTO
		AND NVL(PESSOADOCUMENTO.DTEXPIRACAO,SYSDATE) >= SYSDATE
		AND ( TIPODOCUMENTO.SGTIPODOCUMENTO LIKE '%CPF' OR
			  TIPODOCUMENTO.SGTIPODOCUMENTO LIKE '%CNPJ' )
		AND PESSOADOCUMENTO.IDPESSOA = PESSOA.IDPESSOA
		AND PESSOADOCUMENTO.IDPESSOA IN (SELECT PESSOADEPARA.IDPESSOAORIGEM
										   FROM CUSTOMER.PESSOADEPARA PESSOADEPARA
										  WHERE PESSOADEPARA.IDPESSOA = :pszOraIdPessoa);
	if ( 1403 == sqlca.sqlcode )
	{
		ULOGI("Finalizando proCBuscaCPFCNPJPorIdPessoa <NOT FOUND>");
		return false;
	}

	// Atribui os dados encontrados à estrutura de entrada, salvo os dados que
	// retornarem NULL.
	if(stRegistroInd.iIdDocumento != -1) {
		STRCPY_FROM_ORA(ptDocumento->szIdDocumento, stRegistro.oszIdDocumento);
	}

	if(stRegistroInd.iCdCpfCnpjBase != -1) {
		STRCPY_FROM_ORA(ptDocumento->szCdCpfCnpjBase, stRegistro.oszCdCpfCnpjBase);
	}

	if(stRegistroInd.iCdCnpjFilial != -1) {
		STRCPY_FROM_ORA(ptDocumento->szCdCnpjFilial, stRegistro.oszCdCnpjFilial);
	}

	if(stRegistroInd.iCdCpfCnpjControle != -1) {
		STRCPY_FROM_ORA(ptDocumento->szCdCpfCnpjControle, stRegistro.oszCdCpfCnpjControle);
	}

	if(stRegistroInd.iNrDocumento != -1) {
		STRCPY_FROM_ORA(ptDocumento->szNrDocumento, stRegistro.oszNrDocumento);
	}

	if(stRegistroInd.iSgOrgaoExpedidor != -1) {
		STRCPY_FROM_ORA(ptDocumento->szSgOrgaoExpedidor, stRegistro.oszSgOrgaoExpedidor);
	}

	if(stRegistroInd.iDtEmissao != -1) {
		STRCPY_FROM_ORA(ptDocumento->szDtEmissao, stRegistro.oszDtEmissao);
	}

	if(stRegistroInd.iIdPais != -1) {
		STRCPY_FROM_ORA(ptDocumento->szIdPais, stRegistro.oszIdPais);
	}

	if(stRegistroInd.iIdUf != -1) {
		STRCPY_FROM_ORA(ptDocumento->szIdUf, stRegistro.oszIdUf);
	}

	if(stRegistroInd.iIdTipoDocumento != -1) {
		STRCPY_FROM_ORA(ptDocumento->szIdTipoDocumento, stRegistro.oszIdTipoDocumento);
	}

	if(stRegistroInd.iDsTipoDocumento != -1) {
		STRCPY_FROM_ORA(ptDocumento->szDsTipoDocumento, stRegistro.oszDsTipoDocumento);
	}

	if(stRegistroInd.iNmPessoa != -1) {
		STRCPY_FROM_ORA(ptDocumento->szNmPessoa, stRegistro.oszNmPessoa);
	}

    ULOG_END("CDocumentopc::proCBuscaCPFCNPJPorIdPessoa");

	return true;
    
    erro:
        ULOGE("Finalizando proCBuscaCPFCNPJPorIdPessoa <ERROR>");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}

/*************************************************************************************/
void CDocumentopc::proCApagaDocumento(TDocumento tDocumento)
{
    ULOG_START("CDocumentopc::proCApagaDocumento()");
    EXEC SQL BEGIN DECLARE SECTION;
        long olIdDocumento;
    EXEC SQL END DECLARE SECTION;

    struct sqlca sqlca;

    EXEC SQL WHENEVER SQLERROR goto erro;
    EXEC SQL WHENEVER NOT FOUND goto erro;

    olIdDocumento = atol(tDocumento.szIdDocumento);

    EXEC SQL DELETE FROM Customer.Documento
                   WHERE iddocumento = :olIdDocumento;

    ULOG_END("CDocumentopc::proCApagaDocumento()");
    return;

    erro:
    	ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    	ULOG_END("CDocumentopc::proCApagaDocumento()");
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc, sqlca.sqlerrm.sqlerrml);
}
