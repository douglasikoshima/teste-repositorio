/**
 * 
 * @modulo  Clientes
 * @usecase Clientes
 * @author  ??
 * @version $Revision: 1.1.118.1.8.5 $
 * @CVS     $Author: a5114878 $ - $Date: 2013/06/12 21:40:21 $
 **/

#ifdef WIN32
#pragma warning(disable:4786)
#endif

#include <string>
using namespace std;

#undef SQLCA
#define SQLCA_NONE
#include <sqlca.h>
#include <sqlda.h>

#include <tuxfw.h>
//#include "../include/Exception.h"
#include "../include/Funcoes.h"

#undef MSG_NONE
#define MSG_NONE
#include "../include/Messages.h"

#define CONVIND(O,I) \
{ \
	if (I == -1) { \
		##O.arr[0]=0; \
	} else { \
		##O.arr[##O.len]=0; \
	} \
}

#define STRLENNULL( y ) ( y == NULL ? 0 : strlen( y )  )

EXEC SQL BEGIN DECLARE SECTION;
EXEC SQL INCLUDE "../include/Global.h";
EXEC SQL END DECLARE SECTION;

EXEC SQL INCLUDE "../include/BuscaDocumentoPessoa.h";


//
// Construtor e Destrutor
CBuscaDocumentoPessoa::CBuscaDocumentoPessoa()
{
    memset(&tDocPesq, 0x00, sizeof(tDocPesq));
    memset(&tDocPesqST,-1,sizeof(tDocPesqST));
	isProtocolo=0;
}

CBuscaDocumentoPessoa::~CBuscaDocumentoPessoa()
{
}

void CBuscaDocumentoPessoa::clear()
{
    memset(&tDocPesq, 0x00, sizeof(tDocPesq));
    memset(&tDocPesqST,-1,sizeof(tDocPesqST));
}

//Setters
void CBuscaDocumentoPessoa::setIdPessoa(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sIdPessoa = -1;
    }
    else 
    {
        STRCPY_TO_ORA(tDocPesq.sIdPessoa, pDado);
        tDocPesqST.sIdPessoa = 0;
    }
}
void CBuscaDocumentoPessoa::setNmNome(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sNmNome = -1;
    }
    else
    {
        STRCPY_TO_ORA(tDocPesq.sNmNome, pDado);
        tDocPesqST.sNmNome = 0;
    }
}
void CBuscaDocumentoPessoa::setDsTipoDocumento(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sDsTipoDocumento = -1;
    }
    else
    {
        STRCPY_TO_ORA(tDocPesq.sDsTipoDocumento, pDado);
        tDocPesqST.sDsTipoDocumento = 0;
    }
}
void CBuscaDocumentoPessoa::setSgTipoDocumento(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sSgTipoDocumento = -1;
    }
    else
    {
        STRCPY_TO_ORA(tDocPesq.sSgTipoDocumento, pDado);
        tDocPesqST.sSgTipoDocumento = 0;
    }
}
void CBuscaDocumentoPessoa::setNrDocumento(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sNrDocumento = -1;
    }
    else
    {
        STRCPY_TO_ORA(tDocPesq.sNrDocumento, pDado);
        tDocPesqST.sNrDocumento = 0;
    }
}
void CBuscaDocumentoPessoa::setDsTipoPessoa(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sDsTipoPessoa = -1;
    }
    else
    {
        STRCPY_TO_ORA(tDocPesq.sDsTipoPessoa, pDado);
        tDocPesqST.sDsTipoPessoa = 0;
    }
}

void CBuscaDocumentoPessoa::setSgTipoPessoa(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sSgTipoPessoa = -1;
    }
    else
    {
        STRCPY_TO_ORA(tDocPesq.sSgTipoPessoa, pDado);
        tDocPesqST.sSgTipoPessoa = 0;
    }
}
void CBuscaDocumentoPessoa::setSgTipoRelacionamento(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sSgTipoRelacionamento = -1;
    }
    else
    {
        STRCPY_TO_ORA(tDocPesq.sSgTipoRelacionamento, pDado);
        tDocPesqST.sSgTipoRelacionamento = 0;
    }
}

void CBuscaDocumentoPessoa::setNrLinha(char* pDado)
{
    if(pDado == NULL)
    {
        tDocPesqST.sNrLinha = -1;
    }
    else
    {
        STRCPY_TO_ORA(tDocPesq.sNrLinha, pDado);
        tDocPesqST.sNrLinha = 0;
    }
}

void CBuscaDocumentoPessoa::setUltimaPagina(int nUltimaPaginaAux)
{
    tDocPesq.nUltimaPagina = nUltimaPaginaAux;
}

//Getters
char* CBuscaDocumentoPessoa::getIdPessoa(void)
{
    return ((char *)tDocPesq.sIdPessoa.arr);
}
char* CBuscaDocumentoPessoa::getNmNome(void)
{
    return ((char *)tDocPesq.sNmNome.arr);
}
char* CBuscaDocumentoPessoa::getDsTipoDocumento(void)
{
    return ((char *)tDocPesq.sDsTipoDocumento.arr);
}
char* CBuscaDocumentoPessoa::getSgTipoDocumento(void)
{
    return ((char *)tDocPesq.sSgTipoDocumento.arr);
}
char* CBuscaDocumentoPessoa::getNrDocumento(void)
{
    return ((char *)tDocPesq.sNrDocumento.arr);
}
char* CBuscaDocumentoPessoa::getDsTipoPessoa(void)
{
    return ((char *)tDocPesq.sDsTipoPessoa.arr);
}
char* CBuscaDocumentoPessoa::getSgTipoPessoa(void)
{
    return ((char *)tDocPesq.sSgTipoPessoa.arr);
}
char* CBuscaDocumentoPessoa::getNrLinha(void)
{
    return ((char *)tDocPesq.sNrLinha.arr);
}
char* CBuscaDocumentoPessoa::getSgTipoRelacionamento(void)
{
    return ((char *)tDocPesq.sSgTipoRelacionamento.arr);
}
int CBuscaDocumentoPessoa::getUltimaPagina(void)
{
    return tDocPesq.nUltimaPagina;
}

CBuscaDocumentoPessoa* CBuscaDocumentoPessoa::buscarDocPorNomePJ(int* iNroObjetos, char *pPriNm, char* cpageNumber)
{
    ULOG_START("CBuscaDocumentoPessoa::buscarDocPorNomePJ()");
    struct sqlca sqlca;

    CBuscaDocumentoPessoa* oObj = NULL;
    int iNroFetchLocal = 0;

    int ipageNumber = atoi( cpageNumber );
    int iTotalLinhasPorPaginas = getTotalLinhasPorPagina();

    EXEC SQL BEGIN DECLARE SECTION;
        int iPaginaIni = (ipageNumber-1) * iTotalLinhasPorPaginas;
        int iPaginaFim = iTotalLinhasPorPaginas + ((ipageNumber-1) * iTotalLinhasPorPaginas);

        //typedef struct
        //{
        //    VARCHAR sIdPessoa[LEN_NUMBER+LEN_EOS];
        //    VARCHAR sNmNome[LEN_NOME+LEN_EOS];
        //    VARCHAR sIdTipoPessoa[LEN_NUMBER+LEN_EOS];
        //    VARCHAR sDsTipoDocumento[LEN_NUMBER+LEN_EOS];
        //    VARCHAR sIdDocumento[LEN_NUMBER+LEN_EOS];
        //    VARCHAR sNrDocumento[LEN_NRDOCUMENTO+LEN_EOS];
        //    VARCHAR sSgTipoPessoa[LEN_DSTIPOPESSOA+LEN_EOS];
        //    VARCHAR sDsTipoPessoa[LEN_DSTIPOPESSOA+LEN_EOS];
        //
        //    //Nulls
        //    short *iIdPessoa_ora;
        //    short *iNmNome_ora;
        //    short *iIdTipoPessoa_ora;
        //    short *iDsTipoDocumento_ora;
        //    short *iIdDocumento_ora;
        //    short *iNrDocumento_ora;
        //    short *iDsTipoPessoa_ora;
        //    short *iSgTipoPessoa_ora;
        //
        //    long lRowToFetch;
        //    long lRowRecords;
        //}TDADOPRINCIPAL;

        TDOCPESQUISADOS sDados;
        TDOCPESQUISADOSST sStatus;
        //TDADOPRINCIPAL sDados;
        VARCHAR sSgTipoPessoa[LEN_DSTIPOPESSOA+LEN_EOS];
        VARCHAR sDsTipoPessoa[LEN_DSTIPOPESSOA+LEN_EOS];
        short iDsTipoPessoa_ora=-1;
        short iSgTipoPessoa_ora=-1;

        VARCHAR sClausula1[LEN_NMPESSOA+1+LEN_EOS];
    EXEC SQL END DECLARE SECTION;

    ULOG("iPaginaIni[%d] iPaginaFim[%d]", iPaginaIni, iPaginaFim );

    memset(&sDados, 0x00, sizeof(sDados));
    memset(&sStatus, -1, sizeof(sStatus));
    memset(&sSgTipoPessoa, 0x00, sizeof(sSgTipoPessoa));
    memset(&sDsTipoPessoa, 0x00, sizeof(sDsTipoPessoa));
    STRNCPY_TO_ORA(sClausula1, pPriNm, LEN_NMPESSOA);
    STRNCAT_TO_ORA(sClausula1, "%", 1);

    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;

    try
    {
        EXEC SQL WHENEVER NOT FOUND CONTINUE;

        EXEC SQL
        SELECT
            DSTIPOPESSOA,
            SGTIPOPESSOA
        INTO
            :sSgTipoPessoa:iDsTipoPessoa_ora,
            :sDsTipoPessoa:iSgTipoPessoa_ora
        FROM
            APOIO.TIPOPESSOA
        WHERE SGTIPOPESSOA = 'PJ';

        EXEC SQL WHENEVER NOT FOUND DO BREAK;

        EXEC SQL
        DECLARE cMasters CURSOR  FOR
        SELECT
            IDPESSOA,
            NMPESSOAFILIAL,
            IDTIPOPESSOA
        FROM
        (
            SELECT /*+ INDEX ( PESSOADEPARA PESSOADEPARAAK1 ) */
                 PR.IDPESSOA
                ,PR.NMPESSOAFILIAL
                ,PR.IDTIPOPESSOA
                ,ROWNUM AS LINHA
            FROM
                (
                    SELECT /*+ INDEX ( PESSOA PESSOAPK) */
                         PESSOA.IDPESSOA
                        ,PESSOAJURIDICA.NMPESSOAFILIAL
                        ,PESSOA.IDTIPOPESSOA
                    FROM
                        CUSTOMER.PESSOA PESSOA,
                        CUSTOMER.PESSOAJURIDICA PESSOAJURIDICA
                    WHERE
                        UPPER(PESSOAJURIDICA.NMPESSOAFILIAL) LIKE UPPER(:sClausula1)
                    AND
                        PESSOAJURIDICA.IDPESSOA = PESSOA.IDPESSOA
                    AND
                        PESSOA.IDTIPOPESSOA = ( SELECT IDTIPOPESSOA FROM APOIO.TIPOPESSOA WHERE SGTIPOPESSOA = 'PJ' )
                    AND
                        ROWNUM <= (:iPaginaFim+1)
                ) PR,
                CUSTOMER.PESSOADEPARA PESSOADEPARA
            WHERE
                PR.IDPESSOA = PESSOADEPARA.IDPESSOAORIGEM
            AND
                PESSOADEPARA.IDPESSOA = PESSOADEPARA.IDPESSOAORIGEM
            AND
                ROWNUM <= :iPaginaFim+1
        )
        WHERE
            LINHA > :iPaginaIni;

        EXEC SQL OPEN cMasters;

        for(;;)
        {
            memset( &sDados, 0, sizeof( sDados ) );
            memset( &sStatus, -1, sizeof( sStatus ) );

            EXEC SQL WHENEVER NOT FOUND DO BREAK;
            EXEC SQL FETCH cMasters
            INTO
                :sDados.sIdPessoa:sStatus.sIdPessoa,
                :sDados.sNmNome:sStatus.sNmNome,
                :sDados.sIdTipoPessoa:sStatus.sIdTipoPessoa;

            if( iNroFetchLocal == iTotalLinhasPorPaginas )
            {
                iNroFetchLocal++;
                break;
            }

            EXEC SQL WHENEVER NOT FOUND CONTINUE;
            EXEC SQL
            SELECT DISTINCT
                D.DSTIPODOCUMENTO,
                C.NRDOCUMENTO
            INTO
                :sDados.sDsTipoDocumento:sStatus.sDsTipoDocumento,
                :sDados.sNrDocumento:sStatus.sNrDocumento
            FROM
                CUSTOMER.PESSOA A,
                CUSTOMER.PESSOADOCUMENTO B,
                CUSTOMER.DOCUMENTO C,
                APOIO.TIPODOCUMENTO D,
                APOIO.TIPOPESSOA E
            WHERE B.IDDOCUMENTO = C.IDDOCUMENTO
            AND C.IDTIPODOCUMENTO = D.IDTIPODOCUMENTO
            AND A.IDTIPOPESSOA   = E.IDTIPOPESSOA
            AND A.IDTIPOPESSOA   = TO_NUMBER(:sDados.sIdTipoPessoa)
            AND A.IDPESSOA = B.IDPESSOA
            AND B.IDPESSOA IN
            (
                SELECT PDP.IDPESSOAORIGEM
                FROM CUSTOMER.PESSOADEPARA PDP
                WHERE PDP.IDPESSOA = :sDados.sIdPessoa
            )
            AND ROWNUM < 2;

            ULOG( "TipoPessoa[%s]", (char*)sDados.sIdTipoPessoa.arr );
            ULOG( "Documento[%s]", (char*)sDados.sNrDocumento.arr );
            ULOG( "Pessoa[%s]", (char*)sDados.sIdPessoa.arr );
            ULOG( "Documento[%s]", (char*)sDados.sNrDocumento.arr );

            if ((oObj = (CBuscaDocumentoPessoa*) realloc((void *)oObj,
                            (sizeof(CBuscaDocumentoPessoa)*(iNroFetchLocal+1)))) != NULL)
            {
                oObj[iNroFetchLocal].clear();
                oObj[iNroFetchLocal].setIdPessoa(sStatus.sIdPessoa == 0?(char*)sDados.sIdPessoa.arr:"");
                oObj[iNroFetchLocal].setNmNome(sStatus.sNmNome == 0?(char*)sDados.sNmNome.arr:"");
                oObj[iNroFetchLocal].setDsTipoDocumento(sStatus.sDsTipoDocumento == 0?(char*)sDados.sDsTipoDocumento.arr:"");
                oObj[iNroFetchLocal].setNrDocumento(sStatus.sNrDocumento == 0?(char*)sDados.sNrDocumento.arr:"");
                oObj[iNroFetchLocal].setDsTipoPessoa(iSgTipoPessoa_ora == 0?(char*)sDsTipoPessoa.arr:"");
                oObj[iNroFetchLocal].setSgTipoPessoa(iDsTipoPessoa_ora == 0?(char*)sSgTipoPessoa.arr:"");

                iNroFetchLocal++;
            }
            else
            {
                if (oObj) { free(oObj); }
            }

        }//for(;;)

        EXEC SQL CLOSE cMasters;

        //Verifica se eh ou nao a ultima pagina
        if( oObj != NULL )
        {
            ULOG("Gravando o LOG iNroFetchLocal[%d] > iTotalLinhasPorPaginas[%d]", iNroFetchLocal, iTotalLinhasPorPaginas);
            if( iNroFetchLocal > iTotalLinhasPorPaginas )
            {
                oObj[0].setUltimaPagina(0);
                iNroFetchLocal--;//Como contou um a mais para saber que eh ultima pagina, tem que tirar este um.
            }
            else
            {
                oObj[0].setUltimaPagina(1);
            }
        }

        *iNroObjetos = iNroFetchLocal;

        ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNomePJ()");
        return oObj;

        // Tratamento de erro - Lança excessão com o código oracle do erro.
        sqlErrorLista:
            ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
            ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNomePJ()");
            throw  new TuxBasicOraException(sqlca.sqlcode);
    }
    catch(...)
    {
        throw;
    }
}

//Metodos de acesso ao Banco de Dados
CBuscaDocumentoPessoa* CBuscaDocumentoPessoa::buscarDocPorNrConta(int* iNroObjetos, char *pNrCta, char* cpageNumber)
{
    ULOG_START("CBuscaDocumentoPessoa::buscarDocPorNrConta()");
    struct sqlca sqlca;

    CBuscaDocumentoPessoa* oObj = NULL;
    int iNroObjLocal = 0;

    int ipageNumber = atoi( cpageNumber );
    int iTotalLinhasPorPaginas = getTotalLinhasPorPagina();

    EXEC SQL BEGIN DECLARE SECTION;
        int iPaginaIni = (ipageNumber-1) * iTotalLinhasPorPaginas;
        int iPaginaFim = iTotalLinhasPorPaginas + ((ipageNumber-1) * iTotalLinhasPorPaginas);
        TDOCPESQUISADOS tDocPesqOra;
        TDOCPESQUISADOSST tDocPesqSTOra;
        VARCHAR sClausula[255];
    EXEC SQL END DECLARE SECTION;

    ULOG("iPaginaIni[%d] iPaginaFim[%d]", iPaginaIni, iPaginaFim );

    STRCPY_TO_ORA(sClausula, pNrCta);

    // Marca ponto de controle de erro
    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;

    // Declara e abre o cursor
    EXEC SQL DECLARE cC1 CURSOR  FOR
    SELECT
        NMPESSOA,
        IDPESSOA,
        NRDOCUMENTO,
        DSTIPODOCUMENTO,
        DSTIPOPESSOA,
        SGTIPOPESSOA
    FROM
    (
        SELECT
            NMPESSOA,
            IDPESSOA,
            NRDOCUMENTO,
            DSTIPODOCUMENTO,
            DSTIPOPESSOA,
            SGTIPOPESSOA,
            ROWNUM AS LINHA
        FROM
        (
             SELECT DISTINCT
                    D.NMPESSOA,
                    C.IDPESSOA,
                    F.NRDOCUMENTO,
                    G.DSTIPODOCUMENTO,
                    H.DSTIPOPESSOA,
                    H.SGTIPOPESSOA
               FROM CUSTOMER.PESSOACONTA A,
                    CUSTOMER.CONTA B,
                    CUSTOMER.PESSOADEPARA C,
                    CUSTOMER.PESSOA D,
                    CUSTOMER.PESSOADOCUMENTO E,
                    CUSTOMER.DOCUMENTO F,
                    APOIO.TIPODOCUMENTO G,
                    APOIO.TIPOPESSOA H
              WHERE B.IDCONTA = A.IDCONTA
                AND C.IDPESSOADEPARA = A.IDPESSOADEPARA
                AND D.IDPESSOA = C.IDPESSOAORIGEM
                AND D.IDPESSOA = E.IDPESSOA
                AND F.IDDOCUMENTO = E.IDDOCUMENTO
                AND G.IDTIPODOCUMENTO = F.IDTIPODOCUMENTO
                AND H.IDTIPOPESSOA = D.IDTIPOPESSOA
                AND UPPER(CDCONTA) = UPPER(:sClausula)
        )
        WHERE
            ROWNUM <= :iPaginaFim+1
    )
    WHERE
        LINHA > :iPaginaIni;


    EXEC SQL OPEN cC1;
    EXEC SQL WHENEVER NOT FOUND DO BREAK;

    for (;;)
    {
        memset(&tDocPesqOra, 0x00, sizeof(tDocPesqOra));
        memset(&tDocPesqSTOra,-1,sizeof(tDocPesqSTOra));

        EXEC SQL FETCH cC1 INTO :tDocPesqOra.sNmNome:tDocPesqSTOra.sNmNome,
                                :tDocPesqOra.sIdPessoa:tDocPesqSTOra.sIdPessoa,
                                :tDocPesqOra.sNrDocumento:tDocPesqSTOra.sNrDocumento,
                                :tDocPesqOra.sDsTipoDocumento:tDocPesqSTOra.sDsTipoDocumento,
                                :tDocPesqOra.sDsTipoPessoa:tDocPesqSTOra.sDsTipoPessoa,
                                :tDocPesqOra.sSgTipoPessoa:tDocPesqSTOra.sSgTipoPessoa;

        if( iNroObjLocal == iTotalLinhasPorPaginas )
        {
            iNroObjLocal++;
            break;
        }

        // Aloca memória para o objeto atual.
        if (tDocPesqSTOra.sNmNome==-1)
        {
            break;
        }

        if ((oObj = (CBuscaDocumentoPessoa*) realloc((void *)oObj,
                        (sizeof(CBuscaDocumentoPessoa) * (iNroObjLocal+1)))) != NULL)
        {
            // Coloca os dados do objeto atual.
            oObj[iNroObjLocal].clear();

            oObj[iNroObjLocal].setIdPessoa((char*)tDocPesqOra.sIdPessoa.arr);
            oObj[iNroObjLocal].setNmNome((char*)tDocPesqOra.sNmNome.arr);
            oObj[iNroObjLocal].setDsTipoDocumento((char*)tDocPesqOra.sDsTipoDocumento.arr);

            if(tDocPesqSTOra.sNrDocumento>=0)
            {
                oObj[iNroObjLocal].setNrDocumento((char*)tDocPesqOra.sNrDocumento.arr);
            }

            if(tDocPesqSTOra.sDsTipoPessoa>=0)
            {
                oObj[iNroObjLocal].setDsTipoPessoa((char*)tDocPesqOra.sDsTipoPessoa.arr);
                oObj[iNroObjLocal].setSgTipoPessoa((char*)tDocPesqOra.sSgTipoPessoa.arr);
            }

            iNroObjLocal++;
        }
        else
        {
            if (oObj) { free(oObj); }

            EXEC SQL CLOSE cC1;

            ULOGE("ERRO DE MEMORIA -> NRO_MEMORIA");
            throw TuxBasicSvcException(sNrMsg,MSG_MEMORIA);
        }
    }
    EXEC SQL CLOSE cC1;

    //Verifica se eh ou nao a ultima pagina
    if( oObj != NULL )
    {
        ULOG("Gravando o LOG iNroObjLocal[%d] > iTotalLinhasPorPaginas[%d]", iNroObjLocal, iTotalLinhasPorPaginas);
        if( iNroObjLocal > iTotalLinhasPorPaginas )
        {
            oObj[0].setUltimaPagina(0);
            iNroObjLocal--;//Como contou um a mais para saber que eh ultima pagina, tem que tirar este um.
        }
        else
            oObj[0].setUltimaPagina(1);
    }
    *iNroObjetos = iNroObjLocal;
    ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNrConta()");
    return oObj;

    // Tratamento de erro - Lança excessão com o código oracle do erro.
    sqlErrorLista:
        ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
        ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNrConta()");
        throw  new TuxBasicOraException(sqlca.sqlcode);
}


CBuscaDocumentoPessoa* CBuscaDocumentoPessoa::buscarDocPorTipDocumento(int* iNroObjetos, char *pTp, char* pNr, char* cpageNumber)
{
    ULOG_START("CBuscaDocumentoPessoa::buscarDocPorTipDocumento()");
    struct sqlca sqlca;

    CBuscaDocumentoPessoa* oObj = NULL;
    int iNroObjLocal = 0;

    int ipageNumber = atoi( cpageNumber );
    int iTotalLinhasPorPaginas = getTotalLinhasPorPagina();

    EXEC SQL BEGIN DECLARE SECTION;
        int iPaginaIni = (ipageNumber-1) * iTotalLinhasPorPaginas;
        int iPaginaFim = iTotalLinhasPorPaginas + ((ipageNumber-1) * iTotalLinhasPorPaginas);
        TDOCPESQUISADOS tDocPesqOra;
        TDOCPESQUISADOSST tDocPesqSTOra;
        VARCHAR sClausula1[512];
        VARCHAR sClausula2[512];
    EXEC SQL END DECLARE SECTION;

    ULOG("iPaginaIni[%d] iPaginaFim[%d]", iPaginaIni, iPaginaFim );

    ULOG("pTp[%s]", pTp);
    ULOG("pNr[%s]", pNr);

    STRCPY_TO_ORA(sClausula1, pTp);
    STRCPY_TO_ORA(sClausula2, pNr);

    // Marca ponto de controle de erro
    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;

    // Declara e abre o cursor
    EXEC SQL DECLARE cC2 CURSOR  FOR
    SELECT
        IDPESSOA,
        NMPESSOA,
        DSTIPODOCUMENTO,
        NRDOCUMENTO,
        DSTIPOPESSOA,
        SGTIPOPESSOA
    FROM
    (
        SELECT
            D.IDPESSOA,
            D.NMPESSOA,
            F.DSTIPODOCUMENTO,
            B.NRDOCUMENTO,
            E.DSTIPOPESSOA,
            E.SGTIPOPESSOA,
            ROWNUM AS LINHA
        FROM
            CUSTOMER.PESSOADEPARA    C,
            CUSTOMER.PESSOADOCUMENTO A,
            CUSTOMER.DOCUMENTO       B,
            CUSTOMER.PESSOA          D,
            APOIO.TIPOPESSOA         E,
            APOIO.TIPODOCUMENTO      F
        WHERE   A.IDDOCUMENTO = B.IDDOCUMENTO
            AND A.IDPESSOA = D.IDPESSOA
            AND C.IDPESSOAORIGEM = D.IDPESSOA
            AND E.IDTIPOPESSOA = D.IDTIPOPESSOA
            AND B.IDTIPODOCUMENTO = F.IDTIPODOCUMENTO
            AND UPPER(F.SGCLASSIFICACAO) = UPPER(:sClausula1)
            AND UPPER(B.NRDOCUMENTO) = UPPER(:sClausula2)
            AND ROWNUM <= :iPaginaFim+1
    )
    WHERE
        LINHA > :iPaginaIni;

    EXEC SQL OPEN cC2;

    EXEC SQL WHENEVER NOT FOUND DO BREAK;

    for (;;)
    {
        memset(&tDocPesqOra, 0x00, sizeof(tDocPesqOra));
        memset(&tDocPesqSTOra,-1,sizeof(tDocPesqSTOra));

        EXEC SQL FETCH cC2 INTO :tDocPesqOra.sIdPessoa:tDocPesqSTOra.sIdPessoa,
                                :tDocPesqOra.sNmNome:tDocPesqSTOra.sNmNome,
                                :tDocPesqOra.sDsTipoDocumento:tDocPesqSTOra.sDsTipoDocumento,
                                :tDocPesqOra.sNrDocumento:tDocPesqSTOra.sNrDocumento,
                                :tDocPesqOra.sDsTipoPessoa:tDocPesqSTOra.sDsTipoPessoa,
                                :tDocPesqOra.sSgTipoPessoa:tDocPesqSTOra.sSgTipoPessoa;

        if( iNroObjLocal == iTotalLinhasPorPaginas )
        {
            iNroObjLocal++;
            break;
        }

        if (tDocPesqSTOra.sIdPessoa==-1)
        {
            break;
        }

        // Aloca memória para o objeto atual.
        if ((oObj = (CBuscaDocumentoPessoa*) realloc((void *)oObj,
                        (sizeof(CBuscaDocumentoPessoa) * (iNroObjLocal+1)))) != NULL)
        {
            oObj[iNroObjLocal].clear();

            // Coloca os dados do objeto atual.
            oObj[iNroObjLocal].setIdPessoa((char*)tDocPesqOra.sIdPessoa.arr);
            oObj[iNroObjLocal].setNmNome((char*)tDocPesqOra.sNmNome.arr);
            oObj[iNroObjLocal].setDsTipoDocumento((char*)tDocPesqOra.sDsTipoDocumento.arr);

            if(tDocPesqSTOra.sNrDocumento>=0)
            {
                oObj[iNroObjLocal].setNrDocumento((char*)tDocPesqOra.sNrDocumento.arr);
            }

            if(tDocPesqSTOra.sDsTipoPessoa>=0)
            {
                oObj[iNroObjLocal].setDsTipoPessoa((char*)tDocPesqOra.sDsTipoPessoa.arr);
            }

            if(tDocPesqSTOra.sSgTipoPessoa>=0)
            {
                oObj[iNroObjLocal].setSgTipoPessoa((char*)tDocPesqOra.sSgTipoPessoa.arr);
            }

            iNroObjLocal++;
        }
        else
        {
            if (oObj) { free(oObj); }

            EXEC SQL CLOSE cC2;
            ULOGE("ERRO DE MEMORIA -> NRO_MEMORIA");
            ULOG_END("CBuscaDocumentoPessoa::buscarDocPorTipDocumento()");
            throw TuxBasicSvcException(sNrMsg,MSG_MEMORIA);
        }
    }//for (;;)

    EXEC SQL CLOSE cC2;

    //Verifica se eh ou nao a ultima pagina
    if( oObj != NULL )
    {
        ULOG("Gravando o LOG iNroObjLocal[%d] > iTotalLinhasPorPaginas[%d]", iNroObjLocal, iTotalLinhasPorPaginas);
        if( iNroObjLocal > iTotalLinhasPorPaginas )
        {
            iNroObjLocal--;//Como contou um a mais para saber que eh ultima pagina, tem que tirar este um.
            oObj[0].setUltimaPagina(0);
        }
        else
        {
            oObj[0].setUltimaPagina(1);
        }
    }
    *iNroObjetos = iNroObjLocal;
    
    ULOG("iNroObjLocal=%d",iNroObjLocal);

    ULOG_END("CBuscaDocumentoPessoa::buscarDocPorTipDocumento()");
    return oObj;

    // Tratamento de erro - Lança excessão com o código oracle do erro.
    sqlErrorLista:
        ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
        ULOG_END("CBuscaDocumentoPessoa::buscarDocPorTipDocumento()");
        throw  new TuxBasicOraException(sqlca.sqlcode);
}


CBuscaDocumentoPessoa* CBuscaDocumentoPessoa::buscarDocPorNrLinha(int* iNroObjetos, char *pNrLin, char* cpageNumber)
{
    ULOG_START("CBuscaDocumentoPessoa::buscarDocPorNrLinha()");
    struct sqlca sqlca;

    CBuscaDocumentoPessoa* oObj = NULL;
    int iNroObjLocal = 0;

    int ipageNumber = atoi( cpageNumber );
    int iTotalLinhasPorPaginas = getTotalLinhasPorPagina();

    EXEC SQL BEGIN DECLARE SECTION;
        int iPaginaIni = (ipageNumber-1) * iTotalLinhasPorPaginas;
        int iPaginaFim = iTotalLinhasPorPaginas + ((ipageNumber-1) * iTotalLinhasPorPaginas);
        TDOCPESQUISADOS tDocPesqOra;
        TDOCPESQUISADOSST tDocPesqSTOra;
        char cOraDDD[3];
        char cOraFone[10];
    EXEC SQL END DECLARE SECTION;

    ULOG("iPaginaIni[%d] iPaginaFim[%d]", iPaginaIni, iPaginaFim );

    strncpy(cOraDDD, pNrLin, 2);
    cOraDDD[2]='\0';
    strcpy( cOraFone, (char*)&pNrLin[2] );

    // Marca ponto de controle de erro
    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;

    // Declara e abre o cursor
    EXEC SQL DECLARE cC3 CURSOR  FOR
    SELECT
        IDPESSOAORIGEM,
        NMPESSOA,
        DSTIPODOCUMENTO,
        NRDOCUMENTO,
        DSTIPOPESSOA,
        SGTIPOPESSOA,
        NRLINHA
    FROM
    (
        SELECT
            IDPESSOAORIGEM,
            NMPESSOA,
            DSTIPODOCUMENTO,
            NRDOCUMENTO,
            DSTIPOPESSOA,
            SGTIPOPESSOA,
            NRLINHA,
            ROWNUM AS LINHA
        FROM
        (
            SELECT
                   PESSOADEPARA.IDPESSOAORIGEM,
                   PESSOA.NMPESSOA,
                   TIPODOCUMENTO.DSTIPODOCUMENTO,
                   DOCUMENTO.NRDOCUMENTO,
                   TIPOPESSOA.DSTIPOPESSOA,
                   TIPOPESSOA.SGTIPOPESSOA,
                   LINHABASE.NRLINHA
              FROM LINHA.LINHABASE LINHABASE,
                   LINHA.LINHATELEFONICA LINHATELEFONICA,
                   CUSTOMER.PESSOALINHA PESSOALINHA,
                   CUSTOMER.PESSOADEPARA PESSOADEPARA,
                   CUSTOMER.PESSOA PESSOA,
                   CUSTOMER.PESSOADOCUMENTO PESSOADOCUMENTO,
                   CUSTOMER.DOCUMENTO DOCUMENTO,
                   APOIO.AREAREGISTRO AREAREGISTRO,
                   APOIO.TIPODOCUMENTO TIPODOCUMENTO,
                   APOIO.TIPOPESSOA TIPOPESSOA
             WHERE LINHABASE.IDLINHABASE = LINHATELEFONICA.IDLINHABASE
               AND LINHATELEFONICA.IDLINHATELEFONICA = PESSOALINHA.IDLINHATELEFONICA
               AND PESSOADEPARA.IDPESSOADEPARA = PESSOALINHA.IDPESSOADEPARA
               AND PESSOA.IDPESSOA = PESSOADEPARA.IDPESSOA
               AND PESSOA.IDPESSOA = PESSOADOCUMENTO.IDPESSOA
               AND DOCUMENTO.IDDOCUMENTO = PESSOADOCUMENTO.IDDOCUMENTO
               AND AREAREGISTRO.IDAREAREGISTRO = LINHABASE.IDAREAREGISTRO
               AND TIPODOCUMENTO.IDTIPODOCUMENTO = DOCUMENTO.IDTIPODOCUMENTO
               AND TIPOPESSOA.IDTIPOPESSOA = PESSOA.IDTIPOPESSOA
               AND TIPODOCUMENTO.NRPRIORIDADE =
               (
                    SELECT MIN(TIPODOCUMENTOA.NRPRIORIDADE)
                    FROM
						CUSTOMER.PESSOADOCUMENTO PESSOADOCUMENTOA,
                        CUSTOMER.DOCUMENTO DOCUMENTOA,
                        APOIO.TIPODOCUMENTO TIPODOCUMENTOA
                    WHERE PESSOA.IDPESSOA = PESSOADOCUMENTOA.IDPESSOA
                    AND DOCUMENTOA.IDDOCUMENTO = PESSOADOCUMENTOA.IDDOCUMENTO
                    AND DOCUMENTOA.IDTIPODOCUMENTO = TIPODOCUMENTOA.IDTIPODOCUMENTO
               )
               AND LINHABASE.NRLINHA           = :cOraFone
               AND AREAREGISTRO.CDAREAREGISTRO = :cOraDDD
               ORDER BY 2
        )
        WHERE
            ROWNUM <= :iPaginaFim+1
    )
    WHERE
        LINHA > :iPaginaIni;

    EXEC SQL OPEN cC3;

    EXEC SQL WHENEVER NOT FOUND DO BREAK;

    for (;;)
    {
        memset(&tDocPesqOra, 0x00, sizeof(tDocPesqOra));
        memset(&tDocPesqSTOra,-1,sizeof(tDocPesqSTOra));

        EXEC SQL FETCH cC3 INTO :tDocPesqOra.sIdPessoa:tDocPesqSTOra.sIdPessoa,
                                :tDocPesqOra.sNmNome:tDocPesqSTOra.sNmNome,
                                :tDocPesqOra.sDsTipoDocumento:tDocPesqSTOra.sDsTipoDocumento,
                                :tDocPesqOra.sNrDocumento:tDocPesqSTOra.sNrDocumento,
                                :tDocPesqOra.sDsTipoPessoa:tDocPesqSTOra.sDsTipoPessoa,
                                :tDocPesqOra.sSgTipoPessoa:tDocPesqSTOra.sSgTipoPessoa,
                                :tDocPesqOra.sNrLinha:tDocPesqSTOra.sNrLinha;

        if( iNroObjLocal == iTotalLinhasPorPaginas )
        {
            iNroObjLocal++;
            break;
        };

        if (tDocPesqSTOra.sIdPessoa==-1)
        {
            break;
        }

        // Aloca memória para o objeto atual.
        if ((oObj = (CBuscaDocumentoPessoa*) realloc((void *)oObj,
                        (sizeof(CBuscaDocumentoPessoa) * (iNroObjLocal+1)))) != NULL)
        {
            oObj[iNroObjLocal].clear();

            // Coloca os dados do objeto atual.
            if(tDocPesqSTOra.sIdPessoa>=0)
                oObj[iNroObjLocal].setIdPessoa((char*)tDocPesqOra.sIdPessoa.arr);

            if(tDocPesqSTOra.sNmNome>=0)
                oObj[iNroObjLocal].setNmNome((char*)tDocPesqOra.sNmNome.arr);

            if(tDocPesqSTOra.sDsTipoDocumento>=0)
                oObj[iNroObjLocal].setDsTipoDocumento((char*)tDocPesqOra.sDsTipoDocumento.arr);

            if(tDocPesqSTOra.sNrDocumento>=0)
                oObj[iNroObjLocal].setNrDocumento((char*)tDocPesqOra.sNrDocumento.arr);

            if(tDocPesqSTOra.sDsTipoPessoa>=0)
                oObj[iNroObjLocal].setDsTipoPessoa((char*)tDocPesqOra.sDsTipoPessoa.arr);

            if(tDocPesqSTOra.sSgTipoPessoa>=0)
                oObj[iNroObjLocal].setSgTipoPessoa((char*)tDocPesqOra.sSgTipoPessoa.arr);

            if(tDocPesqSTOra.sNrLinha>=0)
                oObj[iNroObjLocal].setNrLinha((char*)tDocPesqOra.sNrLinha.arr);

            iNroObjLocal++;
        }
        else
        {
            if (oObj) { free(oObj); }

            EXEC SQL CLOSE cC3;
            ULOGE("ERRO DE MEMORIA -> NRO_MEMORIA");
            ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNrLinha()");
            throw TuxBasicSvcException(sNrMsg,MSG_MEMORIA);
        }
    }

    EXEC SQL CLOSE cC3;

    //Verifica se eh ou nao a ultima pagina
    if( oObj != NULL )
    {
        ULOG("Gravando o LOG iNroObjLocal[%d] > iTotalLinhasPorPaginas[%d]", iNroObjLocal, iTotalLinhasPorPaginas);
        if( iNroObjLocal > iTotalLinhasPorPaginas )
        {
            oObj[0].setUltimaPagina(0);
            iNroObjLocal--;//Como contou um a mais para saber que eh ultima pagina, tem que tirar este um.
        }
        else
            oObj[0].setUltimaPagina(1);
    }
    *iNroObjetos = iNroObjLocal;
    ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNrLinha()");
    return oObj;

    // Tratamento de erro - Lança excessão com o código oracle do erro.
    sqlErrorLista:
        ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
        ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNrLinha()");
        throw  new TuxBasicOraException(sqlca.sqlcode);
}
int   CBuscaDocumentoPessoa::getIsProtocoloAtivo()
{
	return isProtocolo;
}

void   CBuscaDocumentoPessoa::setIsProtocoloAtivo(int iProtocolo)
{
	isProtocolo= (iProtocolo>=1)?1:0;
	
}

CBuscaDocumentoPessoa* CBuscaDocumentoPessoa::buscarDocPorNome(int* iNroObjetos, char *pPriNm, char *pSegNm, char *pTerNm, char* cpageNumber)
{
    ULOG_START("CBuscaDocumentoPessoa::buscarDocPorNome()");
    struct sqlca sqlca;
    CBuscaDocumentoPessoa* oObj = NULL;
    int iNroObjLocal = 0;

    int ipageNumber = atoi( cpageNumber );
    int iTotalLinhasPorPaginas = getTotalLinhasPorPagina();

    char cPaginaIni[10+1];
    char cPaginaFim[10+1];

    memset( &cPaginaIni, 0, sizeof( cPaginaIni ) );
    memset( &cPaginaFim, 0, sizeof( cPaginaFim ) );

    EXEC SQL BEGIN DECLARE SECTION;
        int iPaginaIni = (ipageNumber-1) * iTotalLinhasPorPaginas;
        int iPaginaFim = iTotalLinhasPorPaginas + ((ipageNumber-1) * iTotalLinhasPorPaginas);
        //typedef struct
        //{
        //    char sIdPessoa[LEN_NUMBER+LEN_EOS];
        //    char sNmNome[LEN_NOME+LEN_EOS];
        //    char sIdTipoPessoa[LEN_NUMBER+LEN_EOS];
        //    char sDsTipoDocumento[LEN_NUMBER+LEN_EOS];
        //    char sIdDocumento[LEN_NUMBER+LEN_EOS];
        //    char sSgTipoPessoa[LEN_DSTIPOPESSOA+LEN_EOS];
        //    char sNrDocumento[LEN_NRDOCUMENTO+LEN_EOS];
        //    char sDsTipoPessoa[LEN_DSTIPOPESSOA+LEN_EOS];
        //
        //    //Nulls
        //    short *iIdPessoa_ora;
        //    short *iNmNome_ora;
        //    short *iIdTipoPessoa_ora;
        //    short *iDsTipoDocumento_ora;
        //    short *iIdDocumento_ora;
        //    short *iSgTipoPessoa_ora;
        //    short *iNrDocumento_ora;
        //    short *iDsTipoPessoa_ora;
        //
        //    long lRowToFetch;
        //    long lRowRecords;
        //}TDADOPRINCIPAL;

        char cPriNm[255+1];
        char cSegNm[255+1];
        char cTerNm[255+1];

        //TDADOPRINCIPAL sDados;
        TDOCPESQUISADOS sDados;
        TDOCPESQUISADOSST sStatus;

        VARCHAR sClausula1[(LEN_NMPESSOA*3)+1+LEN_EOS];
        char cPesquisa[1000];
    EXEC SQL END DECLARE SECTION;

    ULOG("iPaginaIni[%d] iPaginaFim[%d]", iPaginaIni, iPaginaFim );

    sprintf( cPaginaIni, "%d", iPaginaIni );
    sprintf( cPaginaFim, "%d", iPaginaFim+1 );

    memset(&sDados, 0, sizeof(sDados));
    memset(&sStatus, -1, sizeof(sStatus));
    memset(&sClausula1, 0, sizeof(sClausula1));
    memset(&cPesquisa, 0, sizeof(cPesquisa));
    memset(&cPriNm, 0, sizeof(cPriNm));
    memset(&cSegNm, 0, sizeof(cSegNm));
    memset(&cTerNm, 0, sizeof(cTerNm));

    if( STRLENNULL( pPriNm ) > 0 )
    {
        strcpy( cPriNm, pPriNm );
        strcat( cPriNm, "%" );
        upper(cPriNm);
    }
    if( STRLENNULL( pSegNm ) > 0 )
    {
        if( STRLENNULL( pPriNm ) <= 0 )
        {
            strcpy( cSegNm, "%" );
            strcat( cSegNm, pSegNm );
        }
        else
            strcpy( cSegNm, pSegNm );
        strcat( cSegNm, "%" );
        upper(cSegNm);
    }
    if( STRLENNULL( pTerNm ) > 0 )
    {
        strcpy( cTerNm, pTerNm );
        strcat( cTerNm, "%" );
        upper(cTerNm);
    }

    try{
        //Esta pesquisa ficou limitada em 150 caracteres por questoes de velocidade
        strcpy( cPesquisa,
        " SELECT"
            " IDPESSOA,"
            " NMPESSOA,"
            " IDTIPOPESSOA,"
            " ( SELECT DSTIPOPESSOA FROM APOIO.TIPOPESSOA WHERE SGTIPOPESSOA = 'PF' ) AS DSTIPOPESSOA,"
            " ( SELECT SGTIPOPESSOA FROM APOIO.TIPOPESSOA WHERE SGTIPOPESSOA = 'PF' ) AS SGTIPOPESSOA "
        " FROM ( "
            " SELECT /*+ INDEX (PESSOA PESSOAIE1) */"
                " PESSOA.IDPESSOA,"
                " PESSOA.NMPESSOA,"
                " PESSOA.IDTIPOPESSOA,"
                " ROWNUM AS LINHA"
            " FROM"
                " CUSTOMER.PESSOA PESSOA"
            " WHERE"
                " PESSOA.IDTIPOPESSOA = ( SELECT IDTIPOPESSOA FROM APOIO.TIPOPESSOA WHERE SGTIPOPESSOA = 'PF' )" );
            if( STRLENNULL( cPriNm ) > 0 )
            {
                strcat( cPesquisa,
            " AND"
                " UPPER(PESSOA.NMNOME) LIKE '" );
                strcat( cPesquisa, cPriNm );
                strcat( cPesquisa, "'" );
            }
            if( STRLENNULL( cSegNm ) > 0 )
            {
                strcat( cPesquisa,
            " AND"
                " UPPER(PESSOA.NMNOMEMEIO) LIKE '" );
                strcat( cPesquisa, cSegNm );
                strcat( cPesquisa, "'" );
            }
            if( STRLENNULL( cTerNm ) > 0 )
            {
                strcat( cPesquisa,
            " AND"
                " UPPER(PESSOA.NMSOBRENOME) LIKE '" );
                strcat( cPesquisa, cTerNm );
                strcat( cPesquisa, "'" );
            }
            strcat( cPesquisa,
            " AND"
                " ROWNUM <= " );

            strcat( cPesquisa, cPaginaFim );

        strcat( cPesquisa,
        ") WHERE "
            " LINHA > " );
        strcat( cPesquisa, cPaginaIni );

        ULOG( "CBuscaDocumentoPessoa::buscarDocPorNome[%s]", cPesquisa );

        EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;
        EXEC SQL WHENEVER NOT FOUND CONTINUE;
        EXEC SQL PREPARE qPesquisa FROM :cPesquisa;
        EXEC SQL DECLARE cMastersPF CURSOR FOR qPesquisa;
        EXEC SQL OPEN cMastersPF;

        for(;;)
        {
            memset( &sDados, 0, sizeof( sDados ) );
            memset( &sStatus, -1, sizeof( sStatus ) );

            EXEC SQL WHENEVER NOT FOUND DO BREAK;
            EXEC SQL
            FETCH
                cMastersPF
            INTO
                :sDados.sIdPessoa:sStatus.sIdPessoa,
                :sDados.sNmNome:sStatus.sNmNome,
                :sDados.sIdTipoPessoa:sStatus.sIdTipoPessoa,
                :sDados.sDsTipoPessoa:sStatus.sDsTipoPessoa,
                :sDados.sSgTipoPessoa:sStatus.sSgTipoPessoa;

            if( iNroObjLocal == iTotalLinhasPorPaginas )
            {
                iNroObjLocal++;
                break;
            }

            EXEC SQL WHENEVER NOT FOUND CONTINUE;

            EXEC SQL
            SELECT DISTINCT
                D.DSTIPODOCUMENTO,
                C.NRDOCUMENTO
            INTO
                :sDados.sDsTipoDocumento:sStatus.sDsTipoDocumento,
                :sDados.sNrDocumento:sStatus.sNrDocumento
            FROM
                CUSTOMER.PESSOA A,
                CUSTOMER.PESSOADOCUMENTO B,
                CUSTOMER.DOCUMENTO C,
                APOIO.TIPODOCUMENTO D
            WHERE B.IDDOCUMENTO = C.IDDOCUMENTO
            AND C.IDTIPODOCUMENTO = D.IDTIPODOCUMENTO
            AND A.IDTIPOPESSOA   = TO_NUMBER(:sDados.sIdTipoPessoa)
            AND A.IDPESSOA = B.IDPESSOA
            AND B.IDPESSOA IN
            (
                SELECT PDP.IDPESSOAORIGEM
                FROM CUSTOMER.PESSOADEPARA PDP
                WHERE PDP.IDPESSOA = TO_NUMBER(:sDados.sIdPessoa)
            )
            AND ROWNUM < 2;

            if ((oObj = (CBuscaDocumentoPessoa*) realloc((void *)oObj,
                            (sizeof(CBuscaDocumentoPessoa) * (iNroObjLocal+1)))) != NULL)
            {
                oObj[iNroObjLocal].clear();
                oObj[iNroObjLocal].setIdPessoa(sStatus.sIdPessoa == 0?rtrim((char*)sDados.sIdPessoa.arr):"");
                oObj[iNroObjLocal].setNmNome(sStatus.sNmNome == 0?rtrim((char*)sDados.sNmNome.arr):"");
                oObj[iNroObjLocal].setDsTipoDocumento(sStatus.sDsTipoDocumento == 0?rtrim((char*)sDados.sDsTipoDocumento.arr):"");
                oObj[iNroObjLocal].setNrDocumento(sStatus.sNrDocumento == 0?rtrim((char*)sDados.sNrDocumento.arr):"");
                oObj[iNroObjLocal].setDsTipoPessoa(sStatus.sDsTipoPessoa == 0?rtrim((char*)sDados.sDsTipoPessoa.arr):"");
                oObj[iNroObjLocal].setSgTipoPessoa(sStatus.sSgTipoPessoa == 0?rtrim((char*)sDados.sSgTipoPessoa.arr):"");

                iNroObjLocal++;
            }
            else
            {
                if (oObj) { free(oObj); }
            }

        }//for(;;)

        EXEC SQL CLOSE cMastersPF;

        //Verifica se eh ou nao a ultima pagina
        if( oObj != NULL )
        {
            ULOG("Gravando o LOG iNroObjLocal[%d] > iTotalLinhasPorPaginas[%d]", iNroObjLocal, iTotalLinhasPorPaginas);
            if( iNroObjLocal > iTotalLinhasPorPaginas )
            {
                oObj[0].setUltimaPagina(0);
                iNroObjLocal--;//Como contou um a mais para saber que eh ultima pagina, tem que tirar este um.
            }
            else
            {
                oObj[0].setUltimaPagina(1);
            }
        }
        *iNroObjetos = iNroObjLocal;

        ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNome()");
        return oObj;

        // Tratamento de erro - Lança excessão com o código oracle do erro.
        sqlErrorLista:
            ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
            ULOG_END("CBuscaDocumentoPessoa::buscarDocPorNome()");
            throw  new TuxBasicOraException(sqlca.sqlcode);
    }
    catch(...){
        throw;
    }
}


int CBuscaDocumentoPessoa::getTotalLinhasPorPagina( void )
{
    ULOG_START("CBuscaDocumentoPessoa::getTotalLinhasPorPagina()");
    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int iTotalPorPagina = 0;
        short sTotalPorPagina = -1;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;
    EXEC SQL WHENEVER NOT FOUND CONTINUE;

    EXEC SQL
    SELECT
        DSVALORPARAMETRO
    INTO
        iTotalPorPagina:sTotalPorPagina
    FROM
        APOIO.PARAMETRO
    WHERE
        CDPARAMETRO = 'LINHAS_POR_PAGINA_PESQUISA_PESSOA';

    ULOG("APOIO.PARAMETRO.DSVALORPARAMETRO=LINHAS_POR_PAGINA_PESQUISA_PESSOA[%d]", iTotalPorPagina );
    ULOG_END("CBuscaDocumentoPessoa::getTotalLinhasPorPagina()");

    if( iTotalPorPagina <= 0 )
        throw "APOIO.PARAMETRO.DSVALORPARAMETRO=LINHAS_POR_PAGINA_PESQUISA_PESSOA não encontrado";

    return iTotalPorPagina;

// Tratamento de erro - Lança excessão com o código oracle do erro.
sqlErrorLista:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("CBuscaDocumentoPessoa::getTotalLinhasPorPagina()");
    throw  new TuxBasicOraException(sqlca.sqlcode);
}


CBuscaDocumentoPessoa* CBuscaDocumentoPessoa::buscarNrLinhaPorProtocolo(int* iNroObjetos, char *pNrProtocolo, char* cpageNumber)
{
    ULOG_START("CBuscaDocumentoPessoa::buscarNrLinhaPorProtocolo()");
    struct sqlca sqlca;

    CBuscaDocumentoPessoa* oObj = NULL;
    int iNroObjLocal = 0;

    int ipageNumber = atoi( cpageNumber );

    EXEC SQL BEGIN DECLARE SECTION;
        
        char nrTelefoneAux[16];
        
        int iTotalLinhasPorPaginas = getTotalLinhasPorPagina();
        VARCHAR sgSistemaOrigem[256];
        short i_sgSistemaOrigem = -1;

        struct
        {
            VARCHAR idAtendimentoProtocolo[39];
            VARCHAR nrDDDTelefone[15];
            VARCHAR cdAreaRegistro[5];
            VARCHAR nrTelefone[10];
            VARCHAR idPessoaDePara[39];
            VARCHAR cdConta[101];
            VARCHAR idLinhaTelefonica[39];
            VARCHAR idTipoAberturaProtocolo[2];
            int inProtocoloAtivo;
        } dadoOraDadosProtocolo;

        struct
        {
            short idAtendimentoProtocolo;
            short nrDDDTelefone;
            short cdAreaRegistro;
            short nrTelefone;
            short idPessoaDePara;
            short cdConta;
            short idLinhaTelefonica;
            short idTipoAberturaProtocolo;
            short inProtocoloAtivo;
        } statOraDadosProtocolo;

        //int iPaginaIni = (ipageNumber-1) * iTotalLinhasPorPaginas;
        //int iPaginaFim = iTotalLinhasPorPaginas + ((ipageNumber-1) * iTotalLinhasPorPaginas);
        //int iPrototcoloAtivo=0;
        TDOCPESQUISADOSOLD      tST;
        const char *cOraNrProtocolo = pNrProtocolo;
        const char *pOraQuery;
    EXEC SQL END DECLARE SECTION;
    
    memset( &sgSistemaOrigem, 0x0, sizeof(sgSistemaOrigem) );
    memset( nrTelefoneAux, 0x0, sizeof(nrTelefoneAux) );

    //ULOG("iPaginaIni[%d] iPaginaFim[%d]", iPaginaIni, iPaginaFim );
    ULOG("pNrProtocolo[%s]", pNrProtocolo);

    // Marca ponto de controle de erro
    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;

    EXEC SQL WHENEVER NOT FOUND CONTINUE;

    memset(&dadoOraDadosProtocolo,0,sizeof(dadoOraDadosProtocolo));
    memset(&statOraDadosProtocolo,-1,sizeof(statOraDadosProtocolo));

    EXEC SQL
        SELECT
             ESTADOATDPROTOCOLOV01.IDATENDIMENTOPROTOCOLO
            ,ESTADOATDPROTOCOLOV01.CDAREAREGISTRO||ESTADOATDPROTOCOLOV01.NRTELEFONE AS NRDDDTELEFONE
            ,ESTADOATDPROTOCOLOV01.CDAREAREGISTRO
            ,ESTADOATDPROTOCOLOV01.NRTELEFONE
            ,ESTADOATDPROTOCOLOV01.IDPESSOADEPARA
            ,ESTADOATDPROTOCOLOV01.CDCONTA
            ,ESTADOATDPROTOCOLOV01.IDLINHATELEFONICA
            ,ESTADOATDPROTOCOLOV01.IDTIPOABERTURAPROTOCOLO
            ,DECODE(ESTADOATDPROTOCOLOV01.DSSTATUSPROTOCOLO,'Em Atendimento',1,0) INPROTOCOLOATIVO
        INTO
            :dadoOraDadosProtocolo:statOraDadosProtocolo
        FROM
            ATENDIMENTO.ESTADOATENDIMENTOPROTOCOLOV01 ESTADOATDPROTOCOLOV01
        WHERE
            ESTADOATDPROTOCOLOV01.IDATENDIMENTOPROTOCOLO = :cOraNrProtocolo;

    
    if ( 0==sqlca.sqlcode )
    {
        CONVIND(dadoOraDadosProtocolo.idAtendimentoProtocolo,statOraDadosProtocolo.idAtendimentoProtocolo);
        CONVIND(dadoOraDadosProtocolo.nrDDDTelefone,statOraDadosProtocolo.nrDDDTelefone);
        CONVIND(dadoOraDadosProtocolo.cdAreaRegistro,statOraDadosProtocolo.cdAreaRegistro);
        CONVIND(dadoOraDadosProtocolo.nrTelefone,statOraDadosProtocolo.nrTelefone);
        CONVIND(dadoOraDadosProtocolo.idPessoaDePara,statOraDadosProtocolo.idPessoaDePara);
        CONVIND(dadoOraDadosProtocolo.cdConta,statOraDadosProtocolo.cdConta);
        CONVIND(dadoOraDadosProtocolo.idLinhaTelefonica,statOraDadosProtocolo.idLinhaTelefonica);
        CONVIND(dadoOraDadosProtocolo.idTipoAberturaProtocolo,statOraDadosProtocolo.idTipoAberturaProtocolo);

	    EXEC SQL
		SELECT TRIM(UPPER(sistemaorigem.sgsistemaorigem))
		  INTO :sgSistemaOrigem:i_sgSistemaOrigem
		  FROM atendimento.atendimentoprotocolo atendimentoprotocolo,
		       apoio.sistemaorigem sistemaorigem
		 WHERE idatendimentoprotocolo = :cOraNrProtocolo
		   AND sistemaorigem.idsistemaorigem = atendimentoprotocolo.idsistemaorigem
		   AND ROWNUM < 2;
		
		CONVIND(sgSistemaOrigem,i_sgSistemaOrigem);
		
		if ( dadoOraDadosProtocolo.inProtocoloAtivo == 1 )
		{
			if ( !strcmp((char*)sgSistemaOrigem.arr,"URA") || !strcmp((char*)sgSistemaOrigem.arr,"SCRPOP") || !strcmp((char*)sgSistemaOrigem.arr,"FO") )
			{
				dadoOraDadosProtocolo.inProtocoloAtivo = 1;
			}
			else
			{
				dadoOraDadosProtocolo.inProtocoloAtivo = 0;
			}
		}
	    
        ULOG(" idAtendimentoProtocolo=%+d:%s",statOraDadosProtocolo.idAtendimentoProtocolo,dadoOraDadosProtocolo.idAtendimentoProtocolo.arr);
        ULOG("          nrDDDTelefone=%+d:%s",statOraDadosProtocolo.nrDDDTelefone,dadoOraDadosProtocolo.nrDDDTelefone.arr);
        ULOG("         cdAreaRegistro=%+d:%s",statOraDadosProtocolo.cdAreaRegistro,dadoOraDadosProtocolo.cdAreaRegistro.arr);
        ULOG("             nrTelefone=%+d:%s",statOraDadosProtocolo.nrTelefone,dadoOraDadosProtocolo.nrTelefone.arr);
        ULOG("         idPessoaDePara=%+d:%s",statOraDadosProtocolo.idPessoaDePara,dadoOraDadosProtocolo.idPessoaDePara.arr);
        ULOG("                cdConta=%+d:%s",statOraDadosProtocolo.cdConta,dadoOraDadosProtocolo.cdConta.arr);
        ULOG("      idLinhaTelefonica=%+d:%s",statOraDadosProtocolo.idLinhaTelefonica,dadoOraDadosProtocolo.idLinhaTelefonica.arr);
        ULOG("idTipoAberturaProtocolo=%+d:%s",statOraDadosProtocolo.idTipoAberturaProtocolo,dadoOraDadosProtocolo.idTipoAberturaProtocolo.arr);
        ULOG("       inProtocoloAtivo=%+d:%d",statOraDadosProtocolo.inProtocoloAtivo,dadoOraDadosProtocolo.inProtocoloAtivo);
        
        // Chamado 20287278
        sprintf( nrTelefoneAux, "%s", (char*)&dadoOraDadosProtocolo.nrDDDTelefone.arr );
        ULOG( "nrTelefoneAux [%s]", nrTelefoneAux);

        string whereCl;
        string openCl;

           if ( dadoOraDadosProtocolo.idLinhaTelefonica.arr[0] )
           {
               openCl = " FROM "
                     "LINHA.LINHATELEFONICA LINHATELEFONICA"
                    ",LINHA.LINHABASE LINHABASE"
                    ",CUSTOMER.PESSOALINHA PESSOALINHA"
                    ",CUSTOMER.PESSOA PESSOA"
                    ",CUSTOMER.PESSOADEPARA PESSOADEPARA"
                    ",APOIO.TIPOPESSOA TIPOPESSOA"
                    ",APOIO.ESTADOLINHA ESTADOLINHA"
                    ",APOIO.AREAREGISTRO AREAREGISTRO";

                whereCl = " WHERE "
                       "LINHATELEFONICA.IDLINHATELEFONICA = "+(string)(char*)dadoOraDadosProtocolo.idLinhaTelefonica.arr+
                  "  AND LINHATELEFONICA.IDLINHABASE = LINHABASE.IDLINHABASE "
                   "AND LINHABASE.IDAREAREGISTRO = AREAREGISTRO.IDAREAREGISTRO "
                   "AND LINHATELEFONICA.IDLINHATELEFONICA = PESSOALINHA.IDLINHATELEFONICA "
                   "AND NVL(LINHATELEFONICA.DTEXPIRACAO,SYSDATE+1) > SYSDATE "
                   "AND LINHABASE.IDESTADOLINHA = ESTADOLINHA.IDESTADOLINHA "
                   "AND NVL(ESTADOLINHA.INLINHACANCELADA,0) = 0 "
                   "AND PESSOALINHA.IDPESSOADEPARA = PESSOADEPARA.IDPESSOADEPARA "
                   "AND PESSOALINHA.IDTIPORELACIONAMENTO = 2 "
                   "AND PESSOADEPARA.IDPESSOA = PESSOA.IDPESSOA "
                   "AND PESSOA.IDTIPOPESSOA = TIPOPESSOA.IDTIPOPESSOA ";
           }
           else if ( dadoOraDadosProtocolo.idPessoaDePara.arr[0] )
           {
               openCl = " FROM "
                    "LINHA.LINHABASE LINHABASE"
                    ",LINHA.LINHATELEFONICA LINHATELEFONICA"
                    ",CUSTOMER.PESSOA PESSOA"
                    ",CUSTOMER.PESSOADEPARA PESSOADEPARA"
                    ",CUSTOMER.PESSOALINHA PESSOALINHA"
                    ",APOIO.TIPOPESSOA TIPOPESSOA"
                    ",APOIO.AREAREGISTRO AREAREGISTRO";

                whereCl = " WHERE "
                    "PESSOADEPARA.IDPESSOADEPARA = "+(string)(char*)dadoOraDadosProtocolo.idPessoaDePara.arr+
                    " AND PESSOADEPARA.IDPESSOA = PESSOA.IDPESSOA(+) "
                    "AND PESSOA.IDTIPOPESSOA = TIPOPESSOA.IDTIPOPESSOA(+) "
                    "AND PESSOADEPARA.IDPESSOADEPARA = PESSOALINHA.IDPESSOADEPARA(+) "
                    "AND PESSOALINHA.IDTIPORELACIONAMENTO (+)= 2 "
                    "AND PESSOALINHA.IDLINHATELEFONICA = LINHATELEFONICA.IDLINHATELEFONICA(+) "
                    "AND LINHATELEFONICA.IDLINHABASE = LINHABASE.IDLINHABASE(+) "
                    "AND LINHABASE.IDAREAREGISTRO = AREAREGISTRO.IDAREAREGISTRO(+)";
           }
           else if ( dadoOraDadosProtocolo.nrTelefone.arr[0] )
           {
               openCl = " FROM "
                    "LINHA.LINHABASE LINHABASE"
                    ",LINHA.LINHATELEFONICA LINHATELEFONICA"
                    ",CUSTOMER.PESSOA PESSOA"
                    ",CUSTOMER.PESSOADEPARA PESSOADEPARA"
                    ",CUSTOMER.PESSOALINHA PESSOALINHA"
                    ",APOIO.TIPOPESSOA TIPOPESSOA"
                    ",APOIO.AREAREGISTRO AREAREGISTRO";

                /*   Chamado 20286500
                whereCl = " WHERE "
                    "LINHABASE.NRLINHA (+)="+(string)(char*)dadoOraDadosProtocolo.nrTelefone.arr+
                    " AND AREAREGISTRO.CDAREAREGISTRO (+)= "+(string)(char*)dadoOraDadosProtocolo.cdAreaRegistro.arr+
                    "AND LINHABASE.IDLINHABASE = LINHATELEFONICA.IDLINHABASE(+) "
                    "AND LINHATELEFONICA.IDLINHATELEFONICA = PESSOALINHA.IDLINHATELEFONICA(+) "
                    "AND PESSOALINHA.IDTIPORELACIONAMENTO (+)= 2 "
                    "AND PESSOALINHA.IDPESSOADEPARA = PESSOADEPARA.IDPESSOADEPARA(+) "
                    "AND PESSOADEPARA.IDPESSOA = PESSOA.IDPESSOA(+) "
                    "AND PESSOA.IDTIPOPESSOA = TIPOPESSOA.IDTIPOPESSOA(+) ";
                */

                whereCl = " WHERE "
                    "LINHABASE.NRLINHA = "+(string)(char*)dadoOraDadosProtocolo.nrTelefone.arr+
                    " AND AREAREGISTRO.CDAREAREGISTRO = "+(string)(char*)dadoOraDadosProtocolo.cdAreaRegistro.arr+
                    "AND LINHABASE.IDLINHABASE = LINHATELEFONICA.IDLINHABASE "
                    "AND LINHATELEFONICA.IDLINHATELEFONICA = PESSOALINHA.IDLINHATELEFONICA "
                    "AND PESSOALINHA.IDTIPORELACIONAMENTO = 2 "
                    "AND PESSOALINHA.IDPESSOADEPARA = PESSOADEPARA.IDPESSOADEPARA "
                    "AND PESSOADEPARA.IDPESSOA = PESSOA.IDPESSOA "
                    "AND PESSOA.IDTIPOPESSOA = TIPOPESSOA.IDTIPOPESSOA "
                    "AND LINHABASE.IDAREAREGISTRO = AREAREGISTRO.IDAREAREGISTRO ";
           }
           else if ( dadoOraDadosProtocolo.cdConta.arr[0] )
           {
               openCl = " FROM "
                     "CUSTOMER.CONTA CONTA"
                    ",CUSTOMER.PESSOA PESSOA"
                    ",CUSTOMER.PESSOACONTA PESSOACONTA"
                    ",CUSTOMER.PESSOADEPARA PESSOADEPARA"
                    ",CUSTOMER.PESSOALINHA PESSOALINHA"
                    ",LINHA.LINHABASE LINHABASE"
                    ",LINHA.LINHATELEFONICA LINHATELEFONICA"
                    ",APOIO.ESTADOLINHA ESTADOLINHA"
                    ",APOIO.AREAREGISTRO AREAREGISTRO"
                    ",APOIO.TIPOPESSOA TIPOPESSOA";

                whereCl = " WHERE "
                       "CONTA.CDCONTA = '"+(string)(char*)dadoOraDadosProtocolo.cdConta.arr+
                   "' AND CONTA.IDCONTA = PESSOACONTA.IDCONTA "
                   "AND PESSOACONTA.IDPESSOADEPARA = PESSOADEPARA.IDPESSOADEPARA "
                   "AND PESSOADEPARA.IDPESSOA = PESSOA.IDPESSOA "
                   "AND PESSOA.IDTIPOPESSOA = TIPOPESSOA.IDTIPOPESSOA "
                   "AND NVL(PESSOACONTA.DTEXPIRACAO,SYSDATE+1) > SYSDATE "
                   "AND NVL(LINHATELEFONICA.DTEXPIRACAO,SYSDATE+1) > SYSDATE "
                   "AND PESSOADEPARA.IDPESSOADEPARA = PESSOALINHA.IDPESSOADEPARA(+) "
                   "AND PESSOALINHA.IDLINHATELEFONICA = LINHATELEFONICA.IDLINHATELEFONICA(+) "
                   "AND LINHATELEFONICA.IDLINHABASE = LINHABASE.IDLINHABASE(+) "
                   "AND LINHABASE.IDESTADOLINHA = ESTADOLINHA.IDESTADOLINHA(+) "
                   "AND LINHABASE.IDAREAREGISTRO = AREAREGISTRO.IDAREAREGISTRO(+) "
                   "AND NVL(ESTADOLINHA.INLINHACANCELADA,0)=0";
           }

        if ( openCl.size() > 0 )
        {
            string query =
               "SELECT DISTINCT "
                 "NVL(PESSOA.IDPESSOA,26) AS IDPESSOA,"
                 "NVL(PESSOA.NMPESSOA,'Não cliente') AS NMPESSOA,"
                 "NVL(TIPOPESSOA.DSTIPOPESSOA,'PESSOA FÍSICA') AS DSTIPOPESSOA,"
                 "AREAREGISTRO.CDAREAREGISTRO||LINHABASE.NRLINHA AS NRTELEFONE,"
                 "DECODE(LINHATELEFONICA.IDLINHATELEFONICA,NULL,'N','C') AS SGTIPORELACIONAMENTO " 
                                               + openCl + whereCl;

            pOraQuery = query.c_str();

            ULOG("query=%s",pOraQuery);

            EXEC SQL PREPARE DadosProtocolo FROM :pOraQuery;
            EXEC SQL DECLARE cC4 CURSOR FOR DadosProtocolo;

            EXEC SQL OPEN cC4;

            EXEC SQL WHENEVER NOT FOUND DO BREAK;

            oObj = (CBuscaDocumentoPessoa*) malloc(sizeof(CBuscaDocumentoPessoa)*iTotalLinhasPorPaginas);
            memset(oObj,0,sizeof(CBuscaDocumentoPessoa)*iTotalLinhasPorPaginas);

            if ( 0==oObj )
            {
                ULOGE("ERRO DE MEMORIA -> NRO_MEMORIA");
                ULOG_END("CBuscaDocumentoPessoa::buscarNrLinhaPorProtocolo()");
                throw TuxBasicSvcException(sNrMsg,MSG_MEMORIA);
            }

            for(;;)
            {
                memset(&tST, 0x00, sizeof(tST));

                EXEC SQL FETCH cC4 INTO :tST.sIdPessoa:tST.iIdPessoa_ora,
                                        :tST.sNmNome:tST.iNmNome_ora,
                                        :tST.sDsTipoPessoa:tST.iDsTipoPessoa_ora,
                                        :tST.sNrLinha:tST.iNrLinha_ora,
                                        :tST.sSgTipoRelacionamento:tST.iSgTipoRelacionamento_ora;

                if( iNroObjLocal == iTotalLinhasPorPaginas )
                {
                    iNroObjLocal++;
                    break;
                }

                // Chamado 20287278
                ULOG( "iNroObjLocal  [%d]", iNroObjLocal );
                ULOG( "nrTelefoneAux [%s]", nrTelefoneAux );
                oObj[iNroObjLocal].setNrLinha(nrTelefoneAux);
                
                ULOG("            idPessoa %+d:%s",tST.iIdPessoa_ora            ,tST.sIdPessoa.arr);
                ULOG("              nmNome %+d:%s",tST.iNmNome_ora              ,tST.sNmNome.arr);
                ULOG("        dsTipoPessoa %+d:%s",tST.iDsTipoPessoa_ora        ,tST.sDsTipoPessoa.arr);
                ULOG("             nrLinha %+d:%s",tST.iNrLinha_ora             ,tST.sNrLinha.arr);
                ULOG("sgTipoRelacionamento %+d:%s",tST.iSgTipoRelacionamento_ora,tST.sSgTipoRelacionamento.arr);

                // Coloca os dados do objeto atual.
                if(tST.iIdPessoa_ora>=0)
                    oObj[iNroObjLocal].setIdPessoa((char*)tST.sIdPessoa.arr);

                if(tST.iNmNome_ora>=0)
                    oObj[iNroObjLocal].setNmNome((char*)tST.sNmNome.arr);

                if(tST.iDsTipoPessoa_ora>=0)
                    oObj[iNroObjLocal].setDsTipoPessoa((char*)tST.sDsTipoPessoa.arr);

                if(tST.iNrLinha_ora>=0)
                {
                    oObj[iNroObjLocal].setNrLinha((char*)tST.sNrLinha.arr);
                }
                else if (strcmp((char*)dadoOraDadosProtocolo.idTipoAberturaProtocolo.arr,TIPO_ABER_PROT_PESSOA) &&
                         dadoOraDadosProtocolo.nrDDDTelefone.arr[0] )
                {
                    oObj[iNroObjLocal].setNrLinha((char*)dadoOraDadosProtocolo.nrDDDTelefone.arr);
                }

			    if(tST.iSgTipoRelacionamento_ora>=0)
                    oObj[iNroObjLocal].setSgTipoRelacionamento((char*)tST.sSgTipoRelacionamento.arr);
                else
                    oObj[iNroObjLocal].setSgTipoRelacionamento("N");

			    oObj[iNroObjLocal].setIsProtocoloAtivo(dadoOraDadosProtocolo.inProtocoloAtivo);

                iNroObjLocal++;
            }

            EXEC SQL CLOSE cC4;

            if ( 0 == iNroObjLocal )
            {
                ULOG("Dados da linha não encontrados. Retornando como NÃO CLIENTE");

                oObj[iNroObjLocal].setIdPessoa("26");
                oObj[iNroObjLocal].setNmNome("Não cliente");
                oObj[iNroObjLocal].setDsTipoPessoa("PESSOA FÍSICA");
                oObj[iNroObjLocal].setSgTipoRelacionamento("N");
			    oObj[iNroObjLocal].setIsProtocoloAtivo(dadoOraDadosProtocolo.inProtocoloAtivo);

                if (strcmp((char*)dadoOraDadosProtocolo.idTipoAberturaProtocolo.arr,TIPO_ABER_PROT_PESSOA)
                   && dadoOraDadosProtocolo.nrDDDTelefone.arr[0] )
                {
                    oObj[iNroObjLocal].setNrLinha((char*)dadoOraDadosProtocolo.nrDDDTelefone.arr);
                }

                iNroObjLocal++;
            }

        } // if ( openCl.size() > 0 )
        else
        {
            ULOG("Protocolo não possui dados suficientes para montar uma pesquisa");
        }

    } // if ( 0==sqlca.sqlcode )
    else
    {
        ULOG("Protocolo informado não existe");
    }

    //Verifica se eh ou nao a ultima pagina
    if( oObj != NULL )
    {
        ULOG("Gravando o LOG iNroObjLocal[%d] > iTotalLinhasPorPaginas[%d]", iNroObjLocal, iTotalLinhasPorPaginas);
        if( iNroObjLocal > iTotalLinhasPorPaginas )
        {
            oObj[0].setUltimaPagina(0);
            iNroObjLocal--;//Como contou um a mais para saber que eh ultima pagina, tem que tirar este um.
        }
        else
        {
            oObj[0].setUltimaPagina(1);
        }
    }
    *iNroObjetos = iNroObjLocal;
    ULOG_END("CBuscaDocumentoPessoa::buscarNrLinhaPorProtocolo()");
    return oObj;

    // Tratamento de erro - Lança excessão com o código oracle do erro.
    sqlErrorLista:
        ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
        ULOG_END("CBuscaDocumentoPessoa::buscarNrLinhaPorProtocolo()");
        throw  new TuxBasicOraException(sqlca.sqlcode);
}

CBuscaDocumentoPessoa* CBuscaDocumentoPessoa::buscarProspect(int* iNroObjetos, char *pNrProtocolo, char* cpageNumber)
{
    ULOG_START("CBuscaDocumentoPessoa::buscarProspect()");
    struct sqlca sqlca;

    CBuscaDocumentoPessoa* oObj = NULL;
    int iNroObjLocal = 0;

    int ipageNumber = atoi( cpageNumber );
    int iTotalLinhasPorPaginas = getTotalLinhasPorPagina();

    EXEC SQL BEGIN DECLARE SECTION;
        int iPaginaIni = (ipageNumber-1) * iTotalLinhasPorPaginas;
        int iPaginaFim = iTotalLinhasPorPaginas + ((ipageNumber-1) * iTotalLinhasPorPaginas);
        TDOCPESQUISADOS tDocPesqOra;
        TDOCPESQUISADOSST tDocPesqSTOra;

        VARCHAR cOraNrProtocolo[25];
    EXEC SQL END DECLARE SECTION;

    ULOG("iPaginaIni[%d] iPaginaFim[%d]", iPaginaIni, iPaginaFim );
    ULOG("pNrProtocolo[%s]", pNrProtocolo);
    STRCPY_TO_ORA(cOraNrProtocolo, pNrProtocolo);

    // Marca ponto de controle de erro
    EXEC SQL WHENEVER SQLERROR GOTO sqlErrorLista;

    // Declara e abre o cursor
    EXEC SQL DECLARE cC5 CURSOR FOR
        SELECT
            IDPESSOA,
            NMPESSOA,
            DSTIPOPESSOA
        FROM
        (        
            SELECT
                IDPESSOA,
                NMPESSOA,
                DSTIPOPESSOA,
                ROWNUM AS LINHA
            FROM
            (        
                SELECT
                    CP.IDPESSOA,
                    CP.NMPESSOA,
                    ATP.DSTIPOPESSOA
                FROM
                    ATENDIMENTO.ATENDIMENTO AA,
                    ATENDIMENTO.ATENDIMENTOPESSOA AAP,
                    CUSTOMER.PESSOADEPARA CPDP,
                    CUSTOMER.PESSOA CP,
                    APOIO.TIPOPESSOA ATP
                WHERE
                    AA.IDATENDIMENTO = AAP.IDATENDIMENTO
                AND
                    AAP.IDPESSOADEPARA = CPDP.IDPESSOADEPARA
                AND
                    CPDP.IDPESSOA = CP.IDPESSOA
                AND
                    AA.IDLINHATELEFONICA IS NULL
                AND
                    CP.IDTIPOPESSOA = ATP.IDTIPOPESSOA
                AND
                    AA.NRPROTOCOLO = :cOraNrProtocolo
            )
            WHERE 
                ROWNUM <= :iPaginaFim+1
        )
        WHERE
            LINHA > :iPaginaIni;


    EXEC SQL OPEN cC5;

    EXEC SQL WHENEVER NOT FOUND DO BREAK;


    for(;;)
    {
        memset(&tDocPesqOra, 0x00, sizeof(tDocPesqOra));
        memset(&tDocPesqSTOra,-1,sizeof(tDocPesqSTOra));

        EXEC SQL FETCH cC5 INTO :tDocPesqOra.sIdPessoa:tDocPesqSTOra.sIdPessoa,
                                :tDocPesqOra.sNmNome:tDocPesqSTOra.sNmNome,
                                :tDocPesqOra.sDsTipoPessoa:tDocPesqSTOra.sDsTipoPessoa;

        if( iNroObjLocal == iTotalLinhasPorPaginas ) {
            iNroObjLocal++;
            break;
        }

        // Aloca memória para o objeto atual.
        if ((oObj = (CBuscaDocumentoPessoa*) realloc((void *)oObj,
                        (sizeof(CBuscaDocumentoPessoa) * (iNroObjLocal+1)))) != NULL)
        {
            oObj[iNroObjLocal].clear();

            // Coloca os dados do objeto atual.
            if(tDocPesqSTOra.sIdPessoa>=0)
                oObj[iNroObjLocal].setIdPessoa((char*)tDocPesqOra.sIdPessoa.arr);

            if(tDocPesqSTOra.sNmNome>=0)
                oObj[iNroObjLocal].setNmNome((char*)tDocPesqOra.sNmNome.arr);

            if(tDocPesqSTOra.sDsTipoPessoa>=0)
                oObj[iNroObjLocal].setDsTipoPessoa((char*)tDocPesqOra.sDsTipoPessoa.arr);

            if(tDocPesqSTOra.sNrLinha>=0)
                oObj[iNroObjLocal].setNrLinha((char*)tDocPesqOra.sNrLinha.arr);

            iNroObjLocal++;
        }
        else
        {
            if (oObj) { free(oObj); }

            EXEC SQL CLOSE cC5;
            ULOGE("ERRO DE MEMORIA -> NRO_MEMORIA");
            ULOG_END("CBuscaDocumentoPessoa::buscarProspect()");
            throw TuxBasicSvcException(sNrMsg,MSG_MEMORIA);
        }
    }


    EXEC SQL CLOSE cC5;

    //Verifica se eh ou nao a ultima pagina
    if( oObj != NULL )
    {
        ULOG("Gravando o LOG iNroObjLocal[%d] > iTotalLinhasPorPaginas[%d]", iNroObjLocal, iTotalLinhasPorPaginas);
        if( iNroObjLocal > iTotalLinhasPorPaginas )
        {
            oObj[0].setUltimaPagina(0);
            iNroObjLocal--;//Como contou um a mais para saber que eh ultima pagina, tem que tirar este um.
        }
        else
            oObj[0].setUltimaPagina(1);
    }
    *iNroObjetos = iNroObjLocal;
    ULOG_END("CBuscaDocumentoPessoa::buscarProspect()");
    return oObj;

    // Tratamento de erro - Lança excessão com o código oracle do erro.
    sqlErrorLista:
        ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
        ULOG_END("CBuscaDocumentoPessoa::buscarProspect()");
        throw  new TuxBasicOraException(sqlca.sqlcode);
}
