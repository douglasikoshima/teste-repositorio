#undef SQLCA
#define SQLCA_NONE
#include <sqlca.h>
#include <sqlda.h>

#include "../include/Grupo.h"
#include <tuxfw.h>

EXEC SQL BEGIN DECLARE SECTION;
#include "../include/Global.h"
EXEC SQL END DECLARE SECTION;

Grupo::Grupo()
{
}

Grupo::~Grupo()
{
}
            
/*******************************************************************************************************/
void Grupo::retornoVazio(XMLGen *xml_g)
{
    ULOG_START("Grupo::retornoVazio()");

    xml_g->createTag("GrupoCRIVO");
    xml_g->addProp(XML_OUT_PROP_XMLNS, XML_OUT_PROP_XMLNS_VALUE);

        xml_g->createTag("Pesquisa");
            xml_g->createTag("Filtro");
            xml_g->closeTag();
        xml_g->closeTag();

    xml_g->closeTag();

    ULOG_END("Grupo::retornoVazio()");
}

/*******************************************************************************************************/
void Grupo::expiraLinhaTelefonicaGrupo(char *pszIdPessoaLinhaHistorico)
{
    ULOG_START("Grupo::expiraLinhaTelefonicaGrupo()");
	struct sqlca sqlca;
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoaLinhaHistorico[LEN_NUMBER_ORA + LEN_EOS];
        VARCHAR oszIdUsuarioAlteracao[LEN_NUMBER_ORA + LEN_EOS];
    EXEC SQL END DECLARE SECTION;

	try
	{
        
        ULOG("pszIdPessoaLinhaHistorico[%s]", pszIdPessoaLinhaHistorico);

        STRCPY_TO_ORA(oszIdPessoaLinhaHistorico, pszIdPessoaLinhaHistorico);
        STRCPY_TO_ORA(oszIdUsuarioAlteracao, "1");

        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
    
        EXEC SQL
            UPDATE customer.linhatelefonicagrupo
                SET
                    dtexclusao = SYSDATE,
                    dtultimaalteracao = SYSDATE,
                    idusuarioalteracao = TO_NUMBER(:oszIdUsuarioAlteracao)
                WHERE
                    idpessoalinhahistorico = TO_NUMBER(:oszIdPessoaLinhaHistorico)
                AND
                    dtexclusao IS NULL;

        ULOG("UPDATE -> sqlca.sqlcode(%d)", sqlca.sqlcode);

        if(sqlca.sqlcode == NO_DATA_FOUND)
            ULOGI("NENHUM REGISTRO EXPIRADO!");
        else if(sqlca.sqlcode == 0)
            ULOGI("REGISTRO EXPIRADO!");

        ULOG_END("Grupo::expiraLinhaTelefonicaGrupo()");
        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::expiraLinhaTelefonicaGrupo()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
void Grupo::insereLinhaTelefonicaGrupo(char *pszIdPessoaLinhaHistorico, char *pszIdGrupo)
{
	ULOG_START("Grupo::insereLinhaTelefonicaGrupo()");
	struct sqlca sqlca;
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoaLinhaHistorico[LEN_NUMBER_ORA + LEN_EOS];
        VARCHAR oszIdGrupo[LEN_NUMBER_ORA + LEN_EOS];
        VARCHAR oszIdUsuarioAlteracao[LEN_NUMBER_ORA + LEN_EOS];
        VARCHAR oszIdLinhaTelefonicaGrupo[LEN_NUMBER_ORA + LEN_EOS];
    EXEC SQL END DECLARE SECTION;

	try
	{
        
        ULOG("pszIdPessoaLinhaHistorico[%s]", pszIdPessoaLinhaHistorico);
        ULOG("pszIdGrupo[%s]", pszIdGrupo);

        STRCPY_TO_ORA(oszIdPessoaLinhaHistorico, pszIdPessoaLinhaHistorico);
        STRCPY_TO_ORA(oszIdGrupo, pszIdGrupo);
        STRCPY_TO_ORA(oszIdUsuarioAlteracao, "1");

        EXEC SQL WHENEVER SQLERROR GOTO GotoError;

        EXEC SQL SELECT TO_CHAR(customer.linhatelefonicagruposq.nextval) INTO :oszIdLinhaTelefonicaGrupo FROM dual;
        ULOG("sqlca.sqlcode(%d)", sqlca.sqlcode);
        ULOG("Sequence -> customer.linhatelefonicagruposq.nextval[%.*s]", oszIdLinhaTelefonicaGrupo.len, oszIdLinhaTelefonicaGrupo.arr);

    
        EXEC SQL
        	INSERT INTO customer.linhatelefonicagrupo
            (
                idlinhatelefonicagrupo,
                idpessoalinhahistorico,
                idgrupo,
                idusuarioalteracao,
                dtultimaalteracao
            )
            VALUES
            (
                TO_NUMBER(:oszIdLinhaTelefonicaGrupo),
                TO_NUMBER(:oszIdPessoaLinhaHistorico),
                TO_NUMBER(:oszIdGrupo),
                TO_NUMBER(:oszIdUsuarioAlteracao),
                SYSDATE
            );

        ULOG("sqlca.sqlcode(%d)", sqlca.sqlcode);
        
        
        ULOG_END("Grupo::insereLinhaTelefonicaGrupo()");

        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::insereLinhaTelefonicaGrupo()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
void Grupo::buscaClientePorRazao(char *pszNmPessoaFilial, XMLGen *xml_g)
{
    ULOG_START("Grupo::buscaClientePorRazao()");
    unsigned int iCont;
    bool bFlagRegFound = false;
	struct sqlca sqlca;

    char szNmPessoaFilial[LEN_NMPESSOAFILIAL + LEN_EOS];

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszNmPessoaFilial[LEN_NMPESSOAFILIAL + LEN_EOS];
        struct {
            VARCHAR oszIdPessoa[LEN_IDPESSOA + LEN_EOS];                 // customer.pessoa
            VARCHAR oszIdTipoPessoa[LEN_IDTIPOPESSOA + LEN_EOS];         // customer.pessoa
            VARCHAR oszDsTipoPessoa[LEN_DSTIPOPESSOA + LEN_EOS];         // apoio.tipopessoa
            VARCHAR oszNmPessoa[LEN_NMPESSOA + LEN_EOS];                 // customer.pessoa
            VARCHAR oszIdTipoDocumento[LEN_IDTIPODOCUMENTO + LEN_EOS];   // customer.documento
            VARCHAR oszDsTipoDocumento[LEN_DSTIPODOCUMENTO + LEN_EOS];   // apoio.tipodocumento
            VARCHAR oszSgClassificacao[LEN_SGCLASSIFICACAO + LEN_EOS];   // apoio.tipodocumento
            VARCHAR oszNrDocumento[LEN_NRDOCUMENTO + LEN_EOS];           // customer.documento
        } stBuscaPorRazao;
        struct {
            short iIdPessoa;
            short iIdTipoPessoa;
            short iDsTipoPessoa;
            short iNmPessoa;
            short iIdTipoDocumento;
            short iDsTipoDocumento;
            short iSgClassificacao;
            short iNrDocumento;
        } stBuscaPorRazaoIndicator;
    EXEC SQL END DECLARE SECTION;

	try
	{
        
        ULOG("pszNmPessoaFilial[%s]", pszNmPessoaFilial);
        sprintf(szNmPessoaFilial, "%s%c", pszNmPessoaFilial, '%');
        ULOG("szNmPessoaFilial[%s]", szNmPessoaFilial);

        STRCPY_TO_ORA(oszNmPessoaFilial, szNmPessoaFilial);

        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
    
        EXEC SQL 
            DECLARE 
                CursorBuscaPorRazao CURSOR FOR
                    SELECT DISTINCT
                        PESSOANOME.idpessoa,
                        TIPOPESSOA.idtipopessoa,
                        TIPOPESSOA.dstipopessoa,
                        PESSOANOME.NMPESSOAFILIAL,
                        tipodocumento.idtipodocumento,
                        tipodocumento.dstipodocumento,
                        tipodocumento.sgclassificacao,
                        documento.nrdocumento
                    FROM    
                        customer.pessoadocumento pessoadocumento,
                        customer.documento documento,
                        apoio.tipodocumento tipodocumento,
                        customer.pessoadepara pessoadepara,
                        customer.pessoalinha pessoalinha,
                        customer.tiporelacionamento tiporelacionamento,
                        APOIO.TIPOPESSOA TIPOPESSOA,
                        (
                            SELECT 
                                pessoajuridica.IDPESSOA,
                                NMPESSOAFILIAL
                            FROM
                                customer.pessoajuridica pessoajuridica
                            WHERE    
                                upper(pessoajuridica.NMPESSOAFILIAL) LIKE upper(:oszNmPessoaFilial)
                        ) PESSOANOME,
                        linha.linhatelefonica linhatelefonica
                    WHERE   PESSOANOME.idpessoa = pessoadocumento.idpessoa
                    AND     pessoadocumento.iddocumento = documento.iddocumento
                    AND     documento.idtipodocumento = tipodocumento.idtipodocumento
                    AND     PESSOANOME.idpessoa = pessoadepara.idpessoa
                    AND     pessoadepara.idpessoadepara = pessoalinha.idpessoadepara
                    AND     pessoalinha.idtiporelacionamento = tiporelacionamento.idtiporelacionamento
                    AND     tiporelacionamento.sgtiporelacionamento = 'C'
                    AND     tipodocumento.invisualiza = '1'
                    AND     pessoalinha.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                    AND     tipodocumento.idtipopessoa = TIPOPESSOA.IDTIPOPESSOA
                    AND     TIPOPESSOA.SGTIPOPESSOA = 'PJ'
                    AND     linhatelefonica.idlinhatelefonica IN 
                            ( 
                                SELECT
                                    idlinhatelefonica
                                FROM
                                    customer.pessoalinhahistorico pessoalinhahistorico
                                WHERE
                                    pessoalinhahistorico.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                            )
                     AND
                        TIPODOCUMENTO.NRPRIORIDADE = 
                        (
                            SELECT
                                MIN( TIPODOCUMENTO.NRPRIORIDADE )
                            FROM
                                CUSTOMER.PESSOADOCUMENTO PESSOADOCUMENTON,
                                CUSTOMER.DOCUMENTO DOCUMENTON,
                                APOIO.TIPODOCUMENTO TIPODOCUMENTON
                            WHERE
                                PESSOADOCUMENTON.IDDOCUMENTO = DOCUMENTON.IDDOCUMENTO
                            AND
                                DOCUMENTON.IDTIPODOCUMENTO = TIPODOCUMENTON.IDTIPODOCUMENTO
                            AND
                                TIPODOCUMENTON.INVISUALIZA = 1
                            AND
                                PESSOADOCUMENTON.IDPESSOA = PESSOANOME.IDPESSOA
                       );



        EXEC SQL OPEN CursorBuscaPorRazao;
    
        ULOG("1.sqlca.sqlcode(%d)", sqlca.sqlcode);
    
        EXEC SQL WHENEVER NOT FOUND DO break;
    
        for(iCont=0; iCont<50; iCont++)
        {
            ULOG("iCont(%u)", iCont);

            memset(&stBuscaPorRazao, 0x00, sizeof(stBuscaPorRazao));
    
            EXEC SQL FETCH CursorBuscaPorRazao INTO :stBuscaPorRazao:stBuscaPorRazaoIndicator;
            ULOG("2.sqlca.sqlcode(%d)", sqlca.sqlcode);

            ULOG("(char *)&stBuscaPorRazao.oszIdPessoa.arr[%s] stBuscaPorRazaoIndicator.iIdPessoa(%d)", (char *)&stBuscaPorRazao.oszIdPessoa.arr, stBuscaPorRazaoIndicator.iIdPessoa);
            ULOG("(char *)&stBuscaPorRazao.oszIdTipoPessoa.arr[%s] stBuscaPorRazaoIndicator.iIdTipoPessoa(%d)", (char *)&stBuscaPorRazao.oszIdTipoPessoa.arr, stBuscaPorRazaoIndicator.iIdTipoPessoa);
            ULOG("(char *)&stBuscaPorRazao.oszDsTipoPessoa.arr[%s] stBuscaPorRazaoIndicator.iDsTipoPessoa(%d)", (char *)&stBuscaPorRazao.oszDsTipoPessoa.arr, stBuscaPorRazaoIndicator.iDsTipoPessoa);
            ULOG("(char *)&stBuscaPorRazao.oszNmPessoa.arr[%s] stBuscaPorRazaoIndicator.iNmPessoa(%d)", (char *)&stBuscaPorRazao.oszNmPessoa.arr, stBuscaPorRazaoIndicator.iNmPessoa);
            ULOG("(char *)&stBuscaPorRazao.oszIdTipoDocumento.arr[%s] stBuscaPorRazaoIndicator.iIdTipoDocumento(%d)", (char *)&stBuscaPorRazao.oszIdTipoDocumento.arr, stBuscaPorRazaoIndicator.iIdTipoDocumento);
            ULOG("(char *)&stBuscaPorRazao.oszDsTipoDocumento.arr[%s] stBuscaPorRazaoIndicator.iDsTipoDocumento(%d)", (char *)&stBuscaPorRazao.oszDsTipoDocumento.arr, stBuscaPorRazaoIndicator.iDsTipoDocumento);
            ULOG("(char *)&stBuscaPorRazao.oszSgClassificacao.arr[%s] stBuscaPorRazaoIndicator.iSgClassificacao(%d)", (char *)&stBuscaPorRazao.oszSgClassificacao.arr, stBuscaPorRazaoIndicator.iSgClassificacao);
            ULOG("(char *)&stBuscaPorRazao.oszNrDocumento.arr[%s] stBuscaPorRazaoIndicator.iNrDocumento(%d)", (char *)&stBuscaPorRazao.oszNrDocumento.arr, stBuscaPorRazaoIndicator.iNrDocumento);
    
            if(bFlagRegFound == false) {
                xml_g->createTag("GrupoCRIVO");
                xml_g->addProp(XML_OUT_PROP_XMLNS, XML_OUT_PROP_XMLNS_VALUE);
                xml_g->createTag("Pesquisa");
                bFlagRegFound = true;
            }

            xml_g->createTag("Pessoas");
                xml_g->addItem("idPessoa", (char *)&stBuscaPorRazao.oszIdPessoa.arr);
                xml_g->addItem("idTipoPessoa", (char *)&stBuscaPorRazao.oszIdTipoPessoa.arr);
                xml_g->addItem("dsTipoPessoa", (char *)&stBuscaPorRazao.oszDsTipoPessoa.arr);
                xml_g->addItem("nmPessoa", (char *)&stBuscaPorRazao.oszNmPessoa.arr);
                xml_g->addItem("idTipoDocumento", (char *)&stBuscaPorRazao.oszIdTipoDocumento.arr);
                xml_g->addItem("dsTipoDocumento", (char *)&stBuscaPorRazao.oszDsTipoDocumento.arr);
                xml_g->addItem("sgClassificacaoDocumento", (char *)&stBuscaPorRazao.oszSgClassificacao.arr);
                xml_g->addItem("nrDocumento", (char *)&stBuscaPorRazao.oszNrDocumento.arr);
            xml_g->closeTag();
        }

        ULOG("2.iCont(%u)", iCont);

        // Muitas ocorrências
        if(iCont == 50) {
            ULOG("Inserindo tag inErro - Muitas ocorrencias!");
            xml_g->addItem("inErro", "1");
        }


        if(bFlagRegFound == true) {
            xml_g->closeTag();
            xml_g->closeTag();
            bFlagRegFound = false;
        }
        else
            this->retornoVazio(xml_g);
            
    
        EXEC SQL CLOSE CursorBuscaPorRazao;
        ULOG("3.sqlca.sqlcode(%d)", sqlca.sqlcode);
        ULOG_END("Grupo::buscaClientePorRazao()");

        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::buscaClientePorRazao()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
void Grupo::buscaClientePorNome(char *pszNmNome, char *pszNmNomeMeio, char *pszNmSobreNome, XMLGen *xml_g)
{
    ULOG_START("Grupo::buscaClientePorNome()");
    unsigned int iCont;
    bool bFlagRegFound = false;
	struct sqlca sqlca;

    char szNmNome[LEN_NMNOME + LEN_EOS];
    char szNmNomeMeio[LEN_NMNOMEMEIO + LEN_EOS];
    char szNmSobreNome[LEN_NMSOBRENOME + LEN_EOS];

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszNmNome[LEN_NMNOME + LEN_EOS];
        VARCHAR oszNmNomeMeio[LEN_NMNOMEMEIO + LEN_EOS];
        VARCHAR oszNmSobreNome[LEN_NMSOBRENOME + LEN_EOS];
        struct {
            VARCHAR oszIdPessoa[LEN_IDPESSOA + LEN_EOS];                 // customer.pessoa
            VARCHAR oszIdTipoPessoa[LEN_IDTIPOPESSOA + LEN_EOS];         // customer.pessoa
            VARCHAR oszDsTipoPessoa[LEN_DSTIPOPESSOA + LEN_EOS];         // apoio.tipopessoa
            VARCHAR oszNmPessoa[LEN_NMPESSOA + LEN_EOS];                 // customer.pessoa
            VARCHAR oszIdTipoDocumento[LEN_IDTIPODOCUMENTO + LEN_EOS];   // customer.documento
            VARCHAR oszDsTipoDocumento[LEN_DSTIPODOCUMENTO + LEN_EOS];   // apoio.tipodocumento
            VARCHAR oszSgClassificacao[LEN_SGCLASSIFICACAO + LEN_EOS];   // apoio.tipodocumento
            VARCHAR oszNrDocumento[LEN_NRDOCUMENTO + LEN_EOS];           // customer.documento
        } stBuscaPorNome;
        struct {
            short iIdPessoa;
            short iIdTipoPessoa;
            short iDsTipoPessoa;
            short iNmPessoa;
            short iIdTipoDocumento;
            short iDsTipoDocumento;
            short iSgClassificacao;
            short iNrDocumento;
        } stBuscaPorNomeIndicator;
    EXEC SQL END DECLARE SECTION;

	try
	{
        

        ULOG("pszNmNome[%s]", pszNmNome);
        sprintf(szNmNome, "%s%c", pszNmNome, '%');
        ULOG("szNmNome[%s]", szNmNome);
        STRCPY_TO_ORA(oszNmNome, szNmNome);

        ULOG("pszNmNomeMeio[%s]", pszNmNomeMeio);
        sprintf(szNmNomeMeio, "%s%c", pszNmNomeMeio, '%');
        ULOG("szNmNomeMeio[%s]", szNmNomeMeio);
        STRCPY_TO_ORA(oszNmNomeMeio, szNmNomeMeio);

        ULOG("pszNmSobreNome[%s]", pszNmSobreNome);
        sprintf(szNmSobreNome, "%s%c", pszNmSobreNome, '%');
        ULOG("szNmSobreNome[%s]", szNmSobreNome);
        STRCPY_TO_ORA(oszNmSobreNome, szNmSobreNome);

        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
    
        EXEC SQL 
            DECLARE 
                CursorBuscaPorNome CURSOR FOR
                    SELECT DISTINCT
                        PESSOANOME.idpessoa,
                        tipopessoa.idtipopessoa,
                        tipopessoa.dstipopessoa,
                        PESSOANOME.nmpessoa,
                        tipodocumento.idtipodocumento,
                        tipodocumento.dstipodocumento,
                        tipodocumento.sgclassificacao,
                        documento.nrdocumento
                    FROM    
                        customer.pessoadocumento pessoadocumento,
                        customer.documento documento,
                        apoio.tipodocumento tipodocumento,
                        apoio.tipopessoa tipopessoa,
                        customer.pessoadepara pessoadepara,
                        customer.pessoalinha pessoalinha,
                        customer.tiporelacionamento tiporelacionamento,
                        linha.linhatelefonica linhatelefonica,
                        (
                            SELECT /* INDEX (PESSOA, PESSOAIE1)*/
                                IDPESSOA,
                                idtipopessoa,
                                nmpessoa
                            FROM
                                CUSTOMER.PESSOA
                            WHERE    
                                    upper(pessoa.nmnome) LIKE upper(:oszNmNome)
                            AND     (upper(pessoa.nmnomemeio) LIKE upper(:oszNmNomeMeio) OR pessoa.nmnomemeio is NULL)
                            AND     upper(pessoa.nmsobrenome) LIKE upper(:oszNmSobreNome)
                        ) PESSOANOME
                    WHERE   
                            PESSOANOME.idpessoa = pessoadocumento.idpessoa
                    AND     pessoadocumento.iddocumento = documento.iddocumento
                    AND     documento.idtipodocumento = tipodocumento.idtipodocumento
                    AND     PESSOANOME.idtipopessoa = tipopessoa.idtipopessoa
                    AND     PESSOANOME.idpessoa = pessoadepara.idpessoa
                    AND     pessoadepara.idpessoadepara = pessoalinha.idpessoadepara
                    AND     pessoalinha.idtiporelacionamento = tiporelacionamento.idtiporelacionamento
                    AND     tiporelacionamento.sgtiporelacionamento = 'C'
                    AND     tipodocumento.invisualiza = '1'
                    AND     pessoalinha.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                    AND     linhatelefonica.idlinhatelefonica IN 
                            ( 
                                SELECT
                                    idlinhatelefonica
                                FROM
                                    customer.pessoalinhahistorico pessoalinhahistorico
                                WHERE
                                    pessoalinhahistorico.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                            )
                    AND tipodocumento.nrprioridade = (   SELECT MIN(tipodocumento.nrprioridade)
                                                           FROM customer.pessoadocumento pessoadocumento
                                                              , customer.documento       documento
                                                              , apoio.tipodocumento      tipodocumento
                                                          WHERE PESSOANOME.idpessoa = pessoadocumento.idpessoa
                                                            AND documento.iddocumento = pessoadocumento.iddocumento
                                                            AND documento.idtipodocumento = tipodocumento.idtipodocumento ); 


        EXEC SQL OPEN CursorBuscaPorNome;
    
        ULOG("1.sqlca.sqlcode(%d)", sqlca.sqlcode);
    
        EXEC SQL WHENEVER NOT FOUND DO break;
    
        for(iCont=0; iCont<50; iCont++)
        {
            ULOG("iCont(%u)", iCont);

            memset(&stBuscaPorNome, 0x00, sizeof(stBuscaPorNome));
    
            EXEC SQL FETCH CursorBuscaPorNome INTO :stBuscaPorNome:stBuscaPorNomeIndicator;
            ULOG("2.sqlca.sqlcode(%d)", sqlca.sqlcode);

            ULOG("(char *)&stBuscaPorNome.oszIdPessoa.arr[%s] stBuscaPorNomeIndicator.iIdPessoa(%d)", (char *)&stBuscaPorNome.oszIdPessoa.arr, stBuscaPorNomeIndicator.iIdPessoa);
            ULOG("(char *)&stBuscaPorNome.oszIdTipoPessoa.arr[%s] stBuscaPorNomeIndicator.iIdTipoPessoa(%d)", (char *)&stBuscaPorNome.oszIdTipoPessoa.arr, stBuscaPorNomeIndicator.iIdTipoPessoa);
            ULOG("(char *)&stBuscaPorNome.oszDsTipoPessoa.arr[%s] stBuscaPorNomeIndicator.iDsTipoPessoa(%d)", (char *)&stBuscaPorNome.oszDsTipoPessoa.arr, stBuscaPorNomeIndicator.iDsTipoPessoa);
            ULOG("(char *)&stBuscaPorNome.oszNmPessoa.arr[%s] stBuscaPorNomeIndicator.iNmPessoa(%d)", (char *)&stBuscaPorNome.oszNmPessoa.arr, stBuscaPorNomeIndicator.iNmPessoa);
            ULOG("(char *)&stBuscaPorNome.oszIdTipoDocumento.arr[%s] stBuscaPorNomeIndicator.iIdTipoDocumento(%d)", (char *)&stBuscaPorNome.oszIdTipoDocumento.arr, stBuscaPorNomeIndicator.iIdTipoDocumento);
            ULOG("(char *)&stBuscaPorNome.oszDsTipoDocumento.arr[%s] stBuscaPorNomeIndicator.iDsTipoDocumento(%d)", (char *)&stBuscaPorNome.oszDsTipoDocumento.arr, stBuscaPorNomeIndicator.iDsTipoDocumento);
            ULOG("(char *)&stBuscaPorNome.oszSgClassificacao.arr[%s] stBuscaPorNomeIndicator.iSgClassificacao(%d)", (char *)&stBuscaPorNome.oszSgClassificacao.arr, stBuscaPorNomeIndicator.iSgClassificacao);
            ULOG("(char *)&stBuscaPorNome.oszNrDocumento.arr[%s] stBuscaPorNomeIndicator.iNrDocumento(%d)", (char *)&stBuscaPorNome.oszNrDocumento.arr, stBuscaPorNomeIndicator.iNrDocumento);
    
            if(bFlagRegFound == false) {
                xml_g->createTag("GrupoCRIVO");
                xml_g->addProp(XML_OUT_PROP_XMLNS, XML_OUT_PROP_XMLNS_VALUE);
                xml_g->createTag("Pesquisa");
                bFlagRegFound = true;
            }

            xml_g->createTag("Pessoas");
                xml_g->addItem("idPessoa", (char *)&stBuscaPorNome.oszIdPessoa.arr);
                xml_g->addItem("idTipoPessoa", (char *)&stBuscaPorNome.oszIdTipoPessoa.arr);
                xml_g->addItem("dsTipoPessoa", (char *)&stBuscaPorNome.oszDsTipoPessoa.arr);
                xml_g->addItem("nmPessoa", (char *)&stBuscaPorNome.oszNmPessoa.arr);
                xml_g->addItem("idTipoDocumento", (char *)&stBuscaPorNome.oszIdTipoDocumento.arr);
                xml_g->addItem("dsTipoDocumento", (char *)&stBuscaPorNome.oszDsTipoDocumento.arr);
                xml_g->addItem("sgClassificacaoDocumento", (char *)&stBuscaPorNome.oszSgClassificacao.arr);
                xml_g->addItem("nrDocumento", (char *)&stBuscaPorNome.oszNrDocumento.arr);
            xml_g->closeTag();
         }

        ULOG("2.iCont(%u)", iCont);

        // Muitas ocorrências
        if(iCont == 50) {
            ULOG("Inserindo tag inErro - Muitas ocorrencias!");
            xml_g->addItem("inErro", "1");
        }

        if(bFlagRegFound == true) {
            xml_g->closeTag();
            xml_g->closeTag();
            bFlagRegFound = false;
        }else
            this->retornoVazio(xml_g);
            
    
        EXEC SQL CLOSE CursorBuscaPorNome;
        ULOG("3.sqlca.sqlcode(%d)", sqlca.sqlcode);
        
        
        ULOG_END("Grupo::buscaClientePorNome()");

        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::buscaClientePorNome()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
void Grupo::carregaCombo(XMLGen *xml_g)
{
    ULOG_START("Grupo::carregaCombo()");
    bool bFlagRegFound = false;
	struct sqlca sqlca;
    EXEC SQL BEGIN DECLARE SECTION;
        struct {
            VARCHAR oszIdGrupo[LEN_NUMBER_ORA + LEN_EOS];
            VARCHAR oszNmGrupo[LEN_NMGRUPO + LEN_EOS];
        } stGrupoRegistro;
        struct {
            short oiIdGrupo;
            short oiNmGrupo;
        } stGrupoIndicator;
    EXEC SQL END DECLARE SECTION;

	try
	{


        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
    
        EXEC SQL 
            DECLARE 
                CursorGrupo CURSOR FOR 
            SELECT
                grupo.idgrupo,
                grupo.nmgrupo
            FROM
                acesso.grupo grupo
               ,apoio.tipogrupo tipogrupo
            WHERE
                grupo.dtexclusao IS NULL
            AND
                grupo.idtipogrupo = tipogrupo.idtipogrupo
            AND
                tipogrupo.cdtipogrupo = 'CRI'
            ORDER BY
                UPPER(nmgrupo);
    
        EXEC SQL OPEN CursorGrupo;
    
        ULOG("1.sqlca.sqlcode(%d)", sqlca.sqlcode);
    
        EXEC SQL WHENEVER NOT FOUND DO break;
    
        for(;;)
        {
            memset(&stGrupoRegistro, 0x00, sizeof(stGrupoRegistro));
    
            EXEC SQL FETCH CursorGrupo INTO :stGrupoRegistro:stGrupoIndicator;
            ULOG("2.sqlca.sqlcode(%d)", sqlca.sqlcode);

            ULOG("(char *)&stGrupoRegistro.oszIdGrupo.arr[%s]stGrupoIndicator.oiIdGrupo(%d)", (char *)&stGrupoRegistro.oszIdGrupo.arr, stGrupoIndicator.oiIdGrupo);
            ULOG("(char *)&stGrupoRegistro.oszNmGrupo.arr[%s]stGrupoIndicator.oiNmGrupo(%d)", (char *)&stGrupoRegistro.oszNmGrupo.arr, stGrupoIndicator.oiNmGrupo);
    
            if(bFlagRegFound == false) {
                xml_g->createTag("GrupoCRIVO");
                xml_g->addProp(XML_OUT_PROP_XMLNS, XML_OUT_PROP_XMLNS_VALUE);
                bFlagRegFound = true;
            }

            xml_g->createTag("Grupos");
                xml_g->addItem("idGrupo", (char *)&stGrupoRegistro.oszIdGrupo.arr);
                xml_g->addItem("dsGrupo", (char *)&stGrupoRegistro.oszNmGrupo.arr);
            xml_g->closeTag();
         }

        if(bFlagRegFound == true) {
            xml_g->closeTag();
            bFlagRegFound = false;
        }else
            this->retornoVazio(xml_g);
            
    
        EXEC SQL CLOSE CursorGrupo;
        ULOG("3.sqlca.sqlcode(%d)", sqlca.sqlcode);
        ULOG_END("Grupo::carregaCombo()");

        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::carregaCombo()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
void Grupo::buscaClientePorDocumento(char *pszNrDocumento, char *pszSgClassificacao, XMLGen *xml_g)
{
    ULOG_START("Grupo::buscaClientePorDocumento()");
    unsigned int iCont;
    bool bFlagRegFound = false;
	struct sqlca sqlca;
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszNrDocumento[LEN_NRDOCUMENTO + LEN_EOS];
        VARCHAR oszSgClassificacao[LEN_SGCLASSIFICACAO + LEN_EOS];
        struct {
            VARCHAR oszIdPessoa[LEN_IDPESSOA + LEN_EOS];                 // customer.pessoa
            VARCHAR oszIdTipoPessoa[LEN_IDTIPOPESSOA + LEN_EOS];         // customer.pessoa
            VARCHAR oszDsTipoPessoa[LEN_DSTIPOPESSOA + LEN_EOS];         // apoio.tipopessoa
            VARCHAR oszNmPessoa[LEN_NMPESSOA + LEN_EOS];                 // customer.pessoa
            VARCHAR oszIdTipoDocumento[LEN_IDTIPODOCUMENTO + LEN_EOS];   // customer.documento
            VARCHAR oszDsTipoDocumento[LEN_DSTIPODOCUMENTO + LEN_EOS];   // apoio.tipodocumento
            VARCHAR oszSgClassificacao[LEN_SGCLASSIFICACAO + LEN_EOS];   // apoio.tipodocumento
            VARCHAR oszNrDocumento[LEN_NRDOCUMENTO + LEN_EOS];           // customer.documento
        } stBuscaPorNrDocumento;
        struct {
            short iIdPessoa;
            short iIdTipoPessoa;
            short iDsTipoPessoa;
            short iNmPessoa;
            short iIdTipoDocumento;
            short iDsTipoDocumento;
            short iSgClassificacao;
            short iNrDocumento;
        } stBuscaPorNrDocumentoIndicator;
    EXEC SQL END DECLARE SECTION;

	try
	{
       
        ULOG("pszSgClassificacao[%s]", pszSgClassificacao);
        STRCPY_TO_ORA(oszSgClassificacao, pszSgClassificacao);

        ULOG("pszNrDocumento[%s]", pszNrDocumento);
        STRCPY_TO_ORA(oszNrDocumento, pszNrDocumento);

        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
    
        EXEC SQL 
            DECLARE 
                CursorBuscaPorNrDocumento CURSOR for
                    SELECT DISTINCT
                        pessoa.idpessoa,
                        tipopessoa.idtipopessoa,
                        tipopessoa.dstipopessoa,
                        pessoa.nmpessoa,
                        tipodocumento.idtipodocumento,
                        tipodocumento.dstipodocumento,
                        tipodocumento.sgclassificacao,
                        documento.nrdocumento
                    FROM    
                        customer.pessoa pessoa,
                        customer.pessoadocumento pessoadocumento,
                        customer.documento documento,
                        apoio.tipodocumento tipodocumento,
                        apoio.tipopessoa tipopessoa,
                        customer.pessoadepara pessoadepara,
                        customer.pessoalinha pessoalinha,
                        customer.tiporelacionamento tiporelacionamento,
                        linha.linhatelefonica linhatelefonica
                    WHERE   pessoa.idpessoa = pessoadocumento.idpessoa
                    AND     pessoa.idtipopessoa = tipopessoa.idtipopessoa
                    AND     pessoadocumento.iddocumento = documento.iddocumento
                    AND     documento.idtipodocumento = tipodocumento.idtipodocumento
                    AND     documento.nrdocumento = :oszNrDocumento
                    AND     tipodocumento.sgclassificacao = :oszSgClassificacao
                    AND     pessoa.idpessoa = pessoadepara.idpessoa
                    AND     pessoadepara.idpessoadepara = pessoalinha.idpessoadepara
                    AND     pessoalinha.idtiporelacionamento = tiporelacionamento.idtiporelacionamento
                    AND     tiporelacionamento.sgtiporelacionamento = 'C'
                    AND     tipodocumento.invisualiza = '1'
                    AND     pessoalinha.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                    AND     linhatelefonica.idlinhatelefonica IN 
                            ( 
                                SELECT
                                    idlinhatelefonica
                                FROM
                                    customer.pessoalinhahistorico pessoalinhahistorico
                                WHERE
                                    pessoalinhahistorico.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                            )
                    // ==> Incidência 3412 Homologação Vivo - Dez/2005 - Cassio
                    // AND tipodocumento.nrprioridade = (   SELECT MIN(tipodocumento.nrprioridade)
                    //                                        FROM customer.pessoadocumento pessoadocumento
                    //                                           , customer.documento       documento
                    //                                           , apoio.tipodocumento      tipodocumento
                    //                                       WHERE pessoa.idpessoa = pessoadocumento.idpessoa
                    //                                         AND documento.iddocumento = pessoadocumento.iddocumento
                    //                                         AND documento.idtipodocumento = tipodocumento.idtipodocumento )
                    // ==> Incidência 3412 Homologação Vivo - Dez/2005 - Cassio
                    ORDER BY pessoa.nmpessoa;

        EXEC SQL OPEN CursorBuscaPorNrDocumento;
    
        ULOG("1.sqlca.sqlcode(%d)", sqlca.sqlcode);
    
        EXEC SQL WHENEVER NOT FOUND DO break;
    
        for(iCont=0;;iCont++)
        {
            ULOG("iCont(%u)", iCont);

            memset(&stBuscaPorNrDocumento, 0x00, sizeof(stBuscaPorNrDocumento));
    
            EXEC SQL FETCH CursorBuscaPorNrDocumento INTO :stBuscaPorNrDocumento:stBuscaPorNrDocumentoIndicator;
            ULOG("2.sqlca.sqlcode(%d)", sqlca.sqlcode);

            ULOG("(char *)&stBuscaPorNrDocumento.oszIdPessoa.arr[%s] stBuscaPorNrDocumentoIndicator.iIdPessoa(%d)", (char *)&stBuscaPorNrDocumento.oszIdPessoa.arr, stBuscaPorNrDocumentoIndicator.iIdPessoa);
            ULOG("(char *)&stBuscaPorNrDocumento.oszIdTipoPessoa.arr[%s] stBuscaPorNrDocumentoIndicator.iIdTipoPessoa(%d)", (char *)&stBuscaPorNrDocumento.oszIdTipoPessoa.arr, stBuscaPorNrDocumentoIndicator.iIdTipoPessoa);
            ULOG("(char *)&stBuscaPorNrDocumento.oszDsTipoPessoa.arr[%s] stBuscaPorNrDocumentoIndicator.iDsTipoPessoa(%d)", (char *)&stBuscaPorNrDocumento.oszDsTipoPessoa.arr, stBuscaPorNrDocumentoIndicator.iDsTipoPessoa);
            ULOG("(char *)&stBuscaPorNrDocumento.oszNmPessoa.arr[%s] stBuscaPorNrDocumentoIndicator.iNmPessoa(%d)", (char *)&stBuscaPorNrDocumento.oszNmPessoa.arr, stBuscaPorNrDocumentoIndicator.iNmPessoa);
            ULOG("(char *)&stBuscaPorNrDocumento.oszIdTipoDocumento.arr[%s] stBuscaPorNrDocumentoIndicator.iIdTipoDocumento(%d)", (char *)&stBuscaPorNrDocumento.oszIdTipoDocumento.arr, stBuscaPorNrDocumentoIndicator.iIdTipoDocumento);
            ULOG("(char *)&stBuscaPorNrDocumento.oszDsTipoDocumento.arr[%s] stBuscaPorNrDocumentoIndicator.iDsTipoDocumento(%d)", (char *)&stBuscaPorNrDocumento.oszDsTipoDocumento.arr, stBuscaPorNrDocumentoIndicator.iDsTipoDocumento);
            ULOG("(char *)&stBuscaPorNrDocumento.oszSgClassificacao.arr[%s] stBuscaPorNrDocumentoIndicator.iSgClassificacao(%d)", (char *)&stBuscaPorNrDocumento.oszSgClassificacao.arr, stBuscaPorNrDocumentoIndicator.iSgClassificacao);
            ULOG("(char *)&stBuscaPorNrDocumento.oszNrDocumento.arr[%s] stBuscaPorNrDocumentoIndicator.iNrDocumento(%d)", (char *)&stBuscaPorNrDocumento.oszNrDocumento.arr, stBuscaPorNrDocumentoIndicator.iNrDocumento);
    
            if(bFlagRegFound == false) {
                xml_g->createTag("GrupoCRIVO");
                xml_g->addProp(XML_OUT_PROP_XMLNS, XML_OUT_PROP_XMLNS_VALUE);
                xml_g->createTag("Pesquisa");
                bFlagRegFound = true;
            }

            xml_g->createTag("Pessoas");
                xml_g->addItem("idPessoa", (char *)&stBuscaPorNrDocumento.oszIdPessoa.arr);
                xml_g->addItem("idTipoPessoa", (char *)&stBuscaPorNrDocumento.oszIdTipoPessoa.arr);
                xml_g->addItem("dsTipoPessoa", (char *)&stBuscaPorNrDocumento.oszDsTipoPessoa.arr);
                xml_g->addItem("nmPessoa", (char *)&stBuscaPorNrDocumento.oszNmPessoa.arr);
                xml_g->addItem("idTipoDocumento", (char *)&stBuscaPorNrDocumento.oszIdTipoDocumento.arr);
                xml_g->addItem("dsTipoDocumento", (char *)&stBuscaPorNrDocumento.oszDsTipoDocumento.arr);
                xml_g->addItem("sgClassificacaoDocumento", (char *)&stBuscaPorNrDocumento.oszSgClassificacao.arr);
                xml_g->addItem("nrDocumento", (char *)&stBuscaPorNrDocumento.oszNrDocumento.arr);
            xml_g->closeTag();
         }

        if(bFlagRegFound == true) {
            xml_g->closeTag();
            xml_g->closeTag();
            bFlagRegFound = false;
        }else
            this->retornoVazio(xml_g);
    
        EXEC SQL CLOSE CursorBuscaPorNrDocumento;
        ULOG("3.sqlca.sqlcode(%d)", sqlca.sqlcode);

        ULOG_END("Grupo::buscaClientePorDocumento()");

        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::buscaClientePorDocumento()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
bool Grupo::buscaClientePorIdLinhaTelefonica(char *pszIdLinhaTelefonica, TGrupo *ptGrupo)
{
	ULOG_START("Grupo::buscaClientePorIdLinhaTelefonica()");
	struct sqlca sqlca;
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS];
        struct {
            VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS];
            VARCHAR oszIdPessoaLinhaHistorico[LEN_IDPESSOALINHAHISTORICO + LEN_EOS];
            VARCHAR oszIdGrupo[LEN_IDGRUPO + LEN_EOS];
            VARCHAR oszNmGrupo[LEN_NMGRUPO + LEN_EOS];
        }stBuscaPorIdLinhaTelefonica;
        struct {
            short oiIdLinhaTelefonica;
            short oiIdPessoaLinhaHistorico;
            short oiIdGrupo;
            short oiNmGrupo;
        }stBuscaPorIdLinhaTelefonicaIndicator;
    EXEC SQL END DECLARE SECTION;


	try
	{
        

        ULOG("pszIdLinhaTelefonica[%s]", pszIdLinhaTelefonica);
        STRCPY_TO_ORA(oszIdLinhaTelefonica, pszIdLinhaTelefonica);

        memset(&stBuscaPorIdLinhaTelefonica, 0x00, sizeof(stBuscaPorIdLinhaTelefonica));

        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
        EXEC SQL WHENEVER NOT FOUND GOTO sqlNotFound;

        EXEC SQL 
            SELECT
                idlinhatelefonica,
                linhas.Idpessoalinhahistorico,
                idgrupo,
                decode(nmgrupo, NULL, 'SEM GRUPO', decode( dtexclusao, null, nmgrupo, 'SEM GRUPO' ) ) DSGRUPO
            INTO:stBuscaPorIdLinhaTelefonica:stBuscaPorIdLinhaTelefonicaIndicator
            FROM
                (
                   SELECT distinct
                        idlinhatelefonicagrupo,
                        idlinhatelefonica,
                        filtros.Idpessoalinhahistorico,
                        LINHA,
                        grupo.idgrupo,
                        grupo.nmgrupo,
                        linhatelefonicagrupo.dtexclusao,
                        FILTROS.dtrelacionamento
                   FROM
                       (
                         SELECT
                              idlinhatelefonica,
                              Idpessoalinhahistorico,
                              Dtrelacionamento,
                              ROWNUM LINHA
                          FROM
                              (
                                  SELECT DISTINCT
                                      pessoalinhahistorico.idlinhatelefonica,
                                      pessoalinhahistorico.Idpessoalinhahistorico,
                                      pessoalinhahistorico.Dtrelacionamento
                                  FROM
                                      customer.pessoalinhahistorico pessoalinhahistorico,
                                      customer.tiporelacionamento tiporelacionamento
                                  WHERE
                                      pessoalinhahistorico.idlinhatelefonica = :oszIdLinhaTelefonica
                                  AND
                                      pessoalinhahistorico.idtiporelacionamento = tiporelacionamento.idtiporelacionamento
                                  AND
                                  	  tiporelacionamento.sgtiporelacionamento = 'C'
                                  ORDER BY
                                      NVL(DTRELACIONAMENTO, TO_DATE('00010101000000', 'YYYYMMDDHH24MISS' )) DESC
                              )
                       ) FILTROS,
                       customer.linhatelefonicagrupo linhatelefonicagrupo,
                       acesso.grupo grupo
                    WHERE
                        filtros.Idpessoalinhahistorico = linhatelefonicagrupo.Idpessoalinhahistorico (+)
                    AND
                       linhatelefonicagrupo.idgrupo = grupo.idgrupo (+)
                    AND
                       FILTROS.LINHA = 1
                    ORDER BY 
                          customer.linhatelefonicagrupo.idlinhatelefonicagrupo DESC
                ) linhas
            WHERE
                ROWNUM < 2;

        ULOG("Select.sqlca.sqlcode(%d)", sqlca.sqlcode);

        ULOG("stBuscaPorIdLinhaTelefonica.oszIdLinhaTelefonica.arr[%s](%d)", (char *)&stBuscaPorIdLinhaTelefonica.oszIdLinhaTelefonica.arr, stBuscaPorIdLinhaTelefonicaIndicator.oiIdLinhaTelefonica);
        ULOG("stBuscaPorIdLinhaTelefonica.oszIdPessoaLinhaHistorico.arr[%s](%d)", (char *)&stBuscaPorIdLinhaTelefonica.oszIdPessoaLinhaHistorico.arr, stBuscaPorIdLinhaTelefonicaIndicator.oiIdPessoaLinhaHistorico);
        ULOG("stBuscaPorIdLinhaTelefonica.oszIdGrupo.arr[%s](%d)", (char *)&stBuscaPorIdLinhaTelefonica.oszIdGrupo.arr, stBuscaPorIdLinhaTelefonicaIndicator.oiIdGrupo);
        ULOG("stBuscaPorIdLinhaTelefonica.oszNmGrupo.arr[%s](%d)", (char *)&stBuscaPorIdLinhaTelefonica.oszNmGrupo.arr, stBuscaPorIdLinhaTelefonicaIndicator.oiNmGrupo);

        memset(ptGrupo, 0x00, sizeof(TGrupo));

        if(stBuscaPorIdLinhaTelefonicaIndicator.oiIdLinhaTelefonica != -1) {
            ULOG("A");
            strcpy(ptGrupo->szIdLinhaTelefonica, (char *)&stBuscaPorIdLinhaTelefonica.oszIdLinhaTelefonica.arr);
        }

        if(stBuscaPorIdLinhaTelefonicaIndicator.oiIdPessoaLinhaHistorico != -1) {
            ULOG("B");
            strcpy(ptGrupo->szIdPessoaLinhaHistorico, (char *)&stBuscaPorIdLinhaTelefonica.oszIdPessoaLinhaHistorico.arr);
        }

        if(stBuscaPorIdLinhaTelefonicaIndicator.oiIdGrupo != -1) {
            ULOG("C");
            strcpy(ptGrupo->szIdGrupo, (char *)&stBuscaPorIdLinhaTelefonica.oszIdGrupo.arr);
        }

        if(stBuscaPorIdLinhaTelefonicaIndicator.oiNmGrupo != -1) {
            ULOG("D");
            strcpy(ptGrupo->szNmGrupo, (char *)&stBuscaPorIdLinhaTelefonica.oszNmGrupo.arr);
        }



        ULOG_END("Grupo::buscaClientePorIdLinhaTelefonica()");

        return true;
    
    }
    catch(...)
    {
        throw;
    }

sqlNotFound:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::buscaClientePorIdLinhaTelefonica()");
    return false;

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::buscaClientePorIdLinhaTelefonica()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
void Grupo::buscaClientePorCelular(char *pszCelular, XMLGen *xml_g)
{
    ULOG_START("Grupo::buscaClientePorCelular()");
    TGrupo tGrupo;
    char szAux[LEN_AUX + LEN_EOS];
    char szIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS];

    unsigned int iCont;
    bool bFlagRegFound = false;
	struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszCdAreaRegistro[LEN_CDAREAREGISTRO + LEN_EOS];
        VARCHAR oszNrLinha[LEN_NRLINHA + LEN_EOS];

        struct {
            VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS];
            VARCHAR oszNrMin[LEN_NRMIN + LEN_EOS];
            VARCHAR oszIdPessoaCliente[LEN_IDPESSOA + LEN_EOS];
            VARCHAR oszNmPessoaCliente[LEN_NMPESSOA + LEN_EOS];
            VARCHAR oszIdPessoaUsuario[LEN_IDPESSOA + LEN_EOS];
            VARCHAR oszNmPessoaUsuario[LEN_NMPESSOA + LEN_EOS];
            VARCHAR oszIdTipoLinha[LEN_IDTIPOLINHA + LEN_EOS];
            VARCHAR oszDsTipoLinha[LEN_DSTIPOLINHA + LEN_EOS];
        } stBuscaPorCelular;
        struct {
            short oiIdLinhaTelefonica;
            short oiNrMin;
            short oiIdPessoaCliente;
            short oiNmPessoaCliente;
            short oiIdPessoaUsuario;
            short oiNmPessoaUsuario;
            short oiIdTipoLinha;
            short oiDsTipoLinha;
        } stBuscaPorCelularIndicator;
    EXEC SQL END DECLARE SECTION;


	try
	{
        
        ULOG("pszCelular[%s]", pszCelular);

        memset(szAux, 0x00, sizeof(szAux));
        memcpy(szAux, pszCelular, 2);
        STRCPY_TO_ORA(oszCdAreaRegistro, szAux);
        ULOG("oszCdAreaRegistro.arr[%s]", oszCdAreaRegistro.arr);

        strcpy(szAux, pszCelular+2);
        STRCPY_TO_ORA(oszNrLinha, szAux);
        ULOG("oszNrLinha.arr[%s]", oszNrLinha.arr);
        
        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
        EXEC SQL WHENEVER NOT FOUND do break;

        EXEC SQL 
            DECLARE 
                CursorBuscaPorCelular CURSOR FOR
                    SELECT
                        LINHATELEFONICA.IDLINHATELEFONICA,
                        linhabase.nrmin,
                        pessoa.idpessoa,
                        pessoa.nmpessoa,
                        pessoaU.idpessoa idpessoaU,
                        pessoaU.nmpessoa nmpessoaU,
                        tipolinha.idtipolinha,
                        tipolinha.dstipolinha
                    FROM    
                        customer.pessoa pessoa,
                        customer.tiporelacionamento tiporelacionamento,
                        customer.pessoadepara pessoadepara,
                        customer.pessoalinha pessoalinha,
                        linha.linhatelefonica linhatelefonica,
                        linha.linhabase linhabase,
                        apoio.arearegistro arearegistro,
                        apoio.tipolinha tipolinha,
                        customer.pessoa pessoaU,
                        customer.tiporelacionamento tiporelacionamentoU,
                        customer.pessoadepara pessoadeparaU,
                        customer.pessoalinha pessoalinhaU,
                        linha.linhatelefonica linhatelefonicaU
                    WHERE   pessoa.idpessoa = pessoadepara.idpessoa
                    AND     pessoalinha.idtiporelacionamento = tiporelacionamento.idtiporelacionamento
                    AND     tiporelacionamento.Sgtiporelacionamento = 'C'
                    AND     pessoadepara.idpessoadepara = pessoalinha.idpessoadepara
                    AND     pessoalinha.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                    AND     linhatelefonica.idlinhabase = linhabase.idlinhabase
                    AND     linhabase.idarearegistro = arearegistro.idarearegistro
                    AND     linhabase.nrlinha = :oszNrLinha
                    AND     arearegistro.cdarearegistro = :oszCdAreaRegistro
                    AND     linhatelefonica.idtipolinha = tipolinha.idtipolinha
                    AND     linhatelefonica.idlinhabase = linhatelefonicaU.Idlinhabase
                    AND     linhatelefonicaU.Idlinhatelefonica = pessoalinhaU.Idlinhatelefonica
                    AND     pessoalinhaU.Idpessoadepara = pessoadeparaU.idpessoadepara
                    AND     pessoalinhaU.Idtiporelacionamento = tiporelacionamentoU.Idtiporelacionamento
                    AND     tiporelacionamentoU.Sgtiporelacionamento = 'U'
                    AND     pessoadeparaU.idpessoa = pessoaU.Idpessoa
                    AND     linhatelefonica.idlinhatelefonica IN 
                            ( 
                                SELECT 
                                    idlinhatelefonica
                                FROM
                                    customer.pessoalinhahistorico
                                WHERE
                                    pessoalinhahistorico.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                            );



        EXEC SQL OPEN CursorBuscaPorCelular;
        ULOG("OpenCursor.sqlca.sqlcode(%d)", sqlca.sqlcode);


        for(iCont=0;;iCont++)
        {
            ULOG("iCont(%u)", iCont);

            memset(&stBuscaPorCelular, 0x00, sizeof(stBuscaPorCelular));

            EXEC SQL FETCH CursorBuscaPorCelular INTO :stBuscaPorCelular:stBuscaPorCelularIndicator;
            ULOG("FETCH.sqlca.sqlcode(%d)", sqlca.sqlcode);

            ULOG("stBuscaPorCelular.oszIdLinhaTelefonica.arr[%s](%d)", (char *)&stBuscaPorCelular.oszIdLinhaTelefonica.arr, stBuscaPorCelularIndicator.oiIdLinhaTelefonica);
            ULOG("stBuscaPorCelular.oszNrMin.arr[%s](%d)", (char *)&stBuscaPorCelular.oszNrMin.arr, stBuscaPorCelularIndicator.oiNrMin);
            ULOG("stBuscaPorCelular.oszIdPessoaCliente.arr[%s](%d)", (char *)&stBuscaPorCelular.oszIdPessoaCliente.arr, stBuscaPorCelularIndicator.oiIdPessoaCliente);
            ULOG("stBuscaPorCelular.oszNmPessoaCliente.arr[%s](%d)", (char *)&stBuscaPorCelular.oszNmPessoaCliente.arr, stBuscaPorCelularIndicator.oiNmPessoaCliente);
            ULOG("stBuscaPorCelular.oszIdPessoaUsuario.arr[%s](%d)", (char *)&stBuscaPorCelular.oszIdPessoaUsuario.arr, stBuscaPorCelularIndicator.oiIdPessoaUsuario);
            ULOG("stBuscaPorCelular.oszNmPessoaUsuario.arr[%s](%d)", (char *)&stBuscaPorCelular.oszNmPessoaUsuario.arr, stBuscaPorCelularIndicator.oiNmPessoaUsuario);
            ULOG("stBuscaPorCelular.oszIdTipoLinha.arr[%s](%d)", (char *)&stBuscaPorCelular.oszIdTipoLinha.arr, stBuscaPorCelularIndicator.oiIdTipoLinha);
            ULOG("stBuscaPorCelular.oszDsTipoLinha.arr[%s](%d)", (char *)&stBuscaPorCelular.oszDsTipoLinha.arr, stBuscaPorCelularIndicator.oiDsTipoLinha);

            strcpy(szIdLinhaTelefonica, (char *)&stBuscaPorCelular.oszIdLinhaTelefonica.arr);
            ULOG("szIdLinhaTelefonica[%s]", szIdLinhaTelefonica);

            if(this->buscaClientePorIdLinhaTelefonica(szIdLinhaTelefonica, &tGrupo) == false) {
                this->retornoVazio(xml_g);
                break;
            }


            if(bFlagRegFound == false) {
                xml_g->createTag("GrupoCRIVO");
                xml_g->addProp(XML_OUT_PROP_XMLNS, XML_OUT_PROP_XMLNS_VALUE);
                bFlagRegFound = true;
            }

            xml_g->createTag("Linhas");
                xml_g->addItem("idLinha", (char *)&tGrupo.szIdPessoaLinhaHistorico);
                xml_g->addItem("nrLinha", (char *)&stBuscaPorCelular.oszNrMin.arr);
                xml_g->addItem("idCliente", (char *)&stBuscaPorCelular.oszIdPessoaCliente.arr);
                xml_g->addItem("nmCliente", (char *)&stBuscaPorCelular.oszNmPessoaCliente.arr);
                xml_g->addItem("idUsuario", (char *)&stBuscaPorCelular.oszIdPessoaUsuario.arr);
                xml_g->addItem("nmUsuario", (char *)&stBuscaPorCelular.oszNmPessoaUsuario.arr);
                xml_g->addItem("idTipoLinha", (char *)&stBuscaPorCelular.oszIdTipoLinha.arr);
                xml_g->addItem("dsTipoLinha", (char *)&stBuscaPorCelular.oszDsTipoLinha.arr);
                xml_g->addItem("idGrupoAssociado", (char *)&tGrupo.szIdGrupo);
                xml_g->addItem("dsGrupoAssociado", (char *)&tGrupo.szNmGrupo);
            xml_g->closeTag();
        }

        if(bFlagRegFound == true) {
            xml_g->closeTag();
            bFlagRegFound = false;
        }
        else
            this->retornoVazio(xml_g);

            
        EXEC SQL CLOSE CursorBuscaPorCelular;
        ULOG("CloseCursor.sqlca.sqlcode(%d)", sqlca.sqlcode);
        ULOG_END("Grupo::buscaClientePorCelular()");

        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::buscaClientePorCelular()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
void Grupo::buscaClientePorIdPessoa(char *pszIdPessoa, XMLGen *xml_g)
{
    ULOG_START("Grupo::buscaClientePorIdPessoa()");
    TGrupo tGrupo;
    unsigned int iCont;
    char szIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS];
    bool bFlagRegFound = false;
	struct sqlca sqlca;
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszIdPessoa[LEN_IDPESSOA + LEN_EOS];
        struct {
            VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS];
            VARCHAR oszNrMin[LEN_NRMIN + LEN_EOS];
            VARCHAR oszIdPessoaCliente[LEN_IDPESSOA + LEN_EOS];
            VARCHAR oszNmPessoaCliente[LEN_NMPESSOA + LEN_EOS];
            VARCHAR oszIdPessoaUsuario[LEN_IDPESSOA + LEN_EOS];
            VARCHAR oszNmPessoaUsuario[LEN_NMPESSOA + LEN_EOS];
            VARCHAR oszIdTipoLinha[LEN_IDTIPOLINHA + LEN_EOS];
            VARCHAR oszDsTipoLinha[LEN_DSTIPOLINHA + LEN_EOS];
        } stBuscaPorIdPessoa;
        struct {
            short oiIdLinhaTelefonica;
            short oiNrMin;
            short oiIdPessoaCliente;
            short oiNmPessoaCliente;
            short oiIdPessoaUsuario;
            short oiNmPessoaUsuario;
            short oiIdTipoLinha;
            short oiDsTipoLinha;
        } stBuscaPorIdPessoaIndicator;
    EXEC SQL END DECLARE SECTION;


	try
	{
        ULOG("Iniciando buscaClientePorIdPessoa");

        ULOG("pszIdPessoa[%s]", pszIdPessoa);
        STRCPY_TO_ORA(oszIdPessoa, pszIdPessoa);

        memset(&stBuscaPorIdPessoa, 0x00, sizeof(stBuscaPorIdPessoa));

        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
        EXEC SQL WHENEVER NOT FOUND do break;
    
        EXEC SQL 
            DECLARE 
                CursorBuscaPorIdPessoa CURSOR FOR
                    SELECT
                        linhatelefonica.idlinhatelefonica,
                        linhabase.nrmin,
                        pessoa.idpessoa,
                        pessoa.nmpessoa,
                        pessoaU.idpessoa idpessoaU,
                        pessoaU.nmpessoa nmpessoaU,
                        tipolinha.idtipolinha,
                        tipolinha.dstipolinha
                    FROM    
                        customer.pessoa pessoa,
                        customer.tiporelacionamento tiporelacionamento,
                        customer.pessoadepara pessoadepara,
                        customer.pessoalinha pessoalinha,
                        linha.linhatelefonica linhatelefonica,
                        linha.linhabase linhabase,
                        apoio.tipolinha tipolinha,
                        customer.pessoa pessoaU,
                        customer.tiporelacionamento tiporelacionamentoU,
                        customer.pessoadepara pessoadeparaU,
                        customer.pessoalinha pessoalinhaU,
                        linha.linhatelefonica linhatelefonicaU
                    WHERE   pessoa.idpessoa = pessoadepara.idpessoa
                    AND     pessoalinha.idtiporelacionamento = tiporelacionamento.idtiporelacionamento
                    AND     tiporelacionamento.Sgtiporelacionamento = 'C'
                    AND     pessoadepara.idpessoadepara = pessoalinha.idpessoadepara
                    AND     pessoalinha.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                    AND     linhatelefonica.idlinhabase = linhabase.idlinhabase
                    AND     linhatelefonica.idtipolinha = tipolinha.idtipolinha
                    AND     pessoa.idpessoa = TO_NUMBER(:oszIdPessoa)
                    AND     linhatelefonica.idlinhabase = linhatelefonicaU.Idlinhabase
                    AND     linhatelefonicaU.Idlinhatelefonica = pessoalinhaU.Idlinhatelefonica
                    AND     pessoalinhaU.Idpessoadepara = pessoadeparaU.idpessoadepara
                    AND     pessoalinhaU.Idtiporelacionamento = tiporelacionamentoU.Idtiporelacionamento
                    AND     tiporelacionamentoU.Sgtiporelacionamento = 'U'
                    AND     pessoadeparaU.idpessoa = pessoaU.Idpessoa
                    AND     linhatelefonica.idlinhatelefonica IN 
                            ( 
                                SELECT 
                                    idlinhatelefonica
                                FROM
                                    customer.pessoalinhahistorico
                                WHERE
                                    pessoalinhahistorico.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                            );



        EXEC SQL OPEN CursorBuscaPorIdPessoa;
    
        ULOG("1.sqlca.sqlcode(%d)", sqlca.sqlcode);


        for(iCont=0;;iCont++)
        {
            ULOG("iCont(%u)", iCont);

            memset(&stBuscaPorIdPessoa, 0x00, sizeof(stBuscaPorIdPessoa));

            EXEC SQL FETCH CursorBuscaPorIdPessoa INTO :stBuscaPorIdPessoa:stBuscaPorIdPessoaIndicator;
            ULOG("Fetch.sqlca.sqlcode(%d)", sqlca.sqlcode);

            ULOG("stBuscaPorIdPessoa.oszIdLinhaTelefonica.arr[%s](%d)", (char *)&stBuscaPorIdPessoa.oszIdLinhaTelefonica.arr, stBuscaPorIdPessoaIndicator.oiIdLinhaTelefonica);
            ULOG("stBuscaPorIdPessoa.oszNrMin.arr[%s](%d)", (char *)&stBuscaPorIdPessoa.oszNrMin.arr, stBuscaPorIdPessoaIndicator.oiNrMin);
            ULOG("stBuscaPorIdPessoa.oszIdPessoaCliente.arr[%s](%d)", (char *)&stBuscaPorIdPessoa.oszIdPessoaCliente.arr, stBuscaPorIdPessoaIndicator.oiIdPessoaCliente);
            ULOG("stBuscaPorIdPessoa.oszNmPessoaCliente.arr[%s](%d)", (char *)&stBuscaPorIdPessoa.oszNmPessoaCliente.arr, stBuscaPorIdPessoaIndicator.oiNmPessoaCliente);
            ULOG("stBuscaPorIdPessoa.oszIdPessoaUsuario.arr[%s](%d)", (char *)&stBuscaPorIdPessoa.oszIdPessoaUsuario.arr, stBuscaPorIdPessoaIndicator.oiIdPessoaUsuario);
            ULOG("stBuscaPorIdPessoa.oszNmPessoaUsuario.arr[%s](%d)", (char *)&stBuscaPorIdPessoa.oszNmPessoaUsuario.arr, stBuscaPorIdPessoaIndicator.oiNmPessoaUsuario);
            ULOG("stBuscaPorIdPessoa.oszIdTipoLinha.arr[%s](%d)", (char *)&stBuscaPorIdPessoa.oszIdTipoLinha.arr, stBuscaPorIdPessoaIndicator.oiIdTipoLinha);
            ULOG("stBuscaPorIdPessoa.oszDsTipoLinha.arr[%s](%d)", (char *)&stBuscaPorIdPessoa.oszDsTipoLinha.arr, stBuscaPorIdPessoaIndicator.oiDsTipoLinha);



            strcpy(szIdLinhaTelefonica, (char *)&stBuscaPorIdPessoa.oszIdLinhaTelefonica.arr);
            ULOG("szIdLinhaTelefonica[%s]", szIdLinhaTelefonica);

            if(this->buscaClientePorIdLinhaTelefonica(szIdLinhaTelefonica, &tGrupo) == false) {
                this->retornoVazio(xml_g);
                break;
            }

            if(bFlagRegFound == false) {
                xml_g->createTag("GrupoCRIVO");
                xml_g->addProp(XML_OUT_PROP_XMLNS, XML_OUT_PROP_XMLNS_VALUE);
                bFlagRegFound = true;
            }

            xml_g->createTag("Linhas");
                xml_g->addItem("idLinha", (char *)&tGrupo.szIdPessoaLinhaHistorico);
                xml_g->addItem("nrLinha", (char *)&stBuscaPorIdPessoa.oszNrMin.arr);
                xml_g->addItem("idCliente", (char *)&stBuscaPorIdPessoa.oszIdPessoaCliente.arr);
                xml_g->addItem("nmCliente", (char *)&stBuscaPorIdPessoa.oszNmPessoaCliente.arr);
                xml_g->addItem("idUsuario", (char *)&stBuscaPorIdPessoa.oszIdPessoaUsuario.arr);
                xml_g->addItem("nmUsuario", (char *)&stBuscaPorIdPessoa.oszNmPessoaUsuario.arr);
                xml_g->addItem("idTipoLinha", (char *)&stBuscaPorIdPessoa.oszIdTipoLinha.arr);
                xml_g->addItem("dsTipoLinha", (char *)&stBuscaPorIdPessoa.oszDsTipoLinha.arr);
                xml_g->addItem("idGrupoAssociado", (char *)&tGrupo.szIdGrupo);
                xml_g->addItem("dsGrupoAssociado", (char *)&tGrupo.szNmGrupo);
            xml_g->closeTag();
        }

        if(bFlagRegFound == true) {
            xml_g->closeTag();
            bFlagRegFound = false;
        }
        else
            this->retornoVazio(xml_g);
            
        EXEC SQL CLOSE CursorBuscaPorIdPessoa;

        ULOG("CloseCursor.sqlca.sqlcode(%d)", sqlca.sqlcode);
        ULOG_END("Grupo::buscaClientePorIdPessoa()");
        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::buscaClientePorIdPessoa()");
	throw TuxBasicOraException(sqlca.sqlcode);
}

/*******************************************************************************************************/
void Grupo::buscaClientePorConta(char *pszCdConta, XMLGen *xml_g)
{
    ULOG_START("Grupo::buscaClientePorConta()");
    TGrupo tGrupo;
    char szIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS];
    unsigned int iCont;
    bool bFlagRegFound = false;
	struct sqlca sqlca;
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR oszCdConta[LEN_CDCONTA + LEN_EOS];
        struct {
            VARCHAR oszNrMin[LEN_NRMIN + LEN_EOS];
            VARCHAR oszIdPessoaCliente[LEN_IDPESSOA + LEN_EOS];
            VARCHAR oszNmPessoaCliente[LEN_NMPESSOA + LEN_EOS];
            VARCHAR oszIdPessoaUsuario[LEN_IDPESSOA + LEN_EOS];
            VARCHAR oszNmPessoaUsuario[LEN_NMPESSOA + LEN_EOS];
            VARCHAR oszIdTipoLinha[LEN_IDTIPOLINHA + LEN_EOS];
            VARCHAR oszDsTipoLinha[LEN_DSTIPOLINHA + LEN_EOS];
            VARCHAR oszIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS];
        } stBuscaPorContaA;
        struct {
            short oiNrMin;
            short oiIdPessoaCliente;
            short oiNmPessoaCliente;
            short oiIdPessoaUsuario;
            short oiNmPessoaUsuario;
            short oiIdTipoLinha;
            short oiDsTipoLinha;
            short oiIdLinhaTelefonica;
        } stBuscaPorContaAIndicator;
    EXEC SQL END DECLARE SECTION;


	try
	{
        ULOG("pszCdConta[%s]", pszCdConta);
        STRCPY_TO_ORA(oszCdConta, pszCdConta);


        EXEC SQL WHENEVER SQLERROR GOTO GotoError;
        EXEC SQL WHENEVER NOT FOUND do break;
    
        EXEC SQL 
            DECLARE 
                CursorBuscaPorConta CURSOR FOR
                    SELECT
                        linhabase.nrmin,
                        pessoa.idpessoa,
                        pessoa.nmpessoa,
                        pessoaU.idpessoa idpessoaU,
                        pessoaU.nmpessoa nmpessoaU,
                        tipolinha.idtipolinha,
                        tipolinha.dstipolinha,
                        pessoalinha.idlinhatelefonica
                    FROM    
                        customer.pessoa pessoa,
                        customer.tiporelacionamento tiporelacionamento,
                        customer.pessoadepara pessoadepara,
                        customer.pessoalinha pessoalinha,
                        linha.linhatelefonica linhatelefonica,
                        linha.linhabase linhabase,
                        apoio.tipolinha tipolinha,
                        customer.pessoa pessoaU,
                        customer.tiporelacionamento tiporelacionamentoU,
                        customer.pessoadepara pessoadeparaU,
                        customer.pessoalinha pessoalinhaU,
                        linha.linhatelefonica linhatelefonicaU,
                        customer.linhaconta linhaconta,
                        customer.conta conta
                    WHERE   pessoa.idpessoa = pessoadepara.idpessoa
                    AND     pessoalinha.idtiporelacionamento = tiporelacionamento.idtiporelacionamento
                    AND     tiporelacionamento.Sgtiporelacionamento = 'C'
                    AND     pessoadepara.idpessoadepara = pessoalinha.idpessoadepara
                    AND     pessoalinha.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                    AND     linhatelefonica.idlinhabase = linhabase.idlinhabase
                    AND     linhatelefonica.idtipolinha = tipolinha.idtipolinha
                    AND     linhatelefonica.idlinhabase = linhatelefonicaU.Idlinhabase
                    AND     linhatelefonicaU.Idlinhatelefonica = pessoalinhaU.Idlinhatelefonica
                    AND     pessoalinhaU.Idpessoadepara = pessoadeparaU.idpessoadepara
                    AND     pessoalinhaU.Idtiporelacionamento = tiporelacionamentoU.Idtiporelacionamento
                    AND     tiporelacionamentoU.Sgtiporelacionamento = 'U'
                    AND     pessoadeparaU.idpessoa = pessoaU.Idpessoa
                    AND     linhatelefonica.idlinhatelefonica = linhaconta.idlinhatelefonica
                    AND     linhaconta.idconta = conta.idconta
                    AND     conta.cdconta = :oszCdConta
                    AND     linhatelefonica.idlinhatelefonica IN 
                            ( 
                                SELECT 
                                    idlinhatelefonica
                                FROM
                                    customer.pessoalinhahistorico
                                WHERE
                                    pessoalinhahistorico.idlinhatelefonica = linhatelefonica.idlinhatelefonica
                            );

        EXEC SQL OPEN CursorBuscaPorConta;
    
        ULOG("1.sqlca.sqlcode(%d)", sqlca.sqlcode);


        for(iCont=0;;iCont++)
        {
            ULOG("iCont(%u)", iCont);

            memset(&stBuscaPorContaA, 0x00, sizeof(stBuscaPorContaA));

            EXEC SQL FETCH CursorBuscaPorConta INTO :stBuscaPorContaA:stBuscaPorContaAIndicator;

            ULOG("2.sqlca.sqlcode(%d)", sqlca.sqlcode);

            ULOG("stBuscaPorContaA.oszNrMin.arr[%s](%d)", (char *)&stBuscaPorContaA.oszNrMin.arr, stBuscaPorContaAIndicator.oiNrMin);
            ULOG("stBuscaPorContaA.oszIdPessoaCliente.arr[%s](%d)", (char *)&stBuscaPorContaA.oszIdPessoaCliente.arr, stBuscaPorContaAIndicator.oiIdPessoaCliente);
            ULOG("stBuscaPorContaA.oszNmPessoaCliente.arr[%s](%d)", (char *)&stBuscaPorContaA.oszNmPessoaCliente.arr, stBuscaPorContaAIndicator.oiNmPessoaCliente);
            ULOG("stBuscaPorContaA.oszIdPessoaUsuario.arr[%s](%d)", (char *)&stBuscaPorContaA.oszIdPessoaUsuario.arr, stBuscaPorContaAIndicator.oiIdPessoaUsuario);
            ULOG("stBuscaPorContaA.oszNmPessoaUsuario.arr[%s](%d)", (char *)&stBuscaPorContaA.oszNmPessoaUsuario.arr, stBuscaPorContaAIndicator.oiNmPessoaUsuario);
            ULOG("stBuscaPorContaA.oszIdTipoLinha.arr[%s](%d)", (char *)&stBuscaPorContaA.oszIdTipoLinha.arr, stBuscaPorContaAIndicator.oiIdTipoLinha);
            ULOG("stBuscaPorContaA.oszDsTipoLinha.arr[%s](%d)", (char *)&stBuscaPorContaA.oszDsTipoLinha.arr, stBuscaPorContaAIndicator.oiDsTipoLinha);
            ULOG("stBuscaPorContaA.oszIdLinhaTelefonica.arr[%s](%d)", (char *)&stBuscaPorContaA.oszIdLinhaTelefonica.arr, stBuscaPorContaAIndicator.oiIdLinhaTelefonica);

            strcpy(szIdLinhaTelefonica, (char *)&stBuscaPorContaA.oszIdLinhaTelefonica.arr);
            ULOG("szIdLinhaTelefonica[%s]", szIdLinhaTelefonica);

            if(this->buscaClientePorIdLinhaTelefonica(szIdLinhaTelefonica, &tGrupo) == false) {
                this->retornoVazio(xml_g);
                break;
            }

            if(bFlagRegFound == false) {
                xml_g->createTag("GrupoCRIVO");
                xml_g->addProp(XML_OUT_PROP_XMLNS, XML_OUT_PROP_XMLNS_VALUE);
                bFlagRegFound = true;
            }

            xml_g->createTag("Linhas");
                xml_g->addItem("idLinha", (char *)&tGrupo.szIdPessoaLinhaHistorico);
                xml_g->addItem("nrLinha", (char *)&stBuscaPorContaA.oszNrMin.arr);
                xml_g->addItem("idCliente", (char *)&stBuscaPorContaA.oszIdPessoaCliente.arr);
                xml_g->addItem("nmCliente", (char *)&stBuscaPorContaA.oszNmPessoaCliente.arr);
                xml_g->addItem("idUsuario", (char *)&stBuscaPorContaA.oszIdPessoaUsuario.arr);
                xml_g->addItem("nmUsuario", (char *)&stBuscaPorContaA.oszNmPessoaUsuario.arr);
                xml_g->addItem("idTipoLinha", (char *)&stBuscaPorContaA.oszIdTipoLinha.arr);
                xml_g->addItem("dsTipoLinha", (char *)&stBuscaPorContaA.oszDsTipoLinha.arr);
                xml_g->addItem("idGrupoAssociado", (char *)&tGrupo.szIdGrupo);
                xml_g->addItem("dsGrupoAssociado", (char *)&tGrupo.szNmGrupo);
            xml_g->closeTag();
        }

        if(bFlagRegFound == true) {
            xml_g->closeTag();
            bFlagRegFound = false;
        }
        else
            this->retornoVazio(xml_g);

        EXEC SQL CLOSE CursorBuscaPorConta;
        ULOG("3.sqlca.sqlcode(%d)", sqlca.sqlcode);
        ULOG_END("Grupo::buscaClientePorConta()");

        return;
    
    }
    catch(...)
    {
        throw;
    }

GotoError:
    ULOGE("ERRO ORACLE -> sqlcode=%d,sqlerrmc=%.70s",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
    ULOG_END("Grupo::buscaClientePorConta()");
	throw TuxBasicOraException(sqlca.sqlcode);
}
