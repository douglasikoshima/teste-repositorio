#include "../../negocio/clienteCmm/include/Messages.h"
#include "../../negocio/clienteCmm/include/Funcoes.h"
#include <tuxfw.h>

#include "../include/CarregaTI.h"

EXEC SQL BEGIN DECLARE SECTION;
#include "Global.h"
EXEC SQL END DECLARE SECTION;

EXEC SQL INCLUDE "../../negocio/clienteCmm/include/classUsuario.h";
EXEC SQL INCLUDE "../../negocio/clienteCmm/include/classPlanoServicoLinha.h";
EXEC SQL INCLUDE "../../negocio/clienteCmm/include/classPessoaLinha.h";
EXEC SQL INCLUDE "../../negocio/clienteCmm/include/classPessoaEndereco.h";
EXEC SQL INCLUDE "../../negocio/clienteCmm/include/classDocumentoVO.h";
EXEC SQL INCLUDE "../../negocio/clienteCmm/include/AreaRegistroBloqueado.h";

DECLARE_TUXEDO_SERVICE(CarregaTI);

void implCarregaTI::Execute(DOMNode *pDnode, XMLGen *pXmlG)
{
	char szIdLinhaTelefonica[LEN_IDLINHATELEFONICA + LEN_EOS]={0};
    char szNrLinha[LEN_NRLINHA + LEN_EOS]={0};
    bool bFlagExecQuery=true;
    char *pParam1=NULL;
    CUsuario *poUsuario=NULL;
	int  iPortabilidade=0;
	char szTpPortabilidade[10]={0};
	char szDsPortabilidade[255]={0};
    int  inSaltador = 0;


    try
    {
        ULOG_START( "implCarregaTI::Execute()" );


        CPessoaLinha oPessLinha;
        CPlanoServicoLinha oPSL;
        CPessoaEndereco oPE;
        CDocumentoVO oPD;

		memset(szTpPortabilidade,0,sizeof(szTpPortabilidade));
		memset(szTpPortabilidade,0,sizeof(szDsPortabilidade));

		pParam1 = walkTree(pDnode, XML_IN_IDLINHATELEFONICA, 0);
		if (pParam1) {
	        if(!*pParam1) {
	            ERROR(NRO_IDLINHATELEFONICA_VV);
	            TAG_VALOR_VAZIO(XML_IN_IDLINHATELEFONICA);
	            XMLString::release(&pParam1);
	            throw new TuxBasicSvcException(sNrMsg, sMsg);
	        }
	        if(!IsNumeric(pParam1) ){
	            ERROR(NRO_IDLINHATELEFONICA_VI);
	            TAG_VALOR_INVALIDO(XML_IN_IDLINHATELEFONICA);
	            XMLString::release(&pParam1);
	            throw new TuxBasicSvcException(sNrMsg, sMsg);
	        }

	        strcpy(szIdLinhaTelefonica, pParam1);
	        XMLString::release(&pParam1);
	        ULOG("szIdLinhaTelefonica[%s]", szIdLinhaTelefonica);
		} else {
        pParam1 = walkTree(pDnode, XML_IN_NRLINHA, 0);
        if(!pParam1) {
            ERROR(NRO_NR_LINHA_NE);
            TAG_INEXISTENTE(XML_IN_NRLINHA);
            throw new TuxBasicSvcException(sNrMsg, sMsg);
        }
        if(!*pParam1) {
            ERROR(NRO_NR_LINHA_VV);
            TAG_VALOR_VAZIO(XML_IN_NRLINHA);
            XMLString::release(&pParam1);
            throw new TuxBasicSvcException(sNrMsg, sMsg);
        }
        if(!IsNumeric(pParam1) ){
            ERROR(NRO_NR_LINHA_VI);
            TAG_VALOR_INVALIDO(XML_IN_NRLINHA);
            XMLString::release(&pParam1);
            throw new TuxBasicSvcException(sNrMsg, sMsg);
        }

        strcpy(szNrLinha, pParam1);
        XMLString::release(&pParam1);
        ULOG("szNrLinha[%s]", szNrLinha);
		}


        pXmlG->createTag(XML_OUT_ROOT);
        pXmlG->addProp("xmlns", XML_OUT_PROP);
        pXmlG->createTag(XML_OUT_NO_TICLIENTE);


        short ret = (szNrLinha[0])? oPessLinha.buscarDadosClientePorNrLinha(szNrLinha) : oPessLinha.buscarDadosClientePorIdLinhaTelefonica(szIdLinhaTelefonica);
		if ( ret == OK )
			{
				pXmlG->addItem(XML_OUT_IDPESSOA, oPessLinha.getIdPessoa());
				pXmlG->addItem(XML_OUT_NMPESSOA, oPessLinha.getNmPessoa());
				pXmlG->addItem(XML_OUT_NRTELEFONE, oPessLinha.getNrTelefone());
				pXmlG->addItem(XML_OUT_INTPPESSOA, oPessLinha.getDsTipoPessoa());
				pXmlG->addItem(XML_OUT_DSCHURN, oPessLinha.getDtChurn());
				pXmlG->createTag(XML_OUT_NO_CARTEIRA);
					pXmlG->addItem(XML_OUT_CODIGO, oPessLinha.getIdTipoCarteira());
					pXmlG->addItem(XML_OUT_DESCRICAO, oPessLinha.getDsTipoCarteira());
					pXmlG->addItem( "sgTipoCarteira", oPessLinha.getSgTipoCarteira());
				pXmlG->closeTag();

				//Mandando vazio pq os dados estao na SESSAO
				pXmlG->createTag(XML_OUT_NO_SEGMENTA);
				pXmlG->closeTag();
			}
		else
		{
			ret = (szNrLinha[0])? oPessLinha.buscarDadosProspectPorNrLinha(szNrLinha) : oPessLinha.buscarDadosProspectPorIdLinhaTelefonica(szIdLinhaTelefonica);
			if ( ret == OK )
			{
				pXmlG->addItem(XML_OUT_IDPESSOA, oPessLinha.getIdPessoa());
				pXmlG->addItem(XML_OUT_NMPESSOA, oPessLinha.getNmPessoa());
				pXmlG->addItem(XML_OUT_NRTELEFONE, oPessLinha.getNrTelefone());
				pXmlG->addItem(XML_OUT_INTPPESSOA, oPessLinha.getDsTipoPessoa());
				pXmlG->addItem(XML_OUT_DSCHURN, oPessLinha.getDtChurn());
				pXmlG->createTag(XML_OUT_NO_CARTEIRA);
					pXmlG->addItem(XML_OUT_CODIGO, oPessLinha.getIdTipoCarteira());
					pXmlG->addItem(XML_OUT_DESCRICAO, oPessLinha.getDsTipoCarteira());
                    pXmlG->addItem( "sgTipoCarteira", oPessLinha.getSgTipoCarteira());
				pXmlG->closeTag();

				//Mandando vazio pq os dados estao na SESSAO
				pXmlG->createTag(XML_OUT_NO_SEGMENTA);
				pXmlG->closeTag();
			}
		}


		pXmlG->addItem("isBlindagem", oPessLinha.getBlindagem(  (szNrLinha[0])? szNrLinha : oPessLinha.getNrLinha() ));

        if ( oPessLinha.obterNomeGestorConta() == true )
        {
            ULOG( "oPessLinha.getNmPessoa   [%s]", oPessLinha.getNmPessoa() );
            ULOG( "oPessLinha.getNrTelefone [%s]", oPessLinha.getNrTelefone() );
            
            pXmlG->createTag(XML_OUT_NO_GESTOR);
                pXmlG->addItem(XML_OUT_NMGESTOR, oPessLinha.getNmPessoa());
                pXmlG->addItem(XML_OUT_NRTELEFONE, oPessLinha.getNrTelefone());
            pXmlG->closeTag();
        }

        pXmlG->closeTag();

        ULOG("local2");

        ULOG("oPessLinha.getIdPessoa()[%s]", oPessLinha.getIdPessoa());
        if(strlen(oPessLinha.getIdPessoa()) == 0) {
            bFlagExecQuery=false;
        }

        pXmlG->createTag(XML_OUT_NO_TILINHA);

            pXmlG->addItem(XML_OUT_IDLINHA, oPessLinha.getIdLinhaTelefonica());
            pXmlG->addItem(XML_OUT_NRCODAREA, oPessLinha.getCdAreaRegistro());
            pXmlG->addItem(XML_OUT_NRLINHA, oPessLinha.getNrLinha());
            
            /*
            if ( oPessLinha.IsClienteSaltador(szNrLinha) == true )
            {
                inSaltador = 1;
            }

            pXmlG->addItem( "flagSaltador", inSaltador );
            */

            int retorno = oPessLinha.buscarDadosCartaoVivoItau( (szNrLinha[0])? szNrLinha : oPessLinha.getNrLinha() );
            
            pXmlG->createTag("ItaucardVO");
            if ( retorno == OK )
            {
                pXmlG->addItem("inItaucard","1");
                pXmlG->addItem("sgTipoLinha",oPessLinha.getDsModalidadeCartaoItau());
            }
            else
            {
                pXmlG->addItem("inItaucard","0");
            }
            pXmlG->closeTag();

            if(bFlagExecQuery)
            {
                CAreaRegistroBloqueado *pclAreaRegistroBloqueado = new CAreaRegistroBloqueado;
                pclAreaRegistroBloqueado->setNrLinha(oPessLinha.getNrLinha());
                if(pclAreaRegistroBloqueado->DDDBloqueado() == true)
                {
                    pXmlG->addItem("inBloqueado", "1");
                }
                else
                {
                    pXmlG->addItem("inBloqueado", "0");
                }
                delete pclAreaRegistroBloqueado;
            }
            else
            {
                pXmlG->addItem("inBloqueado", "0");
            }

            pXmlG->addItem("nrLinhaFormat", oPessLinha.getDddLinhaFormatada());
            pXmlG->addItem(XML_OUT_DSTIPOLINHA, oPessLinha.getDsTipoLinha());
            pXmlG->addItem(XML_OUT_DSESTADOLINHA, oPessLinha.getDsEstadoLinha());
            pXmlG->addItem(XML_OUT_DTHABILITACAO, oPessLinha.getDtHabilitacaoOut());

            oPSL.buscarPlanoServico(oPessLinha.getIdLinhaTelefonica());
            pXmlG->addItem(XML_OUT_DSPLANOSERVICO, oPSL.getNmServico());

            if(bFlagExecQuery)
            {
                pXmlG->addItem(XML_OUT_QTDLINHAATIVA, "0");
                pXmlG->addItem(XML_OUT_QTDLINHAINATIVA, "0");
                pXmlG->addItem(XML_OUT_QTDLINHAS, "0");
                //
                // --> Funcionalidade movida para o LupaLinha -- Jan/2009 -- Cassio
                //pXmlG->addItem(XML_OUT_QTDLINHAATIVA, oPessLinha.obterQtdEstadoLinhaCarregaTI(oPessLinha.getIdPessoa(), "A")); //"A"=Ativa
                //pXmlG->addItem(XML_OUT_QTDLINHAINATIVA, oPessLinha.obterQtdEstadoLinhaCarregaTI(oPessLinha.getIdPessoa(), "D")); // "D"=Cancelado
                //pXmlG->addItem(XML_OUT_QTDLINHAS, oPessLinha.obterQtdTipoLinhaCarregaTI(oPessLinha.getIdPessoa()));
                // <-- Funcionalidade movida para o LupaLinha -- Jan/2009 -- Cassio
            }
            else
            {
                pXmlG->addItem(XML_OUT_QTDLINHAATIVA, "0");
                pXmlG->addItem(XML_OUT_QTDLINHAINATIVA, "0");
                pXmlG->addItem(XML_OUT_QTDLINHAS, "0");
            }

            if(bFlagExecQuery)
            {
                ULOG("CUsuario(oPessLinha.getIdLinhaTelefonica())");
                poUsuario = new CUsuario(oPessLinha.getIdLinhaTelefonica());
            }
            else
            {
                ULOG("CUsuario");
                poUsuario = new CUsuario;
            }

			//799 - Protocolo portabilidade
			
            pXmlG->createTag(XML_OUT_NO_USUARIOLIN);
                pXmlG->addItem(XML_OUT_IDPESSOA, poUsuario->getIdPessoa());
                pXmlG->addItem(XML_OUT_NMUSUARIO, poUsuario->getNmPessoa());
                pXmlG->addItem(XML_OUT_IDDOCUM, poUsuario->getIdDocumento());
                pXmlG->addItem(XML_OUT_TPDOCUM, poUsuario->getSgTipoDocumento());
                pXmlG->addItem(XML_OUT_NRDOCUM, poUsuario->getNrDocumento());
                pXmlG->addItem(XML_OUT_TPCONTATO, poUsuario->getDsTipoComunicacao());
                pXmlG->addItem(XML_OUT_NRCONTATO, poUsuario->getDsContato());
                pXmlG->addItem(XML_OUT_VLRENTAB, poUsuario->getVlRentabilidade());
                if(bFlagExecQuery)
                {
                    pXmlG->addItem(XML_OUT_DSCARGO, poUsuario->getDsCargoContatoDeVerdade(poUsuario->getIdPessoa()));
                }
                else
                {
                    pXmlG->addItem(XML_OUT_DSCARGO, "");
                }
                ULOG("local b2");
	        pXmlG->closeTag();


			  //799 - Protocolo - identificao de portabilidade na tela inicia
		  	  iPortabilidade= oPessLinha.obterDadosPortabilidade( ((szNrLinha[0])? szNrLinha : oPessLinha.getNrLinha()), szTpPortabilidade, szDsPortabilidade);
			  pXmlG->addItem("inPortabilidade",iPortabilidade);
             
			  if (iPortabilidade)
			  {
				  pXmlG->addItem("tpPortada",szTpPortabilidade);
				  pXmlG->addItem("dsPortada",szDsPortabilidade);
			  }

        pXmlG->closeTag();

        ULOG("local3");

        pXmlG->createTag(XML_OUT_NO_TIFATU);
        pXmlG->closeTag();

        ULOG("...PONTO...");
        if(bFlagExecQuery)
            oPE.buscarPorIdLinhaTelefonica(oPessLinha.getIdPessoa(), oPessLinha.getIdLinhaTelefonica());

        pXmlG->createTag(XML_OUT_NO_ENDERECO);
                pXmlG->addItem(XML_OUT_IDENDERECO, oPE.getIdEndereco());

                char *pTipoLogradouro;
                char *pTituloLogradouro;
                char *pNmLogradouro;
                char szAux[LEN_NMLOGRADOURO + LEN_EOS];

                pTipoLogradouro = oPE.getNmTipoLogradouro();
                pTituloLogradouro = oPE.getNmTituloLogradouro();
                pNmLogradouro = oPE.getNmLogradouro1();

                // Verifica se o TipoLogradouro eh igual ao TituloLogradouro.
                if(!strcmp(pTipoLogradouro, pTituloLogradouro))
                    sprintf(szAux, "%s %s", pTipoLogradouro, pNmLogradouro);
                else
                    sprintf(szAux, "%s %s %s", pTipoLogradouro, pTituloLogradouro, pNmLogradouro);

                ULOG("szAux[%s]", szAux);

                pXmlG->addItem(XML_OUT_NMLOGRADOURO, szAux);

                pXmlG->addItem(XML_OUT_NUMERO, oPE.getNrEndereco());
                pXmlG->addItem(XML_OUT_COMPLEMENTO, oPE.getDsEnderecoComplemento());
                pXmlG->addItem(XML_OUT_NMBAIRRO, oPE.getNmBairro());
                pXmlG->addItem(XML_OUT_MUNICIPIO, oPE.getNmMunicipio());
                pXmlG->addItem(XML_OUT_CEP, oPE.getNrCep());


                pXmlG->createTag(XML_OUT_NO_UF);
                    pXmlG->addItem(XML_OUT_IDUF, oPE.getIdUF());
                    pXmlG->addItem(XML_OUT_SGUF, oPE.getSgUF());
                    pXmlG->addItem(XML_OUT_DSUF, oPE.getNmUF());
                pXmlG->closeTag();

                pXmlG->createTag(XML_OUT_NO_PAIS);
                    pXmlG->addItem(XML_OUT_IDPAIS, oPE.getIdPais());
                    pXmlG->addItem(XML_OUT_SGPAIS, oPE.getSgPais());
                    pXmlG->addItem(XML_OUT_DSPAIS, oPE.getNmPais());
                    pXmlG->addItem(XML_OUT_NACIONALIDADE, oPE.getDsNacionalidade());
                pXmlG->closeTag();
        pXmlG->closeTag();

        ULOG("local4");

        if(bFlagExecQuery)
            oPD.buscarPorIdPessoa(oPessLinha.getIdPessoa());

        pXmlG->createTag(XML_OUT_NO_TIDOCUME);
            pXmlG->addItem(XML_OUT_IDDOCUM, oPD.getIdDocumento());
            pXmlG->addItem(XML_OUT_TPDOCUM, oPD.getSgTipoDocumento());
            pXmlG->addItem(XML_OUT_NRDOCUM, oPD.getNrDocumento());
        pXmlG->closeTag();

        pXmlG->closeTag();  // fecha a tag principal
    }
    catch(...)
    {
        if(poUsuario) {
            delete poUsuario;
            poUsuario=NULL;
        }
        throw;
    }


    if(poUsuario) {
        delete poUsuario;
        poUsuario=NULL;
    }

	// Execução OK.
	INFORMATION(NRO_OK);

    ULOG_END( "implCarregaTI::Execute()" );
	setStatusCode(sNrMsg, MSG_OK);
}
