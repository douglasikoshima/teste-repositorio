#include <tuxfw.h>
#include "../../negocio/clienteCmm/include/Messages.h"
#include "../../negocio/clienteCmm/include/Funcoes.h"
#include "../../negocio/clienteCmm/include/Grupo.h"
#include "../include/SETLINHAS.h"

DECLARE_TUXEDO_SERVICE(SETLINHAS);

void implSETLINHAS::Execute(DOMNode* dnode, XMLGen* xml_g) {
    TXmlIn tXmlIn;
    unsigned int iCont;
    char *pAux;
    Grupo *pclGrupo;


    ULOG_START( "implSETLINHAS::Execute()" );
    try
    {
        ULOG("Iniciando SETLINHAS");
    
        pclGrupo = new Grupo;
    
        for(iCont=0;;iCont++) {
            ULOG("iCont(%d)", iCont);
            memset(&tXmlIn, 0x00, sizeof(TXmlIn));
        
            pAux = walkTree(dnode, XML_IN_IDPESSOALINHAHISTORICO, iCont);
            if(pAux) {
                strcpy(tXmlIn.szIdPessoaLinhaHistorico, pAux);
                XMLString::release(&pAux);
            }
            else
                break;
        
            pAux = walkTree(dnode, XML_IN_IDGRUPO, iCont);
            if(pAux) {
                strcpy(tXmlIn.szIdGrupo, pAux);
                XMLString::release(&pAux);
            }
    
            ULOG("tXmlIn.szIdPessoaLinhaHistorico[%s]", tXmlIn.szIdPessoaLinhaHistorico);
            ULOG("tXmlIn.szIdGrupo[%s]", tXmlIn.szIdGrupo);
    
            /* se o campo XML_IN_IDGRUPO estiver vazio, expira os szIdPessoaLinhaHistorico obtidos */
            /* senao, expira os szIdPessoaLinhaHistorico que vieram no xml, se existir, e insere-os novamente junto com o IdGrupo*/
            if(strlen(tXmlIn.szIdGrupo) == 0) {
                ULOG("Local1");
                pclGrupo->expiraLinhaTelefonicaGrupo(tXmlIn.szIdPessoaLinhaHistorico);
            }
            else {
                ULOG("Local2");
                pclGrupo->expiraLinhaTelefonicaGrupo(tXmlIn.szIdPessoaLinhaHistorico);
                ULOG("Local3");
                pclGrupo->insereLinhaTelefonicaGrupo(tXmlIn.szIdPessoaLinhaHistorico, tXmlIn.szIdGrupo);
            }
        }
    }
    catch(...)
    {
        ULOG("Local4");
        delete pclGrupo;
        throw;
    }
    
    
    ULOG_START( "implSETLINHAS::Execute()" );
    delete pclGrupo;

	INFORMATION(NRO_OK);
	setStatusCode(sNrMsg, MSG_OK);
}
