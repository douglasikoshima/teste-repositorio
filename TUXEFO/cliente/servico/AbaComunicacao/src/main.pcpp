//------------------------------------------------------------------------------------
  //                           (c) Consorcio Indra/PT-SI.
  //                              xxxxxxxxxxxxxxxxxxxxxxx
  //                                  xxxxxxxxxxxxxx 
  //----------------------------------------------------------------------------------
  // Los contenidos de este fichero son propiedad de Telefonica Consorsio Indra/Pt-SI.
  // titular del copyright. Este fichero solo podra ser copiado, distribuido y utilizado,
  // em su totalidad o en parte, con el permiso escrito de Consorcio Indra/Pt-SI o de
  // acuerdo com los terminos y condiciones establecidas em el acuerdo/contrato bajo el
  // que se suministra.
//----------------------------------------------------------------------------------
//* Fonte: main.pcpp
//* Servico: AbaComunicacao
//* Servidor: LupaCliente
//*
//* Ficheiro: TUXEFO/cliente/LupaCliente/AbaComunicacao/src
//*
//* Tipo: Pro*C
//*
//* Autor: Jefferson da S. Martins
//*
//* Fecha primeira version:11/06/2004
//*
//* Version actual: 01.00
//*
//* Purpose:
//*//-------------------------------------------------------------------------------
//* Purpose:
//*
//* Servico para gerar o arquivo XML de saida para preenchimento da AbaComunicacao da 
//* Lupa Cliente.
//*
//*//-------------------------------------------------------------------------------
//---------------------------------------------------------------------
//EXEC SQL INCLUDE SQLCA;
#undef SQLCA
#define SQLCA_NONE
#include <sqlca.h>
#include <sqlda.h>

#include <tuxfw.h>

#include "../../negocio/clienteCmm/include/Exception.h"
#include "../../negocio/clienteCmm/include/Messages.h"
#include "../../negocio/clienteCmm/include/Funcoes.h"

#include "../include/AbaComunicacao.h"

EXEC SQL BEGIN DECLARE SECTION;
	VARCHAR stIdSistemaOrigemBase[21+1];
	short   iIdSistemaOrigemBase;
#include "Global.h"
EXEC SQL END DECLARE SECTION;

EXEC SQL INCLUDE "../../negocio/clienteCmm/include/classPessoaComunicacao.h";

int buscaIdSistemaOrigem( char* csgSistemOrigem );

DECLARE_TUXEDO_SERVICE(AbaComunicacao);

void implAbaComunicacao::Execute(DOMNode *pDnode, XMLGen *pXmlG)
{
    ULOG_START( "implAbaComunicacao::Execute()" );
    
	char *pParam;
	char *pAcao;
	int iNroReg = 0;
	int iAux = 0;
	int iRet;
    int iCont;
	CPessoaComunicacao oObj;
	CPessoaComunicacao* poObj;

    pAcao = walkTree(pDnode, XML_ACAO, 0);
    if(!pAcao){
        ERROR(NRO_ACAO_NE);
        TAG_INEXISTENTE(XML_ACAO);
        throw new TuxBasicSvcException(sNrMsg, sMsg);
    }

    if ( !*pAcao){
        ERROR(NRO_ACAO_VV);
        TAG_INEXISTENTE(XML_ACAO);

        if (pAcao) XMLString::release(&pAcao);

        throw new TuxBasicSvcException(sNrMsg, sMsg);
    }
    //

    try{
        upper(pAcao);
        if ( !(strcmp(pAcao, "INCLUIR")) || !(strcmp(pAcao, "ALTERAR")) )
        {
            ULOG("local1.0");


	        // Guarda o usuario que esta executando esse servico
	        oObj.setUsuarioAlteracao(getUser());

            if ( !(strcmp(pAcao, "INCLUIR")) )
            {
                pParam = walkTree(pDnode, XML_DSCONTATO, 0);
                if(!pParam){
                    ERROR(NRO_DS_CONTATO_NE);
                    TAG_INEXISTENTE(XML_DSCONTATO);
                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                if ( !*pParam){
                    ERROR(NRO_DS_CONTATO_VV);
                    TAG_INEXISTENTE(XML_DSCONTATO);
    
                    if (pParam) XMLString::release(&pParam);
    
                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                oObj.setDsContato(pParam);
    
                if (pParam) XMLString::release(&pParam);


                pParam = walkTree(pDnode, XML_IDPESSOA, 0);
                if(!pParam)
                {
                    ERROR(NRO_ID_PESSOA_NE);
                    TAG_INEXISTENTE(XML_IDPESSOA);
                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                if ( !*pParam)
                {
                    ERROR(NRO_ID_PESSOA_NE);
                    TAG_VALOR_VAZIO(XML_IDPESSOA);

                    if (pParam) XMLString::release(&pParam);

                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                if ( !IsNumeric(pParam) ){
                    ERROR(NRO_ID_PESSOA_VI);
                    TAG_VALOR_INVALIDO(XML_IDPESSOA);

                    if (pParam) XMLString::release(&pParam);

                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                oObj.setIdPessoa(pParam);
                if (pParam) XMLString::release(&pParam);

                pParam = walkTree(pDnode, XML_IDTPCOMUNICACAO, 0);
                if(!pParam){
                    ERROR(NRO_ID_TPCOMUNICACAO_NE);
                    TAG_INEXISTENTE(XML_IDTPCOMUNICACAO);
                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                if ( !*pParam){
                    ERROR(NRO_ID_TPCOMUNICACAO_VV);
                    TAG_INEXISTENTE(XML_IDTPCOMUNICACAO);

                    if (pParam) XMLString::release(&pParam);

                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                if ( !IsNumeric(pParam) ){
                    ERROR(NRO_ID_TPCOMUNICACAO_VI);
                    TAG_VALOR_INVALIDO(XML_IDTPCOMUNICACAO);

                    if (pParam) XMLString::release(&pParam);

                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                oObj.setIdTipoComunicacao(pParam);
                if (pParam) XMLString::release(&pParam);

                pParam = walkTree(pDnode, XML_NRSEQUENCIA, 0);
                if(pParam && *pParam){
                    if ( !IsNumeric(pParam) ){
                        ERROR(NRO_NR_SEQUENCIA_VI);
                        TAG_VALOR_INVALIDO(XML_NRSEQUENCIA);

                        if (pParam) XMLString::release(&pParam);

                        throw new TuxBasicSvcException(sNrMsg, sMsg);
                    }
                }
                else
                {
                    XMLString::release(&pParam);
                    pParam = 0;
                }

                oObj.setNrSequencia(pParam);

                if (pParam) XMLString::release(&pParam);

                ULOG("local1.1");
                iRet = oObj.Incluir();
                ULOG("local1.2");

                switch(iRet)
                {
                    case NOK:
                        ERROR(NRO_INSERT_NAO_EFETUADO);
                        throw new TuxBasicSvcException(sNrMsg, MSG_INSERT_NAO_EFETUADO);
                        break;
                    case DUPLICATE_KEY:
                        pXmlG->addItem("FAILED", "DUPLICATE KEY");
                        break;
                };
            }
            else {

                // OBTEM IDPESSOA
                pParam = walkTree(pDnode, XML_IDPESSOA, 0);
                if(!pParam) {
                    ERROR(NRO_ID_PESSOA_NE);
                    TAG_INEXISTENTE(XML_IDPESSOA);
                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                if ( !*pParam) {
                    ERROR(NRO_ID_PESSOA_NE);
                    TAG_VALOR_VAZIO(XML_IDPESSOA);

                    if (pParam) XMLString::release(&pParam);
                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                if ( !IsNumeric(pParam) ){
                    ERROR(NRO_ID_PESSOA_VI);
                    TAG_VALOR_INVALIDO(XML_IDPESSOA);

                    if (pParam) XMLString::release(&pParam);
                    throw new TuxBasicSvcException(sNrMsg, sMsg);
                }
                oObj.setIdPessoa(pParam);
                ULOG("setIdPessoa[%s]", pParam);
                if (pParam) XMLString::release(&pParam);




                for(iCont=0; (pParam = walkTree(pDnode, XML_IDPESSOACOMU, iCont)) != NULL; iCont++)
                {
                    ULOG("iCont(%d)", iCont);

                    // OBTEM IDCOMUNICACAO
                    //pParam = walkTree(pDnode, XML_IDPESSOACOMU, iCont);
                    if(!pParam){
                        ERROR(NRO_ID_PESSOA_COM_NE);
                        TAG_INEXISTENTE(XML_IDPESSOACOMU);
                        throw new TuxBasicSvcException(sNrMsg, sMsg);
                    }
                    if ( !*pParam){
                        ERROR(NRO_ID_PESSOA_COM_VV);
                        TAG_INEXISTENTE(XML_IDPESSOACOMU);
    
                        if (pParam) XMLString::release(&pParam);
                        throw new TuxBasicSvcException(sNrMsg, sMsg);
                    }
                    if ( !IsNumeric(pParam) ){
                        ERROR(NRO_ID_PESSOA_COM_VI);
                        TAG_VALOR_INVALIDO(XML_IDPESSOACOMU);
    
                        if (pParam) XMLString::release(&pParam);
                        throw new TuxBasicSvcException(sNrMsg, sMsg);
                    }
                    oObj.setIdComunicacao(pParam);
                    ULOG("setIdComunicacao[%s]", pParam);
                    if (pParam) XMLString::release(&pParam);
    
    
    
    
    
                    // OBTEM DSCONTATO
                    pParam = walkTree(pDnode, XML_DSCONTATO, iCont);
                    if(!pParam){
                        ERROR(NRO_DS_CONTATO_NE);
                        TAG_INEXISTENTE(XML_DSCONTATO);
                        throw new TuxBasicSvcException(sNrMsg, sMsg);
                    }
                    if ( !*pParam){
                        ERROR(NRO_DS_CONTATO_VV);
                        TAG_INEXISTENTE(XML_DSCONTATO);
        
                        if (pParam) XMLString::release(&pParam);
                        throw new TuxBasicSvcException(sNrMsg, sMsg);
                    }
                    oObj.setDsContato(pParam);
                    ULOG("setDsContato[%s]", pParam);
                    if (pParam) XMLString::release(&pParam);
    
    


    
    
                    // OBTEM NRSEQUENCIA
                    pParam = walkTree(pDnode, XML_NRSEQUENCIA, iCont);
                    if(pParam && *pParam){
                        if ( !IsNumeric(pParam) ){
                            ERROR(NRO_NR_SEQUENCIA_VI);
                            TAG_VALOR_INVALIDO(XML_NRSEQUENCIA);
    
                            if (pParam) XMLString::release(&pParam);
                            throw new TuxBasicSvcException(sNrMsg, sMsg);
                        }
                    } else {
                        XMLString::release(&pParam);
                        pParam = 0;
                    }
    
                    oObj.setNrSequencia(pParam);
                    ULOG("setNrSequencia[%s]", pParam);
                    if (pParam) XMLString::release(&pParam);
    
        
    
                    switch (oObj.Alterar())
                    {
                        case NOK:
                            ERROR(NRO_UPDATE_NAO_EFETUADO);
                            throw new TuxBasicSvcException(sNrMsg, MSG_UPDATE_NAO_EFETUADO);
                            break;
                        case DUPLICATE_KEY:
                            pXmlG->addItem("FAILED", "DUPLICATE KEY");
                            break;
                    }
                } // for
            }
        }
        else if ( !(strcmp(pAcao, "EXCLUIR")) )
        {
	        // Guarda o usuario que esta executando esse servico
            // Seto o usuario neste caso porque a exclusao e´ logica
	        oObj.setUsuarioAlteracao(getUser());

            pParam = walkTree(pDnode, XML_IDPESSOACOMU, 0);
            if(!pParam){
                ERROR(NRO_ID_PESSOA_COM_NE);
                TAG_INEXISTENTE(XML_IDPESSOACOMU);
                throw new TuxBasicSvcException(sNrMsg, sMsg);
            }

            if ( !*pParam){
                ERROR(NRO_ID_PESSOA_COM_VV);
                TAG_INEXISTENTE(XML_IDPESSOACOMU);

                if (pParam) XMLString::release(&pParam);

                throw new TuxBasicSvcException(sNrMsg, sMsg);
            }
            if ( !IsNumeric(pParam) ){
                ERROR(NRO_ID_PESSOA_COM_VI);
                TAG_VALOR_INVALIDO(XML_IDPESSOACOMU);

                if (pParam) XMLString::release(&pParam);

                throw new TuxBasicSvcException(sNrMsg, sMsg);
            }
            oObj.setIdComunicacao(pParam);

            if (pParam) XMLString::release(&pParam);

            //

            if (oObj.Excluir() == NOK)
            {
                ERROR(NRO_DELETE_NAO_EFETUADO);
                throw new TuxBasicSvcException(sNrMsg, MSG_DELETE_NAO_EFETUADO);
            };
        }
        else if ( !(strcmp(pAcao, "LISTAR")) )
        {
            pParam = walkTree(pDnode, XML_IDPESSOA, 0);
            if(!pParam){
                ERROR(NRO_ID_TP_PESSOA_NE);
                TAG_INEXISTENTE(XML_IDPESSOA);
                throw new TuxBasicSvcException(sNrMsg, sMsg);
            }

            if ( !*pParam){
                ERROR(NRO_ID_TP_PESSOA_VV);
                TAG_INEXISTENTE(XML_IDPESSOA);

                if (pParam) XMLString::release(&pParam);

                throw new TuxBasicSvcException(sNrMsg, sMsg);
            }
            if ( !IsNumeric(pParam) ){
                ERROR(NRO_ID_TP_PESSOA_VI);
                TAG_VALOR_INVALIDO(XML_IDPESSOA);

                if (pParam) XMLString::release(&pParam);

                throw new TuxBasicSvcException(sNrMsg, sMsg);
            }
            //Recupera o IDSISTEMA origem do FrontOffice
            poObj = CPessoaComunicacao::RecuperarTodos(&iNroReg, pParam);
            buscaIdSistemaOrigem( SIGLA_SO_FO );
		    pXmlG->createTag("LupaClienteVO");
		    pXmlG->addProp("xmlns","cliente.fo.vivo.com.br/vo");
		        pXmlG->createTag("DadosAbaLupaCliente");
	                for (; iAux < iNroReg; iAux++) 
                    {
		                pXmlG->createTag("ComunicacaoVO");
		                    pXmlG->addItem("idComunicacao", poObj[iAux].getIdComunicacao());
		                    pXmlG->createTag("TipoComunicacaoVO");
		                        pXmlG->addItem("idTipoComunicacao", poObj[iAux].getIdTipoComunicacao());
		                        pXmlG->addItem("sgTipoComunicacao", poObj[iAux].getSgTipoComunicacao());
		                        pXmlG->addItem("dsTipoComunicacao", poObj[iAux].getDsTipoComunicacao());
								pXmlG->addItem("sgClassificacao", poObj[iAux].getSgClassificacao());
	
																			  
                            pXmlG->closeTag();
		                    pXmlG->addItem("dsContato", poObj[iAux].getDsContato());
		                    pXmlG->addItem("nrSequencia", poObj[iAux].getNrSequencia());
		                    pXmlG->addItem("dtCadastro", poObj[iAux].getDtCadastroOut());

							ULOGI("\npoObj[iAux].getIdSistemaOrigem():[%s]", poObj[iAux].getIdSistemaOrigem() );
							ULOGI("\nstIdSistemaOrigemBase:[%s]", (char*)stIdSistemaOrigemBase.arr );

				            if( strcmp( poObj[iAux].getIdSistemaOrigem(), (char*)stIdSistemaOrigemBase.arr ) != 0 )
					            pXmlG->addItem("inSincronismo","1");
				            else
					            pXmlG->addItem("inSincronismo","0");
		                pXmlG->closeTag();
	                }
                pXmlG->closeTag();
            pXmlG->closeTag();

            //Liberando memoria alocada
            free(poObj);
        }
    }
    catch(...){
        throw;  //repassando o erro para nucleo
    }

	// Execução OK.
	INFORMATION(NRO_OK);

    ULOG_END( "implAbaComunicacao::Execute()" );
	setStatusCode(sNrMsg, MSG_OK);
}


int buscaIdSistemaOrigem( char* csgSistemOrigem )
{
    ULOG_START( "buscaIdSistemaOrigem()" );

	struct sqlca sqlca;
	EXEC SQL BEGIN DECLARE SECTION;
        char* cgSistemOrigemAux = csgSistemOrigem;
	EXEC SQL END DECLARE SECTION;

	// Marca ponto de controle de erro
	EXEC SQL WHENEVER SQLERROR GOTO GotobuscaIdSistemaOrigem;
    EXEC SQL WHENEVER NOT FOUND CONTINUE;
    
    memset( &stIdSistemaOrigemBase, 0, sizeof( stIdSistemaOrigemBase ) );

	// Declara e abre o cursor
	EXEC SQL 
	SELECT
		IDSISTEMAORIGEM
	INTO
		:stIdSistemaOrigemBase:iIdSistemaOrigemBase
	FROM
		APOIO.SISTEMAORIGEM
	WHERE
		UPPER(SGSISTEMAORIGEM) = UPPER(:cgSistemOrigemAux);
		

    ULOG_END( "buscaIdSistemaOrigem()" );

	return OK;

	// Tratamento de erro - Lança excessão com o código oracle do erro.
	GotobuscaIdSistemaOrigem:
		throw new TuxBasicOraException(sqlca.sqlcode);
}
