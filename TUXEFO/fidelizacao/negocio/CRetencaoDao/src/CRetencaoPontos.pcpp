#include <CRetencaoPontos.h>


int CRetencaoPontos::Inserir(DOMNode *pdnode,char *pidUser,char *pidRetencao)
{
    ULOG_START( "CRetencaoPontos::Inserir()" );

    char parm[255];
    parm[0] = 0x0;

    EXEC SQL BEGIN DECLARE SECTION;

        VARCHAR     idRetencao[21+1];
        VARCHAR     qtPontos[21+1];
        VARCHAR     idUser[21+1];
		VARCHAR		nrLinha[11+1];

    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );

    strToOra(idRetencao,pidRetencao);

    /*get_tag(parm,pdnode,"qtPontos",0,0); 
    strToOra(qtPontos,parm);*/

	get_tag(parm,pdnode,"nrLinha",0,0); 
    strToOra(nrLinha,parm);

	strToOra(idUser,pidUser);

    ULOG_VAR(idUser);

/*    ULOG( "*** INSERT RETENCAO.RETENCAOPONTOS IDRETENCAO [%s] - QTPONTOS [%s]", (char*)idRetencao.arr,(char*)qtPontos.arr );
    EXEC SQL
    INSERT INTO RETENCAO.RETENCAOPONTOS
    ( 
        IDRETENCAO,
        QTPONTOS,
        IDUSUARIOINCLUSAO, 
        DTINCLUSAO
    )
    VALUES 
    ( 
        :idRetencao,
        :qtPontos,
        :idUser,
        SYSDATE
    );*/

	ULOG( "*** UPDATE RETENCAO.CLIENTEBLINDAGEM ");

	EXEC SQL
	UPDATE RETENCAO.CLIENTEBLINDAGEM
		SET IDUSUARIOACEITE=:idUser,
			DTACEITE=sysdate
	where cdarearegistro=substr(:nrLinha,1,2)
	and	  nrlinha=substr(:nrLinha,3);
		

    ULOG_END( "CRetencaoPontos::Inserir()" );
	
	return 1;
}
