
#include <CRetencaoBonus.h>


int CRetencaoBonus::Inserir(DOMNode *pdnode,char *pidUser,char *pidRetencao)
{
    ULOG_START( "CRetencaoBonus::Inserir()" );
    
    char parm[255];

    EXEC SQL BEGIN DECLARE SECTION;

        VARCHAR     idRetencao[21+1];
        VARCHAR     nmBonus[50+1];
        VARCHAR     idMatrizBonus[21+1];
        VARCHAR     dtInicioVigencia[21+1];
        VARCHAR     dtFinalVigencia[21+1];
        VARCHAR     idUser[21+1];
        varchar     idbonus[21+1];//mpog master
        
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );

    memset(&idRetencao,0,sizeof(idRetencao));
    memset(&nmBonus,0,sizeof(nmBonus));
    memset(&idMatrizBonus,0,sizeof(idMatrizBonus));
    memset(&dtInicioVigencia,0,sizeof(dtInicioVigencia));
    memset(&dtFinalVigencia,0,sizeof(dtFinalVigencia));
    memset(&idUser,0,sizeof(idUser));
  
    strToOra(idRetencao,pidRetencao);

    parm[0] = 0x0;
    get_tag(parm,pdnode,"nmBonus",0,0); 
    strToOra(nmBonus,parm);

    parm[0] = 0x0;
    get_tag(parm,pdnode,"idMatrizBonus",0,0); 
    strToOra(idbonus,parm);

    parm[0] = 0x0;
    get_tag(parm,pdnode,"dtInicioVigencia",0,0); 
    strToOra(dtInicioVigencia,parm);

    parm[0] = 0x0;
    get_tag(parm,pdnode,"dtFinalVigencia",0,0); 
    strToOra(dtFinalVigencia,parm);

    strToOra(idUser,pidUser);

    ULOG_VAR(idUser);

    EXEC SQL
    SELECT IDMATRIZBONUS 
    INTO   :idMatrizBonus
    FROM RETENCAO.MATRIZBONUS
    WHERE IDBONUS = :idbonus
    AND ROWNUM < 2;
    
    endOraStr(idMatrizBonus);

    ULOG( "Consulta de RETENCAO.MATRIZBONUS - idMatrizBonus [%s]", (char*)idMatrizBonus.arr );

    EXEC SQL
    INSERT INTO 
        RETENCAO.RETENCAOBONUS (
            IDRETENCAO,
            NMBONUS,
            DTFIMVIGENCIA,
            DTINICIOVIGENCIA,
            IDUSUARIOINCLUSAO,
            DTINCLUSAO,
            IDMATRIZBONUS)
        VALUES	 (:idRetencao,
                  SUBSTR(:nmBonus,1,40),
                  TO_DATE(:dtFinalVigencia,'DD/MM/YYYY'),
                  TO_DATE(:dtInicioVigencia,'DD/MM/YYYY'),
                  :idUser,
                  SYSDATE,
                  :idMatrizBonus);		

    ULOG_END( "CRetencaoBonus::Inserir()" );
    
    return 1;
}

