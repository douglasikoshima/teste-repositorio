
#include <CRetencaoAnalise.h>


int CRetencaoAnalise::Inserir(DOMNode *pdnode,char *pidUser,char *pidRetencao)
{
    ULOG_START( "CRetencaoAnalise::Inserir()" );

    char parm[255];
    parm[0] = 0x0;
    
    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR        nrDocumento[20];         // -- NUMERO DO CPF
        VARCHAR        dtConsulta[64];          // -- DATA DA CONSULTA AO LEGADO
        VARCHAR		idRetencao[21+1];        // -- CHAVE PRIMARIA           
        int            idTipoAnalise;
        int			idTipoEncerramento;// -- NUMERO DA CONTA
        VARCHAR        dsObsAnalise[256];	     // -- TEXTO QUE O ANALISTA INFORMOU PARA A APROVACAO OU REPROVACAO         
        VARCHAR		idUser[21+1];                  // -- NUMERO DO USUARIO ALTERACAO  
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    strToOra(idRetencao,pidRetencao);
    strToOra(idUser,pidUser);

    get_tag(parm,pdnode,"idTipoEncerramento",0,0);  // OK
    idTipoEncerramento=atoi(parm);

    idTipoAnalise=(idTipoEncerramento==10)?1:4;

    strToOra(dsObsAnalise,"");

    get_tag(parm,pdnode,"nrDocumento",0,0);  // OK
    strToOra(nrDocumento,parm);

    ULOG( " INSERT INTO RETENCAO.RETENCAOANALISE" );

    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
    EXEC SQL WHENEVER NOT FOUND CONTINUE;

    EXEC SQL
    INSERT INTO RETENCAO.RETENCAOANALISE
    (
        IDRETENCAO          ,
        IDTIPOANALISE       ,
        DSOBSANALISE        ,
        NRDOCUMENTO         ,
        IDUSUARIOALTERACAO  ,
        DTULTIMAALTERACAO   
    )
    VALUES
    (
        :idRetencao,
        :idTipoAnalise,
        :dsObsAnalise,    
        :nrDocumento,
        :idUser,
        SYSDATE             
    );

    ULOG_END( "CRetencaoAnalise::Inserir()" );
	return 1;

}

int CRetencaoAnalise::InserirAnaliseEndereco(DOMNode *pdnode,char *pidUser,char *pidRetencao)
{
    ULOG_START( "CRetencaoAnalise::InserirAnaliseEndereco()" );

    char	parm[255];
    parm[0] = 0x0;

    EXEC SQL BEGIN DECLARE SECTION;

        VARCHAR        dsEndereco[255];                  //  ENDERECO ALTERADO PELO ATENDENTE RETENCAO
        VARCHAR        nrNumero[255];                    //  NUMERO ALTERADO PELO ATENDENTE RETENCAO
        VARCHAR        dsComplemento[255];               //  NUMERO ALTERADO PELO ATENDENTE RETENCAO
        VARCHAR        dsBairro[255];                   //  NUMERO ALTERADO PELO ATENDENTE RETENCAO
        VARCHAR        dsCidade[255];                    //  NUMERO ALTERADO PELO ATENDENTE RETENCAO
        VARCHAR        dsEstado[3];                     //  NUMERO ALTERADO PELO ATENDENTE RETENCAO
        VARCHAR        dsCep[70];                       //  CEP ALTERADO PELO ATENDENTE RETENCAO
        short          idMotivoAlteracaoEndereco=-1;       //  CHAVE ESTRANGEIRA   
        VARCHAR		idRetencao[21+1];                     //  CHAVE PRIMARIA          
        unsigned long  idUsuarioInclusao;               //  NUMERO DO USUARIO ALTERACAO  
        VARCHAR        nmTerceiro[70];
        VARCHAR        nrRGTerceiro[45];
        VARCHAR        nrTelTerceiro[45];
        VARCHAR		   idUser[21+1];
    EXEC SQL END DECLARE SECTION;

    strToOra(idRetencao,pidRetencao);
    strToOra(idUser,pidUser);

	memset(&dsEndereco,0,sizeof(dsEndereco));
	memset(&nrNumero,0,sizeof(nrNumero));
	memset(&dsComplemento,0,sizeof(dsComplemento));
	memset(&dsBairro,0,sizeof(dsBairro));
	memset(&dsCidade,0,sizeof(dsCidade));
	memset(&dsEstado,0,sizeof(dsEstado));
	memset(&dsCep,0,sizeof(dsCep));
	memset(&nmTerceiro,0,sizeof(nmTerceiro));
	memset(&nrTelTerceiro,0,sizeof(nrTelTerceiro));

    get_tag(parm,pdnode,"idMotivoAlteracaoEndereco",0,0);  // OK
    idMotivoAlteracaoEndereco=atoi(parm);

    get_tag(parm,pdnode,"dsEndereco",0,0);  // OK
    strToOra(dsEndereco, parm);

    get_tag(parm,pdnode,"nrEndereco",0,0);  // OK
    strToOra(nrNumero, parm);

    get_tag(parm,pdnode,"dsComplemento",0,0);  // OK
    strToOra(dsComplemento, parm);

    get_tag(parm,pdnode,"dsBairro",0,0);  // OK
    strToOra(dsBairro, parm);

    get_tag(parm,pdnode,"dsCidade",0,0);  // OK
    strToOra(dsCidade, parm);

    get_tag(parm,pdnode,"dsUF",0,0);  // OK
    strToOra(dsEstado, parm);

    get_tag(parm,pdnode,"dsCEP",0,0);  // OK
    strToOra(dsCep, parm);

    ULOG( " INSERT INTO RETENCAO.ENDERECOALTERADO" );

    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    EXEC SQL
    INSERT INTO RETENCAO.ENDERECOALTERADO
    (
        IDRETENCAO,
        DSENDERECO,
        NRNUMERO,
        DSCOMPLEMENTO,
        DSBAIRRO,
        DSCIDADE,
        DSESTADO,
        DSCEP,
        IDMOTIVOALTERACAOENDERECO ,
        DTULTIMAALTERACAO,
        IDUSUARIOINCLUSAO,    
        NMTERCEIRO ,
        NRRGTERCEIRO,
        NRTELTERCEIRO
    )
    VALUES
    (
        :idRetencao,
        :dsEndereco,
        :nrNumero,
        :dsComplemento,
        :dsBairro,
        :dsCidade,
        :dsEstado,
        :dsCep,
        :idMotivoAlteracaoEndereco,
        SYSDATE,
        :idUsuarioInclusao,
        :nmTerceiro,
        :nrRGTerceiro,
        :nrTelTerceiro
    );

    ULOG_END( "CRetencaoAnalise::InserirAnaliseEndereco()" );
    return 1;
}

int CRetencaoAnalise::InserirAnaliseCredito(DOMNode *pdnode,char *pidUser,char *pidRetencao)
{
    ULOG_START( "CRetencaoAnalise::InserirAnaliseCredito()" );

    char parm[3000];
    parm[0] = 0x0;

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR        dsRetornoConsulta[1000];             // -- TEXTO DE RETONO DO LEGADO (ATLYS)
        VARCHAR        nrDocumento[255];                     // -- NUMERO DO CPF55
        VARCHAR        nrConta[255];                         // -- NUMERO DA CONTA
        VARCHAR        nrLinha[15];                         // -- NUMERO DA LINHA
        VARCHAR        dtConsulta[255];                      // -- DATA DA CONSULTA AO LEGADO
        VARCHAR        vlDebito[22];                       // -- VALOR DO DEBITO EM ABERTO
        VARCHAR        idContaInadimplente[20];             // -- IDENTIFICACAO DA CONTA INADIMPLENTE
        VARCHAR        dtVencDebito[64];                    // -- DATA DO VENCIMENTO DO DEBITO
        VARCHAR        dtInterrupcao[64];                   // -- DATA DA FALHA DE COMUNICACAO COM O LEGADO
        VARCHAR        idRegional[21+1];                      // -- IDENTIFICACAO DA REGIONAL
        VARCHAR        dsRegional[70];                      // -- NOME DA REGIONAL
        VARCHAR        dsMotivoErro[255];                   // -- DESCRICAO SUCINTA DO ERRO DSOBSANALISE
        VARCHAR        dsObsAnalise[256]   ;              // -- TEXTO QUE O ANALISTA INFORMOU PARA A APROVACAO OU REPROVACAO
        VARCHAR		idRetencao[21+1];                         // -- CHAVE PRIMARIA           
        VARCHAR		idUser[21+1];                  // -- NUMERO DO USUARIO ALTERACAO  
        unsigned long  idSegmentacao;                       
        unsigned long  idGrupo;
        short          inAprovadoLegado =-1;                         //  -- APROVADO A ANALISE 0 REPROVADO 1 APROVADO 
        short          inStatusComunicacao=-1 ;                //  -- ESTADOS DE COMUNICACAO 1 REPROVADO 0 APROVADO
    EXEC SQL END DECLARE SECTION;

    memset(&dsRetornoConsulta,0,sizeof(dsRetornoConsulta));  
    memset(&nrDocumento,0,sizeof(nrDocumento));           
    memset(&nrConta,0,sizeof(nrConta));           
    memset(&nrLinha,0,sizeof(nrLinha));           
    memset(&dtConsulta,0,sizeof(dtConsulta));           
    memset(&vlDebito,0,sizeof(vlDebito));           
    memset(&idContaInadimplente,0,sizeof(idContaInadimplente));          
    memset(&dtVencDebito,0,sizeof(dtVencDebito));         
    memset(&dtInterrupcao,0,sizeof(dtInterrupcao));   
    memset(&idRegional,0,sizeof(idRegional));   
    memset(&dsRegional,0,sizeof(dsRegional));   
    memset(&dsMotivoErro,0,sizeof(dsMotivoErro));   
    memset(&dsObsAnalise,0,sizeof(dsObsAnalise));   
    memset(&idRetencao,0,sizeof(idRetencao));   
    memset(&idUser,0,sizeof(idUser));   

    strToOra(idRetencao,pidRetencao);
    strToOra(idUser,pidUser);

    get_tag(parm,pdnode,"idSegmentacao",0,0);  // OK
    idSegmentacao=atoi(parm);

    get_tag(parm,pdnode,"idGrupo",0,0);  // OK
    idGrupo=atoi(parm);

    get_tag(parm,pdnode,"inAprovadoLegado",0,0);  // OK
    inAprovadoLegado=atoi(parm);

    get_tag(parm,pdnode,"inStatusComunicacao",0,0);  // OK
    inStatusComunicacao=atoi(parm);


    get_tag(parm,pdnode,"nrDocumento",0,0);  // OK
    strToOra(nrDocumento,parm);

    get_tag(parm,pdnode,"dsRetornoConsulta",0,0);  // OK
    strToOra(dsRetornoConsulta,parm);

    get_tag(parm,pdnode,"nrDocumento",0,0);  // OK
    strToOra(nrDocumento,parm);

    get_tag(parm,pdnode,"dtInterrupcao",0,0);  // OK
    strToOra(dtInterrupcao,parm);

    get_tag(parm,pdnode,"idUFOperadora",0,0);  // OK
    strToOra(idRegional,parm);

    EXEC SQL
    SELECT NMAREAREGISTRO  
    INTO :dsRegional
    FROM APOIO.AREAREGISTRO
    WHERE IDUFOPERADORA = :idRegional
    AND ROWNUM < 2;

    endOraStr(dsRegional);
    strToOra(vlDebito,"");
    strToOra(idContaInadimplente,"");
    strToOra(dsMotivoErro,"");

    ULOG_VAR(idRetencao);
    ULOG_VAR(dsRetornoConsulta);        
    ULOG_VAR(nrConta);                  
    ULOG_VAR(nrLinha);                  
    ULOG_VAR(vlDebito);              
    ULOG_VAR(idContaInadimplente);   
    ULOG_VAR(idRegional);            
    ULOG_VAR(dsRegional);
    ULOG_VAR(dsMotivoErro);          
    ULOG_INT(idGrupo);
    ULOG_INT(idSegmentacao);
    ULOG_INT(inAprovadoLegado);
    ULOG_INT(inStatusComunicacao);
    ULOG_VAR(idUser);	

    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );
   
	EXEC SQL
    INSERT INTO RETENCAO.RELANALISECREDITO
        (
            IDRETENCAO          ,
            DSRETORNOCONSULTA   ,
            NRCONTA             ,
            NRLINHA             ,
            DTCONSULTA          ,
            VLDEBITO           ,
            IDCONTAINADIMPLENTE ,
            IDREGIONAL          ,
            DSREGIONAL          ,
            DSMOTIVOERRO        ,
            IDGRUPO             ,
            IDSEGMENTO       ,
            INAPROVADOLEGADO    ,
            INSTATUSCOMUNICACAO ,
            IDUSUARIOALTERACAO  ,
            DTULTIMAALTERACAO   
        )
        VALUES
        (
            :idRetencao,
            :dsRetornoConsulta,              // -- TEXTO DE RETONO DO LEGADO (ATLYS)
            nvl(:nrConta,''),                        // -- NUMERO DA CONTA
            :nrLinha,                        // -- NUMERO DA LINHA
            SYSDATE,						 //:dtConsulta[64];  // -- DATA DA CONSULTA AO LEGADO
            :vlDebito,                      // -- VALOR DO DEBITO EM ABERTO
            :idContaInadimplente,            // -- IDENTIFICACAO DA CONTA INADIMPLENTE
            :idRegional,                     // -- IDENTIFICACAO DA REGIONAL
            nvl(:dsRegional,'não cadastrado'),
            :dsMotivoErro,                   // -- DESCRICAO SUCINTA DO ERRO
            :idGrupo,
            :idSegmentacao,
            :inAprovadoLegado,
            :inStatusComunicacao,
            :idUser,						 // -- NUMERO DO USUARIO ALTERACAO
            SYSDATE                         // :dtUltimaAlteracao,              // -- DATA DE ALTERACAO
        );

    ULOG_END( "CRetencaoAnalise::InserirAnaliseCredito()" );

	return 1;

}

int CRetencaoAnalise::FinalisarAnalise(char* pretold)
{
    ULOG_START("conclui_retencao()");  

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR  Idretencao[21+1];
    EXEC SQL END DECLARE SECTION;
    
    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
    strToOra(Idretencao,pretold);

    EXEC SQL 
    UPDATE RETENCAO.RETENCAOANALISE
    SET IDTIPOANALISE   = 0  // valor definido na tabela TIPOANALISE
    WHERE IDRETENCAO  = :Idretencao;
  
    ULOG_END("conclui_retencao()");    

    return 1;
}




