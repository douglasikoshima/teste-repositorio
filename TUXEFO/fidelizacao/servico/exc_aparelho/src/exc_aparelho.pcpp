//
// $Id: exc_aparelho.pcpp,v 1.1 2009/07/31 15:33:58 a5110702 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"

int exc_aparelho(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[10];

  EXEC SQL BEGIN DECLARE SECTION;
  int     idAparelho;
  int     idPessoaUsuarioAlteracao;
  int	  contador=0;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
    //  Obtendo dados do xml
    get_tag(parm,dnode,"idAparelho",0,0);
    idAparelho = atoi(parm);

    // Pegando id do usuario
    idPessoaUsuarioAlteracao = usuario;
   
    //verifica se o aparelho esta cadastrado em alguma matriz...
    //EXEC SQL
	//SELECT COUNT(1) into :contador FROM  retencao.MatrizAparelho
	//WHERE  idAparelho = :idAparelho AND INATIVO = 1;
	
    EXEC SQL
    SELECT 
      COUNT(1)
    INTO
      :contador
    FROM 
      retencao.aparelho ra,
      retencao.aparelhogrupo apgrupo,
      retencao.aparelhotipopessoa aptipopessoa,
      retencao.aparelhosegmentacao apsegmentacao,
      retencao.aparelhoufoperadora apufoperadora
    WHERE 
       apgrupo.idaparelho = ra.idaparelho
    AND aptipopessoa.idaparelho = ra.idaparelho
    AND apsegmentacao.idaparelho = ra.idaparelho
    AND apufoperadora.idaparelho = ra.idaparelho
    AND ra.inativo = 1
    AND apgrupo.inativo = 1
    AND aptipopessoa.inativo = 1
    AND apsegmentacao.inativo = 1
    AND apufoperadora.inativo = 1
    AND ra.idaparelho = :idAparelho;
    
    /*
    if(contador)//aparelho existe
	{
		  throw new TuxBasicSvcException(NOKFID,"Existe Matriz Associada!");
	}
    */
   
  //procedimetnos normais de deleção  
    EXEC SQL   
      update retencao.AparelhoCor
      set    inAtivo = 0,
      idPessoaUsuarioAlteracao = :idPessoaUsuarioAlteracao,
      dtAlteracao = sysdate,
      idUsuarioAlteracao = :idPessoaUsuarioAlteracao,
      dtUltimaAlteracao = sysdate
      where idAparelho = :idAparelho;

    EXEC SQL
      update retencao.Aparelho
      set    inAtivo = 0,
      idPessoaUsuarioAlteracao = :idPessoaUsuarioAlteracao,
      dtAlteracao = sysdate,
      idUsuarioAlteracao = :idPessoaUsuarioAlteracao,
      dtUltimaAlteracao = sysdate
      where  idAparelho = :idAparelho;

    xml->addItem("descricao","EXCLUIR");
    xml->addItem("valor",sqlca.sqlerrd[2]);
  }
  catch(...)
  {
	throw;
  }

  return 1;
}

