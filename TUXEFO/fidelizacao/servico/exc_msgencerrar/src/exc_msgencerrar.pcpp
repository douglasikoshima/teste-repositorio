//
// $Id: exc_msgencerrar.pcpp,v 1.1 2009/07/31 15:33:55 a5110702 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"

int exc_msgencerrar(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[10];

  EXEC SQL BEGIN DECLARE SECTION;
  int     idMsgEncerramento;
  int     idPessoaUsuarioAlteracao;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
    //  Obtendo dados do xml
    get_tag(parm,dnode,"idMsgEncerramento",0,0);
    idMsgEncerramento = atoi(parm);

    // Pegando id do usuario
    idPessoaUsuarioAlteracao = usuario;

    EXEC SQL
      update retencao.MsgEncerramento
      set    inAtivo = 0,
      idUsuarioAlteracao = :idPessoaUsuarioAlteracao,
      dtUltimaAlteracao = sysdate
      where  idMsgEncerramento = :idMsgEncerramento;

    xml->addItem("descricao","EXCLUIR");
    xml->addItem("valor",sqlca.sqlerrd[2]);

  }catch(...){
	  
    EXEC SQL
      DELETE retencao.MsgEncerramento
      where  idMsgEncerramento = :idMsgEncerramento;
    xml->addItem("descricao","EXCLUIR");
    xml->addItem("valor",sqlca.sqlerrd[2]);  
  }


  return 1;
}

