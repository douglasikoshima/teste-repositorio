//
// $Id: sel_desconto.pcpp,v 1.1.2.1 2010/08/25 21:41:23 a5114878 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"


int sel_desconto(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[255];
  int  iExcecao=0;

  EXEC SQL BEGIN DECLARE SECTION;
    int     idMatrizAparelho;
    int     idMatrizAparelhoDesconto;
    int     vlPercentualDesconto;
    int     idSegmentacaoPrm;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
  EXEC SQL WHENEVER NOT FOUND DO break;

  try{
    //  Obtendo dados do xml
    get_tag(parm,dnode,"idMatrizAparelho",0,0);
    idMatrizAparelho = atoi(parm);

    get_tag(parm,dnode,"idSegmentacao",0,0);
    idSegmentacaoPrm = atoi(parm);
    ULOG( "idSegmentacaoPrm [%d]", idSegmentacaoPrm );
    

	get_tag(parm,dnode,"excecao",0,0);
    iExcecao = atoi(parm);

	if(!iExcecao)
	{
			// Definicao dos cursores
			EXEC SQL DECLARE crsMtzDesc CURSOR FOR
			SELECT DISTINCT 
				   idaparelho,
				   vldesconto
			FROM   retencao.MatrizAparelhoDesconto
			WHERE idsegmentacao=:idSegmentacaoPrm
			AND	  idaparelho=:idMatrizAparelho
			AND	  inativo=1
			ORDER BY vldesconto;

			EXEC SQL OPEN crsMtzDesc;

		    for(;;) 
			{
				EXEC SQL FETCH crsMtzDesc INTO :idMatrizAparelhoDesconto,:vlPercentualDesconto;
    
			    ULOG_INT(idMatrizAparelhoDesconto);
				ULOG_INT(vlPercentualDesconto);
				xml->createTag("tns:itemListaVO");
				xml->addItem("id",idMatrizAparelhoDesconto);
				xml->addItem("descricao",vlPercentualDesconto);
				xml->closeTag();
			}
  
			EXEC SQL CLOSE crsMtzDesc;
	}
	else
	{      int icod=0;
			for(int x=0;x<=99;x++) 
			{
				xml->createTag("tns:itemListaVO");
				xml->addItem("id",icod);
				xml->addItem("descricao",x);
				xml->closeTag();
				icod++;
			}


	}
  }
  catch(...)
  {
	throw;
  }

  return 1;
}

