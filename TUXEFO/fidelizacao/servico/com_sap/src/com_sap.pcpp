

#include "../../negocio/fidutil/include/retencao.hpp"
//#include  "../../negocio/fidutil/include/CallTux.h"

struct Venda
{
    int idAparelho;
    char nrLinha[16];
    char cdSap[21];
    char vlrVenda[16];
	char vlAparelho[16];
};

struct stVendaPJ
{
    char szTipoDoc[10];
    char szPermaneciaSAP[21];
    char dtDE[16];
	char dtATE[16];
	int	 inComodato;
};

int EmiteTag( void );
void BuscaInscricoes( char * idPessoa, char * sInscrEstad, char * sInscrMunic );
void SeparaEndereco( char * pEnderecoPrm, char * nmRuaPrm, char * NroPrm, char * nmComplementoPrm );
void BuscaEmail( char * pidPessoaPrm, char * nmEmailPrm );
bool ExisteOrdemVenda( char* pIdRetencaoPrm );
int get_TipoPagto( char * pagto, char * pcod );
//int BaixaEstornoEstoque(int usuario,char *pidAparelho,char *pSGUF,char *pidPessoa,int inTipo,char *plinha);
int get_Cpf(char * pretencao,char *pnrcpf,char *pTipoDoc);
int get_parcelas(int quantidade,char *pcod);
int get_SapEmpresaOrgVenda(char *pcod, char *nmTelefone );
int get_SapEmpresa(char* psgsigla,char *pcod);

int get_ParametrosPJ(char* psgOf,char* pidTpCart, char* pidContrato, stVendaPJ *pVendaPJ);//SM COMODATO E MULTA CONTRATUAL

int set_logInfo(char *pidret,char* perro, int iuser, char *pXml, char* pOrdemVenda );

int formata_cep(char *pcepin,char* pcepout);
//  int set_logInfo(char *pidret,char* perro, int iuser,char *pXml);

void IdentificaItemVenda( Venda *pVenda,char *pvlAparelho,char *ptipodoc );
void GetIM( char * idPessoaPrm, char * sInscrMunicipalPrm );
void GetIE( char * idPessoaPrm, char * sInscrEstadualPrm );


int get_parcelas( int quantidade,char *pcod )
{
    ULOG_START( "get_parcelas()" );

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR cdsapparcela[256];
        int    nrparcelas = quantidade;
        short i_cdsapparcela = -1;
    EXEC SQL END DECLARE SECTION;

    memset( &cdsapparcela,0x0,sizeof(cdsapparcela) );

    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );

    EXEC SQL
        SELECT  
            CDSAPPARCELA
        INTO	
           :cdsapparcela:i_cdsapparcela
        FROM 
            RETENCAO.PARCELA
        WHERE 
            NRPARCELAS =:nrparcelas
        AND 
            ROWNUM < 2;

    endOraStr(cdsapparcela);
    if ( i_cdsapparcela != -1 )
        strcpy( pcod,(char *)cdsapparcela.arr );

    ULOG_END( "get_parcelas()" );
    return 1;
}


// int BaixaEstornoEstoque(int usuario,char *pidAparelho,char *pSGUF,char *pidPessoa,int inTipo,char *plinha)
// {
    // ULOG_START("BaixaEstornoEstoque()");

    // ULOG("usuario     = [%d]",usuario);
    // ULOG("pidAparelho = [%s]",pidAparelho);
    // ULOG("pSGUF       = [%s]",pSGUF);
    // ULOG("pidPessoa   = [%s]",pidPessoa);
    // ULOG("inTipo      = [%d]", inTipo);
    
    // char tmp[512];
    
    // memset( tmp,0x0,sizeof(tmp));

    // EXEC SQL BEGIN DECLARE SECTION;

    // VARCHAR		idAparelho[21+1];
	// VARCHAR		nrLinha[21+1];
	// int 		idTipoAparelho=0;

    // VARCHAR		sgUF[21+1];
	// VARCHAR		idPessoa[21+1];

	// VARCHAR		idufoperadora[21+1];
    // VARCHAR		idtipopessoa[21+1];
    // int         qtDisponivel;

    // short       i_qtDisponivel=-1;
	// short       i_idTipoAparelho=-1;
	// short 		i_idtipopessoa=-1;
    // short       i_idufoperadora=-1;


	// EXEC SQL END DECLARE SECTION;

  	// memset( &idAparelho,0x0,sizeof(idAparelho));
    // memset( &nrLinha,0x0,sizeof(nrLinha));
  	// memset( &sgUF,0x0,sizeof(sgUF));
    // memset( &idPessoa,0x0,sizeof(idPessoa));
  	// memset( &idufoperadora,0x0,sizeof(idufoperadora));
    // memset( &idtipopessoa,0x0,sizeof(idtipopessoa));

	// strToOra(idAparelho,pidAparelho);
	// strToOra(sgUF,pSGUF);
	// strToOra(idPessoa,pidPessoa);
	// strToOra(nrLinha,plinha);

    // ULOG_VAR(idAparelho);
    // ULOG_VAR(sgUF);
    // ULOG_VAR(idPessoa);


    // ULOGW("	SELECT idufoperadora "
		  // "   FROM   customer.ufoperadora "
		  // "  WHERE iduf IN(SELECT iduf FROM apoio.uf WHERE sguf ='%s')",(char* )sgUF.arr);

	// EXEC SQL
		// SELECT idufoperadora
        // into  :idufoperadora:i_idufoperadora
		// FROM   customer.ufoperadora
		// WHERE iduf IN(SELECT iduf 
			  	   	  // FROM apoio.uf
					  // WHERE sguf =:sgUF);

    // endOraStr(idufoperadora);
	// ULOG_VAR(idufoperadora);
	
    // ULOGW(	
          	// " SELECT idtipopessoa  "
        	// " FROM   customer.pessoa "
        	// " WHERE idpessoa='%s'",(char*)idPessoa.arr) ;


	// EXEC SQL
	// SELECT idtipopessoa
    // INTO   :idtipopessoa:i_idtipopessoa
	// FROM   customer.pessoa
	// WHERE idpessoa=:idPessoa;

    // endOraStr(idtipopessoa);
	// ULOG_VAR(idtipopessoa);

    //verifica a existencia em estoque

    // ULOG("SELECT * FROM RETENCAO.ESTOQUE "
    	 // "WHERE IDAPARELHOCOR= '%s'"
    	 // "AND   IDTIPOPESSOA= '%s' "
    	 // "AND   IDUFOPERADORA='%s' " ,(char*)idAparelho.arr ,(char*)idtipopessoa.arr,(char*)idufoperadora.arr);


    // EXEC SQL
    	// SELECT  RE.QTDISPONIVEL,
				// RA.IDTIPOAPARELHO
         // INTO :qtDisponivel:i_qtDisponivel,
			  // :idTipoAparelho:i_idTipoAparelho
        // FROM RETENCAO.ESTOQUE RE,
		  	   // RETENCAO.APARELHOCOR RAC,
			   // RETENCAO.APARELHO RA 
    	// WHERE  RAC.IDAPARELHOCOR=RE.IDAPARELHOCOR
		// AND    RAC.IDAPARELHO=RA.IDAPARELHO
		// AND	   RE.IDAPARELHOCOR =:idAparelho
    	// AND    RE.IDTIPOPESSOA = :idtipopessoa
    	// AND    RE.IDUFOPERADORA=:idufoperadora;

  //:i_qtDisponivel
    // ULOG( "qtDisponivel = [%d]",qtDisponivel);
    // ULOG( "i_qtDisponivel = [%d]",i_qtDisponivel);


	// ULOG("Entrou no update");
    // if (i_qtDisponivel == 0 )
    // {    
        // if ( 1 == inTipo )
        // {   // baixa no estoque  

    	    // ULOG("UPDATE RETENCAO.ESTOQUE "
    		    // "SET QTDISPONIVEL = %d "
    		    // "WHERE IDAPARELHOCOR= '%s'"
    		    // "AND   IDTIPOPESSOA= '%s' "
    		    // "AND   IDUFOPERADORA='%s' " ,qtDisponivel,(char*)idAparelho.arr ,(char*)idtipopessoa.arr,(char*)idufoperadora.arr);
            // qtDisponivel --;
    	    // EXEC SQL
    		    // UPDATE RETENCAO.ESTOQUE
                // SET QTDISPONIVEL = :qtDisponivel
    		    // WHERE IDAPARELHOCOR=:idAparelho
    		    // AND   IDTIPOPESSOA= :idtipopessoa
    		    // AND   IDUFOPERADORA=:idufoperadora;

			// if(idTipoAparelho==2)
			// {
		
				// EXEC SQL										   
				// UPDATE retencao.estoquechipsap
				// SET QTCHIPAVULSO=QTCHIPAVULSO-1
				// WHERE idTipopessoa=:idtipopessoa
				// AND  idestoquechip = (SELECT idestoquechip FROM retencao.estoquechip
	 			   					 // WHERE idarearegistro=(SELECT idarearegistro FROM apoio.arearegistro
					 	   								   // WHERE cdarearegistro=SUBSTR(:nrLinha,1,2)));

			// }
			// else if(idTipoAparelho==3)
			// {
				// EXEC SQL
				// UPDATE retencao.estoquechipsap
				// SET QTCHIPPREPROG=QTCHIPPREPROG-1
				// WHERE idTipopessoa=:idtipopessoa
				// AND  idestoquechip = (SELECT idestoquechip FROM retencao.estoquechip
	 			   					 // WHERE idarearegistro=(SELECT idarearegistro FROM apoio.arearegistro
					 	   								   // WHERE cdarearegistro=SUBSTR(:nrLinha,1,2)));	
			// }

        // }
        // else
        // {   // estorno no estoque 

    	    // ULOG("UPDATE RETENCAO.ESTOQUE "
    		    // "SET QTDISPONIVEL = %d "
    		    // "WHERE IDAPARELHOCOR= '%s'"
    		    // "AND   IDTIPOPESSOA= '%s' "
    		    // "AND   IDUFOPERADORA='%s' " ,qtDisponivel,(char*)idAparelho.arr ,(char*)idtipopessoa.arr,(char*)idufoperadora.arr);
            // qtDisponivel ++;
    	    // EXEC SQL
    		    // UPDATE RETENCAO.ESTOQUE
                // SET QTDISPONIVEL = :qtDisponivel
    		    // WHERE IDAPARELHOCOR=:idAparelho
    		    // AND   IDTIPOPESSOA= :idtipopessoa
    		    // AND   IDUFOPERADORA=:idufoperadora;

				// if(idTipoAparelho==2)
			// {
		
				// EXEC SQL										   
				// UPDATE retencao.estoquechipsap
				// SET QTCHIPAVULSO=QTCHIPAVULSO+1
				// WHERE idTipopessoa=:idtipopessoa
				// AND  idestoquechip = (SELECT idestoquechip FROM retencao.estoquechip
	 			   					 // WHERE idarearegistro=(SELECT idarearegistro FROM apoio.arearegistro
					 	   								   // WHERE cdarearegistro=SUBSTR(:nrLinha,1,2)));

			// }
			// else if(idTipoAparelho==3)
			// {
				// EXEC SQL
				// UPDATE retencao.estoquechipsap
				// SET QTCHIPPREPROG=QTCHIPPREPROG+1
				// WHERE idTipopessoa=:idtipopessoa
				// AND  idestoquechip = (SELECT idestoquechip FROM retencao.estoquechip
	 			   					 // WHERE idarearegistro=(SELECT idarearegistro FROM apoio.arearegistro
					 	   								   // WHERE cdarearegistro=SUBSTR(:nrLinha,1,2)));	
			// }
        // }
    // }
    // else
    // {

        // ULOG("nao existe aparelho na tabela");
    // }

	
	// ULOG_INT(sqlca.sqlerrd[2]);
	
	// char msg[128];
	// sprintf( msg,"%s","saiu do update" );
	// ULOG( msg );

  // ULOG_END("BaixaEstornoEstoque()");
  // return usuario;
// }



int get_Cpf(char * pretencao,char *pnrcpf,char *pTipoDoc)
{
    ULOG_START("int get_Cpf(char * pretencao,char *pnrcpf,char *pTipoDoc)");
    char szTipoDoc[10];  //sm 229
    char szTipoDocTemp[10]; //sm 229 
    
    EXEC SQL BEGIN DECLARE SECTION;
	    VARCHAR nrdocumento[255];
	    VARCHAR idPessoa[255];
    EXEC SQL END DECLARE SECTION;

	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

	strToOra(idPessoa,pretencao); //sm 229
	strToOra(nrdocumento,"0"); //sm 229


    strcpy(szTipoDoc,pTipoDoc);  // sm 229

    memset( pTipoDoc,10,0);
    
	EXEC SQL
	SELECT nrdocumento 
	INTO  :nrdocumento
	FROM   customer.documento
	WHERE  iddocumento IN (SELECT iddocumento 
	                         FROM customer.pessoadocumento 
	                        WHERE idpessoa =:idPessoa)
	   AND IDTIPODOCUMENTO IN (SELECT idtipodocumento
	         			         FROM APOIO.TIPODOCUMENTO 
							    WHERE SGCLASSIFICACAO LIKE '%CPF%')
    AND ROWNUM<=1;


    if(nrdocumento.len<3)
    {

        EXEC SQL
            SELECT nrdocumento 
              INTO :nrdocumento
              FROM customer.documento
             WHERE iddocumento IN (
                                   SELECT iddocumento 
                                     FROM customer.pessoadocumento 
                                    WHERE idpessoa =:idPessoa
                                  )
               AND IDTIPODOCUMENTO IN (
                                        SELECT idtipodocumento
					                      FROM APOIO.TIPODOCUMENTO 
						                 WHERE (SGCLASSIFICACAO LIKE '%CGC%'
                                            OR  SGCLASSIFICACAO LIKE '%CNPJ%'
                                               )
                                       )
            AND ROWNUM<=1;


        strcpy(szTipoDocTemp,"CGC"); //sm 229
    }
    else
    {
        strcpy(szTipoDocTemp,"CPF"); //sm 229
    }
    
    // inicio sm 229
    if ( strcmp(szTipoDoc,"CON") == 0 )
        strcpy(pTipoDoc,szTipoDoc);
    else
        strcpy(pTipoDoc,szTipoDocTemp);
            
    // fimo sm 229     
        
    endOraStr(nrdocumento);

    strcpy(pnrcpf,(char *)nrdocumento.arr);
    
    ULOG_END("int get_Cpf(char * pretencao,char *pnrcpf,char *pTipoDoc)");

return 1;

}


// inicio sm 279
int get_SapEmpresaOrgVenda(char *pcod, char *nmTelefone )
{
    ULOG_START("int get_SapEmpresa()");
    
    ULOG("pcod = [%s]",pcod);
    ULOG("nmTelefone = [%s]",nmTelefone);
    
    EXEC SQL BEGIN DECLARE SECTION;
      int cdArea;
      int nmPrevixo;
      short id_OrgVenda = -1 ;

      VARCHAR cdOrgVenda[5];

    EXEC SQL END DECLARE SECTION;
    
    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    char stArea[3];
    char stPrevixo[5];

    memset( &stArea, 0, sizeof( stArea ) );	
    memset( &stPrevixo, 0, sizeof( stPrevixo ) );	
    
    strncpy(stArea,nmTelefone,2);
    strncpy(stPrevixo,nmTelefone+2,4);

    cdArea = atoi(stArea);

    nmPrevixo = atoi(stPrevixo);

    memset( &cdOrgVenda, 0, sizeof( VARCHAR ) );	
    
    /* ESPERANDO DEFINICAO DA VIVO
    // verifica a regional e o prefixo 
    EXEC SQL
        SELECT   ORGANIZACAOVENDA.NMORGVENDA  
          INTO   :cdOrgVenda:id_OrgVenda
          FROM 	 C_CSANTOS.ORGANIZACAOVENDA ORGANIZACAOVENDA,
   	 	         C_CSANTOS.PREFIXOEXCECAO PREFIXOEXCECAO
         WHERE   ORGANIZACAOVENDA.CDAREAREGISTRO = PREFIXOEXCECAO.CDAREAREGISTRO
          AND    PREFIXOEXCECAO.CDAREAREGISTRO = :cdArea
          AND    PREFIXOEXCECAO.NRPREFIXO = :nmPrevixo ;

	// nao foi encontrado um prexifo excecao retorna a ORGVENDA

    if ( id_OrgVenda == -1 )
    {
        EXEC SQL
          SELECT   ORGANIZACAOVENDA.NMORGVENDA  
            INTO   :cdOrgVenda:id_OrgVenda
            FROM   C_CSANTOS.ORGANIZACAOVENDA ORGANIZACAOVENDA
           WHERE   ORGANIZACAOVENDA.CDAREAREGISTRO = :cdArea ;
    }
	*/
	

    ULOG( 
          " SELECT   ORGANIZACAOVENDA.NMORGVENDA  "
          "    FROM   RETENCAO.ORGANIZACAOVENDA ORGANIZACAOVENDA, "
          "	         APOIO.AREAREGISTRO AREAREGISTRO "
          "   WHERE   ORGANIZACAOVENDA.IDAREAREGISTRO = AREAREGISTRO.IDAREAREGISTRO "
          "	   AND   AREAREGISTRO.CDAREAREGISTRO = %d ; " , 
          cdArea
         );
        	   
        	   
	
	
    EXEC SQL
    SELECT   ORGANIZACAOVENDA.NMORGVENDA  
      INTO   :cdOrgVenda:id_OrgVenda
      FROM   RETENCAO.ORGANIZACAOVENDA ORGANIZACAOVENDA,
	         APOIO.AREAREGISTRO AREAREGISTRO
     WHERE   ORGANIZACAOVENDA.IDAREAREGISTRO = AREAREGISTRO.IDAREAREGISTRO
	   AND   AREAREGISTRO.CDAREAREGISTRO = :cdArea ;

	
    endOraStr(cdOrgVenda);

    strcpy(pcod,(char *)cdOrgVenda.arr);

    ULOG_END("int get_SapEmpresa()");
	return 1;
}
// fim sm 279


int get_SapEmpresa( char *psgsigla,char *pcod )
{
    ULOG_START("get_SapEmpresa()");

    EXEC SQL BEGIN DECLARE SECTION;
        VARCHAR sgUf[256];
        VARCHAR cdEmpresaSap[256];
    EXEC SQL END DECLARE SECTION;

    memset( &sgUf,0x0,sizeof(sgUf) );
    memset( &cdEmpresaSap,0x0,sizeof(cdEmpresaSap) );
    strToOra(sgUf,psgsigla);

    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );
    EXEC SQL
        SELECT 
            RUFOESAP.CDEMPRESA
        INTO   
            :cdEmpresaSap
        FROM 
            RETENCAO.UFOPERADORAEMPRESASAP RUFOESAP,
            CUSTOMER.UFOPERADORA		CUFO,
            APOIO.UF						AUF
        WHERE 
            RUFOESAP.IDUFOPERADORA = CUFO.IDUFOPERADORA
        AND   
            CUFO.IDUF = AUF.IDUF
        AND   
            AUF.SGUF = UPPER(:sgUf);


    endOraStr(cdEmpresaSap);
    strcpy(pcod,(char *)cdEmpresaSap.arr);

    ULOG_END("get_SapEmpresa()");
    return 1;
}


extern int get_Retencao(char *pidRet)
{
    ULOG_START("get_Retencao()");

    EXEC SQL BEGIN DECLARE SECTION;
      VARCHAR idRetencao[255];
    EXEC SQL END DECLARE SECTION;
    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
    
    memset(&idRetencao,0,sizeof(idRetencao));
    
    EXEC SQL SELECT RETENCAO.RETENCAOSQ.NEXTVAL
    		 INTO   :idRetencao
    		 FROM	DUAL;
    
    endOraStr(idRetencao);
    strcpy(pidRet,(char *)idRetencao.arr);
    ULOG("< get_Retencao() idRetencao = %s ",pidRet );
return 1;
}


int get_SapParametros(int  iidGrupo, 
					  char *pidPesoa,
					  char *psgUf, 
					  char *pidSeg, //entrada
					  char *pVKGRP,
					  char *pPOMETHOD, 
					  char* pAUGRU)	//saida
{
    ULOG_START("get_SapParametros()");
    
    ULOG("iidGrupo  = [%d]",iidGrupo);
	ULOG("pidPesoa  = [%s]",pidPesoa);
	ULOG("psgUf     = [%s]",psgUf);
	ULOG("pidSeg    = [%s]",pidSeg);
	ULOG("pVKGRP    = [%s]",pVKGRP);
	ULOG("pPOMETHOD = [%s]",pPOMETHOD);
	ULOG("pAUGRU    = [%s]",pAUGRU);
    
    
     
    
    EXEC SQL BEGIN DECLARE SECTION;
      VARCHAR idPessoa[21+1];
      VARCHAR sgUf[4];
      VARCHAR idSegmetacao[21+1];
      int idTipoPessoa;
      int	  idGrupo=iidGrupo;
    
      VARCHAR szVKGRP[255];
      VARCHAR szPMTHOD[255];
      VARCHAR szAUGRU[5];
    EXEC SQL END DECLARE SECTION;
    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
    
    
    memset( &szVKGRP, 0, sizeof( VARCHAR ) );	
    memset( &szPMTHOD, 0, sizeof( VARCHAR ) );	
    memset( &szAUGRU, 0, sizeof( VARCHAR ) );	
    
    
    
    strToOra(idPessoa,pidPesoa);
    strToOra(sgUf,psgUf);
    strToOra(idSegmetacao,pidSeg);
    
    
    
    EXEC SQL
    	SELECT IDTIPOPESSOA 
    	INTO   :idTipoPessoa
    	FROM CUSTOMER.PESSOA
    	WHERE IDPESSOA=:idPessoa;
    
    
    		EXEC SQL 
    		SELECT  RGS.SGGRUPOVENDEDORSAP VKGRP,
    				ATPS.NMTIPOPEDIDOSAP   PO_METHOD,
    				AMOS.SGMOTIVOORDEMSAP  AUGRU
    		INTO	:szVKGRP,
    				:szPMTHOD,
    				:szAUGRU
    		FROM   ACESSO.GRUPO AG,
    			   RETENCAO.GRUPOVENDEDORSAP RGS,
    			   RETENCAO.MATRIZAPARELHOSAP RMTS,
    			   APOIO.TIPOPEDIDOSAP		  ATPS,
    			   APOIO.MOTIVOORDEMSAP		  AMOS
    		WHERE  AG.IDGRUPO=RGS.IDGRUPO
    		AND	   RGS.IDGRUPO=RMTS.IDGRUPO
    		AND	   ATPS.IDTIPOPEDIDOSAP=RMTS.IDTIPOPEDIDOSAP
    		AND	   AMOS.IDMOTIVOORDEMSAP=RMTS.IDMOTIVOORDEMSAP
    		AND	   RMTS.IDTIPOPESSOA=:idTipoPessoa
    		AND	   RMTS.IDGRUPO = :idGrupo
    		AND	   RGS.IDSEGMENTACAO=:idSegmetacao
    		AND	   ROWNUM<=1;
    
    endOraStr(szVKGRP);
    endOraStr(szPMTHOD);
    endOraStr(szAUGRU);
    
    strcpy(pVKGRP,(char *)szVKGRP.arr);
    strcpy(pPOMETHOD,(char *)szPMTHOD.arr);
    strcpy(pAUGRU,(char *)szAUGRU.arr);
    
    ULOG_END("get_SapParametros()");
    return 1;
}




/*
 * Verifica se existe alguma ordem de venda
 * para o idRetencao passado como parametro.
 *
 * Marcelo Outubro/2006
 *
 */
bool ExisteOrdemVenda( char* pIdRetencaoPrm )
{
    ULOG_START( "ValidaOrdemVenda()" );
    
    EXEC SQL BEGIN DECLARE SECTION;

        VARCHAR pIdRetencao[21+1];
        int existe = 0;
        
    EXEC SQL END DECLARE SECTION;
    
    memset( &pIdRetencao,0x0,sizeof(pIdRetencao) );
    strToOra( pIdRetencao, pIdRetencaoPrm );

    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );

    ULOG( "*** Consultando idRetencao [%s]", (char *)pIdRetencao.arr );

    EXEC SQL
    SELECT 
        COUNT(VLIDREFERENCIA)
    INTO 
        :existe
    FROM 
        RETENCAO.STATUSSAP 
    WHERE 
        VLIDREFERENCIA = :pIdRetencao
    AND
        STATUSSAP.ORDEMVENDA IS NOT NULL;
        
    ULOG( "Encontradas [%d] retencoes para o idRetencao [%s]", existe, (char *)pIdRetencao.arr  );        
        
    ULOG_END( "ValidaOrdemVenda()" );

    if ( existe > 0 )
        return true;
    else
        return false;
}



int set_logInfo( char *pidret, char* perro, int iuser, char *pXml, char* pOrdemVenda )
{
    ULOG_START( "set_logInfo()" );

    EXEC SQL BEGIN DECLARE SECTION;
    VARCHAR idRetencao[21+1];
    VARCHAR szMsgErro[255];
    int	  idUser=iuser;
    VARCHAR szXML[2500];
    VARCHAR szOrdemVenda[255+1];
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);


    strToOra( idRetencao,pidret );
    strToOra( szMsgErro,perro );
    strToOra( szXML,pXml );
    strToOra( szOrdemVenda,pOrdemVenda );


     EXEC SQL
	    INSERT INTO 
	        RETENCAO.STATUSSAP
	        (
	            IDSTATUSSAP,
                VLIDREFERENCIA,
                IDUSUARIOALTERACAO,
                DTULTIMAALTERACAO,
                DSOBSERVACAO,
                VLLOGXMLIN,
                ORDEMVENDA
            )	 
		    VALUES
		    (
                RETENCAO.STATUSSAPSQ.NEXTVAL,
                :idRetencao,
                :idUser,
                SYSDATE,
                :szMsgErro,
                :szXML,
                :szOrdemVenda
            );

    ULOG_END( "set_logInfo()" );

    return 1;

}			



/*
int get_TipoPagto(int idpagto,char *pcod)
{

   EXEC SQL BEGIN DECLARE SECTION;
   VARCHAR sgTipoPagto[5];
   int    idTipoPagto =idpagto;
   EXEC SQL END DECLARE SECTION;
   EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);


	EXEC SQL
	SELECT  CDSAPTIPOPAGAMENTO
 	INTO	:sgTipoPagto
	FROM retencao.tipopagamentoaparelho
	WHERE idtipopagamentoaparelho=:idTipoPagto
	AND ROWNUM <=1;

	endOraStr(sgTipoPagto);
	strcpy(pcod,(char *)sgTipoPagto.arr);
return 1;


}
*/



int get_TipoPagto( char * parm, char * pcod )
{
    ULOG_START("get_TipoPagto()");
    ULOG("parm =[%s]",parm);
    EXEC SQL BEGIN DECLARE SECTION;

        VARCHAR sgTipoPagto[5];
        VARCHAR dsTipoPagamento[256];
        int idTpPagto;
        
        short i_sgTipoPagto=-1;

    EXEC SQL END DECLARE SECTION;
    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    memset( &sgTipoPagto, 0x0, sizeof(sgTipoPagto) );
    
    strToOra( dsTipoPagamento,parm );

    EXEC SQL
        SELECT CDSAPTIPOPAGAMENTO
        INTO  :sgTipoPagto:i_sgTipoPagto
        FROM RETENCAO.TIPOPAGAMENTOAPARELHO
        WHERE UPPER(dSTIPOPAGAMENTOAPARELHO) = UPPER(:dsTipoPagamento)
        AND ROWNUM < 2;

    if ( i_sgTipoPagto < 0 )
    {
        idTpPagto = atoi(parm);

	    EXEC SQL
	    SELECT  CDSAPTIPOPAGAMENTO
        INTO	:sgTipoPagto:i_sgTipoPagto
	    FROM retencao.tipopagamentoaparelho
	    WHERE idtipopagamentoaparelho=:idTpPagto
	    AND ROWNUM <=1;

        if ( i_sgTipoPagto < 0 )
        {
            pcod[0] = 'T';
            pcod[1] = 0x0;
        }
        else
        {
            endOraStr(sgTipoPagto);
            strcpy(pcod,(char *)sgTipoPagto.arr);
        }


    }
    else
    {
        endOraStr(sgTipoPagto);
        strcpy(pcod,(char *)sgTipoPagto.arr);
    }

    
    ULOG("pcod =[%s]",pcod);
    ULOG_END("get_TipoPagto()");
    return 1;
}

int formata_cep(char *pcepin,char* pcepout)
{
    ULOG_START("int formata_cep()");
    ULOG(pcepin);
 
    EXEC SQL BEGIN DECLARE SECTION;
      VARCHAR cepIn[40];
      VARCHAR cepOut[40];
      short i_cepOut = -1;
    EXEC SQL END DECLARE SECTION;
    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    strToOra(cepIn,pcepin);

  EXEC SQL
 	SELECT (CASE WHEN LENGTH(TRIM(:cepIn))<9 THEN
	    SUBSTR(triM(:cepIn),1,5) ||'-' ||SUBSTR(triM(:cepIn),6,3)
        ELSE TRIM(:cepIn) END) AS CEP
    INTO :cepOut:i_cepOut
    FROM dual;

    endOraStr(cepOut);

    strcpy(pcepout,(char*)cepOut.arr);

	ULOG(pcepout);
    ULOG_END("int formata_cep()");
    return 1;

}



/*
 * SM250 - Marcelo - Jan/2007
 * Usada para venda de aparelhos GSM.
 * Identifica se será vendido aparelho com CHIP, ou sem CHIP.
 * Retornando o valor unitario do CHIP, tanto para Avulso, como Pre-Programado
 */
void IdentificaItemVenda( Venda *pVenda,char *pvlAparelho,char *ptipodoc )
{
    ULOG_START( "IdentificaItemVenda()" );

    char ddd[3];

    EXEC SQL BEGIN DECLARE SECTION;
        
        int idAparelho = -1;
        int idMatrizAparelho = pVenda->idAparelho;
        int idTipoAparelho = 1;
		int idTipoPessoa   =-1;
        float vlrChip = 0.0;
		float vlrAparelho = 0.0;
		float vlrAparelhoSemChip=0.0;
        short i_vlrChip = -1;
        int cdArea = -1;
        VARCHAR cdSAP[21];
        short i_cdSAP = -1;
        short i_idTipoAparelho = -1;
        short i_idAparelho = -1;
        short i_idTipoPessoa = -1;
		

    EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    memset( ddd,0x0,sizeof(ddd) );
    memset( &cdSAP,0x0,sizeof(cdSAP) );

	vlrAparelho=atof(pVenda->vlAparelho);

	idTipoPessoa=(strcmp(ptipodoc,"CPF")==0?1:2);
 
	//NA VERDADE É O IDAPARELHOCOR E NÃO IDMATRIZAPARELHO QUE É 
	//CAPTURADO

    EXEC SQL
   	SELECT  ap.idtipoaparelho
	INTO	:idTipoAparelho:i_idTipoAparelho
	FROM retencao.aparelhocor apc,
		 retencao.aparelho	  ap
	WHERE apc.idaparelho=ap.idaparelho
	AND apc.idaparelhocor=:idMatrizAparelho;

    
    // @Marcelo - Feb/2007
    // POG: Em um futuro distante, talvez em outra dimensão
    // Um heroi serah o escolhido. Desvendar a lenda do
    // IDAPARELHOCOR... Serah a sua missao.
    // Sabe-se que esta propriedade existe, e as vezes, 
    // raramente ouve-se de sua aparicao
    // Resta ao nosso heroi, que desvende este misterio.
    if ( i_idTipoAparelho == -1 )
    {
        // EXEC SQL
   	    // SELECT
            // IDAPARELHO
	    // INTO	
            // :idAparelho:i_idAparelho
	    // FROM 
            // RETENCAO.MATRIZAPARELHO
	    // WHERE 
            // IDMATRIZAPARELHO = :idMatrizAparelho
        // AND
            // ROWNUM < 2;

        // if ( i_idAparelho != -1 )
        // {
            // EXEC SQL
   	        // SELECT
                // IDTIPOAPARELHO
	        // INTO	
                // :idTipoAparelho:i_idTipoAparelho
	        // FROM 
                // RETENCAO.APARELHO
	        // WHERE 
                // IDAPARELHO = :idAparelho
            // AND
                // ROWNUM < 2;
        // }
    }

	ULOG( "Identificado TipoAparelho [%d]",idTipoAparelho );
    
    if ( idTipoAparelho == 1)
    {
        ULOG( "*** Aparelho Sem Chip" );
        ULOG_END( "IdentificaItemVenda()" );
        return;
    }

    sprintf( ddd,"%.2s",(char *)pVenda->nrLinha );
    cdArea = atoi( ddd );
    ULOG( "Identificado DDD [%d]", cdArea );

    if ( idTipoAparelho == 2 )  // Avulso
    {
        EXEC SQL
        SELECT
           CDSAPCHIPAVULSO,
           VLCHIPAVULSO
        INTO :cdSAP:i_cdSAP,
             :vlrChip:i_vlrChip
        FROM
           RETENCAO.CHIP
        WHERE
           IDAREAREGISTRO = ( SELECT IDAREAREGISTRO FROM APOIO.AREAREGISTRO WHERE CDAREAREGISTRO = :cdArea );
    }

    if ( idTipoAparelho == 3 )  // Pre-programado
    {
        EXEC SQL
        SELECT
           CDSAPCHIPPREPROGRAMADO,
           VLCHIPPREPROGRAMADO
        INTO :cdSAP:i_cdSAP,
             :vlrChip:i_vlrChip
        FROM
           RETENCAO.CHIP
        WHERE
           IDAREAREGISTRO = ( SELECT IDAREAREGISTRO FROM APOIO.AREAREGISTRO WHERE CDAREAREGISTRO = :cdArea );
    }

    endOraStr( cdSAP );
    if ( i_cdSAP != -1 )
    {
        strcpy( pVenda->cdSap,(char *)cdSAP.arr );
    }

    if ( i_vlrChip != -1 )
        sprintf( pVenda->vlrVenda,"%5.2f",vlrChip );


	if(idTipoAparelho!=1)
	{
		EXEC SQL
		SELECT TO_NUMBER(:vlrAparelho)-TO_NUMBER(:vlrChip)
		into :vlrAparelhoSemChip
		FROM dual;
		
		sprintf( pvlAparelho,"%5.2f",vlrAparelhoSemChip );
	}


    ULOG( "Retornando valor do CHIP [%s], codigo SAP [%s]",(char *)pVenda->vlrVenda,(char *)pVenda->cdSap );

    ULOG_END( "IdentificaItemVenda()" );
    
}


int get_ParametrosPJ(char* psgOf,char* pidTpCart, char* pidContrato, stVendaPJ *pVendaPJ)
{
   ULOG_START( "int get_ParametrosPJ()" );

  
  EXEC SQL BEGIN DECLARE SECTION;
        
		//parametros de entrada
        VARCHAR sgOferta[4];
		VARCHAR idTipoCarteira[21+1];
		VARCHAR idContrato[21+1];

		//Parametros de Saida
        VARCHAR cdSAPContrato[6];
        VARCHAR cdSAPTipoDoc[6];
		VARCHAR	dtDE[10];
		VARCHAR	dtATE[10];
		
		short      icdSAPContrato=-1;
		short	   icdSAPTipoDoc=-1; 
		short	   idtDE=-1;        
		short	   idtATE=-1;       

    EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

	//zerando variaveis
	//entrada
    memset( &sgOferta,0x0,sizeof(sgOferta) );
    memset( &idTipoCarteira,0x0,sizeof(idTipoCarteira) );
	memset( &idContrato,0x0,sizeof(idContrato) );     
	//saida
	memset( &cdSAPContrato,0x0,sizeof(cdSAPContrato) );
	memset( &cdSAPTipoDoc,0x0,sizeof(cdSAPTipoDoc) );     
	memset( &dtDE,0x0,sizeof(dtDE) );
	memset( &dtATE,0x0,sizeof(dtATE));	

	ULOG("INICIANDO PROCESSAMENTO");
	//Atribuindo valores às variaves oracle
	strToOra(sgOferta,psgOf);
	strToOra(idTipoCarteira,pidTpCart);
	strToOra(idContrato,pidContrato);

 EXEC SQL
    SELECT    NVL(TPDOC.CDSAPTIPODOCPJ,(CASE WHEN TPCONT.SGOFERTAAPARELHO='APC'
 		   							 THEN 'CPM' ELSE 'VPM'END))cdsap,
	 		   TPCONT.CDSAPTIPOCONTRATOPJ,			   			   
	 		   (CASE WHEN TPCONT.SGOFERTAAPARELHO='APC' THEN
	 		   TO_CHAR(SYSDATE,'DD/MM/YYYY') ELSE ''END)DTDE,
	 		   (CASE WHEN TPCONT.SGOFERTAAPARELHO='APC' THEN
	 		   TO_CHAR((SYSDATE+TPCONT.QTPRAZODIAS),'DD/MM/YYYY') ELSE ''END)DTATE
	 INTO	   :cdSAPTipoDoc:icdSAPTipoDoc,
	 	  	   :cdSAPContrato:icdSAPContrato,
	 		   :dtDE:idtDE,
	 		   :dtATE:idtATE
	 FROM      RETENCAO.TIPOCONTRATOPJ TPCONT,
	 		   (SELECT TPDOC.CDSAPTIPODOCPJ,
			   		   TPDOC.SGOFERTAAPARELHO,
					   TPDOC.IDTIPOCARTEIRA
	 	   	   FROM RETENCAO.TIPODOCPJ TPDOC) TPDOC	 		   
	 WHERE     TPCONT.SGOFERTAAPARELHO=TPDOC.SGOFERTAAPARELHO(+)
	 AND 	   TPCONT.SGOFERTAAPARELHO=:sgOferta
	 AND	   TPCONT.IDTIPOCONTRATOPJ=:idContrato
	 AND	   TPDOC.IDTIPOCARTEIRA(+)=:idTipoCarteira;	 
	
	ULOG("DEPOIS DA QUERY");
	 endOraStr(cdSAPContrato);
     endOraStr(cdSAPTipoDoc);
     endOraStr(dtDE);	
     endOraStr(dtATE);	


	ULOG_VAR(cdSAPContrato);
	ULOG_VAR(cdSAPTipoDoc);
	ULOG_VAR(dtDE);
	ULOG_VAR(dtATE);

	strcpy(pVendaPJ->szTipoDoc,(char*)cdSAPTipoDoc.arr);
	strcpy(pVendaPJ->szPermaneciaSAP,(char*)cdSAPContrato.arr);
	strcpy(pVendaPJ->dtDE,(char*)dtDE.arr);
	strcpy(pVendaPJ->dtATE,(char*)dtATE.arr);

	ULOG(pVendaPJ->szTipoDoc);
	ULOG(pVendaPJ->szPermaneciaSAP);
	ULOG(pVendaPJ->dtDE);
	ULOG(pVendaPJ->dtATE);


	//Se a terceira letra da sigla de oferta for igual
	//a 'C' (só poderá ser APC) e um comodato.
    pVendaPJ->inComodato=(psgOf[2] == 'C')?1:0;

	ULOG_END("int get_ParametrosPJ()");
	return 1;
	
	
};


/*

struct stVendaPJ
{
    char szTipoDoc[10];
    char szPermaneciaSAP[21];
    char dtDE[16];
	char dtATE[16];
	int	 inComodato;
};*/



/*
void SeparaEndereco( char * pEnderecoPrm, char * nmRuaPrm, char * NroPrm, char * nmComplementoPrm )
{
    ULOG_START("SeparaEndereco()");
    
    EXEC SQL BEGIN DECLARE SECTION;
       VARCHAR dscEndereco[256];
       VARCHAR nmRua[96];
       VARCHAR Nro[8];
       VARCHAR nmComplemento[32];
       short i_nmRua = -1;
       short i_Nro = -1;
       short i_nmComplemento = -1;
    EXEC SQL END DECLARE SECTION;
    
    memset( &dscEndereco  , 0x0, sizeof(dscEndereco) );
    memset( &nmRua        , 0x0, sizeof(nmRua) );
    memset( &Nro          , 0x0, sizeof(Nro) );
    memset( &nmComplemento, 0x0, sizeof(nmComplemento) );
    
    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );
    strToOra( dscEndereco, pEnderecoPrm );

    EXEC SQL
    SELECT SUBSTR (:dscEndereco, 0, INSTR (:dscEndereco, ',') - 1) rua,
           SUBSTR (SUBSTR (:dscEndereco, INSTR (:dscEndereco, ',') + 2),
                   0,
                   INSTR (SUBSTR (:dscEndereco, INSTR (:dscEndereco, ',') + 2), '-') - 1
                  ) numero,
           SUBSTR (:dscEndereco, INSTR (:dscEndereco, '-') + 1, LENGTH (:dscEndereco)) complemento
      INTO :nmRua:i_nmRua ,
           :Nro:i_Nro ,
           :nmComplemento:i_nmComplemento
      FROM DUAL;
    
    endOraStr( nmRua );
    strcpy( nmRuaPrm,(char*)nmRua.arr);
    
    endOraStr( Nro );
    strcpy( NroPrm,(char*)Nro.arr);

    endOraStr( nmComplemento );
    strcpy( nmComplementoPrm,(char*)nmComplemento.arr);
  
    ULOG_END("SeparaEndereco()");

}
*/



void SeparaEndereco( char * pEnderecoPrm, char * nmRuaPrm, char * NroPrm, char * nmComplementoPrm )
{
    ULOG_START("SeparaEndereco()");
    
    int i,k,n;
    char buffer[256];
    char tmp[256];
    char nmRua[96];
    char Nro[8];
    char nmComplemento[32];
    
    memset( &buffer       , 0x0, sizeof(buffer) );
    memset( &nmRua        , 0x0, sizeof(nmRua) );
    memset( &Nro          , 0x0, sizeof(Nro) );
    memset( &nmComplemento, 0x0, sizeof(nmComplemento) );
    
    strcpy( buffer,pEnderecoPrm );
    
    ULOG( "Endereco recebido: [%s]",buffer );
    
    for ( i = 0;i<strlen(buffer);i++ )
    {
        if ( buffer[i] == ',' )
        {
           sprintf( nmRua,"%.*s",i,buffer);
           strcpy( nmRuaPrm,nmRua );
           strcpy( tmp,(char*)&buffer[i]);
           break;
        }
    }

    for ( i = 0;i<strlen(tmp);i++ )
    {
        if ( tmp[i] == ',' )
        {
           strcpy( Nro,(char*)&tmp[i+2] );
           n = strlen(Nro);
           for ( k=0; k<n; k++ )
           {
               if ( Nro[k] == 0x20 || Nro[k] == 0x0a || Nro[k] == 0x0d )
               {
                  Nro[k] = 0x0;
                  break;
               }
           }
           n = strlen(Nro);
           strcpy( NroPrm,Nro );
           strcpy( tmp,(char*)&tmp[i+n+2]);
           break;
        }

    }

    if ( strlen(tmp) )
    {
        strcpy( nmComplemento   , (char*)&tmp[5] );
        strcpy( nmComplementoPrm, nmComplemento );
    }

    ULOG( "Retornando Rua [%s] Numero [%s] Complemento [%s]",nmRuaPrm, NroPrm, nmComplementoPrm );

    ULOG_END("SeparaEndereco()");

}



void BuscaSegmentacao( char * idSegPrm, char * sgSegmPrm )
{
    ULOG_START( "BuscaSegmentacao()" );
    
    EXEC SQL BEGIN DECLARE SECTION;
       char idSegm[40];
       VARCHAR sgSegm[256];
       short i_sgSegm = -1;
    EXEC SQL END DECLARE SECTION;
    
    
    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );
    
    memset( &sgSegm, 0x0, sizeof(sgSegm) );
	strcpy( idSegm, idSegPrm );

    EXEC SQL
    select 
	   sgSegmentacao 
	into 
	   :sgSegm:i_sgSegm 
	from 
	   apoio.segmentacao 
	where 
	   idsegmentacao = :idSegm 
	and rownum < 2;   
	
    endOraStr( sgSegm );
    strcpy( sgSegmPrm,(char*)sgSegm.arr);
      
    ULOG_END( "BuscaSegmentacao()" );

}



int EmiteTag( void )
{
    ULOG_START( "EmiteTag()" );
    
    EXEC SQL BEGIN DECLARE SECTION;
	   int iCt;
       char sParam[256];
    EXEC SQL END DECLARE SECTION;
    
    
    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );
    
	strcpy( sParam, "ENVIA_TAG" );

    EXEC SQL
    select 
	   count(dsParametro) 
	into 
	   :iCt
	from 
	   apoio.parametro 
	where 
	   cdParametro = :sParam;
	
	if ( iCt > 0)
	   return 1;
	else
	   return 0;
      
    ULOG_END( "EmiteTag()" );

}



void BuscaEmail( char * pidPessoaPrm, char * nmEmailPrm )
{
    ULOG_START( "BuscaEmail()" );
    
    EXEC SQL BEGIN DECLARE SECTION;
       VARCHAR idPessoa[40];
       VARCHAR nmEmail[32];
       short i_nmEmail = -1;
    EXEC SQL END DECLARE SECTION;
    
    memset( &idPessoa  , 0x0, sizeof(idPessoa) );
    memset( &nmEmail   , 0x0, sizeof(nmEmail) );
    
    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );
    strToOra( idPessoa, pidPessoaPrm );

    EXEC SQL
    SELECT pessoacomunicacao.dscontato
      INTO :nmEmail:i_nmEmail
      FROM customer.pessoacomunicacao pessoacomunicacao,
           apoio.tipocomunicacao tipocomunicacao
     WHERE idpessoa = :idPessoa
       AND pessoacomunicacao.idtipocomunicacao = tipocomunicacao.idtipocomunicacao
       AND tipocomunicacao.sgclassificacao = 'E-MAIL'
       AND ROWNUM < 2;
   
    endOraStr( nmEmail );
    strcpy( nmEmailPrm,(char*)nmEmail.arr);
      
    ULOG_END( "BuscaEmail()" );

}



void GetIE( char * idPessoaPrm, char * sInscrEstadualPrm )
{
    ULOG_START( "GetIE()" );

    EXEC SQL BEGIN DECLARE SECTION;
       VARCHAR idPessoa[256];
       VARCHAR nrIE[256];
       short i_nrIE = -1;
    EXEC SQL END DECLARE SECTION;

    memset( &idPessoa  , 0x0, sizeof(idPessoa) );
    memset( &nrIE      , 0x0, sizeof(nrIE) );

    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );
    ULOG( "Pesquisando idPessoa [%s]", idPessoaPrm );
    
    strToOra( idPessoa, idPessoaPrm );

    EXEC SQL
    select
       documento.nrdocumento
    into
       :nrIE:i_nrIE
    from
       customer.documento         documento ,
       customer.pessoadocumento   pessoadocumento ,
       apoio.tipodocumento        tipodocumento
    where
       documento.iddocumento = pessoadocumento.iddocumento
    and documento.idtipodocumento = tipodocumento.idtipodocumento
    and tipodocumento.sgtipodocumento = 'IE'
    and pessoadocumento.idpessoa = :idPessoa
    and rownum < 2;
            
    endOraStr( nrIE );
    strcpy( sInscrEstadualPrm, (char*)nrIE.arr);

    ULOG( "Retornando sInscrEstadualPrm [%s]", sInscrEstadualPrm );
    
    ULOG_END( "GetIE()" );
}



void GetIM( char * idPessoaPrm, char * sInscrMunicipalPrm )
{
    ULOG_START( "GetIM()" );

    EXEC SQL BEGIN DECLARE SECTION;
       VARCHAR idPessoa[256];
       VARCHAR nrIM[256];
       short i_nrIM = -1;
    EXEC SQL END DECLARE SECTION;

    memset( &idPessoa  , 0x0, sizeof(idPessoa) );
    memset( &nrIM      , 0x0, sizeof(nrIM) );

    EXEC SQL WHENEVER SQLERROR DO sql_error( NULL );
    ULOG( "Pesquisando idPessoa [%s]", idPessoaPrm );
    
    strToOra( idPessoa, idPessoaPrm );

    EXEC SQL
    select
       documento.nrdocumento
    into
       :nrIM:i_nrIM
    from
       customer.documento         documento ,
       customer.pessoadocumento   pessoadocumento ,
       apoio.tipodocumento        tipodocumento
    where
       documento.iddocumento = pessoadocumento.iddocumento
    and documento.idtipodocumento = tipodocumento.idtipodocumento
    and tipodocumento.sgtipodocumento = 'IM'
    and pessoadocumento.idpessoa = :idPessoa
    and rownum < 2;
            
    endOraStr( nrIM );
    strcpy( sInscrMunicipalPrm, (char*)nrIM.arr );
    
    ULOG( "Retornando sInscrMunicipalPrm [%s]", sInscrMunicipalPrm );
    
    ULOG_END( "GetIM()" );
}

