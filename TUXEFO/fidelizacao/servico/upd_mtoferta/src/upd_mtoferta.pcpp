//
// $Id: upd_mtoferta.pcpp,v 1.1 2009/07/31 15:34:40 a5110702 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"

int upd_mtoferta(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[255];
  int  i;

  EXEC SQL BEGIN DECLARE SECTION;
  int     idMatrizOferta;
  int     operacao;
  int     idUfOperadora;
  int     idSegmentacao;
  int     idTipoPessoa;
  int     idIntencao;
  int     idDestino;
  int     idPessoaUsuarioAlteracao;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
    //  Obtendo dados do xml
    get_tag(parm,dnode,"operacao",0,0);
    operacao = atoi(parm);

    get_tag(parm,dnode,"idUfOperadora",0,0);
    idUfOperadora = atoi(parm);

    get_tag(parm,dnode,"idSegmentacao",0,0);
    idSegmentacao = atoi(parm);

    get_tag(parm,dnode,"idTipoPessoa",0,0);
    idTipoPessoa = atoi(parm);

    get_tag(parm,dnode,"idIntencao",0,0);
    idIntencao = atoi(parm);

    get_tag(parm,dnode,"idDestino",0,0);
    idDestino = atoi(parm);

    // Pegando id do usuario
    idPessoaUsuarioAlteracao = usuario;

    // Apagando os registros de ofertas deste caso
    EXEC SQL 
      update  retencao.MatrizOferta
      set     inAtivo = 0,
      dtAlteracao = sysdate,
      idPessoaUsuarioAlteracao = :idPessoaUsuarioAlteracao,
      dtUltimaAlteracao = sysdate,
      idUsuarioAlteracao = :idPessoaUsuarioAlteracao
      where   idUfOperadora = :idUfOperadora
      and     idSegmentacao = :idSegmentacao
      and     idTipoPessoa  = :idTipoPessoa
      and     idRespostaIntencao = :idIntencao
      and     idRespostaDestino = :idDestino;

    // Update 
    i= 0;
    while( get_tag(parm,dnode,"id",i,-1) != -1 ){
      idMatrizOferta = atoi(parm);
      ULOG_INT(idMatrizOferta);
      EXEC SQL 
	update  retencao.MatrizOferta
	set     inAtivo = :operacao,
	dtAlteracao = sysdate,
	idPessoaUsuarioAlteracao = :idPessoaUsuarioAlteracao,
	dtUltimaAlteracao = sysdate,
	idUsuarioAlteracao = :idPessoaUsuarioAlteracao
	where   idMatrizOferta = :idMatrizOferta;

      i++;
    }

    // insert OK 
    xml->addItem("descricao","MODIFICADO");
    xml->addItem("valor",i);
  }catch(...){throw;}

  return 1;
}

