//
// $Id: exc_destint.pcpp,v 1.1 2009/07/31 15:34:31 a5110702 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"

int exc_destint(int usuario,DOMNode*dnode,XMLGen*xml)
{
  char parm[10];
  int  ret=0;
  int operacao=0;
  	
  EXEC SQL BEGIN DECLARE SECTION;
    int     idResposta; 
    int     idPessoaUsuarioAlteracao;
	int     contador=0;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
  
  try
  {


    get_tag(parm,dnode,"id",0,0);
    idResposta = atoi(parm);
    
    // Pegando id do usuario
    idPessoaUsuarioAlteracao = usuario;


	//###################################################
	//#	VERIFICANDO SE DADO EXISTE NA MATRIZ DE SCRIPT  #
	//###################################################
	
	EXEC SQL
	SELECT COUNT(1) into :contador 
	FROM retencao.RespostaUnidade
	WHERE (idResposta1 = :idResposta
		   	OR idResposta2=:idResposta)
	AND inativo=1;
	if(!contador)
	{
		// mudar linha 
		EXEC SQL 
			update questionario.resposta
			set    inDisponibilidade = 0,
			idUsuarioAlteracao = :idPessoaUsuarioAlteracao,
			dtUltimaAlteracao = sysdate
			where  idResposta = :idResposta;
    
			// delete OK 
			strcpy(parm,"EXCLUIR");
			ret=1;
	}
	else
	{	
			strcpy(parm,"Existe uma matriz associada!");
			ret=-1;
	}

	xml->addItem("descricao",parm);
    xml->addItem("valor",ret);

  }
catch(...)
 {
	throw;
 }
  
  return 1;
}
