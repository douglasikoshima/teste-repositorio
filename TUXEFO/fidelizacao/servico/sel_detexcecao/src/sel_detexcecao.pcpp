//
// $Id: sel_detexcecao.pcpp,v 1.1 2009/07/31 15:34:18 a5110702 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"

int sel_detexcecao(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[50];

  EXEC SQL BEGIN DECLARE SECTION;
  int     idOfertaRealizada;
  VARCHAR nmPropriedade[255];
  VARCHAR vlPropriedade[255];
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
  EXEC SQL WHENEVER NOT FOUND DO break;

  try
  {
    //  Obtendo dados do xml
    get_tag(parm,dnode,"idOfertaAceita",0,0);
    idOfertaRealizada = atoi(parm);

    // Definicao dos cursores
    EXEC SQL DECLARE crsOfrt CURSOR FOR
	SELECT nmPropriedade,vlPropriedade 
    FROM retencao.caracteristicaofertaaceita
    WHERE idOfertaRealizada = :idOfertaRealizada 
          AND idcaracteristicaoferta NOT IN
			( SELECT idcaracteristicaoferta 
			  FROM   retencao.caracteristicaoferta 
			  WHERE sgcaracteristicaoferta IN('EX','LOJA','0','DELIV') );


    EXEC SQL OPEN crsOfrt;

    for(;;) 
	{
      EXEC SQL FETCH crsOfrt INTO :nmPropriedade,:vlPropriedade;
    
      endOraStr(nmPropriedade);
      endOraStr(vlPropriedade);
      ULOG_VAR(nmPropriedade);
      ULOG_VAR(vlPropriedade);

      xml->createTag("tns:itemListaOfertaDetalheVO");
      xml->addItem("nome",(char *)nmPropriedade.arr);
      xml->addItem("valor",(char *)vlPropriedade.arr);
      xml->closeTag();

    }
  
    EXEC SQL CLOSE crsOfrt;
  }catch(...){throw;}

  return 1;
}

