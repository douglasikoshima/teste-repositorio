//
// $Id: ins_plano.pcpp,v 1.1 2009/07/31 15:34:31 a5110702 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"     
// #include  "../../negocio/fidutil/include/CallTux.h"

int ins_plano(int usuario, DOMNode*dnode, XMLGen*xml)
{
  ULOG_START("ins_plano()");
  char parm[255];
  //int   existeRegistro = 1;
  int ret=0;

  EXEC SQL BEGIN DECLARE SECTION;
  int     idPlano;
  VARCHAR nmPlano[255];
  int     idUfOperadora;
  int     idPessoaUsuarioInclusao;
  int	  idTipoPessoa;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
    
    idPlano = 0 ;
    
    //  Obtendo dados do xml
    get_tag(parm,dnode,"descricao",0,0);
    strToOra(nmPlano,parm);

    get_tag(parm,dnode,"idReg",0,0);
    idUfOperadora = atoi(parm);

	get_tag(parm,dnode,"idTipoPessoa",0,0);
    idTipoPessoa = atoi(parm);

    // Pegando id do usuario
    idPessoaUsuarioInclusao = usuario;

    //Verificando existencia do registro
    
    ULOG(" select COUNT(idPlano) from retencao.plano where inAtivo != 0 and idUfOperadora = %d and idTipoPessoa  = %d and   UPPER(TRIM(nmPlano)) = UPPER(TRIM(%s))",idUfOperadora,idTipoPessoa,(char *)nmPlano.arr); 
    
    EXEC SQL 
      select COUNT(idPlano)
      into   :idPlano
      from retencao.plano
      where inAtivo != 0
      and   idUfOperadora = :idUfOperadora
	  and   idTipoPessoa  = :idTipoPessoa
      and   UPPER(TRIM(nmPlano)) = UPPER(TRIM(:nmPlano)); 
  
    // Insercoes  
    if (!idPlano)
	{ // Nao existe registro igual
        EXEC SQL 
	    insert into retencao.plano(idPlano,
	    							  nmPlano,
	    							  idPessoaUsuarioInclusao,
	    							  dtInclusao,
	    							  idPessoaUsuarioAlteracao,
	    							  dtAlteracao,
	    							  idUsuarioAlteracao,
	    							  dtUltimaAlteracao,
	    							  idUfOperadora,
	    							  idTipoPessoa)
	    values(retencao.planoSQ.nextval,
	    	   :nmPlano,
	    	   :idPessoaUsuarioInclusao,
	           sysdate,
	    	   :idPessoaUsuarioInclusao,
	    	   sysdate,
	           :idPessoaUsuarioInclusao,
	    	   sysdate,
	           :idUfOperadora,
	    	   :idTipoPessoa);
        
          strcpy(parm,"INSERIDO");
	      ret=sqlca.sqlerrd[2];
    }
	else
	{ 
        strcpy(parm,"Já existe plano com esta descrição");
	    ret=-1;
    }

    // insert OK 
    xml->addItem("descricao",parm);
    xml->addItem("valor",ret);
  }
  catch(...)
  {
	throw;
  }

  ULOG_END("ins_plano()");
  return 1;
}

