//
// $Id: upd_plano.pcpp,v 1.1 2009/07/31 15:33:34 a5110702 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"
#include  "../../negocio/fidutil/include/CallTux.h"

int upd_plano(int usuario, DOMNode*dnode, XMLGen*xml)
{
  ULOG_START("upd_plano()");
  char parm[256];
  char szMsg[256];
  int iRet=0; 	

  EXEC SQL BEGIN DECLARE SECTION;
  int     idPlano;
  
  VARCHAR nmPlano[256];
  int     idUfOperadora;
  int     idPessoaUsuarioAlteracao;
  
  int     inCont;
  short   iinCont;
  int	  idTipoPessoa;
  
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
    //  Obtendo dados do xml
    get_tag(parm,dnode,"id",0,0);
    idPlano = atoi(parm);

    get_tag(parm,dnode,"descricao",0,0);
    strToOra(nmPlano,parm);

    get_tag(parm,dnode,"idReg",0,0);
    idUfOperadora = atoi(parm);

	get_tag(parm,dnode,"idTipoPessoa",0,0);
    idTipoPessoa = atoi(parm);

    // Pegando id do usuario
    idPessoaUsuarioAlteracao = usuario;

    // inc 3999
    ULOG("SELECT " ); 
    ULOG("nmPlano = [%s]",(char*)nmPlano.arr);
	ULOG("idUfOperadora = [%d]",idUfOperadora);
	ULOG("idPessoaUsuarioAlteracao = [%d]",idPessoaUsuarioAlteracao);
	ULOG("idTipoPessoa= [%d]",idTipoPessoa );
	ULOG("idPlano= [%d]",idPlano );

    ULOG("SELECT COUNT(1) "
           "FROM RETENCAO.PLANO "
          "WHERE INATIVO <> 0 "
            "AND IDUFOPERADORA = %d "
            "AND IDTIPOPESSOA = %d "
            "AND IDPLANO <> %d "
            "AND UPPER(TRIM(NMPLANO)) = UPPER(TRIM('%s')) "
         , idUfOperadora,idTipoPessoa,idPlano,(char*)nmPlano.arr );

	EXEC SQL 
      SELECT COUNT(1)
      INTO  :inCont:iinCont
      FROM  RETENCAO.PLANO
      WHERE INATIVO <> 0
      AND   IDUFOPERADORA = :idUfOperadora
	  AND   IDTIPOPESSOA = :idTipoPessoa  
      AND	IDPLANO <> :idPlano
      AND   UPPER(TRIM(NMPLANO)) = UPPER(TRIM(:nmPlano));

    ULOG("inCont = [%d] ",inCont ); 
    
    if( !inCont )
	{

		// Update 
		EXEC SQL 
			update  retencao.plano
			set     nmPlano = :nmPlano,
			idUfOperadora = :idUfOperadora,
			idPessoaUsuarioAlteracao = :idPessoaUsuarioAlteracao,
			dtAlteracao = sysdate,
			idTipoPessoa=:idTipoPessoa
			where   idPlano = :idPlano;
		
		    strcpy(szMsg,"MODIFICADO");
			iRet=sqlca.sqlerrd[2];
	}
	else
	{
		strcpy(szMsg,"Já existe esta descrição");
		iRet=-1;
	}

	xml->addItem("descricao",szMsg);
	xml->addItem("valor",iRet);
  }
  catch(...)
  {
	throw;
  }
  ULOG_END("upd_plano()");
  return 1;
}

