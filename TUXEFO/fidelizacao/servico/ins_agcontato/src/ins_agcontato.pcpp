//
// $Id: ins_agcontato.pcpp,v 1.1.118.42 2012/06/14 18:56:34 a5110706 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"

int ins_agcontato(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[255];

  EXEC SQL BEGIN DECLARE SECTION;
 
  int	  iQuantidadePREPOS;
  int	  iQuantidadePRECli;
  int	  iQuantidadePREPARAM;     
  int     idPessoaUsuarioInclusao;
  int     iPertence;
  int     idTipolinha;
  VARCHAR nrCPF[255];
  varchar  ddd[255];
  varchar  nrlinha[255];
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
    //  Obtendo dados do xml
     get_tag(parm,dnode,"cdDDD",0,0);
     strToOra(ddd,parm);
	
	 get_tag(parm,dnode,"numTelefone",0,0);
     strToOra(nrlinha,parm);
    
    // Pegando id do usuario
    idPessoaUsuarioInclusao = usuario;

	//


    // Insert agendamento
    EXEC SQL 
	select count(p.idlinhatelefonica)
		into  :iQuantidadePREPOS
		from  customer.programarelacionamentoprectrl p,
			  customer.programarelacionamentoprectrl p2
		where p.idpessoaendereco=p2.IDPESSOAENDERECO
		and   p.DTEXCLUSAO is null
		and   p2.dtexclusao is null
		and   p2.NRLINHA=:ddd||:nrlinha;

	ULOG( ">>>iQuantidadePREPOS [%d]", iQuantidadePREPOS);
	exec sql
		select D.NRDOCUMENTO
		into   :nrCPF
		from linha.linhatelefonica lt1,
		linha.linhabase lb1,
		customer.pessoalinha pl1,
		customer.pessoadepara pdp,
		customer.pessoadocumento pd,
	 	customer.documento d, 
		apoio.arearegistro ar1,
		apoio.tipodocumento td
		where lt1.IDLINHABASE=lb1.IDLINHABASE
		and   pl1.IDPESSOADEPARA=pdp.idpessoadepara
		and   pdp.idpessoa=pd.idpessoa
		and   pd.IDDOCUMENTO=d.iddocumento
		and   d.IDTIPODOCUMENTO=td.IDTIPODOCUMENTO
		and   lb1.IDAREAREGISTRO=ar1.IDAREAREGISTRO
		and   lt1.IDLINHATELEFONICA=pl1.IDLINHATELEFONICA
		and   pl1.IDTIPORELACIONAMENTO=2
		and   td.DSTIPODOCUMENTO='CPF'
		and   ar1.CDAREAREGISTRO=:ddd
		and   lb1.NRLINHA=:nrlinha
		AND ROWNUM<=1;
	
	endOraStr( nrCPF );
	
	ULOG( ">>>nrCPF [%s]", (char*)nrCPF.arr);

	
	EXEC SQL
	 select count(lt.idlinhatelefonica)
			into :iQuantidadePRECli
			from
                     customer.documento d,
                     customer.pessoadocumento pd,
                     customer.pessoadepara pdp,
                     customer.pessoalinha pl,
			         linha.linhatelefonica lt,
					 linha.linhabase lb,
					 apoio.arearegistro ar
             where	 d.IDDOCUMEnto=pd.IDDOCUMENTO
             and	 pd.IDPESSOA=pdp.IDPESSOA
             and	 pdp.IDPESSOADEPARA=pl.IDPESSOADEPARA
			 and     pl.IDTIPORELACIONAMENTO=2 --tipo de relacionamento cliente
			 and 	 pl.IDLINHATELEFONICA=lt.IDLINHATELEFONICA
			 and 	 lt.IDTIPOLINHA in (2,6)
			 and     lt.IDLINHABASE=lb.IDLINHABASE
			 and	 lb.IDAREAREGISTRO=ar.IDAREAREGISTRO
			 and	 d.nrdocumento=:nrCPF;
	
  exec sql	

  SELECT DSVALORPARAMETRO
		  INTO   :iQuantidadePREPARAM
		  FROM APOIO.PARAMETRO
		  WHERE CDPARAMETRO ='QTD_LIMITE_PR';
  
    // insert OK
	ULOG( ">>>iQuantidadePREPARAM [%d]", iQuantidadePREPARAM);
	exec sql
	select count(1)
		into :iPertence
		from (
		select nrdocumento 
		from customer.programarelacionamentopos
		where nrdocumento=:nrCPF
		union
		select idpessoaendereco
		from customer.programarelacionamentoprectrl
		where idpessoaendereco=:nrCPF);
	
	ULOG( ">>>iPertence [%d]", iPertence);

	xml->addItem("statCom","1");
    xml->addItem("cdCodigoRetorno","00");
    xml->addItem("QTLINHASPOSSIVEISPR",iQuantidadePREPARAM );
	xml->addItem("QTLINHASPRE",iQuantidadePRECli);
	xml->addItem("QTLINHASPR",iQuantidadePREPOS);
	xml->addItem("INPARTICIPAPR",(iPertence>0?1:0));

  }
  catch(...)
  {
	throw;
  }

  return 1;
}



int ins_pr(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[255];

  EXEC SQL BEGIN DECLARE SECTION;
 
  int	  iQuantidadePREPOS;
  int	  iQuantidadePRECli;
  int	  iQuantidadePREPARAM;     
  int     idPessoaUsuarioInclusao;
  VARCHAR nrCPF[255];
  varchar  ddd[255];
  varchar  nrlinha[255];
  varchar  telContato[255];
  varchar  idpessoadepara[255];
  varchar  idlinhatelefonica[255];
  int  idtipolinha;
  int	   idUser;
  int	   cdOperacao;
  int	   iMesmoDoc;
  int	   inDeletada;
  int		iQtpre;
  int      iDtvazio=0;
  int      iEndvazio=0;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
	idUser=usuario;
    //  Obtendo dados do xml
     get_tag(parm,dnode,"cdDDD",0,0);
     strToOra(ddd,parm);
	
	 get_tag(parm,dnode,"numTelefone",0,0);
     strToOra(nrlinha,parm);

	 get_tag(parm,dnode,"telContato",0,0);
     strToOra(telContato,parm);

	 get_tag(parm,dnode,"cdOperacao",0,0);
	 cdOperacao=atoi(parm);

    // Pegando id do usuario
    idPessoaUsuarioInclusao = usuario;

    // Insert agendamento
	
	exec sql
		select D.NRDOCUMENTO,
			   pl1.idpessoadepara,
			   pl1.idlinhatelefonica,
			   lt1.idtipolinha
		into   :nrCPF,
			   :idpessoadepara,
			   :idlinhatelefonica,
			   :idtipolinha
		from linha.linhatelefonica lt1,
		linha.linhabase lb1,
		customer.pessoalinha pl1,
		customer.pessoadepara pdp,
		customer.pessoadocumento pd,
	 	customer.documento d, 
		apoio.arearegistro ar1,
		apoio.tipodocumento td
		where lt1.IDLINHABASE=lb1.IDLINHABASE
		and   pl1.IDPESSOADEPARA=pdp.idpessoadepara
		and   pdp.idpessoa=pd.idpessoa
		and   pd.IDDOCUMENTO=d.iddocumento
		and   d.IDTIPODOCUMENTO=td.IDTIPODOCUMENTO
		and   lb1.IDAREAREGISTRO=ar1.IDAREAREGISTRO
		and   lt1.IDLINHATELEFONICA=pl1.IDLINHATELEFONICA
		and   pl1.IDTIPORELACIONAMENTO=2
		and   td.DSTIPODOCUMENTO='CPF'
		and   ar1.CDAREAREGISTRO=substr(:telContato,1,2) 
		and   lb1.NRLINHA=substr(:telContato,3) 
		AND ROWNUM<=1;

	 endOraStr( nrCPF );
	 endOraStr( idpessoadepara );
	 endOraStr( idlinhatelefonica );
	
	if(idtipolinha==2 || idtipolinha==6)
	  {
		exec sql
			select count(1) 
				into :iQtpre
			from customer.programarelacionamentoprectrl
			where idpessoaendereco=:nrCPF
			and   dtexclusao is null;
		ULOG( ">>>iQtpre [%d]", iQtpre);
	  }

	exec sql
	select count(1)
	into :iDtvazio
	from customer.pessoafisica pf,
		  customer.pessoadepara pdp
	where pf.idpessoa=pdp.idpessoa
	and   pf.DTNASCIMENTO is not null
	and   pdp.idpessoadepara =:idpessoadepara;

	exec sql
	select count(1)
	into	:iEndvazio
	from customer.pessoaendereco pe,
		  customer.pessoadepara pdp
	where pe.idpessoa=pdp.idpessoa
	and   pe.NRCEP is not null
	and   pdp.idpessoadepara =:idpessoadepara
	and exists (select 1 from customer.contaendereco ce 
				where ce.idpessoaendereco=pe.idpessoaendereco);
	
	/*if (iDtvazio ==0 || iEndvazio==0 )
	{
		ULOG( ">>>paramaetros incompletos");
		xml->addItem("statCom","1");
		xml->addItem("cdCodigoRetorno","05");
		return 1;
	}*/

	EXEC SQL
			select DECODE(D.NRDOCUMENTO,:nrCPF,1,0)
		into   :iMesmoDoc
		from linha.linhatelefonica lt1,
		linha.linhabase lb1,
		customer.pessoalinha pl1,
		customer.pessoadepara pdp,
		customer.pessoadocumento pd,
	 	customer.documento d, 
		apoio.arearegistro ar1,
		apoio.tipodocumento td
		where lt1.IDLINHABASE=lb1.IDLINHABASE
		and   pl1.IDPESSOADEPARA=pdp.idpessoadepara
		and   pdp.idpessoa=pd.idpessoa
		and   pd.IDDOCUMENTO=d.iddocumento
		and   d.IDTIPODOCUMENTO=td.IDTIPODOCUMENTO
		and   lb1.IDAREAREGISTRO=ar1.IDAREAREGISTRO
		and   lt1.IDLINHATELEFONICA=pl1.IDLINHATELEFONICA
		and   pl1.IDTIPORELACIONAMENTO=2
		and   td.DSTIPODOCUMENTO='CPF'
		and   ar1.CDAREAREGISTRO=:ddd
		and   lb1.NRLINHA=:nrlinha
		AND ROWNUM<=1;



	if(iMesmoDoc==0)
	  {
		ULOG( ">>>iMesmoDoc [%d]", iMesmoDoc);
		xml->addItem("statCom","1");
		xml->addItem("cdCodigoRetorno","06");
		return 1;
	  }
	
	if(cdOperacao==1)
	{
			if (idtipolinha==2 || idtipolinha==6 )
			{
				ULOG( ">>>idtipolinha in(2,6)");
				
				if(iQtpre<5)
				{	
					ULOG( ">>>iQtpre<5)");
				  
						EXEC SQL
						INSERT INTO customer.programarelacionamentoprectrl
											  (nrlinha, 
											   dtcadastro, 
											   dtexclusao,
											   dtultimaatualizacao, 
											   idusuarioatualizacao,
											   idpessoaendereco, 
											   nrlinhasolicitante,
											   intipoinscricao, 
											   idpessoadepara,
											   idlinhatelefonica, 
											   idtipolinha
											  )
									   VALUES (:telContato , 
											   SYSDATE, 
											   NULL,
											   SYSDATE, 
											   :idUser,
											   :nrCPF,
											   :ddd||:nrlinha,
											   NULL, 
											   :idpessoadepara,
											   :idlinhatelefonica, 
											   :idtipolinha
											  );
							
				}
					else
				{
					ULOG( ">>>iQtpre>=5)");
					xml->addItem("statCom","1");
					xml->addItem("cdCodigoRetorno","08");
					return 1;
				}
			}
			else 
			{

			 try{		
				 exec sql
               INSERT INTO customer.programarelacionamentopos
                           (idprogramarelacionamento,
							nrdocumento,
                            dtcadastro, 
							dtexclusao, 
							dtultimaatualizacao,
                            idusuarioatualizacao, 
							idpessoaendereco,
                            nrlinhasolicitante
                           )
                    VALUES ('1', 
							:nrCPF,
                            SYSDATE, 
							NULL, 
							SYSDATE,
                            :idUser, 
							'1',
                            :ddd||:nrlinha
                           );
			  }
			   catch(...)
				 {
					ULOG( ">>>CPF [%s] pos ja cadastrado",(char*)nrCPF.arr);
				 }
			}
		

		xml->addItem("statCom","1");
		xml->addItem("cdCodigoRetorno","00");
	}
	else if(cdOperacao==0)
	  {
		EXEC SQL	
			UPDATE customer.programarelacionamentoprectrl
			SET dtexclusao=SYSDATE
			WHERE NRLINHA=:telContato;
		

		exec sql UPDATE customer.linhasexcluidaspr
			SET dtexclusao=SYSDATE
			WHERE NRLINHA=:telContato;
		

		xml->addItem("statCom","1");
		xml->addItem("cdCodigoRetorno","00");
	  
	  }
	 else
	  {
		xml->addItem("statCom","1");
		xml->addItem("cdCodigoRetorno","02");
	  }


  }
  catch(...)
  {
	
		EXEC SQL
			select count(1) 
			into  :inDeletada
			from  customer.programarelacionamentoprectrl
			where dtexclusao is not null
			and   nrlinha=:telContato;

		if(inDeletada==1)
		  {
				
			EXEC SQL
			UPDATE customer.programarelacionamentoprectrl
				SET dtexclusao=null
			WHERE NRLINHA=:telContato;
		
			xml->addItem("statCom","1");
			xml->addItem("cdCodigoRetorno","00");

		  }
		else
		 {
			xml->addItem("statCom","1");
			xml->addItem("cdCodigoRetorno","07");
		 }
	
  }

  return 1;
}


int ins_cadpr(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[255];

  EXEC SQL BEGIN DECLARE SECTION;
 
  int	  iQuantidadePREPOS;
  int	  iQuantidadePRECli;
  int	  iQuantidadePREPARAM;     
  int     idPessoaUsuarioInclusao;
  VARCHAR dtNasci[255];
  varchar  CEP[255];
  varchar  ddd[255];
  varchar  nrlinha[255];
  varchar  idpessoadepara[255];
  varchar  idlinhatelefonica[255];
  VARCHAR nrCPF[255];
  int	   idtipolinha;
  int	   idUser;
  int	   cdOperacao;
  int	   iMesmoDoc;
  int	   inDeletada;
  int		iQtpre;
  int      iDtvazio=0;
  int      iEndvazio=0;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
	idUser=usuario;
    //  Obtendo dados do xml
     get_tag(parm,dnode,"dtNasc",0,0);
     strToOra(dtNasci,parm);
	
	 get_tag(parm,dnode,"cep",0,0);
     strToOra(CEP,parm);
	
	 get_tag(parm,dnode,"cdDDD",0,0);
     strToOra(ddd,parm);

	 get_tag(parm,dnode,"numTelf",0,0);
     strToOra(nrlinha,parm);
    // Pegando id do usuario
    idPessoaUsuarioInclusao = usuario;

    // Insert agendamento
	
	exec sql
		select D.NRDOCUMENTO,
			   pdp.idpessoa,
			   pl1.idlinhatelefonica,
			   lt1.idtipolinha
		into   :nrCPF,
			   :idpessoadepara,
			   :idlinhatelefonica,
			   :idtipolinha
		from linha.linhatelefonica lt1,
		linha.linhabase lb1,
		customer.pessoalinha pl1,
		customer.pessoadepara pdp,
		customer.pessoadocumento pd,
	 	customer.documento d, 
		apoio.arearegistro ar1,
		apoio.tipodocumento td
		where lt1.IDLINHABASE=lb1.IDLINHABASE
		and   pl1.IDPESSOADEPARA=pdp.idpessoadepara
		and   pdp.idpessoa=pd.idpessoa
		and   pd.IDDOCUMENTO=d.iddocumento
		and   d.IDTIPODOCUMENTO=td.IDTIPODOCUMENTO
		and   lb1.IDAREAREGISTRO=ar1.IDAREAREGISTRO
		and   lt1.IDLINHATELEFONICA=pl1.IDLINHATELEFONICA
		and   pl1.IDTIPORELACIONAMENTO=2
		and   td.DSTIPODOCUMENTO='CPF'
		and   ar1.CDAREAREGISTRO=:ddd
		and   lb1.NRLINHA=:nrlinha
		AND ROWNUM<=1;

	 endOraStr( nrCPF );
	 endOraStr( idpessoadepara );
	 endOraStr( idlinhatelefonica );

	 exec sql
	 update customer.pessoafisica pf
	 set dtnascimento=to_date(:dtNasci,'dd/mm/rr')
	 where idpessoa=:idpessoadepara;

	 exec sql
	 update customer.pessoaendereco pe
	 set pe.nrcep=:CEP
	 where idpessoa=:idpessoadepara
	and exists (select 1 from customer.contaendereco ce
				where ce.idpessoaendereco=pe.idpessoaendereco) ;
	
	xml->addItem("statCom","1");
	xml->addItem("cdCodigoRetorno","00");
  }
  catch(...)
  {
	
	xml->addItem("statCom","1");
	xml->addItem("cdCodigoRetorno","03");
		 
	
  }

  return 1;
}

