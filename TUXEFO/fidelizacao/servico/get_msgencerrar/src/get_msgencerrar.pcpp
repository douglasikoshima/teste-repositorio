//
// $Id: get_msgencerrar.pcpp,v 1.1 2009/07/31 15:34:09 a5110702 Exp $
//

#include "../../negocio/fidutil/include/retencao.hpp"

int get_msgencerrar(int usuario, DOMNode*dnode, XMLGen*xml)
{
  char parm[255];
  int  existeRegistro = 1;

  EXEC SQL BEGIN DECLARE SECTION;
  int     idUfOperadora;
  int     idMsgEncerramento;
  int     idTpEncerramento;
  VARCHAR dsMsgEncerramento[255];
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

  try{
    //  Obtendo dados do xml
    get_tag(parm,dnode,"idUfOperadora",0,0);

    idUfOperadora = atoi(parm);
  
    get_tag(parm,dnode,"idTpEncerramento",0,0);
    idTpEncerramento = atoi(parm);


    // Selecionar mensagem
    EXEC SQL WHENEVER NOT FOUND DO cl_flag(&existeRegistro);
    EXEC SQL 
      select idMsgEncerramento,dsMsgEncerramento
      into   :idMsgEncerramento,:dsMsgEncerramento
      from   retencao.MsgEncerramento
      where  inAtivo = 1
      and    idUfOperadora = :idUfOperadora
      and    idTipoEncerramento = :idTpEncerramento
	  ORDER BY dsMsgEncerramento;
  
    if (existeRegistro){
      endOraStr(dsMsgEncerramento);
      ULOG_INT(idMsgEncerramento);
      ULOG_VAR(dsMsgEncerramento);
      xml->createTag("tns:itemListaVO");
      xml->addItem("id",idMsgEncerramento);
      xml->addItem("descricao",(char *)dsMsgEncerramento.arr);
      xml->closeTag();
    }
  }catch(...){throw;}
  
  return 1;
}

