//
// $Id: ins_submotivo.pcpp,v 1.1 2009/07/31 15:34:20 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int ins_submotivo(char * usuario, DOMNode*dnode,XMLGen*xml)
{
	char parm[256];

	EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR sgSubMotivo[256];
		VARCHAR nmSubMotivo[256];
		int     idPessoaUsuarioAlteracao;
		int	inAtivo;
                int     idTipoSubMotivoCampanha = 0;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    //  Obtendo dados do xml


	get_tag(parm, dnode, "sgSubMotivo", 0, 0);
	strToOra(sgSubMotivo,parm);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "nmSubMotivo", 0, 0);
	strToOra(nmSubMotivo,parm);

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);

	inAtivo = 1;

	/* Verifica se existe o item a adcionar */
	EXEC SQL DECLARE crsSubMotivo CURSOR FOR
                SELECT SUBMOTIVO.idtiposubmotivocampanha
                FROM apoio.tiposubmotivocampanha SUBMOTIVO
                WHERE  (SUBMOTIVO.sgtiposubmotivocampanha = :sgSubMotivo
		OR     SUBMOTIVO.DSTIPOSUBMOTIVOCAMPANHA = :nmSubMotivo);
	EXEC SQL OPEN crsSubMotivo;

	for(;;) 
	{
		EXEC SQL FETCH crsSubMotivo INTO :idTipoSubMotivoCampanha;
		break;
	}
  
	EXEC SQL CLOSE crsSubMotivo;	
	
	if(idTipoSubMotivoCampanha == 0)
	{

		/* Insert linha */
		EXEC SQL  INSERT INTO APOIO.tiposubmotivocampanha(idtiposubmotivocampanha,
		   			  		   									   sgtiposubmotivocampanha, 
																   dstiposubmotivocampanha,
																   indisponibilidade,
                                                        		   idpessoausuarioinclusao,
                                                        		   idpessoausuarioalteracao,
                                                        		   dtinclusao,
                                                        		   dtalteracao,
																   idusuarioalteracao,
																   dtultimaalteracao,
                                                        		   inativo)
						 VALUES(apoio.tiposubmotivocampanhasq.NEXTVAL,
								    						  :sgSubMotivo,
															  :nmSubMotivo,
                                                        	  :inAtivo,
                                                        	  :idPessoaUsuarioAlteracao,
                                                        	  :idPessoaUsuarioAlteracao,
                                                        	  SYSDATE,
                                                        	  SYSDATE,
															  :idPessoaUsuarioAlteracao,
															  SYSDATE,
                                                        	  :inAtivo);
		if (sqlca.sqlcode)
		{
			throw new TuxBasicSvcException("00E1000","INSERT INTO apoio.tiposubmotivocampanha");
		}

		/* insert OK */
		xml->createTag("SUBMOTIVO");
		xml->addItem("INSERT",1);
		xml->closeTag();
	}
	
        if(idTipoSubMotivoCampanha > 0)
	{
		EXEC SQL UPDATE apoio.tiposubmotivocampanha
		    SET         sgtiposubmotivocampanha = :sgSubMotivo ||SYSDATE|| :idTipoSubMotivoCampanha,  
                        dstiposubmotivocampanha = :nmSubMotivo ||SYSDATE|| :idTipoSubMotivoCampanha,
						indisponibilidade = :inAtivo,
						idPessoaUsuarioAlteracao = :idPessoaUsuarioAlteracao,
						dtAlteracao = sysdate,
						IDUSUARIOALTERACAO=:idPessoaUsuarioAlteracao,
						DTULTIMAALTERACAO=sysdate
						WHERE idtiposubmotivocampanha = :idTipoSubMotivoCampanha;

		
		EXEC SQL  INSERT INTO APOIO.tiposubmotivocampanha(idtiposubmotivocampanha,
		   			  		   									   sgtiposubmotivocampanha, 
																   dstiposubmotivocampanha,
																   indisponibilidade,
                                                        		   idpessoausuarioinclusao,
                                                        		   idpessoausuarioalteracao,
                                                        		   dtinclusao,
                                                        		   dtalteracao,
																   idusuarioalteracao,
																   dtultimaalteracao,
                                                        		   inativo)
						 VALUES(apoio.tiposubmotivocampanhasq.NEXTVAL,
								    						  :sgSubMotivo,
															  :nmSubMotivo,
                                                        	  :inAtivo,
                                                        	  :idPessoaUsuarioAlteracao,
                                                        	  :idPessoaUsuarioAlteracao,
                                                        	  SYSDATE,
                                                        	  SYSDATE,
															  :idPessoaUsuarioAlteracao,
															  SYSDATE,
                                                        	  :inAtivo);

											  
		if (sqlca.sqlcode)
		{
			throw new TuxBasicSvcException("00E1000","UPDATE apoio.tiposubmotivocampanha ");
		}
		
		/* insert modificado para update OK */
		xml->createTag("SUBMOTIVO");
		xml->addItem("ID",idTipoSubMotivoCampanha);
		xml->addItem("UPDATE",1);
		xml->closeTag();
	}
	return 1;

}


