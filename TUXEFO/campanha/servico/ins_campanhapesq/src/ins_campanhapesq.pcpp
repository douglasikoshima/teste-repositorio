//
// $Id: ins_campanhapesq.pcpp,v 1.1 2009/07/31 15:34:19 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int ins_campanhapesq(char * usuario, DOMNode*dnode,XMLGen*xml)
{
	char parm[256];
	char parm2[2001];
	
	EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR sgCampanha[255];
		VARCHAR dsCampanha[2001];
		int     idPessoaUsuarioAlteracao;
        int     idCampanha = 0;
		int		inAtivo;
		int crtId=0;
		
		/*--- Mod 12/08/04*/
		int     NextVal1;
		int     inDisponibilidade = 0;
		
		/*--- Mod 12/08/04*/
		
	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
	

    //  Obtendo dados do xml
	get_tag(parm, dnode, "idCampanha", 0, -1);
	idCampanha=atoi(parm);

	
	get_tag(parm, dnode, "sgCampanha", 0, 0);
	strToOra(sgCampanha,parm);


    //  Obtendo dados do xml

	get_tag(parm2, dnode, "dsCampanha", 0, 0);
	strToOra(dsCampanha,parm2);

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);

	inAtivo = 1;

	/* Verifica se existe o item a adcionar */
	EXEC SQL
                SELECT CAMPANHAPESQ.idcampanha
				into :crtId
                FROM apoio.campanha CAMPANHAPESQ
                WHERE   CAMPANHAPESQ.inativo = 1
                and idCampanha!=:idCampanha
				AND    (UPPER(trim(CAMPANHAPESQ.sgcampanha)) = UPPER(trim(:sgCampanha))
						OR     UPPER(trim(CAMPANHAPESQ.dscampanha)) = UPPER(trim(:dsCampanha)))
				and rownum<=1;
  
	ULOG_INT(crtId);
	if(!crtId) idCampanha=0;
	else idCampanha=crtId;

	
	// xml->createTag("CAMPANHAPESQ");
	xml->addItem("descricao","idCampanha");
	xml->addItem("valor",idCampanha);
	// xml->closeTag();
	return 1;

}
