//
// $Id: upd_subcampanha.pcpp,v 1.1 2009/07/31 15:33:50 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int upd_subcampanha(char * usuario, DOMNode*dnode,XMLGen*xml)
{
    TuxHelper txhI;
    char parm[1000];
    int iSubno = 0;
    int iNroObjCta = 0;
    DOMNode *pConta;
    DOMNode *pNoConta;

	EXEC SQL BEGIN DECLARE SECTION;
		int     idSubCampanhaHistorico = 0;
		int     idSubCampanhaFixa = 0;
		int     idCampanha = 0;
		int     inAtivo = 0;
		int     inDisponibilidade = 0;
		int     idPessoaUsuarioAlteracao = 0;
		int     idTipoCampanha = 0;
		VARCHAR dsScriptSubCampanha[1000];
		int     inClienteTelefonica = 0;
		int     qtMaximaAgenda = 0;
		VARCHAR dtInicio[255];
		VARCHAR dtTermino[255];
		int     sqVersao = 0;
		int     inReincidente = 0;
		int     idGrupo = 0;
		int     idCanalUFOperadora = 0;
		int     sqApresentacao = 0;
		int     idSubCampanhaGrupoUsuario = 0;
		int     idCanalCampanha = 0;
		int     cncmpinAtivo = 0;
		int     ginAtivo = 0;
		int     idGotcha = 0;
		VARCHAR dsNmSubCampanha[255+1];
		int		iConta=0;
		VARCHAR dsinDisponibilidade[255+1];
		int     iinFidelizacao;
		int     iidCampanhaFidelizacao = 0;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

	//  Obtendo dados do xml
	get_tag(parm, dnode, "inFidelizacao", 0, -1);
	iinFidelizacao = atoi(parm);

	get_tag(parm, dnode, "idCampanha", 0, 0);
	idCampanha= atoi(parm);

	get_tag(parm, dnode, "idSubCampanha", 0, 0);
	idSubCampanhaHistorico= atoi(parm);

	get_tag(parm, dnode, "idSubCampanhaFixa", 0, 0);
	idSubCampanhaFixa= atoi(parm);

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);

	get_tag(parm, dnode, "inAtivo", 0, 0);
	inDisponibilidade= atoi(parm);

	get_tag(parm, dnode, "nmSubCampanha",0,0);
	strToOra(dsNmSubCampanha,parm);

	inAtivo = 1;
	//inDisponibilidade = 1;
    cncmpinAtivo = 1;
    ginAtivo = 1;

	//Valida se ja existe
	EXEC SQL
	SELECT
		COUNT(1)
	INTO
		:iConta
	FROM
		CAMPANHA.SUBCAMPANHAFIXA
	WHERE
		UPPER(NMSUBCAMPANHAFIXA) LIKE UPPER(:dsNmSubCampanha)
	AND	
		IDSUBCAMPANHAFIXA <> :idSubCampanhaFixa
	AND 
		INATIVO = 1;

	// Caso ja exista uma subcampanhafixa igual e nao seja ela mesma retorna warning
	if( iConta>0 )
		return 2;

	EXEC SQL
	SELECT 
		COUNT(1)
	INTO
		:iidCampanhaFidelizacao
	FROM
		CAMPANHA.SUBCAMPANHAFIDELIZACAO
	WHERE
		IDSUBCAMPANHAHISTORICO = :idSubCampanhaHistorico;

	//Se achou o idsubcampanhahistorico na tabela SUBCAMPANHAFIDELIZACAO e nao tem a TAG inFidelizacao REMOVE
	if( ( iidCampanhaFidelizacao ) && ( iinFidelizacao != 1 ) )
	{
		EXEC SQL
		DELETE FROM 
			CAMPANHA.SUBCAMPANHAFIDELIZACAO
		WHERE
			IDSUBCAMPANHAHISTORICO = :idSubCampanhaHistorico;
	}
	//Se NAO achou o idsubcampanhahistorico na tabela SUBCAMPANHAFIDELIZACAO e TEM a TAG inFidelizacao INSERE
	else if( ( !iidCampanhaFidelizacao ) && ( iinFidelizacao == 1 ) )
	{
		EXEC SQL
		INSERT INTO CAMPANHA.SUBCAMPANHAFIDELIZACAO
		(	
			IDSUBCAMPANHAHISTORICO
		)
		VALUES
		(
			:idSubCampanhaHistorico
		);
	}
	//Qualquer outra coisa, NAO FAZ NADA. Fica como esta

	/* Update linha */
	EXEC SQL 
	UPDATE campanha.subcampanhafixa
	SET
		IDCAMPANHA         = :idCampanha,
		INATIVO            = :inAtivo,
		INDISPONIBILIDADE  = :inDisponibilidade,
		IDUSUARIOALTERACAO = :idPessoaUsuarioAlteracao,
		DTULTIMAALTERACAO  =  SYSDATE,
		NMSUBCAMPANHAFIXA  = :dsNmSubCampanha
	WHERE
		IDSUBCAMPANHAFIXA = :idSubCampanhaFixa;

	if (sqlca.sqlcode)
	{
		throw new TuxBasicSvcException("00E1000","UPDATE campanha.subcampanhafixa");
	}

	//  Obtendo dados do xml
	get_tag(parm, dnode, "idTipoCampanha", 0, 0);
	idTipoCampanha= atoi(parm);
 
	get_tag(parm, dnode, "dsSubCampanha", 0, 0);
	strToOra(dsScriptSubCampanha,parm);
 
	get_tag(parm, dnode, "inCliente", 0, 0);
	inClienteTelefonica= atoi(parm);
 
	get_tag(parm, dnode, "iAgendaMax", 0, 0);
	qtMaximaAgenda= atoi(parm);
 
	get_tag(parm, dnode, "dtInicio", 0, 0);
	strToOra(dtInicio,parm);

	get_tag(parm, dnode, "dtTermino", 0, 0);
	strToOra(dtTermino,parm);

	get_tag(parm, dnode, "sqVersao", 0, 0);
	sqVersao= atoi(parm);

	get_tag(parm, dnode, "iRecontato", 0, 0);
	inReincidente= atoi(parm);

	get_tag(parm, dnode, "inDisponibilidade",0,0);
	strToOra(dsinDisponibilidade,parm);

	/* Update linha */
	EXEC SQL 
	UPDATE CAMPANHA.SUBCAMPANHAHISTORICO
	SET
		IDSUBCAMPANHAFIXA = :idSubCampanhaFixa,
		IDTIPOCAMPANHA = :idTipoCampanha,
		DSSCRIPTSUBCAMPANHA = :dsScriptSubCampanha,
		INCLIENTETELEFONICA = :inClienteTelefonica,
		QTMAXIMAAGENDA = :qtMaximaAgenda,
		DTINICIO = TO_DATE(:dtInicio, 'DD/MM/YYYY HH:MI:SS AM'),
		DTTERMINO = TO_DATE(:dtTermino, 'DD/MM/YYYY HH:MI:SS AM'),
		SQVERSAO = :sqVersao,
		INREINCIDENTE = :inReincidente,
	    IDUSUARIOALTERACAO = :idPessoaUsuarioAlteracao,
	    DTULTIMAALTERACAO = SYSDATE,
		INDISPONIBILIDADE = :dsinDisponibilidade
	WHERE  
		IDSUBCAMPANHAHISTORICO = :idSubCampanhaHistorico;

	//Acerta todos os nomes, para ficar igual ao de subcampanhafixa. Isto porque estamos em faze de transicao
	//Nesta tabela nao devera mais haver nomes.
	EXEC SQL 
	UPDATE CAMPANHA.SUBCAMPANHAHISTORICO
	SET
	    IDUSUARIOALTERACAO = :idPessoaUsuarioAlteracao,
	    DTULTIMAALTERACAO = SYSDATE,
	    NMSUBCAMPANHA = :dsNmSubCampanha
	WHERE  
		IDSUBCAMPANHAFIXA = :idSubCampanhaFixa;
	
	if (sqlca.sqlcode)
	{
		throw new TuxBasicSvcException("00E1000","UPDATE campanha.subcampanhahistorico");
	}

	/* CanalUtil */
	iNroObjCta = 0;
	pConta = txhI.walkDOM(dnode, "CanalUtil", iNroObjCta);

	for(iNroObjCta = 0; (pNoConta = txhI.walkDOM(pConta, "ApoioCanalVO", iNroObjCta)) ;  iNroObjCta++)
	{
		// ulog("Passagem Canal [%d]",iNroObjCta);
        //  Obtendo dados do xml

	    get_tag(parm, pNoConta, "idCanalUFOperadora", 0, 0);
	    idCanalUFOperadora= atoi(parm);

        //  Obtendo dados do xml

	    // get_tag(parm, pNoConta, "idCanalCampanha", 0, 0);
	    // idCanalCampanha= atoi(parm);

	    get_tag(parm, pNoConta, "sqApresentacao", 0, 0);
	    sqApresentacao= atoi(parm);
            
	    get_tag(parm, pNoConta, "cnlcmpinAtivo", 0, 0);
	    cncmpinAtivo= atoi(parm);

		idGotcha = 0;

		EXEC SQL DECLARE crsCampCanal1 CURSOR FOR
		SELECT	idcanalcampanha
		FROM	campanha.CanalCampanha 
		WHERE	idcanalufoperadora = :idCanalUFOperadora
		AND		idsubcampanhahistorico = :idSubCampanhaHistorico;
		EXEC SQL OPEN crsCampCanal1;

		for(;;)
		{
			EXEC SQL FETCH crsCampCanal1 INTO :idGotcha;
			break;
		}

		EXEC SQL CLOSE crsCampCanal1;

		if(idGotcha > 0)
        {
                EXEC SQL UPDATE campanha.canalcampanha
						SET		idsubcampanhahistorico = :idSubCampanhaHistorico,
								idcanalufoperadora = :idCanalUFOperadora,
								sqapresentacao =  :sqApresentacao,
								indisponibilidade = :inDisponibilidade,
								inAtivo = :cncmpinAtivo,
								idusuarioalteracao = :idPessoaUsuarioAlteracao,
								dtultimaalteracao = sysdate
                     WHERE  idcanalufoperadora = :idCanalUFOperadora
                     AND    idsubcampanhahistorico = :idSubCampanhaHistorico;
	
                if (sqlca.sqlcode)
                {
                    throw new TuxBasicSvcException("00E1000","UPDATE contatoadm.subcampanhagrupousuario");
                }
        }
		else if(idGotcha <= 0)
        {
			EXEC SQL select campanha.canalcampanhasq.nextval into :idGotcha from dual;               

            EXEC SQL INSERT INTO campanha.canalcampanha(idcanalcampanha,
                                              idsubcampanhahistorico,
                                              idcanalufoperadora,
                                              sqapresentacao,
                                              indisponibilidade,
                                              idusuarioalteracao,
                                              dtultimaalteracao)
							VALUES(:idGotcha,
                                              :idSubCampanhaHistorico,
                                              :idCanalUFOperadora,
                                              :sqApresentacao,
                                              :inDisponibilidade,
                                              :idPessoaUsuarioAlteracao,
                                              sysdate);
			if (sqlca.sqlcode)
			{
				throw new TuxBasicSvcException("00E1000","INSERT INTO campanha.SubCampanhaAtual");
			}
		}//idGotcha > 0
	    idCanalUFOperadora= 0;
	    idCanalCampanha= 0;
	    sqApresentacao= 0;
	    cncmpinAtivo= 0;
	}

    /* PerfilUtil */
	iNroObjCta = 0;
	pConta = txhI.walkDOM(dnode, "PerfilUtil", iNroObjCta);

	for(iNroObjCta = 0; (pNoConta = txhI.walkDOM(pConta, "ApoioPerfilVO",  iNroObjCta)) ;  iNroObjCta++)
	{
		// ulog("Passagem Grupo [%d]",iNroObjCta);
		//  Obtendo dados do xml
		get_tag(parm, pNoConta, "idGrupo", 0, 0);
		idGrupo= atoi(parm);

		//  Obtendo dados do xml
		//	    get_tag(parm, pNoConta, "idSubCampanhaGrupoUsuario", 0, -1);
		//	    idSubCampanhaGrupoUsuario= atoi(parm);

		get_tag(parm, pNoConta, "ginAtivo", 0, 0);
		ginAtivo= atoi(parm);

		idGotcha = 0;

		EXEC SQL DECLARE crsGrupoUsu CURSOR FOR
		SELECT	idSubCampanhaGrupoUsuario
		FROM	contatoadm.subcampanhagrupousuario
		WHERE	idsubcampanhafixa = :idSubCampanhaFixa
		AND		idgrupo = :idGrupo;

		EXEC SQL OPEN crsGrupoUsu;

		for(;;)
		{
			EXEC SQL FETCH crsGrupoUsu INTO :idGotcha;
			break;
		}

		EXEC SQL CLOSE crsGrupoUsu;

		if(idGotcha > 0)
		{
			/* Update linha */
			EXEC SQL UPDATE contatoadm.subcampanhagrupousuario
			SET    idsubcampanhafixa = :idSubCampanhaFixa,
						idgrupo = :idGrupo,
						inAtivo = :ginAtivo,
						idusuarioalteracao = :idPessoaUsuarioAlteracao,
						dtultimaalteracao = sysdate
			WHERE  idsubcampanhafixa = :idSubCampanhaFixa
			AND    idgrupo = :idGrupo;

			if (sqlca.sqlcode)
			{
				throw new TuxBasicSvcException("00E1000","UPDATE contatoadm.subcampanhagrupousuario");
			}
		}
		else if(idGotcha <= 0)
        {
			EXEC SQL select contatoadm.subcampanhagrupousuariosq.nextval into :idGotcha from dual;

			EXEC SQL INSERT INTO contatoadm.subcampanhagrupousuario(idsubcampanhagrupousuario,
								  idsubcampanhafixa,
								  idgrupo,
								  inAtivo,
								  idusuarioalteracao,
								  dtultimaalteracao)
						   VALUES(:idGotcha,
								  :idSubCampanhaFixa,
								  :idGrupo,
								  1,
								  :idPessoaUsuarioAlteracao,
								  sysdate);
			if (sqlca.sqlcode)
			{
				throw new TuxBasicSvcException("00E1000","INSERT INTO contatoadm.subcampanhagrupousuario");
			}
		}//idGotcha > 0
	     idGrupo= 0;
	     idSubCampanhaGrupoUsuario= 0;
	     ginAtivo= 0;
	}

	/* updade OK */
	xml->createTag("SUBCAMPANHA");
	xml->addItem("UPDATE",1);
    xml->closeTag();

	return 1;
}