//
// $Id: ins_submotivopesq.pcpp,v 1.1 2009/07/31 15:35:11 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int ins_submotivopesq(char * usuario, DOMNode*dnode,XMLGen*xml)
{
	char parm[256];

	EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR sgSubMotivo[255];
		VARCHAR nmSubMotivo[255];
		int     idPessoaUsuarioAlteracao;
		int	inAtivo;
                int     idTipoSubMotivoCampanha = 0;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    //  Obtendo dados do xml


	get_tag(parm, dnode, "sgSubMotivo", 0, 0);
	strToOra(sgSubMotivo,parm);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "nmSubMotivo", 0, 0);
	strToOra(nmSubMotivo,parm);

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);

	inAtivo = 1;

	/* Verifica se existe o item a adcionar */
	EXEC SQL DECLARE crsSubMotivo CURSOR FOR
                SELECT SUBMOTIVO.idtiposubmotivocampanha
                FROM   apoio.tiposubmotivocampanha SUBMOTIVO

		WHERE  SUBMOTIVO.inativo = 1
                AND    (trim(UPPER(SUBMOTIVO.sgtiposubmotivocampanha)) = UPPER(trim(:sgSubMotivo))
                OR     UPPER(trim(SUBMOTIVO.DSTIPOSUBMOTIVOCAMPANHA)) = UPPER(trim(:nmSubMotivo)));
               
	EXEC SQL OPEN crsSubMotivo;

	for(;;) 
	{
		EXEC SQL FETCH crsSubMotivo INTO :idTipoSubMotivoCampanha;
		break;
	}
  
	EXEC SQL CLOSE crsSubMotivo;	
	
		
	/* insert modificado para update OK */
	// xml->createTag("SUBMOTIVOPESQ");
	xml->addItem("descricao","idTipoSubMotivoCampanha");
	xml->addItem("valor",idTipoSubMotivoCampanha);
	// xml->closeTag();

	return 1;

}


