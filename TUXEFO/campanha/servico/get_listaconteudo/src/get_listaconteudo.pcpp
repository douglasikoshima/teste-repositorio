//
// $Id: get_listaconteudo.pcpp,v 1.1.2.1 2010/01/13 22:57:17 a5110702 Exp $
// 

#include "../../negocio/cmputil/include/campanha.hpp"

int get_listaconteudo(char * usuario, DOMNode*dnode,XMLGen*xml)
{
	char parm[255];
	int nOperacao=0;
	struct sqlca sqlca;
	EXEC SQL BEGIN DECLARE SECTION;
		struct
		{
			VARCHAR idListaConteudo[21+1];
			VARCHAR idLista[21+1];
			VARCHAR nmContato[255+1];
			VARCHAR stnrTelefone[21+1];
			VARCHAR VersaoCampanha[255+1];
			VARCHAR sgCampanha[255+1];
			VARCHAR nmCanal[255+1];
			VARCHAR idSubCampanhaHistorico[21+1];
			VARCHAR sqVersao[21+1];
			VARCHAR nmSubCampanha[255+1];
			VARCHAR sqApresentacao[21+1];
			VARCHAR idCanalCampanha[21+1];
		}stGeral;

		char  cidCanalCampanha[21+1];
		char  cnrTelefone[21+1];
	EXEC SQL END DECLARE SECTION;

	memset( &sqlca, 0, sizeof( sqlca ) );

	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
	EXEC SQL WHENEVER NOT FOUND DO break;

	try
	{
		memset( &stGeral, 0, sizeof( stGeral ) );
		
		get_tag(parm, dnode, "operacao", 0, 0);
		nOperacao=atoi(parm);

		get_tag(cnrTelefone, dnode, "nrTelefone", 0, -1);

		switch(nOperacao)
		{
			case 0:
				EXEC SQL DECLARE crsListaConteudo1 CURSOR FOR
				SELECT DISTINCT
                    CANALCAMPANHA.IDCANALCAMPANHA,
					CAMPANHA.SGCAMPANHA || ' ' || SUBCAMPANHAHISTORICO.SQVERSAO AS VERSAOCAMPANHA,
					CAMPANHA.SGCAMPANHA,
					SUBCAMPANHAHISTORICO.SQVERSAO, 
					CANAL.NMCANAL || '-' || UF.SGUF, 
					SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO,
					SUBCAMPANHAFIXA.NMSUBCAMPANHAFIXA,
					SUBCAMPANHAHISTORICO.SQAPRESENTACAO
				FROM	
					CAMPANHA.SUBCAMPANHAHISTORICO SUBCAMPANHAHISTORICO,
                    CAMPANHA.MOTIVOCAMPANHA MOTIVOCAMPANHA,
					CAMPANHA.SUBCAMPANHAFIXA SUBCAMPANHAFIXA,
                    CAMPANHA.SUBCAMPANHAATUAL SUBCAMPANHAATUAL,
					APOIO.CAMPANHA CAMPANHA,
                    CAMPANHA.CANALCAMPANHA CANALCAMPANHA,
                    CAMPANHA.CANALUFOPERADORA CANALUFOPERADORA,
                    CUSTOMER.UFOPERADORA UFOPERADORA,
                    APOIO.UF UF,
                    APOIO.CANAL CANAL,
                    (
                        SELECT
                            CANALCAMPANHA.IDSUBCAMPANHAHISTORICO,
                            CANALCAMPANHA.IDCANALCAMPANHA
                        FROM    
                            QUESTIONARIO.PERGUNTA PERGUNTA,
                            CAMPANHA.CAMPANHAQUESTIONARIO CAMPANHAQUESTIONARIO,
                            CAMPANHA.CANALCAMPANHA CANALCAMPANHA
                        WHERE
                            CAMPANHAQUESTIONARIO.IDPERGUNTA = PERGUNTA.IDPERGUNTA
                        AND
                            PERGUNTA.IDTIPOAPRESENTACAOPERGUNTA IN (2,4,5)
                        AND
                            CAMPANHAQUESTIONARIO.INATIVO = 1
                        AND
                            CAMPANHAQUESTIONARIO.IDCANALCAMPANHA = CANALCAMPANHA.IDCANALCAMPANHA
                        AND
                            CANALCAMPANHA.INATIVO = 1
                        AND     
                        (
                            PERGUNTA.IDPERGUNTA IN 
                            (
                                SELECT  IDPERGUNTA    
                    	        FROM    QUESTIONARIO.RESPOSTA
                	    	    WHERE   INDISPONIBILIDADE != 0
                		        AND     IDPERGUNTA = PERGUNTA.IDPERGUNTA
                            )
                		    OR 
                                PERGUNTA.IDTIPOAPRESENTACAOPERGUNTA = 5
                        )
                        INTERSECT
                        SELECT
                            CANALCAMPANHA.IDSUBCAMPANHAHISTORICO,
                            CANALCAMPANHA.IDCANALCAMPANHA
                        FROM 
                            CAMPANHA.LISTACONTEUDO LISTACONTEUDO,
                            CAMPANHA.LISTA LISTA,
                            CAMPANHA.LISTACANALCAMPANHA LISTACANALCAMPANHA,
                            CAMPANHA.CANALCAMPANHA CANALCAMPANHA
                        WHERE
                            LISTACONTEUDO.IDLISTA = LISTA.IDLISTA
                        AND
                            LISTA.IDLISTA = LISTACANALCAMPANHA.IDLISTA
                        AND
                            LISTACANALCAMPANHA.INATIVO = 1
                        AND
                            LISTACANALCAMPANHA.IDCANALCAMPANHA = CANALCAMPANHA.IDCANALCAMPANHA
                        AND
                            CANALCAMPANHA.INATIVO = 1
                        AND
                            LISTACONTEUDO.IDLISTACONTEUDO NOT IN 
                            (	
                                SELECT DISTINCT
                                    IDLISTACONTEUDO                                                
                        		FROM 
                                    CAMPANHA.ATENDIMENTOCAMPANHA
                            )
                    )CANALCAMPANHASCAHISTORICO
				WHERE 
                    CANALCAMPANHA.IDSUBCAMPANHAHISTORICO = SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO
                AND
                    SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO = SUBCAMPANHAATUAL.IDSUBCAMPANHAHISTORICO
                AND
                    CANALCAMPANHA.IDCANALUFOPERADORA = CANALUFOPERADORA.IDCANALUFOPERADORA
                AND
                    CANALUFOPERADORA.IDCANAL = CANAL.IDCANAL 
                AND
                    CANALUFOPERADORA.IDUFOPERADORA = UFOPERADORA.IDUFOPERADORA
                AND
                    UFOPERADORA.IDUF = UF.IDUF
                AND
                    SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO = CANALCAMPANHASCAHISTORICO.IDSUBCAMPANHAHISTORICO
                AND
                    CANALCAMPANHASCAHISTORICO.IDCANALCAMPANHA = CANALCAMPANHA.IDCANALCAMPANHA
                AND
					SUBCAMPANHAHISTORICO.IDSUBCAMPANHAFIXA = SUBCAMPANHAFIXA.IDSUBCAMPANHAFIXA
                AND
                    SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO = MOTIVOCAMPANHA.IDSUBCAMPANHAHISTORICO
				AND    
					SUBCAMPANHAFIXA.IDCAMPANHA = CAMPANHA.IDCAMPANHA
				AND
                    SUBCAMPANHAHISTORICO.INDISPONIBILIDADE = 1
				AND
                    CAMPANHA.INATIVO = 1
                AND
                    MOTIVOCAMPANHA.INATIVO = 1
				AND
                    SYSDATE BETWEEN SUBCAMPANHAHISTORICO.DTINICIO AND SUBCAMPANHAHISTORICO.DTTERMINO
                ORDER BY 
                	SUBCAMPANHAHISTORICO.SQAPRESENTACAO;

				EXEC SQL OPEN crsListaConteudo1;
		
				for(;;) 
				{
					memset( &stGeral, 0, sizeof( stGeral ) );
					EXEC SQL 
					FETCH 
						crsListaConteudo1 
					INTO
						:stGeral.idCanalCampanha, 
						:stGeral.VersaoCampanha, 
						:stGeral.sgCampanha, 
						:stGeral.sqVersao, 
						:stGeral.nmCanal,
						:stGeral.idSubCampanhaHistorico,
						:stGeral.nmSubCampanha,
						:stGeral.sqApresentacao;

					xml->createTag("campanhasRelacionadas");
					xml->addItem("idCanalCampanha",(char *)stGeral.idCanalCampanha.arr);
					xml->addItem("nmCanal",(char *)stGeral.nmCanal.arr);
					xml->addItem("VersaoCampanha",(char *)stGeral.VersaoCampanha.arr);
					xml->addItem("sgCampanha",(char *)stGeral.sgCampanha.arr);
					xml->addItem("sqVersao",(char*)stGeral.sqVersao.arr);
					xml->addItem("idSubCampanhaHistorico",(char*)stGeral.idSubCampanhaHistorico.arr); 
					xml->addItem("idListaConteudo",0);
					xml->addItem("nmSubCampanha",(char *)stGeral.nmSubCampanha.arr);
					xml->addItem("sqApresentacao",(char*)stGeral.sqApresentacao.arr);

					xml->closeTag();
				}
  
				EXEC SQL CLOSE crsListaConteudo1;
				//final do case0
				break;
			case 1:
				get_tag(cidCanalCampanha, dnode, "idCanalCampanha", 0, 0);

				EXEC SQL 
				DECLARE 
					crsListaConteudo2 CURSOR FOR	
				SELECT DISTINCT 
					LISTACONTEUDO.IDLISTACONTEUDO,
					LISTACONTEUDO.IDLISTA, 
					LISTACONTEUDO.NMCONTATO, 
					LISTACONTEUDO.NRTELEFONE 
				FROM
					CAMPANHA.LISTACONTEUDO LISTACONTEUDO, 
					CAMPANHA.LISTACANALCAMPANHA CANALCAMPANHA
				WHERE
					CANALCAMPANHA.IDLISTA = LISTACONTEUDO.IDLISTA
				AND
					CANALCAMPANHA.IDCANALCAMPANHA = :cidCanalCampanha
				AND
					LISTACONTEUDO.IDLISTACONTEUDO NOT IN
					(
						SELECT 
							ATENDIMENTOCAMPANHA1.IDLISTACONTEUDO                                                
						FROM 
							CAMPANHA.ATENDIMENTOCAMPANHA ATENDIMENTOCAMPANHA1
					);

				EXEC SQL OPEN crsListaConteudo2;

				for(;;) 
				{
					memset( &stGeral, 0, sizeof( stGeral ) );
					EXEC SQL 
					FETCH 
						crsListaConteudo2 
					INTO 
						:stGeral.idListaConteudo, 
						:stGeral.idLista, 
						:stGeral.nmContato, 
						:stGeral.stnrTelefone;

					xml->addItem("idListaConteudo",(char*)stGeral.idListaConteudo.arr);
					xml->addItem("idLista",(char*)stGeral.idLista.arr);
					xml->addItem("nrTelefone",(char *)stGeral.stnrTelefone.arr);
					xml->addItem("nmContato",(char *)stGeral.nmContato.arr);
					break;
				}	

				EXEC SQL CLOSE crsListaConteudo2;
				break;
			case 2:
				EXEC SQL DECLARE crsListaConteudo3 CURSOR FOR
				SELECT DISTINCT 
					CANALCAMPANHA2.IDCANALCAMPANHA,
					CAMPANHA2.SGCAMPANHA|| ' ' || SUBCAMPANHAHISTORICO2.SQVERSAO AS VERSAOCAMPANHA,
					CAMPANHA2.SGCAMPANHA,
					SUBCAMPANHAHISTORICO2.SQVERSAO, 
					CANAL2.NMCANAL||'-' ||UF.SGUF, 
					SUBCAMPANHAHISTORICO2.IDSUBCAMPANHAHISTORICO,
					LISTACONTEUDO.IDLISTACONTEUDO,
					NVL(SUBCAMPANHAFIXA2.NMSUBCAMPANHAFIXA,'Não Informado'),
					SUBCAMPANHAHISTORICO2.SQAPRESENTACAO
				FROM
					CAMPANHA.LISTACANALCAMPANHA LISTACANALCAMPANHA2,
					CAMPANHA.CANALCAMPANHA CANALCAMPANHA2,
					CAMPANHA.SUBCAMPANHAHISTORICO SUBCAMPANHAHISTORICO2,
					CAMPANHA.SUBCAMPANHAFIXA SUBCAMPANHAFIXA2,
					APOIO.CAMPANHA CAMPANHA2,
					CAMPANHA.CANALUFOPERADORA CANALUFOPERADORA2,
					APOIO.CANAL CANAL2,
					CAMPANHA.LISTACONTEUDO LISTACONTEUDO,
					APOIO.UF UF,
					CUSTOMER.UFOPERADORA UFOPERADORA
				WHERE  
					LISTACANALCAMPANHA2.idlista = LISTACONTEUDO.idLista
				AND
					CANALCAMPANHA2.idcanalcampanha = LISTACANALCAMPANHA2.idcanalcampanha
				AND
					SUBCAMPANHAHISTORICO2.idsubcampanhahistorico = CANALCAMPANHA2.idsubcampanhahistorico
				AND
					SUBCAMPANHAFIXA2.idsubcampanhafixa = SUBCAMPANHAHISTORICO2.idsubcampanhafixa
				AND
					CAMPANHA2.idcampanha = SUBCAMPANHAFIXA2.idcampanha
				AND
					CANALUFOPERADORA2.idcanalufoperadora = CANALCAMPANHA2.idcanalufoperadora
				AND
					CANAL2.idcanal = CANALUFOPERADORA2.idcanal
				AND
					CAMPANHA2.inativo=1
				AND
					CANALCAMPANHA2.INATIVO = 1
				AND
					LISTACANALCAMPANHA2.INATIVO=1
				AND
					SUBCAMPANHAHISTORICO2.idsubcampanhahistorico IN 
					(
						SELECT 
							idsubcampanhahistorico 
						FROM 
							campanha.motivocampanha
						WHERE 
							inativo=1 
					)
				AND
					LISTACONTEUDO.NRTELEFONE=:cnrTelefone
				AND
					LISTACONTEUDO.idlistaconteudo NOT IN
					(
						SELECT
							ATENDIMENTOCAMPANHA1.idlistaconteudo                                                
						FROM 
							campanha.atendimentocampanha ATENDIMENTOCAMPANHA1
					) 
				AND
					UFOPERADORA.IDUFOPERADORA = CANALUFOPERADORA2.IDUFOPERADORA
				AND
					UFOPERADORA.IDUF = UF.IDUF
				AND
					SYSDATE BETWEEN SUBCAMPANHAHISTORICO2.DTINICIO AND SUBCAMPANHAHISTORICO2.DTTERMINO
				AND
					SUBCAMPANHAHISTORICO2.inDisponibilidade=1
				AND
					ROWNUM <=1;
			
				EXEC SQL OPEN crsListaConteudo3;
				for(;;)
				{
					memset( &stGeral, 0, sizeof( stGeral ) );
					EXEC SQL FETCH crsListaConteudo3 INTO 
						:stGeral.idCanalCampanha, 
						:stGeral.VersaoCampanha, 
						:stGeral.sgCampanha, 
						:stGeral.sqVersao, 
						:stGeral.nmCanal,
						:stGeral.idSubCampanhaHistorico,
						:stGeral.idListaConteudo,
						:stGeral.nmSubCampanha,
						:stGeral.sqApresentacao;

					xml->createTag("campanhasRelacionadas");
					xml->addItem("idCanalCampanha",(char*)stGeral.idCanalCampanha.arr);
					xml->addItem("nmCanal",(char *)stGeral.nmCanal.arr);
					xml->addItem("VersaoCampanha",(char *)stGeral.VersaoCampanha.arr);
					xml->addItem("sgCampanha",(char *)stGeral.sgCampanha.arr);
					xml->addItem("sqVersao",(char*)stGeral.sqVersao.arr);
					xml->addItem("idSubCampanhaHistorico",(char*)stGeral.idSubCampanhaHistorico.arr);
					xml->addItem("idListaConteudo",(char*)stGeral.idListaConteudo.arr);
					xml->addItem("nmSubCampanha",(char *)stGeral.nmSubCampanha.arr);
					xml->addItem("sqApresentacao",(char*)stGeral.sqApresentacao.arr);
					xml->closeTag();
				}
				EXEC SQL OPEN crsListaConteudo3;
				break; //CASE 2 PAGINA INICIAL
			case 3:
				EXEC SQL 
				DECLARE 
					crsListaConteudo4 CURSOR FOR
				SELECT DISTINCT  
					CAMPANHA.SGCAMPANHA,
					SUBCAMPANHAFIXA.NMSUBCAMPANHAFIXA,
					SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO,
					SUBCAMPANHAHISTORICO.SQAPRESENTACAO
				FROM	
					CAMPANHA.CANALCAMPANHA CANALCAMPANHA,
					CAMPANHA.SUBCAMPANHAHISTORICO SUBCAMPANHAHISTORICO,
					CAMPANHA.SUBCAMPANHAFIXA SUBCAMPANHAFIXA,
                    CAMPANHA.MOTIVOCAMPANHA MOTIVOCAMPANHA,
					CAMPANHA.CANALUFOPERADORA CANALUFOPERADORA,
					APOIO.CAMPANHA CAMPANHA,
					APOIO.CANAL CANAL,
                    (
                        SELECT DISTINCT
                            LISTACANALCAMPANHA.IDCANALCAMPANHA
                        FROM
        					CAMPANHA.LISTACONTEUDO LISTACONTEUDO,
                            CAMPANHA.LISTA LISTA,
                            CAMPANHA.LISTACANALCAMPANHA LISTACANALCAMPANHA
                        WHERE
        				    LISTACONTEUDO.IDLISTACONTEUDO NOT IN
            				(	
                                SELECT DISTINCT 
                                    IDLISTACONTEUDO                                                
            				    FROM 
                                    CAMPANHA.ATENDIMENTOCAMPANHA
            				)
        				AND 
                            LISTACONTEUDO.IDLISTA = LISTA.IDLISTA
                        AND
                            LISTA.IDLISTA = LISTACANALCAMPANHA.IDLISTA
        				AND 
                            LISTACANALCAMPANHA.INATIVO = 1
                    )ATENDIMENTOCAMPANHALISTA
				WHERE  
                    ATENDIMENTOCAMPANHALISTA.IDCANALCAMPANHA = CANALCAMPANHA.IDCANALCAMPANHA
				AND 
                    CANALCAMPANHA.IDSUBCAMPANHAHISTORICO = SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO
				AND 
                    SUBCAMPANHAHISTORICO.IDSUBCAMPANHAFIXA = SUBCAMPANHAFIXA.IDSUBCAMPANHAFIXA
				AND 
                    SUBCAMPANHAFIXA.IDCAMPANHA = CAMPANHA.IDCAMPANHA
				AND 
                    CANALUFOPERADORA.IDCANALUFOPERADORA = CANALCAMPANHA.IDCANALUFOPERADORA
				AND 
                    CANAL.IDCANAL = CANALUFOPERADORA.IDCANAL
				AND 
                    CAMPANHA.INATIVO = 1
				AND	
                    CANALCAMPANHA.INATIVO = 1
				AND 
                    SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO = MOTIVOCAMPANHA.IDSUBCAMPANHAHISTORICO
				AND 
                    MOTIVOCAMPANHA.INATIVO = 1
				AND 
                    SYSDATE BETWEEN SUBCAMPANHAHISTORICO.DTINICIO AND SUBCAMPANHAHISTORICO.DTTERMINO
				AND	
                    SUBCAMPANHAHISTORICO.INDISPONIBILIDADE = 1
				ORDER BY 
					SUBCAMPANHAHISTORICO.SQAPRESENTACAO;

				EXEC SQL OPEN crsListaConteudo4;
		
				for(;;) 
				{
					memset( &stGeral, 0, sizeof( stGeral ) );
					EXEC SQL FETCH crsListaConteudo4 INTO
						:stGeral.sgCampanha, 
						:stGeral.nmSubCampanha,
						:stGeral.idSubCampanhaHistorico,
						:stGeral.sqApresentacao;

					xml->createTag("campanhasRelacionadas");
					xml->addItem("sgCampanha",(char *)stGeral.sgCampanha.arr);
					xml->addItem("nmSubCampanha",(char *)stGeral.nmSubCampanha.arr);
					xml->addItem("idSubCampanhaHistorico",(char*)stGeral.idSubCampanhaHistorico.arr); 
					xml->addItem("sqApresentacao",(char*)stGeral.sqApresentacao.arr);

					xml->closeTag();
				}
				EXEC SQL CLOSE crsListaConteudo4;
				break;
		}
		return 1;
	}
	catch(...)
	{
		throw;
	}
}
