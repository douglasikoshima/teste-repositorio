/**
 * 
 * @modulo  ins_listaconteudo
 * @usecase insereListaCampanha
 * @author  Mario
 * @version $Revision: 1.1 $
 * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:33:35 $
 **/

#include "../../negocio/cmputil/include/campanha.hpp"
EXEC SQL INCLUDE "ins_listaconteudo.hpp";

int ins_listaconteudo( int pidUsuario, int pidLista, int pnrTelefone, char* pnmContato, char* pnmDocumento, int* pidListaConteudo) throw(TuxException, TuxBasicOraException)
{
	int ret = -1;
	try
	{
	
	//ulog_int(pidUsuario);
	//ulog_int(pidLista);
	//ulog_int(pnrTelefone);
	//ulog_str(pnmContato);
	//ulog_str(pnmDocumento);

	// Prepara as variaveis para interface com Oracle
	EXEC SQL BEGIN DECLARE SECTION;
		int		idListaConteudo;
		int     idLista;
		int		nrTelefone;
		VARCHAR nmContato[20];
		VARCHAR nmDocumento[20];
        int     idUsuarioAlteracao;
		//VARCHAR dtUltimaAlteracaoOut[10];

	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

	//
	// Repassa os dados para as variaveis Oracles
	idLista = pidLista;
	nrTelefone = pnrTelefone;
	strToOra(nmContato,pnmContato);
	if ( pnmDocumento != NULL )
	{
		strToOra(nmDocumento,pnmDocumento);
	}
	else
	{
		nmDocumento.len = 0;
		nmDocumento.arr[0]=0;
	}
	idUsuarioAlteracao = pidUsuario;

	EXEC SQL
		SELECT campanha.listaconteudosq.NEXTVAL
		INTO :idListaConteudo
		FROM DUAL;

	if (sqlca.sqlcode)
	{
		throw new TuxBasicOraException(sqlca.sqlcode);
	}


	// Insert linhaConteudo
	EXEC SQL INSERT INTO campanha.listaConteudo (
						idListaConteudo,
						idLista,
						nrTelefone,
						nmContato,  				
                        idUsuarioalteracao,
                        dtUltimaAlteracao
					)
					VALUES(
							:idListaConteudo,
							:idLista,
							:nrTelefone,
							:nmContato,
                            :idUsuarioAlteracao,
                            sysdate
					);
		if (sqlca.sqlcode)
		{
			//EXEC SQL WHENEVER SQLERROR DO CONTINUE;
			throw new TuxBasicSvcException(ERR_CAMPANHA_INS_LISTACONTEUDO_CD,ERR_CAMPANHA_INS_LISTACONTEUDO_MSG);
		}
		else
		{
			//ulog( "inserido telefone %d na lista %d", pnrTelefone, pidLista);
			*pidListaConteudo = idListaConteudo;
			ret = 1;
		}
	}
	catch(TuxException& te1 )
	{
		printf("tuxException %s,%s", te1.getCode(), te1.getMessage());
		throw;
	}
	catch(TuxException* te3 )
	{
		printf("tuxException*  %s,%s", te3->getCode(), te3->getMessage());
		throw;
	}

	return ret;
}
