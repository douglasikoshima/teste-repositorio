//
// $Id: get_statuscampanha.pcpp,v 1.1 2009/07/31 15:33:47 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int get_listatipostatuscampanha(char * usuario, DOMNode*dnode,XMLGen*xml)
{
   
  char parm[255];
  int control=0;
  try
  {   
     EXEC SQL BEGIN DECLARE SECTION;
       int idtipostatusCampanha;
       VARCHAR sgtipostatusCampanha[255];
       VARCHAR dstipostatusCampanha[255];
       int inAtivo;
       int idPessoaUsuarioAlteracao;
       /*
        processo

       0-campanha-configuração         
       1-campanha-atendimento
        
       */
       int processo;
       int idSubCampanhaHistorico;


     EXEC SQL END DECLARE SECTION;
     EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
     EXEC SQL WHENEVER NOT FOUND DO break;

     inAtivo = 1;

     // Pegando id do usuario
     idPessoaUsuarioAlteracao = get_idUsuario(usuario);
    
     get_tag(parm, dnode, "processo", 0, 0);
     
     processo = atoi(parm); 

     get_tag(parm, dnode, "idSubCampanhaHistorico", 0, -1);
     
     idSubCampanhaHistorico = atoi(parm); 


     switch(processo)  
     {
       case 0: 
 
        EXEC SQL DECLARE crstipostatusCampanha CURSOR FOR
           SELECT DISTINCT 
             idtipostatusCampanha,
             sgtipostatusCampanha,
             dstipostatusCampanha
           FROM
             apoio.tipostatuscampanha;
        break;

       case 1:
        control=1; 
        EXEC SQL DECLARE crstipostatusCampanha1 CURSOR FOR
          SELECT DISTINCT
             idtipostatusCampanha,
             sgtipostatusCampanha,
             dstipostatusCampanha
          FROM 
             campanha.TIPOSTATUSCAMPANHAV01
          WHERE
             idsubcampanhahistorico = :idSubCampanhaHistorico;
        break;
     }
    
	if(control)  EXEC SQL OPEN crstipostatusCampanha1;
        else EXEC SQL OPEN crstipostatusCampanha;

     xml->addItem("nome","TIPOSTATUSCAMPANHA");
     for(;;) 
     {
       if(control)EXEC SQL FETCH crstipostatusCampanha1 INTO :idtipostatusCampanha,:sgtipostatusCampanha,:dstipostatusCampanha;
       else EXEC SQL FETCH crstipostatusCampanha INTO :idtipostatusCampanha,:sgtipostatusCampanha,:dstipostatusCampanha;
       endOraStr(sgtipostatusCampanha);
       endOraStr(dstipostatusCampanha);
       xml->createTag("tns:ApoioVO");
       xml->addItem("codigo",idtipostatusCampanha);
       xml->addItem("sigla",(char *)sgtipostatusCampanha.arr);
       xml->addItem("descricao",(char *)dstipostatusCampanha.arr);
       xml->addItem("peso","null");
       xml->addItem("variante","null");
       xml->closeTag();
     }
  
    if(control) EXEC SQL CLOSE crstipostatusCampanha1;
    else   EXEC SQL CLOSE crstipostatusCampanha;
   }
   catch( ... )
   {
      throw;
   }
  
  return 1;
}
