//
// $Id: del_paramcmp.pcpp,v 1.1 2009/07/31 15:34:31 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int del_paramcmp(char * usuario, DOMNode*dnode, XMLGen*xml)
{
	char parm[256];

	EXEC SQL BEGIN DECLARE SECTION;
            int idGotcha = 0;
            int idCanalCampanha = 0;
            int idSubCampanhaHistorico = 0;
            int nrTempoMedioContato = 0;
            int nrMetaDiariaCampanha = 0;
            int nrMetaDiariaOperador = 0;
            int nrContatoEfetivoOperador = 0;
            int nrContatoEfetivoCampanha = 0;
            int nrContatoSucessoOperador = 0;
            int nrContatoSucessoCampanha = 0;
            int nrPublicoTotal = 0;
            int nrAderiuOperador = 0;
            int nrAderiuCampanha = 0;
            int nrNaoAderiuOperador = 0;
            int nrNaoAderiuCampanha = 0;
	    int idPessoaUsuarioAlteracao;
            int inAtivo;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "idSubCampanha", 0, 0);
        idSubCampanhaHistorico = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "idCanalCampanha", 0, -1);
        idCanalCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrTempoMedioContato", 0, 0);
        nrTempoMedioContato = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrMetaDiariaCampanha", 0, -1);
        nrMetaDiariaCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrMetaDiariaOperador", 0, 0);
        nrMetaDiariaOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrContatoEfetivoOperador", 0, -1);
        nrContatoEfetivoOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrContatoEfetivoCampanha", 0, 0);
        nrContatoEfetivoCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrContatoSucessoOperador", 0, -1);
        nrContatoSucessoOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrContatoSucessoCampanha", 0, 0);
        nrContatoSucessoCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrPublicoTotal", 0, -1);
        nrPublicoTotal = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrAderiuOperador", 0, 0);
        nrAderiuOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrAderiuCampanha", 0, -1);
        nrAderiuCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrNaoAderiuOperador", 0, 0);
        nrNaoAderiuOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrNaoAderiuCampanha", 0, -1);
        nrNaoAderiuCampanha = atoi(parm);

        // Pegando id do usuario
        idPessoaUsuarioAlteracao = get_idUsuario(usuario);

        inAtivo = 0;

        /* Verifica se existe o item a adcionar */
        EXEC SQL DECLARE crsParamCmp CURSOR FOR
                SELECT PARAMETRIZACAOCAMPANHA.idcanalcampanha
                FROM campanha.Parametrizacaocampanha PARAMETRIZACAOCAMPANHA
                WHERE  PARAMETRIZACAOCAMPANHA.idcanalcampanha = :idCanalCampanha;

        EXEC SQL OPEN crsParamCmp;

        for(;;)
        {
                EXEC SQL FETCH crsParamCmp INTO :idGotcha;
                break;
        }

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);

//	inAtivo = 1;

        /* Update linha */
	EXEC SQL UPDATE campanha.Parametrizacaocampanha
	    SET idcanalcampanha = :idCanalCampanha,
                nrtempomediocontato = :nrTempoMedioContato,
                nrmetadiariacampanha = :nrMetaDiariaCampanha,
                nrmetadiariaoperador = :nrMetaDiariaOperador,
                nrcontatoefetivooperador = :nrContatoEfetivoOperador,
                nrcontatoefetivocampanha = :nrContatoEfetivoCampanha,
                nrcontatosucessooperador = :nrContatoSucessoOperador,
                nrcontatosucessocampanha = :nrContatoSucessoCampanha,
                nrpublicototal = :nrPublicoTotal,
                nraderiuoperador = :nrAderiuOperador,
                nraderiucampanha = :nrAderiuCampanha,
                nrnaoaderiuoperador = :nrNaoAderiuOperador, 
                nrnaoaderiucampanha = :nrNaoAderiuCampanha,
                idusuarioalteracao = :idPessoaUsuarioAlteracao,
                dtultimaalteracao = sysdate,
                inativo = :inAtivo
	    WHERE idcanalcampanha = :idCanalCampanha;

	if (sqlca.sqlcode)
	{
		throw new TuxBasicSvcException("00E1000","UPDATE apoio.campanha ");
	}

	/* update OK */
	xml->createTag("DELPARAMCMP");
		xml->addItem("UPDATE",sqlca.sqlerrd[2]);
	xml->closeTag();

	return 1;
}
