#undef SQLCA
#define SQLCA_NONE

#include "../../negocio/cmputil/include/campanha.hpp"

int InsereAgenda( DOMNode *XMLIn , XMLGen *XMLOut )
{
    char sBuf[ 256 ];
    struct sqlca sqlca;
    TuxHelper tuxHelper;


    EXEC SQL BEGIN DECLARE SECTION;
        int     idAgenda;
        int     idPessoaUsuario;
        VARCHAR dtAgendamento[ 50 ];
        int     idAtendimentoCampanha;
        VARCHAR nrTelefoneContato[ 256 ];
        VARCHAR dsObservacaoAgenda[ 501 ];
        VARCHAR nmPessoaContato[ 101 ];
        int     inAgendaCumprida;
    EXEC SQL END DECLARE SECTION;

    sqlca.sqlcode=0;
    
    if ( tuxHelper.walkTree( XMLIn,"idPessoaUsuario",0 ) )
       idPessoaUsuario = atoi( tuxHelper.walkTree(XMLIn,"idPessoaUsuario",0) );

    if ( tuxHelper.walkTree( XMLIn,"dtAgendamento",0 ) )
    {
       sprintf( (char *)dtAgendamento.arr , "%s" , tuxHelper.walkTree(XMLIn,"dtAgendamento",0) );
       dtAgendamento.len = strlen( (char *)dtAgendamento.arr );
    }

    if ( tuxHelper.walkTree( XMLIn,"idAtendimentoCampanha",0 ) )
       idAtendimentoCampanha = atoi( tuxHelper.walkTree(XMLIn,"idAtendimentoCampanha",0) );

    if ( tuxHelper.walkTree( XMLIn,"nrTelefoneContato",0 ) )
    {
       sprintf( (char *)nrTelefoneContato.arr , "%s" , tuxHelper.walkTree(XMLIn,"nrTelefoneContato",0) );
       nrTelefoneContato.len = strlen( (char *)nrTelefoneContato.arr );
    }

    if ( tuxHelper.walkTree( XMLIn,"dsObservacaoAgenda",0 ) )
    {
       sprintf( (char *)dsObservacaoAgenda.arr , "%s" , tuxHelper.walkTree(XMLIn,"dsObservacaoAgenda",0) );
       dsObservacaoAgenda.len = strlen( (char *)dsObservacaoAgenda.arr );
    }

    if ( tuxHelper.walkTree( XMLIn,"nmPessoaContato",0 ) )
    {
       sprintf( (char *)nmPessoaContato.arr , "%s" , tuxHelper.walkTree(XMLIn,"nmPessoaContato",0) );
       nmPessoaContato.len = strlen( (char *)nmPessoaContato.arr );
    }

    if ( tuxHelper.walkTree( XMLIn,"inAgendaCumprida",0 ) )
       inAgendaCumprida = atoi( tuxHelper.walkTree(XMLIn,"inAgendaCumprida",0) );

    EXEC SQL WHENEVER SQLERROR GOTO UndefinedError;

    EXEC SQL SELECT campanha.AgendaSQ.NextVal INTO :idAgenda FROM DUAL;
    
    EXEC SQL INSERT INTO campanha.agenda
             (
                idAgenda , 
                dtAgendamento , 
                nrTelefoneContato , 
                dsObservacaoAgenda , 
                nmPessoaContato , 
                inAgendaCumprida ,
                idPessoaUsuario , 
                idAtendimentoCampanha 
             )
    VALUES
             (
                :idAgenda ,
                TO_DATE(:dtAgendamento,'DD/MM/YYYY HH24:MI') ,
                :nrTelefoneContato ,
                :dsObservacaoAgenda ,
                :nmPessoaContato ,
                :inAgendaCumprida ,
                :idPessoaUsuario ,
                :idAtendimentoCampanha 
             );


    if( sqlca.sqlcode )
        throw new TuxBasicOraException( sqlca.sqlcode , sqlca.sqlerrm.sqlerrmc , sqlca.sqlerrm.sqlerrml );

	XMLOut->createTag("agendamentoCampanhaVO");
        sprintf( sBuf,"%d",idAgenda );
	    XMLOut->addItem("idAgenda",sBuf);
	    XMLOut->addItem("INSERT","1");
	XMLOut->closeTag();

    return 1;


UndefinedError:
        throw new TuxBasicOraException( sqlca.sqlcode , sqlca.sqlerrm.sqlerrmc , sqlca.sqlerrm.sqlerrml );

}

