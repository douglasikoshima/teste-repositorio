//
// $Id: get_campanhasub.pcpp,v 1.1 2009/07/31 15:34:48 a5110702 Exp $
//
/*===================================================================================
Changes:
14/08/2004	CVA	idSubCampanha change to idSubCampanhaFixa, in order to recover
				subcampanhas instead of campanhas/
===================================================================================*/

#include "../../negocio/cmputil/include/campanha.hpp"
#define STRLENNULL( y ) ( y == NULL ? 0 : strlen( y )  )

int get_campanhasub(char * usuario,DOMNode*dnode,XMLGen*xml)
{
    char parm[255+1];  
    EXEC SQL BEGIN DECLARE SECTION;
    	struct
    	{
        	VARCHAR idSubCampanhaFixa[21+1];
        	VARCHAR nmSubCampanhaFixa[255+1];
       	}stGeral;
    	struct
    	{
        	short idSubCampanhaFixa;
        	short nmSubCampanhaFixa;
       	}stIndicator;
       	char  idSubCampanhaFixa[21+1];
        char  idCampanha[21+1];
        int   operacao;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
    EXEC SQL WHENEVER NOT FOUND DO break;
    
    memset( parm, 0, sizeof( parm ) );

	/*
		0 - SubCampanhaFixa
		1 - Versoes de SubCampanhaHistorico
	*/
	get_tag(parm, dnode, "operacao", 0, 0);
	operacao = atoi( parm );
	
	switch( operacao )
	{
		case 0:
    		memset( idCampanha, 0, sizeof( idCampanha ) );
		    //  Obtendo dados do xml
			get_tag(idCampanha, dnode, "idCampanha", 0, -1);

			// Retorna apenas sub campanhas válidas(inAtivo = 1)
		    EXEC SQL 
		    DECLARE 
		    	CursorSubCampanhaFixa CURSOR FOR
		    SELECT
		       	SUBCAMPANHAFIXA.IDSUBCAMPANHAFIXA,
		        SUBCAMPANHAFIXA.NMSUBCAMPANHAFIXA
		  	FROM
		  		CAMPANHA.SUBCAMPANHAFIXA SUBCAMPANHAFIXA
		   	WHERE
		   		SUBCAMPANHAFIXA.IDCAMPANHA = :idCampanha    
				AND SUBCAMPANHAFIXA.INATIVO = 1     
		    ORDER BY
		    	UPPER(SUBCAMPANHAFIXA.NMSUBCAMPANHAFIXA);
		
		    EXEC SQL OPEN CursorSubCampanhaFixa;
		
		    xml->addItem("nome","CAMPANHASUB");
		    for(;;) 
		    {
				memset( &stGeral, 0, sizeof( stGeral ) );
		        EXEC SQL 
		        FETCH 
		        	CursorSubCampanhaFixa
		        INTO 
					:stGeral.idSubCampanhaFixa:stIndicator.idSubCampanhaFixa,
					:stGeral.nmSubCampanhaFixa:stIndicator.nmSubCampanhaFixa;
		
		        xml->createTag("tns:ApoioVO");
		        xml->addItem("codigo",(char*)stGeral.idSubCampanhaFixa.arr);
		        xml->addItem("descricao",(char*)stGeral.nmSubCampanhaFixa.arr);
				xml->addItem("nmSubCampanha", (char*)stGeral.nmSubCampanhaFixa.arr);
		        xml->addItem("sigla", "" );
		        xml->addItem("peso","");
				xml->addItem("variante", "" );
		        xml->closeTag();
		
		    }  
		    EXEC SQL CLOSE CursorSubCampanhaFixa;
			break;

		case 1:
    		memset( idSubCampanhaFixa, 0, sizeof( idSubCampanhaFixa ) );
		    //  Obtendo dados do xml
			// Retorna apenas sub campanhas validas (inAtivo = 1)
			get_tag(idSubCampanhaFixa, dnode, "idSubCampanhaFixa", 0, -1);
		    EXEC SQL 
		    DECLARE 
		    	CursorSubCampanhaHistorico CURSOR FOR
		    SELECT
		       	SUBCAMPANHAHISTORICO.IDSUBCAMPANHAHISTORICO,
		        SUBCAMPANHAHISTORICO.SQVERSAO
		  	FROM
		  		CAMPANHA.SUBCAMPANHAHISTORICO SUBCAMPANHAHISTORICO
		   	WHERE
		   		SUBCAMPANHAHISTORICO.IDSUBCAMPANHAFIXA = :idSubCampanhaFixa
		   		AND SUBCAMPANHAHISTORICO.INATIVO = 1
		    ORDER BY
		    	SUBCAMPANHAHISTORICO.SQVERSAO DESC;
		
		    EXEC SQL OPEN CursorSubCampanhaHistorico;
		
		    xml->addItem("nome","CAMPANHASUB");
		    for(;;) 
		    {
				memset( &stGeral, 0, sizeof( stGeral ) );
		        EXEC SQL 
		        FETCH 
		        	CursorSubCampanhaHistorico
		        INTO 
					:stGeral.idSubCampanhaFixa:stIndicator.idSubCampanhaFixa,
					:stGeral.nmSubCampanhaFixa:stIndicator.nmSubCampanhaFixa;
		
		        xml->createTag("tns:ApoioVO");
		        xml->addItem("codigo",(char*)stGeral.idSubCampanhaFixa.arr);
		        xml->addItem("descricao",(char*)stGeral.nmSubCampanhaFixa.arr);
		        xml->addItem("sigla", "" );
		        xml->addItem("peso","");
				xml->addItem("variante", "" );
				xml->addItem("nmSubCampanha", "");
		        xml->closeTag();
		
		    }  
		    EXEC SQL CLOSE CursorSubCampanhaHistorico;
			break;
		
	}
    return 1;
}

