//
// $Id: get_motivo.pcpp,v 1.1 2009/07/31 15:35:02 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"
#define STRLENNULL( y ) ( y == NULL ? 0 : strlen( y )  )

int get_motivo(char * usuario, DOMNode*dnode,XMLGen*xml)
{
	char parm[256];
	int controle=0;
	
	EXEC SQL BEGIN DECLARE SECTION;
	struct
	{
	    VARCHAR idTipoMotivoCampanha[21+1];
	    char    idSubCampanhaHistorico[21+1];
	    char    idTipoStatusCampanha[21+1];
	    VARCHAR sgTipoMotivoCampanha[255+1];
	    VARCHAR dsTipoMotivoCampanha[255+1];
	}stGeral;
    char* idPessoaUsuarioAlteracao = usuario;
	int inNegative;
	int processo;
	/*
	processo
		0 - campanha-configuração
		1 - campanha-atendimento 
	*/
	EXEC SQL END DECLARE SECTION;

	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
	EXEC SQL WHENEVER NOT FOUND DO break;
	
	memset( &stGeral, 0, sizeof( stGeral ) ) ;

	//  Obtendo dados do xml
	get_tag(stGeral.idSubCampanhaHistorico, dnode, "idSubCampanha", 0, 0);
	get_tag(stGeral.idTipoStatusCampanha, dnode, "idTipoStatusCampanha", 0, -1);

	get_tag(parm, dnode, "inNegative", 0, -1);
	inNegative = atoi(parm); 

	get_tag(parm, dnode, "processo", 0, 0);
	processo = atoi(parm); 
	
	switch(processo)
	{
		case 0:
		
			EXEC SQL 
			DECLARE 
				crsMotivo2 CURSOR FOR
			SELECT 
				TO_CHAR(TIPOMOTIVOCAMPANHA.IDTIPOMOTIVOCAMPANHA),
			    TIPOMOTIVOCAMPANHA.SGTIPOMOTIVOCAMPANHA,
				TIPOMOTIVOCAMPANHA.DSTIPOMOTIVOCAMPANHA
			FROM   
				APOIO.TIPOMOTIVOCAMPANHA TIPOMOTIVOCAMPANHA
			WHERE  
				TIPOMOTIVOCAMPANHA.INATIVO = 1
			ORDER BY 
				UPPER(TRIM(TIPOMOTIVOCAMPANHA.SGTIPOMOTIVOCAMPANHA));

			EXEC SQL OPEN crsMotivo2;

			xml->addItem("nome","MOTIVO");
			for(;;) 
			{
				EXEC SQL 
				FETCH 
					crsMotivo2 
				INTO 
					:stGeral.idTipoMotivoCampanha,
					:stGeral.sgTipoMotivoCampanha,
					:stGeral.dsTipoMotivoCampanha;

				endOraStr(stGeral.idTipoMotivoCampanha);
				endOraStr(stGeral.sgTipoMotivoCampanha);
				endOraStr(stGeral.dsTipoMotivoCampanha);
				xml->createTag("tns:ApoioVO");
				xml->addItem("codigo",(char*)stGeral.idTipoMotivoCampanha.arr);
				xml->addItem("sigla",(char*)stGeral.sgTipoMotivoCampanha.arr);
				xml->addItem("descricao",(char*)stGeral.dsTipoMotivoCampanha.arr);
				xml->addItem("peso","null");
				xml->addItem("variante","null");
				xml->closeTag();
			}
	
			EXEC SQL CLOSE crsMotivo2;
		
		break;
		
		case 1:
			controle=1;
			EXEC SQL 
			DECLARE 
				crsMotivo21 CURSOR FOR
			SELECT
				TO_CHAR(IDTIPOMOTIVOCAMPANHA),
				SGTIPOMOTIVOCAMPANHA, 
				DSTIPOMOTIVOCAMPANHA
			FROM
				CAMPANHA.TIPOMOTIVOCAMPANHAV01
			WHERE
				IDTIPOSTATUSCAMPANHA = :stGeral.idTipoStatusCampanha
			AND 
				IDSUBCAMPANHAHISTORICO = :stGeral.idSubCampanhaHistorico
			ORDER BY
				UPPER(TRIM(SGTIPOMOTIVOCAMPANHA));

      		EXEC SQL OPEN crsMotivo21;

			xml->addItem("nome","MOTIVO");
			for(;;)
			{
				EXEC SQL 
				FETCH 
					crsMotivo21 
				INTO 
					:stGeral.idTipoMotivoCampanha,
					:stGeral.sgTipoMotivoCampanha,
					:stGeral.dsTipoMotivoCampanha;
				
				endOraStr(stGeral.idTipoMotivoCampanha);
				endOraStr(stGeral.sgTipoMotivoCampanha);
				endOraStr(stGeral.dsTipoMotivoCampanha);
				xml->createTag("tns:ApoioVO");
				xml->addItem("codigo",(char*)stGeral.idTipoMotivoCampanha.arr);
				xml->addItem("sigla",(char*)stGeral.sgTipoMotivoCampanha.arr);
				xml->addItem("descricao",(char*)stGeral.dsTipoMotivoCampanha.arr);
				// xml->addItem("peso","null");
				xml->addItem("variante",0);
				xml->closeTag();
			}
 
      		EXEC SQL CLOSE crsMotivo21;
		break;

		case 2:
			controle=1;
			EXEC SQL 
			DECLARE 
				crsMotivo22 CURSOR FOR
			SELECT DISTINCT
				TO_CHAR(IDTIPOMOTIVOCAMPANHA),
				SGTIPOMOTIVOCAMPANHA, 
				DSTIPOMOTIVOCAMPANHA
			FROM
				CAMPANHA.TIPOMOTIVOCAMPANHAV01
			WHERE
				IDSUBCAMPANHAHISTORICO = :stGeral.idSubCampanhaHistorico
			ORDER BY
				UPPER(TRIM(SGTIPOMOTIVOCAMPANHA));

      		EXEC SQL OPEN crsMotivo22;

			xml->addItem("nome","MOTIVO");
			for(;;)
			{
				EXEC SQL 
				FETCH 
					crsMotivo22 
				INTO 
					:stGeral.idTipoMotivoCampanha,
					:stGeral.sgTipoMotivoCampanha,
					:stGeral.dsTipoMotivoCampanha;

				endOraStr(stGeral.idTipoMotivoCampanha);
				endOraStr(stGeral.sgTipoMotivoCampanha);
				endOraStr(stGeral.dsTipoMotivoCampanha);
				xml->createTag("tns:ApoioVO");
				xml->addItem("codigo",(char*)stGeral.idTipoMotivoCampanha.arr);
				xml->addItem("sigla",(char*)stGeral.sgTipoMotivoCampanha.arr);
				xml->addItem("descricao",(char*)stGeral.dsTipoMotivoCampanha.arr);
				// xml->addItem("peso","null");
				xml->addItem("variante",0);
				xml->closeTag();
			}

      		EXEC SQL CLOSE crsMotivo22;
		break;
	}//switch(processo)

  return 1;
}
