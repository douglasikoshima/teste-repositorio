//
// $Id: ins_canal.pcpp,v 1.1 2009/07/31 15:34:22 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int ins_canal(char * usuario, DOMNode*dnode,XMLGen*xml)
{
	char parm[2000];

	EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR sgCanal[2000];
		VARCHAR dsCanal[2000];
		int     idPessoaUsuarioAlteracao;
		int	inAtivo;
                int     idCanal = 0;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "sgCanal", 0, 0);
	strToOra(sgCanal,parm);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "dsCanal", 0, 0);
	strToOra(dsCanal,parm);

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);

	inAtivo = 1;

        /* Verifica se existe o item a adcionar */
        EXEC SQL DECLARE crsCanal CURSOR FOR
                SELECT CANAL.idcanal
                FROM apoio.canal CANAL
                WHERE  CANAL.sgcanal = :sgCanal;

        EXEC SQL OPEN crsCanal;

        for(;;)
        {
                EXEC SQL FETCH crsCanal INTO :idCanal;
		break;
        }

        EXEC SQL CLOSE crsCanal;

	if(idCanal == 0)
        {
		/* Insert linha */
		EXEC SQL INSERT INTO apoio.canal(idcanal,
		   				sgcanal,  				
						dscanal,
                                                idpessoausuarioinclusao,
                                                idpessoausuarioalteracao,
                                                dtinclusao,
                                                dtalteracao,
                                                inativo)
					 VALUES(apoio.canalsq.nextval,
						:sgCanal,
						:dsCanal,
                                                :idPessoaUsuarioAlteracao,
                                                :idPessoaUsuarioAlteracao,
                                                sysdate,
                                                sysdate,
                                                :inAtivo);

		if (sqlca.sqlcode)
		{
			throw new TuxBasicSvcException("00E1000","INSERT INTO apoio.canal");
		}

		/* insert OK */
		xml->createTag("CANAL");
		xml->addItem("INSERT",1);
		xml->closeTag();
        }

        if(idCanal > 0)
        {
                EXEC SQL UPDATE apoio.canal
                    SET inativo = :inAtivo,
                        dscanal = :dsCanal,
                        idPessoaUsuarioAlteracao = :idPessoaUsuarioAlteracao,
                        dtAlteracao = sysdate
                    WHERE idcanal = :idCanal;

                if (sqlca.sqlcode)
                {
                        throw new TuxBasicSvcException("00E1000","UPDATE apoio.canal ");
                }

                /* insert modificado para update OK */
                xml->createTag("CANAL");
                xml->addItem("ID",idCanal);
                xml->addItem("UPDATE",1);
                xml->closeTag();
        }

	return 1;
}


