//
// $Id: upd_submotivo.pcpp,v 1.1 2009/07/31 15:34:34 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int upd_submotivo(char * usuario, DOMNode*dnode, XMLGen*xml)
{
	char parm[256];

	EXEC SQL BEGIN DECLARE SECTION;
		int	idSubMotivo = 0;
		int	idTipoSubMotivoCampanha = 0;
		VARCHAR sgSubMotivo[256];
		VARCHAR nmSubMotivo[256];
		int     idPessoaUsuarioAlteracao;
	        int     inAtivo;
        EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "idSubMotivo", 0, 0);
	idSubMotivo = atoi(parm);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "sgSubMotivo", 0, 0);
	strToOra(sgSubMotivo,parm);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "nmSubMotivo", 0, 0);
	strToOra(nmSubMotivo,parm);

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);

        inAtivo = 1;

        /* Verifica se existe o item a adcionar */
        EXEC SQL DECLARE crsSubMotivo CURSOR FOR
                SELECT SUBMOTIVO.idtiposubmotivocampanha
                FROM apoio.tiposubmotivocampanha SUBMOTIVO
                WHERE  (SUBMOTIVO.sgtiposubmotivocampanha = :sgSubMotivo
                OR     SUBMOTIVO.DSTIPOSUBMOTIVOCAMPANHA = :nmSubMotivo)
				and inativo=0;
        EXEC SQL OPEN crsSubMotivo;

        for(;;)
        {
                EXEC SQL FETCH crsSubMotivo INTO :idTipoSubMotivoCampanha;
                break;
        }

        EXEC SQL CLOSE crsSubMotivo;


		if(idTipoSubMotivoCampanha > 0)
        {

	    /* Update linha */
	    EXEC SQL UPDATE apoio.tiposubmotivocampanha
	        SET   dstiposubmotivocampanha = :nmSubMotivo || SYSDATE|| :idTipoSubMotivoCampanha,
				  sgtiposubmotivocampanha = :sgSubMotivo || SYSDATE|| :idTipoSubMotivoCampanha,	
                      indisponibilidade = 1,
                      idpessoausuarioalteracao = :idPessoaUsuarioAlteracao,
                      dtalteracao = sysdate,
					  IDUSUARIOALTERACAO=:idPessoaUsuarioAlteracao,
					  DTULTIMAALTERACAO=SYSDATE
					  WHERE idtiposubmotivocampanha = :idTipoSubMotivoCampanha;
	
		}

	    /* Update linha */
	    EXEC SQL UPDATE apoio.tiposubmotivocampanha
	        SET    sgtiposubmotivocampanha = :sgSubMotivo,
					dstiposubmotivocampanha = :nmSubMotivo,
                      indisponibilidade = :inAtivo,
                      idpessoausuarioalteracao = :idPessoaUsuarioAlteracao,
                      dtalteracao = sysdate,
					  IDUSUARIOALTERACAO=:idPessoaUsuarioAlteracao,
					  DTULTIMAALTERACAO=SYSDATE
	        WHERE idtiposubmotivocampanha = :idSubMotivo;
  
	  

		
	/* update OK */
	xml->createTag("SUBMOTIVO");
		xml->addItem("UPDATE",sqlca.sqlerrd[2]);
	xml->closeTag();

	return 1;
}
