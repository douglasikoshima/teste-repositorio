//
// $Id: get_grupomotivocamp.pcpp,v 1.1 2009/07/31 15:34:29 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int get_grupomotivocamp(char * usuario, DOMNode*dnode,XMLGen*xml)
{
  char parm[256];
  try
  { 
  EXEC SQL BEGIN DECLARE SECTION;
    int     idGrupo = 0;
    int     idSubCampanhaHistorico = 0;
    int     idSubCampanhaFixa = 0;
    VARCHAR nmGrupo[255];
    int     inAtivo;
    int     inNegative = 0;
    int     idPessoaUsuarioAlteracao;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
  EXEC SQL WHENEVER NOT FOUND DO break;

  //  Obtendo dados do xml
  get_tag(parm, dnode, "idSubCampanha", 0, -1);
  idSubCampanhaHistorico = atoi(parm);

  //  Obtendo dados do xml
  get_tag(parm, dnode, "idSubCampanhaFixa", 0, -1);
  idSubCampanhaFixa = atoi(parm);

  //  Obtendo dados do xml
  get_tag(parm, dnode, "inNegative", 0, -1);
  inNegative = atoi(parm);
  
  inAtivo = 1;

  // Pegando id do usuario
  idPessoaUsuarioAlteracao = get_idUsuario(usuario);

  if(inNegative > 0)
  {
      if(idSubCampanhaFixa > 0)
      {
          // ulog("Passei Neg > 0 Fixa > 0");
          EXEC SQL DECLARE crsGrpMotivo6 CURSOR FOR
            SELECT DISTINCT GRUPO.idgrupo,
                   GRUPO.nmGrupo
            FROM   acesso.grupo GRUPO
            WHERE  GRUPO.idgrupo NOT IN ( SELECT DISTINCT GRUPOA.idgrupo
                                          FROM    acesso.grupo GRUPOA,
                                                  contatoadm.subcampanhagrupousuario SUBCAMPANHAGRPUSUA
                                          WHERE   SUBCAMPANHAGRPUSUA.idsubcampanhafixa = :idSubCampanhaFixa
                                          AND     GRUPOA.idgrupo = SUBCAMPANHAGRPUSUA.idgrupo
                                          AND     SUBCAMPANHAGRPUSUA.inativo = 1 )
			and grupo.idgrupo>0
            ORDER BY upper(GRUPO.nmGrupo);
          EXEC SQL OPEN crsGrpMotivo6;

          xml->addItem("nome","GRUPO");
          for(;;) 
          {
            EXEC SQL FETCH crsGrpMotivo6 INTO :idGrupo, :nmGrupo;
            endOraStr(nmGrupo);

            xml->createTag("tns:ApoioVO");
            xml->addItem("codigo",idGrupo);
            xml->addItem("sigla",(char *)nmGrupo.arr);
            xml->addItem("descricao",(char *)nmGrupo.arr);
            xml->addItem("peso","null");
            xml->addItem("variante","null");
            xml->closeTag();
          }
  
          EXEC SQL CLOSE crsGrpMotivo6;
      }
      else if(idSubCampanhaHistorico > 0)
      {
          // ulog("Passei Neg > 0 Historico > 0");
          EXEC SQL DECLARE crsGrpMotivo5 CURSOR FOR
            SELECT DISTINCT GRUPO.idgrupo,
                   GRUPO.nmGrupo
            FROM   acesso.grupo GRUPO
            WHERE  GRUPO.idgrupo NOT IN ( SELECT DISTINCT GRUPOA.idgrupo
                                          FROM    acesso.grupo GRUPOA,
                                                  contatoadm.subcampanhagrupousuario SUBCAMPANHAGRPUSUA,
                                                  campanha.subcampanhahistorico SUBCAMPANHAHSTA
                                          WHERE   SUBCAMPANHAHSTA.idsubcampanhahistorico = :idSubCampanhaHistorico
                                          AND     SUBCAMPANHAGRPUSUA.idsubcampanhafixa = SUBCAMPANHAHSTA.idsubcampanhafixa
                                          AND     GRUPOA.idgrupo = SUBCAMPANHAGRPUSUA.idgrupo
                                          AND     SUBCAMPANHAGRPUSUA.inativo = 1)
			and grupo.idgrupo>0
		    ORDER BY upper(GRUPO.nmGrupo);
          EXEC SQL OPEN crsGrpMotivo5;

          xml->addItem("nome","GRUPO");
          for(;;) 
          {
            EXEC SQL FETCH crsGrpMotivo5 INTO :idGrupo, :nmGrupo;
            endOraStr(nmGrupo);

            xml->createTag("tns:ApoioVO");
            xml->addItem("codigo",idGrupo);
            xml->addItem("sigla",(char *)nmGrupo.arr);
            xml->addItem("descricao",(char *)nmGrupo.arr);
            xml->addItem("peso","null");
            xml->addItem("variante","null");
            xml->closeTag();
          }
  
          EXEC SQL CLOSE crsGrpMotivo5;
      }
  }
  else
  {
      if(idSubCampanhaFixa > 0)
      {
          // ulog("Passei Neg = 0 Fixa > 0");
          EXEC SQL DECLARE crsGrpMotivo2 CURSOR FOR
            SELECT GRUPO.idGrupo,
                   GRUPO.nmGrupo
            FROM   acesso.grupo GRUPO,
	           contatoadm.subcampanhagrupousuario SUBCAMPANHAGRPUSU
	    WHERE  SUBCAMPANHAGRPUSU.idsubcampanhafixa = :idSubCampanhaFixa
            AND    GRUPO. idGrupo = SUBCAMPANHAGRPUSU.IDGRUPO
            AND    SUBCAMPANHAGRPUSU.inativo = 1 
				ORDER BY upper(GRUPO.nmGrupo);

          EXEC SQL OPEN crsGrpMotivo2;

          xml->addItem("nome","GRUPO");
          for(;;) 
          {
            EXEC SQL FETCH crsGrpMotivo2 INTO :idGrupo, :nmGrupo;
            endOraStr(nmGrupo);

            xml->createTag("tns:ApoioVO");
            xml->addItem("codigo",idGrupo);
            xml->addItem("sigla",(char *)nmGrupo.arr);
            xml->addItem("descricao",(char *)nmGrupo.arr);
            xml->addItem("peso","null");
            xml->addItem("variante","null");
            xml->closeTag();
          }
  
          EXEC SQL CLOSE crsGrpMotivo2;
      }
      else if(idSubCampanhaHistorico > 0)
      {
          // ulog("Passei Neg = 0 Historico > 0");
          EXEC SQL DECLARE crsGrpMotivo1 CURSOR FOR
            SELECT GRUPO.idGrupo,
                   GRUPO.nmGrupo
            FROM   acesso.grupo GRUPO,
	           contatoadm.subcampanhagrupousuario SUBCAMPANHAGRPUSU, 
	           campanha.subcampanhahistorico SUBCAMPANHAHST
            WHERE  SUBCAMPANHAHST.idsubcampanhahistorico = :idSubCampanhaHistorico
	    AND    SUBCAMPANHAGRPUSU.idsubcampanhafixa = SUBCAMPANHAHST.idsubcampanhafixa
            AND    GRUPO. idGrupo = SUBCAMPANHAGRPUSU.IDGRUPO
            AND    SUBCAMPANHAGRPUSU.inativo = 1 
				ORDER BY upper(GRUPO.nmGrupo);

          EXEC SQL OPEN crsGrpMotivo1;

          xml->addItem("nome","GRUPO");
          for(;;) 
          {
            EXEC SQL FETCH crsGrpMotivo1 INTO :idGrupo, :nmGrupo;
            endOraStr(nmGrupo);

            xml->createTag("tns:ApoioVO");
            xml->addItem("codigo",idGrupo);
            xml->addItem("sigla",(char *)nmGrupo.arr);
            xml->addItem("descricao",(char *)nmGrupo.arr);
            xml->addItem("peso","null");
            xml->addItem("variante","null");
            xml->closeTag();
          }
  
          EXEC SQL CLOSE crsGrpMotivo1;
      }
  }
  }
  catch( ... )
  {
      throw;
  }
  
  return 1;
}
