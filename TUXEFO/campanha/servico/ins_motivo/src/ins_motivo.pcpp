//
// $Id:  .cpp,v 1.1 2004/05/17 17:55:07 wfonseca Exp 
//

#include "../../negocio/cmputil/include/campanha.hpp"

int ins_motivo(char * usuario, DOMNode*dnode, XMLGen*xml)
{
	char parm[256];

	EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR sgMotivo[256];
		VARCHAR nmMotivo[256];
		int     idPessoaUsuarioAlteracao;
		int		inAtivo = -1;
        int     idMotivo = 0;
		int		inAderiu = 0;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "sgMotivo", 0, 0);
	strToOra(sgMotivo,parm);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "nmMotivo", 0, 0);
	strToOra(nmMotivo,parm);

    //  Obtendo dados do xml

	get_tag(parm, dnode, "inAderiu", 0, 0);
	inAderiu = atoi(parm);

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);


	// Marcamos inAtivo com -1, se esta linha não existir, a variável continuará -1
	// se existir será alterada para 0 ou 1
	inAtivo = -1;

	/* Verifica se existe o item a adcionar */
	EXEC SQL
	SELECT 
			MOTIVO.inAtivo, MOTIVO.idTipoMotivoCampanha 
	INTO 
			:inAtivo, :idMotivo
	FROM 
			apoio.tipomotivocampanha MOTIVO
	WHERE  
			(MOTIVO.sgtipomotivocampanha = :sgMotivo
			OR MOTIVO.dstipomotivocampanha = :nmMotivo) 
			AND ROWNUM <= 1;

	//for(;;) 
	//{
	//	EXEC SQL FETCH crsMotivo INTO :idMotivo;
	//	break;
	//}
  
//	EXEC SQL CLOSE crsMotivo;	
	
	
	// Se o motivo não existe na base, então vamos inserir
	if(inAtivo == -1)
	{
		// Altera para Ativo
		inAtivo = 1;

		/* Insert linha */
		EXEC SQL  INSERT INTO apoio.tipomotivocampanha(
					idtipomotivocampanha,
					sgtipomotivocampanha,
					dstipomotivocampanha,
					idpessoausuarioinclusao,
					idpessoausuarioalteracao,
					dtinclusao,
					dtalteracao,
					idusuarioalteracao,
					dtultimaalteracao,
					inativo,
					inaderiu)					
				VALUES(
					apoio.tipomotivocampanhasq.NEXTVAL,
					:sgMotivo,
					:nmMotivo,
					:idPessoaUsuarioAlteracao,
					:idPessoaUsuarioAlteracao,
					SYSDATE,
					SYSDATE,
					:idPessoaUsuarioAlteracao,
					SYSDATE,
					:inAtivo,
					:inAderiu);
  
		if (sqlca.sqlcode)
		{
			throw new TuxBasicSvcException("00E1000","INSERT INTO apoio.tipomotivocampanha");
		}

		/* insert OK */
		xml->createTag("MOTIVO");
		xml->addItem("INSERT",sqlca.sqlerrd[2]);
		xml->closeTag();
	}
    else // Caso inAtivo for válido o motivo existe e deve ser atualizado
	{
		// Altera para Ativo
		inAtivo = 1;

		EXEC SQL UPDATE apoio.tipomotivocampanha
		    SET
				sgtipomotivocampanha = :sgMotivo,
				dstipomotivocampanha = :nmMotivo,
				idpessoausuarioalteracao = :idPessoaUsuarioAlteracao,
				dtalteracao = SYSDATE,
				idusuarioalteracao = :idPessoaUsuarioAlteracao,
				dtultimaalteracao = SYSDATE,
				inativo = :inAtivo,
				inaderiu = :inAderiu
     	    WHERE idtipomotivocampanha = :idMotivo;
											  
		if (sqlca.sqlcode)
		{
			throw new TuxBasicSvcException("00E1000","UPDATE apoio.tipomotivocampanha ");
		}
		
		/* insert modificado para update OK */
		xml->createTag("MOTIVO");
		xml->addItem("ID",idMotivo);
		xml->addItem("UPDATE",1);
		xml->closeTag();
	}

	return 1;
}
