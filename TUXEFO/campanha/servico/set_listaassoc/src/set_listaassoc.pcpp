//
// $Id: set_listaassoc.pcpp,v 1.1 2009/07/31 15:33:28 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int set_listaassoc(int usuario,DOMNode*dnode,XMLGen*xml)
{
  char parm[256]; 
  int  i;

  EXEC SQL BEGIN DECLARE SECTION;
    int     idCanalCampanha;
    int     idLista;
    int     inAtivo;
    int     idPessoaUsuarioInclusao;
  EXEC SQL END DECLARE SECTION;
  EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);

	try
	{

		// Atribuindo id do usuario
		idPessoaUsuarioInclusao  = usuario;

		//  Obtendo dados do xml
		get_tag(parm, dnode, "idCanalCampanha", 0, 0);
		idCanalCampanha = atoi(parm);

		// Loop de operacao : inAtivo 0-exclusao 1-inclusao
		// Colocar todos as listas com inativo
		EXEC SQL 
		UPDATE campanha.listaCanalCampanha
		SET		inAtivo = 0,
				idUsuarioAlteracao = :idPessoaUsuarioInclusao,
				dtUltimaAlteracao  = sysdate
		WHERE  idCanalCampanha = :idCanalCampanha;

		i = 0;
		while( get_tag(parm,dnode,"codigo",i,-1) != -1 )
		{
			idLista = atoi(parm);

			get_tag(parm,dnode,"inAtivo",i,-1);
			inAtivo = atoi(parm);

			if(inAtivo == 1)
			{
				// Fazendo update dos ativos
				EXEC SQL 
				UPDATE campanha.listaCanalCampanha
				SET		inAtivo = 1,
						idUsuarioAlteracao = :idPessoaUsuarioInclusao,
						dtUltimaAlteracao  = sysdate
				WHERE	idCanalCampanha = :idCanalCampanha
					AND	idlista = : idLista;

				// if 0 .: nao existe => inserir
				if (sqlca.sqlerrd[2] == 0)
				{
					EXEC SQL 
					INSERT INTO campanha.listaCanalCampanha ( 
										idListaCanalCampanha,
										idLista,
										idCanalCampanha,
										idUsuarioAlteracao,
										dtUltimaAlteracao,
										inAtivo )
					VALUES(				campanha.listaCanalCampanhaSQ.nextval,
										:idLista,
										:idCanalCampanha,
										:idPessoaUsuarioInclusao,
										sysdate,
										1 );
				}
			}

			i++;
		} // While

		xml->addItem("descricao","SETLISTA");
		xml->addItem("valor",i);
	} catch(...){throw;}
  
	return 1;
}

