//
// $Id: get_subcampanha.pcpp,v 1.1 2009/07/31 15:34:25 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int get_subcampanha(char * usuario,DOMNode*dnode,XMLGen*xml)
{
    char parm[1000];  

    EXEC SQL BEGIN DECLARE SECTION;
        int     idSubCampanhaHistorico = 0;
        VARCHAR dsScriptSubCampanha[1000];
        int     inClienteTelefonica = 0;
        int     qtMaximaAgenda = 0;
        VARCHAR dtInicio[255];
        VARCHAR dtInicioOut[255];
        VARCHAR dtTermino[255];
        VARCHAR dtTerminoOut[255];
        int     sqVersao = 0;
        int     inReincidente = 0;
        int     idTipoCampanha = 0;
        VARCHAR sgTipoCampanha[255];
        VARCHAR nmTipoCampanha[255];
        int     TpCmpinAtivo = 0;
        int     idSubCampanhaFixa = 0;
        int     SbCmpinAtivo = 0;
        int     inDisponibilidade = 0;
        int     idCampanha = 0;
        VARCHAR sgCampanha[255];
        VARCHAR dsCampanha[255];
        int     CmpinAtivo = 0;
        int     inAtivo = 0;
        int     idPessoaUsuarioAlteracao = 0;
		int		inFidelizacao=0;
	VARCHAR nmSubCampanha[255+1];
	short   inmSubCampanha;
	int     iCursor;

    EXEC SQL END DECLARE SECTION;
    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
  

    //  Obtendo dados do xml
    get_tag(parm, dnode, "idSubCampanhaFixa", 0, 0);

/*CVA. 16/08/ 2004*/
    //idCampanha = atoi(parm);
	idSubCampanhaFixa = atoi(parm);
/*CVA. 16/08/ 2004*/

    //  Obtendo dados do xml
    get_tag(parm, dnode, "idSubCampanhaHistorico", 0, 0);
    idSubCampanhaHistorico = atoi(parm);

	//inFidelizacao
	EXEC SQL
		SELECT COUNT(idSubCampanhaHistorico)	
		INTO :inFidelizacao
		FROM  campanha.subcampanhafidelizacao
		WHERE idsubcampanhahistorico=:idSubCampanhaHistorico;
		
	// Pegando id do usuario
    idPessoaUsuarioAlteracao = get_idUsuario(usuario);

    inAtivo = 1;
  EXEC SQL WHENEVER NOT FOUND DO break; // Esta chamada acima do SELECT COUNT
										//Gera um erro de illegal break;
    if( idSubCampanhaHistorico != 0 && idSubCampanhaFixa != 0)
    {
        EXEC SQL DECLARE crsSubCampanha1 CURSOR FOR
            SELECT    NVL(SUBCAMPANHAH.idsubcampanhahistorico,0),
 		      SUBCAMPANHAH.dsscriptsubcampanha,
		      NVL(SUBCAMPANHAH.inclientetelefonica,0),
		      SUBCAMPANHAH.qtmaximaagenda,
		      SUBCAMPANHAH.dtinicio,
		      SUBCAMPANHAH.dtinicioout,
		      SUBCAMPANHAH.dttermino,
		      SUBCAMPANHAH.dtterminoout,
		      SUBCAMPANHAH.sqversao,
		      NVL(SUBCAMPANHAH.inreincidente,0),
		      NVL(SUBCAMPANHAH.idtipocampanha,0),
		      NVL(TIPOCAMPANHA.sgtipocampanha,0),
		      TIPOCAMPANHA.nmtipocampanha,
		      NVL(TIPOCAMPANHA.inativo,0) as tpcmpinativo,
		      NVL(SUBCAMPANHAH.idsubcampanhafixa,0),
		      NVL(SUBCAMPANHAF.inativo,0) as sbcmpinativo,
		      NVL(SUBCAMPANHAH.indisponibilidade,0),
		      NVL(CAMPANHA.idcampanha,0),
		      CAMPANHA.sgcampanha,
		      CAMPANHA.dscampanha,
		      NVL(CAMPANHA.inativo,0) as cmpinativo,
		      SUBCAMPANHAH.NMSUBCAMPANHA
            FROM		campanha.subcampanhahistorico SUBCAMPANHAH,
						campanha.subcampanhafixa SUBCAMPANHAF,
						apoio.tipocampanha TIPOCAMPANHA,
						apoio.campanha CAMPANHA
            WHERE     SUBCAMPANHAF.idsubcampanhafixa = SUBCAMPANHAH.idsubcampanhafixa
            AND       TIPOCAMPANHA.idtipocampanha = SUBCAMPANHAH.idtipocampanha
/*CVA. 16/08/ 2004*/
//            AND       CAMPANHA.idcampanha = :idCampanha
			AND       SUBCAMPANHAF.idSubCampanhaFixa = :idSubCampanhaFixa
			AND CAMPANHA.idCampanha = SUBCAMPANHAF.idCampanha
/*CVA. 16/08/2004*/
            AND       SUBCAMPANHAH.idsubcampanhahistorico = :idSubCampanhaHistorico 
            order by  SUBCAMPANHAH.DSSCRIPTSUBCAMPANHA;
        EXEC SQL OPEN crsSubCampanha1;
        iCursor = 1;
            
    }
    else if( idSubCampanhaHistorico == 0 && idSubCampanhaFixa != 0)
    {
        EXEC SQL DECLARE crsSubCampanha2 CURSOR FOR
           SELECT     NVL(SUBCAMPANHAH.idsubcampanhahistorico,0),
 		      SUBCAMPANHAH.dsscriptsubcampanha,
		      NVL(SUBCAMPANHAH.inclientetelefonica,0),
		      NVL(SUBCAMPANHAH.qtmaximaagenda,0),
		      SUBCAMPANHAH.dtinicio,
		      SUBCAMPANHAH.dtinicioout,
		      SUBCAMPANHAH.dttermino,
		      SUBCAMPANHAH.dtterminoout,
		      NVL(SUBCAMPANHAH.sqversao,0),
		      NVL(SUBCAMPANHAH.inreincidente,0),
		      NVL(SUBCAMPANHAH.idtipocampanha,0),
		      TIPOCAMPANHA.sgtipocampanha,
		      TIPOCAMPANHA.nmtipocampanha,
		      NVL(TIPOCAMPANHA.inativo,0) as tpcmpinativo,
		      NVL(SUBCAMPANHAH.idsubcampanhafixa,0),
		      NVL(SUBCAMPANHAF.inativo,0) as sbcmpinativo,
		      NVL(SUBCAMPANHAH.indisponibilidade,0),
		      NVL(CAMPANHA.idcampanha,0),
		      CAMPANHA.sgcampanha,
		      CAMPANHA.dscampanha,
		      NVL(CAMPANHA.inativo,0) as cmpinativo,
		      SUBCAMPANHAH.NMSUBCAMPANHA
           FROM       campanha.subcampanhahistorico SUBCAMPANHAH,
	              campanha.subcampanhafixa SUBCAMPANHAF,
		      apoio.tipocampanha TIPOCAMPANHA,
		      apoio.campanha CAMPANHA
           WHERE      SUBCAMPANHAF.idsubcampanhafixa = SUBCAMPANHAH.idsubcampanhafixa
           AND        TIPOCAMPANHA.idtipocampanha = SUBCAMPANHAH.idtipocampanha
/*CVA. 16/08/2004*/
//           AND        CAMPANHA.idcampanha = :idCampanha       
			AND       SUBCAMPANHAF.idSubCampanhaFixa = :idSubCampanhaFixa
			AND CAMPANHA.idCampanha = SUBCAMPANHAF.idCampanha
/*CVA. 16/08/2004*/			

           order by   SUBCAMPANHAH.DSSCRIPTSUBCAMPANHA;
        EXEC SQL OPEN crsSubCampanha2;
        iCursor = 2;
     
    }


    // EXEC SQL OPEN crsSubCampanha;
    // xml->addItem("nome","SUBCAMPANHA");
    for(;;) 
    {
        if( iCursor == 1 )
        {
	        EXEC SQL FETCH crsSubCampanha1 INTO 
			:idSubCampanhaHistorico, 
			:dsScriptSubCampanha, 
			:inClienteTelefonica, 
			:qtMaximaAgenda, 
			:dtInicio, 
			:dtInicioOut, 
			:dtTermino, 
			:dtTerminoOut, 
			:sqVersao, 
			:inReincidente, 
			:idTipoCampanha,
			:sgTipoCampanha, 
			:nmTipoCampanha, 
			:TpCmpinAtivo, 
			:idSubCampanhaFixa, 
			:SbCmpinAtivo, 
			:inDisponibilidade, 
			:idCampanha, 
			:sgCampanha, 
			:dsCampanha, 
			:CmpinAtivo,
			:nmSubCampanha:inmSubCampanha;
		}
		else
		{
	        EXEC SQL FETCH crsSubCampanha2 INTO 
			:idSubCampanhaHistorico, 
			:dsScriptSubCampanha, 
			:inClienteTelefonica, 
			:qtMaximaAgenda, 
			:dtInicio, 
			:dtInicioOut, 
			:dtTermino, 
			:dtTerminoOut, 
			:sqVersao, 
			:inReincidente, 
			:idTipoCampanha,
			:sgTipoCampanha, 
			:nmTipoCampanha, 
			:TpCmpinAtivo, 
			:idSubCampanhaFixa, 
			:SbCmpinAtivo, 
			:inDisponibilidade, 
			:idCampanha, 
			:sgCampanha, 
			:dsCampanha, 
			:CmpinAtivo,
			:nmSubCampanha:inmSubCampanha;
		}//if( iCursor == 1 )
	
        endOraStr(sgCampanha);
        endOraStr(dsCampanha);    
        endOraStr(sgTipoCampanha);
        endOraStr(nmTipoCampanha);    
        endOraStr(dtInicio);
        endOraStr(dtInicioOut);
        endOraStr(dtTermino);
        endOraStr(dtTerminoOut);    
        endOraStr(dsScriptSubCampanha);  
        endOraStr(nmSubCampanha);  

		xml->addItem("idSubCampanha",idSubCampanhaHistorico);
		xml->addItem("inFidelizacao",inFidelizacao);
		xml->addItem("dsSubCampanha",(char *)dsScriptSubCampanha.arr);
		xml->addItem("inCliente",inClienteTelefonica);
		xml->addItem("iAgendaMax",qtMaximaAgenda);
		xml->addItem("sqVersao",sqVersao);
		xml->addItem("iRecontato",inReincidente);
		xml->addItem("idTipoCampanha",idTipoCampanha);
		xml->addItem("idSubCampanhaFixa",idSubCampanhaFixa);
		xml->addItem("inAtivo",SbCmpinAtivo);
		xml->addItem("idCampanha",idCampanha);
		xml->addItem("sgCampanha",(char *)sgCampanha.arr);
		xml->addItem("dsCampanha",(char *)dsCampanha.arr);
		xml->addItem("dtInicio",(char *)dtInicioOut.arr);
		xml->addItem("dtTermino",(char *)dtTerminoOut.arr);

	    if(inmSubCampanha>=0)
			xml->addItem("nmSubCampanha",(char *)nmSubCampanha.arr);
	    else
			xml->addItem("nmSubCampanha","");

		xml->addItem("inDisponibilidade",inDisponibilidade);
    }  

	if( iCursor == 1 )
		EXEC SQL CLOSE crsSubCampanha1;
	else
    	EXEC SQL CLOSE crsSubCampanha2;
  
    return 1;
}

