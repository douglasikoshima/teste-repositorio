//
// $Id: get_canalcampanha.pcpp,v 1.1.2.1 2010/01/13 22:57:17 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int get_canalcampanha(char * usuario,DOMNode*dnode,XMLGen*xml)
{
    char parm[256];  


    EXEC SQL BEGIN DECLARE SECTION;
        int     idCanalCampanha; 
        int     idCanal; 
        int     idCanalUFOperadora; 
        VARCHAR nmCanal[255];
        VARCHAR cdCanal[255];
	int     idSubCampanhaHistorico;
	int     inDisponibilidade;
        int     sqApresentacao;
	int     idPessoaUsuarioAlteracao;
	int     inAtivo;
    EXEC SQL END DECLARE SECTION;
    EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
    EXEC SQL WHENEVER NOT FOUND DO break;

    //  Obtendo dados do xml
    get_tag(parm, dnode, "idSubCampanhaHistorico", 0, 0);
    idSubCampanhaHistorico = atoi(parm);

    // Pegando id do usuario
    idPessoaUsuarioAlteracao = get_idUsuario(usuario);

    inAtivo = 1;

    if( idSubCampanhaHistorico != 0)
    {
        EXEC SQL DECLARE crsCanalCampanha CURSOR FOR
			SELECT	CANALCAMPANHA.idcanalcampanha,
					CANALCAMPANHA.sqapresentacao,
					CANALCAMPANHA.indisponibilidade,
					CANALCAMPANHA.idsubcampanhahistorico,
					CANALCAMPANHA.idcanalufoperadora,
					CANALUFOPERADORA.idcanal,
			CANAL.cdcanal||'-' ||UF.SGUF,
			CANAL.nmcanal||'-' ||UF.SGUF

			FROM	campanha.canalcampanha CANALCAMPANHA,
				campanha.canalufoperadora CANALUFOPERADORA,
				apoio.canal CANAL,
				APOIO.UF UF,
				CUSTOMER.UFOPERADORA UFOPERADORA
			WHERE  CANALCAMPANHA.idsubcampanhahistorico = :idSubCampanhaHistorico
			AND		CANALUFOPERADORA.idcanalufoperadora = CANALCAMPANHA.idcanalufoperadora
			AND		CANAL.idcanal = CANALUFOPERADORA.idcanal
			AND		CANALCAMPANHA.inativo = 1

			AND		UFOPERADORA.IDUFOPERADORA = CANALUFOPERADORA.IDUFOPERADORA
			AND		UFOPERADORA.IDUF = UF.IDUF
		  		  
          ORDER BY CANAL.cdcanal;
        EXEC SQL OPEN crsCanalCampanha;

        for(;;) 
        {
            EXEC SQL FETCH crsCanalCampanha INTO :idCanalCampanha, :sqApresentacao, 
			:inDisponibilidade, :idSubCampanhaHistorico, :idCanalUFOperadora, 
			:idCanal, :cdCanal, :nmCanal;


            endOraStr(cdCanal);  
            endOraStr(nmCanal);  

            xml->createTag("ApoioCanalVO");
                xml->addItem("idCanalCampanha",idCanalCampanha);
                xml->addItem("sqApresentacao",sqApresentacao);
                xml->addItem("idSubCampanhaHistorico",idSubCampanhaHistorico);
                xml->addItem("idCanalUFOperadora",idCanalUFOperadora);
                xml->addItem("cnlcmpinAtivo",1);
                xml->addItem("codigo",idCanalUFOperadora);
                xml->addItem("sigla",(char *)cdCanal.arr);
                xml->addItem("descricao",(char *)nmCanal.arr);
            xml->closeTag();

        }  
        EXEC SQL CLOSE crsCanalCampanha;
    }
    else
    {
            xml->createTag("ApoioCanalVO");
            xml->closeTag();

    } 

    return 1;
}

