//
// $Id: upd_paramcmp.pcpp,v 1.1 2009/07/31 15:33:37 a5110702 Exp $
//

#include "../../negocio/cmputil/include/campanha.hpp"

int upd_paramcmp(char * usuario, DOMNode*dnode,XMLGen*xml)
{
    TuxHelper txhI;
    char parm[256];
    int iSubno = 0;
    int iNroObjCta = 0;
    DOMNode *pNoConta;
    DOMNode *pConta;
    try
    {

	EXEC SQL BEGIN DECLARE SECTION;
            int idGotcha = 0;
            int contador = 0;
            int idCanalCampanha[50];
            int idCanalCamp;
            int idCanalUFOperadora = 0;
            int idSubCampanhaHistorico = 0;
            int sqApresentacao = 0;
            int nrTempoMedioContato = 0;
            int nrMetaDiariaCampanha = 0;
            int nrMetaDiariaOperador = 0;
            int nrContatoEfetivoOperador = 0;
            int nrContatoEfetivoCampanha = 0;
            int nrContatoSucessoOperador = 0;
            int nrContatoSucessoCampanha = 0;
            int nrPublicoTotal = 0;
            int nrAderiuOperador = 0;
            int nrAderiuCampanha = 0;
            int nrNaoAderiuOperador = 0;
            int nrNaoAderiuCampanha = 0;
	    int idPessoaUsuarioAlteracao;
	    int	inAtivo;
            int NextVal4;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL WHENEVER SQLERROR DO sql_error(NULL);
        EXEC SQL WHENEVER NOT FOUND DO break;

        /* CanalUtil */


        iNroObjCta = 0;
        pConta = txhI.walkDOM(dnode, "CanalUtil", iNroObjCta);

        for(iNroObjCta = 0; (pNoConta = txhI.walkDOM(pConta, "ApoioCanalVO", iNroObjCta)) ; iNroObjCta++)
        {
            //  Obtendo dados do xml
            get_tag(parm, pNoConta, "idCanalCampanha", 0, -1);
            idCanalCampanha[iNroObjCta] = atoi(parm);

            // ulog("Canal [%d] , [%d], [%s]",idCanalCampanha[iNroObjCta],iNroObjCta,parm);
        }
        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrTempoMedio", 0, 0);
        nrTempoMedioContato = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrMetaDiariaCmp", 0, -1);
        nrMetaDiariaCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrMetaDiariaOpr", 0, 0);
        nrMetaDiariaOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrContEfetivoOpr", 0, -1);
        nrContatoEfetivoOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrContEfetivoCmp", 0, 0);
        nrContatoEfetivoCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrContSucessoOpr", 0, -1);
        nrContatoSucessoOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrContSucessoCmp", 0, 0);
        nrContatoSucessoCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrPublicoTotal", 0, -1);
        nrPublicoTotal = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrAderiuOpr", 0, 0);
        nrAderiuOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrAderiuCmp", 0, -1);
        nrAderiuCampanha = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrNaoAderiuOpr", 0, 0);
        nrNaoAderiuOperador = atoi(parm);

        //  Obtendo dados do xml
        get_tag(parm, dnode, "nrNaoAderiuCmp", 0, -1);
        nrNaoAderiuCampanha = atoi(parm);

	// Pegando id do usuario
	idPessoaUsuarioAlteracao = get_idUsuario(usuario);

	inAtivo = 1;

        for(contador = 0; contador < iNroObjCta; contador++)
        {

            idCanalCamp = idCanalCampanha[contador];

            // ulog("Canal [%d] , [%d], CanalCamp [%d]",idCanalCampanha[contador],contador,idCanalCamp);

	    /* Verifica se existe o item a adcionar */
	    EXEC SQL DECLARE crsParamCmp CURSOR FOR
		SELECT PARAMETRIZACAOCAMPANHA.idcanalcampanha
                FROM campanha.Parametrizacaocampanha PARAMETRIZACAOCAMPANHA
		WHERE  PARAMETRIZACAOCAMPANHA.idcanalcampanha = :idCanalCamp;

	    EXEC SQL OPEN crsParamCmp;

	    for(;;) 
	    {
		EXEC SQL FETCH crsParamCmp INTO :idGotcha;
		break;
	    }
  
	    EXEC SQL CLOSE crsParamCmp;	
	
	    if(idGotcha == 0)
	    {
		    /* Insert linha */
		    EXEC SQL INSERT INTO campanha.Parametrizacaocampanha(idcanalcampanha,
                                                                        nrtempomediocontato, 
                                                                        nrmetadiariacampanha, 
                                                                        nrmetadiariaoperador, 
                                                                        nrcontatoefetivooperador, 
                                                                        nrcontatoefetivocampanha, 
                                                                        nrcontatosucessooperador, 
                                                                        nrcontatosucessocampanha, 
                                                                        nrpublicototal, 
                                                                        nraderiuoperador, 
                                                                        nraderiucampanha, 
                                                                        nrnaoaderiuoperador, 
                                                                        nrnaoaderiucampanha,
                                                                        idusuarioalteracao,
                                               				dtultimaalteracao) 
                                                                 VALUES(:idCanalCamp,
                                                                        :nrTempoMedioContato,
                                                                        :nrMetaDiariaCampanha,
                                                                        :nrMetaDiariaOperador,
                                                                        :nrContatoEfetivoOperador,
                                                                        :nrContatoEfetivoCampanha,
                                                                        :nrContatoSucessoOperador,
                                                                        :nrContatoSucessoCampanha,
                                                                        :nrPublicoTotal,
                                                                        :nrAderiuOperador,
                                                                        :nrAderiuCampanha,
                                                                        :nrNaoAderiuOperador,
                                                                        :nrNaoAderiuCampanha,
                                                                        :idPessoaUsuarioAlteracao,
                                                                        sysdate);

		    if (sqlca.sqlcode)
		    {
		    	    throw new TuxBasicSvcException("00E1000","INSERT INTO campanha.Parametrizacaocampanha");
		    }

		    /* insert OK */
	    	    xml->createTag("PARAMETRIZACAOCAMPANHA");
		    xml->addItem("INSERT",1);
	    	    xml->closeTag();
	    }
	
            if(idGotcha > 0)
	    {
                /* Update linha */
                EXEC SQL UPDATE campanha.Parametrizacaocampanha 
                    SET idcanalcampanha = :idGotcha,
                        nrtempomediocontato = :nrTempoMedioContato,
                        nrmetadiariacampanha = :nrMetaDiariaCampanha,
                        nrmetadiariaoperador = :nrMetaDiariaOperador,
                        nrcontatoefetivooperador = :nrContatoEfetivoOperador,
                        nrcontatoefetivocampanha = :nrContatoEfetivoCampanha,
                        nrcontatosucessooperador = :nrContatoSucessoOperador,
                        nrcontatosucessocampanha = :nrContatoSucessoCampanha,
                        nrpublicototal = :nrPublicoTotal,
                        nraderiuoperador = :nrAderiuOperador,
                        nraderiucampanha = :nrAderiuCampanha,
                        nrnaoaderiuoperador = :nrNaoAderiuOperador,
                        nrnaoaderiucampanha = :nrNaoAderiuCampanha,
                        idusuarioalteracao = :idPessoaUsuarioAlteracao,
                        dtultimaalteracao = sysdate
                    WHERE idcanalcampanha = :idGotcha;

                if (sqlca.sqlcode)
                {
                    throw new TuxBasicSvcException("00E1000","UPDATE apoio.campanha ");
                }
	        /* insert modificado para update OK */
	        xml->createTag("PARAMETRIZACAOCAMPANHA");
	        xml->addItem("ID",idGotcha);
	        xml->addItem("UPDATE",1);
	        xml->closeTag();
    	    }

            idGotcha = 0;
            idCanalCamp = 0;
        }

    }
    catch( ... )
    {
        throw;
    }
    return 1;
}
