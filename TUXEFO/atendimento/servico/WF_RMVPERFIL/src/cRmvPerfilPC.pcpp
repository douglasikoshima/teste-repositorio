
#undef SQLCA
#define SQLCA_NONE
#include<sqlca.h>
#include<sqlda.h>

#include "../include/cRmvPerfil.h"
#include "../../../commons/queryMacro.h"
#include "../../../commons/SmallString.h"
#include "../../../commons/msgPadrao.h"

// Prototipos
void SqlError( sqlca * sqlca );

/*---------------------------------------------------------*/
short proCRemovePerfil( unsigned long idPerfilPrm )
{
    ULOG_START("proCRemovePerfil()");
	short retorno;

    struct sqlca sqlca;
	
	EXEC SQL BEGIN DECLARE SECTION;
        unsigned long idPerfil = idPerfilPrm;
        short nmPerf = 0 ;
	EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO SqlError( &sqlca );

    
	//
    // Incidencia 3269.
    // Sera feita apenas exclusao logica.
    // 2006-04-06 @ Marcelo @
    /*---------------------------------------------------------
    EXEC SQL
      SELECT  COUNT(1)
         INTO
              :nmPerf
         FROM 
              CONTATOADM.CONTATOPERFIL CONTATOADM,
              ATENDIMENTO.ATENDIMENTO ATENDIMENTO
         WHERE 
	          CONTATOADM.IDCONTATO =  ATENDIMENTO.IDCONTATO
	AND CONTATOADM.IDGRUPOPERFIL IN 
	( 
		SELECT GRUPOPERFIL.IDGRUPOPERFIL  
		FROM  CONTATOADM.GRUPOPERFIL  GRUPOPERFIL
		WHERE GRUPOPERFIL.IDPERFIL = :idPerfil  
		AND ( GRUPOPERFIL.DTEXPIRACAO IS NULL OR GRUPOPERFIL.DTEXPIRACAO > SYSDATE )
	)
	AND  NOT EXISTS 
	(
		SELECT ATENDIMENTOFECHAMENTO.IDATENDIMENTO  
		FROM ATENDIMENTO.ATENDIMENTOFECHAMENTO ATENDIMENTOFECHAMENTO 
		WHERE ATENDIMENTOFECHAMENTO.IDATENDIMENTO = ATENDIMENTO.IDATENDIMENTO 
	)
	AND  CONTATOADM.DTEXCLUSAO IS NULL
	     AND  ROWNUM  < 2;

    if (nmPerf == 1 )
    {
        retorno = 1; // erro de integridade
    }
    else
    {
    */

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILTIPOLINHA 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILSEGMENTACAO 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILCARTEIRA 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILPROCEDENCIA 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILNATUREZA 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILTIPOCLIENTE 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILGRUPOABERTURA 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILCANAL 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL
        UPDATE 
            CONTATOADM.PERFILUFOPERADORA 
        SET 
            DTEXCLUSAO = SYSDATE 
        WHERE 
            IDPERFIL = :idPerfil;

        EXEC SQL 
        UPDATE
        	CONTATOADM.CONTATOPERFIL
        SET
            DTEXCLUSAO = SYSDATE
        WHERE 
            IDGRUPOPERFIL IN
            (
	            SELECT
	                IDGRUPOPERFIL
	            FROM
	                CONTATOADM.GRUPOPERFIL
	            WHERE
	                IDPERFIL = :idPerfil
            );

        EXEC SQL WHENEVER NOT FOUND CONTINUE;

		//
        // Incidencia 3269.
        // Sera feita apenas exclusao logica.
        // 2006-04-06 @ Marcelo @
	    EXEC SQL 
        UPDATE 
			CONTATOADM.GRUPOPERFIL 
        SET
            DTEXPIRACAO = SYSDATE
		WHERE 
			IDPERFIL = :idPerfil;
		
		//
        // Incidencia 3269.
        // Sera feita apenas exclusao logica.
        // 2006-04-06 @ Marcelo @
		EXEC SQL
        UPDATE 
			CONTATOADM.PERFIL 
        SET
            DTEXCLUSAO = SYSDATE
		WHERE 
			IDPERFIL = :idPerfil;

        retorno = 0;
    /*
    } // else -> if (nmPerf == 1 )
    */

    ULOG_END("proCRemovePerfil()");
    
    return retorno;
}




void SqlError( sqlca * sqlca )
{
    
    ULOGE("SqlError -> sqlcode=%d,sqlerrmc=%.70s",sqlca->sqlcode,sqlca->sqlerrm.sqlerrmc);
	throw new 
        TuxBasicOraException(
            sqlca->sqlcode,
            sqlca->sqlerrm.sqlerrmc,
            sqlca->sqlerrm.sqlerrml
            );
}
