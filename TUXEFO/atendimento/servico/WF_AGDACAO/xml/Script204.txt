
                        

			

//Imports;
#import WFUsuario:PsqUsuario;
#import WFAtdUsuAtual:WFAtdUsAConsultar;
#import WFAtdUsuAtual:WFAtdUsAAlterar;
#import WFAtdUsuAtual:WFAtdUsAExcluir;
#import WFAtdUsuAtual:WFAtdUsAIncluir;
#import WFAtdGrupoAtual:WFAtdGrAAlterar;
#import WFAtdSuspeito:WFAtdSuspExcluir;
#import WFAndamento:WFAndameIncluir;
#import WFAtdAndAtual:WFAtdAnAAlterar;
#import WFAndObservacao:WFAndObsIncluir;
#import WFAndTrf:WFAndTrfIncluir;
#import WFAndTrf:WFAndTrfAlterar;
#import WFAndTrf:WFObtemAndTrf;
#import WFAtdNivel:WFAtdNivIncluir;
#import WFAndMotivo:WFAndMotIncluir;
#import WFAtdGrupoAtual:WFAtdGrAConsultar;
#import WFAtdAge:WFAtdAgeIncluir;

//Definições;
DOMNODE domScript;
DOMNODE paramAtdUs;
DOMNODE parametro;
DOMNODE paramAtdGr;
DOMNODE paramSusp;
DOMNODE parametroAnd;
DOMNODE parametroAndAt;
DOMNODE parametroAndOb;
DOMNODE paramTrf;
DOMNODE domTratWf;
DOMNODE domWorkflow;
DOMNODE domGrupo;
DOMNODE domMotivo;
DOMNODE domUsuario;
DOMNODE domAgendamento;
DOMNODE paramAtdUsEx;
DOMNODE paramUltAnd;
DOMNODE paramAndMot;
DOMNODE paramAtdAg;

XMLGen AtdUsrAtEx;
XMLGen AtdUsrAt;
XMLGen AtdActUsrAt;
XMLGen usuario;
XMLGen AtdGrpAt;
XMLGen ExcSusp;
XMLGen AndAtual;
XMLGen AndamentoIns;
XMLGen Observacao;
XMLGen AndTrfInc;
XMLGen xmlUltAndTrf;
XMLGen grupoAtual;
XMLGen Motivo;
XMLGen xmlAltAndTrf;
XMLGen AtdAgendamento;

string txt;
string urlDestino;
string txtUltAnd;

int proxAndamento;
int UsuarioAtual;
int idAgrEstTPrAt;
int idAgrEstTPrFt;
int idAtividade;
int idUsuAtual;
int idFase;
int idAtendimento;
int estadoUsuario;
int idAndamentoIns;

#debug;

SQL SELECT TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI') DATAATUAL FROM DUAL;
SQL SELECT TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI:SS') DATAANDAMENTO FROM DUAL;

domScript = XML:ScriptExecucaoVO;
	
UsuarioAtual = domScript:idPessoaUsuario;
idAtendimento = domScript:idAtendimento;
idAgrEstTPrFt = domScript:idAgrupamentoEstadoTProcFut;
idAgrEstTPrAt = domScript:idAgrupamentoEstadoTProcAt;
idAtividade = domScript:idAtividade;
idFase = domScript:idFase;
urlDestino = domScript:nmUrlDestino;

domTratWf = XML:AtendimentoWorkflowVO;
domWorkflow = domTratWf:AtendimentoWorkflowComumVO;
domGrupo = domWorkflow:WFGrupoVO;
domMotivo = domWorkflow:WFMotivoVO;
domUsuario= domWorkflow:UsuarioVIVO;
domAgendamento = domTratWf:AtendimentoWorkflowAgendamentoVO;

// Atualizando Usuario Atual;

if (domUsuario)
	idUsuAtual = domUsuario:idPessoaUsuario;
	if (idUsuAtual > 0)
		//** Consulta Estado do Atendente **;
		//;
		// Gerando Parametro de Entrada para Metodo de Consulta;
	   	txt = "<EncaminhaFilaVO>\n";
	   	txt += "<idPessoaUsuario>" + idUsuAtual + "</idPessoaUsuario>\n";
	   	txt += "</EncaminhaFilaVO>\n";
	   	parametro = txt;
	
	   	// Consulta Estado do Atendente;
	   	usuario = WFUsuario.PsqUsuario(parametro);
	   	estadoUsuario = usuario:inDisponivelWF;
	
		Clean(txt);
	   	if ( estadoUsuario != 2 )
	   		// Atendente Indisponivel;
	      		txt = "<WFAcaoRetornoVO xmlns=\"workflow.fo.vivo.com.br/vo\">\n";
	      		txt += "<acaoExecucao>N</acaoExecucao>\n";
	      		txt += "<mensagem>Usuário Indisponível Para Recepcionar Processos</mensagem>\n";
			txt += "<urlDestino>" + urlDestino + "</urlDestino>\n";
	      		txt += "</WFAcaoRetornoVO>\n";
	      		return txt;
	   	fi;
	
	  	Clean(txt);
		// Gerando Entrada Inclusao;
		txt = "<AtendimentoUsuarioAtualVO>\n";
		txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
		txt += "</AtendimentoUsuarioAtualVO>\n";
		
		paramAtdUs = txt;

	 	// Inclui o Atendimento Transferencia;
		AtdUsrAt = WFAtdUsuAtual.WFAtdUsAConsultar(paramAtdUs);
	
	  	Clean(txt);
		// Gerando Entrada Inclusao;
		txt = "<AtendimentoUsuarioAtualVO>\n";
		txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
		txt += "<idPessoaUsuario>" + idUsuAtual + "</idPessoaUsuario>\n";
		txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
		txt += "<inPausaAtendimento>1</inPausaAtendimento>\n";
		txt += "<dtFimPausaAtendimento>" + domAgendamento:dtContato + " " + domAgendamento:hrContato + "</dtFimPausaAtendimento>\n";
		txt += "</AtendimentoUsuarioAtualVO>\n";
	
		println(txt);
		paramAtdUs = txt;
		proxAndamento = 1;
		if (AtdUsrAt)

		 	// Atualiza o Usuario Atual;
			AtdActUsrAt = WFAtdUsuAtual.WFAtdUsAAlterar(paramAtdUs);
			
			// Atualiza o ultimo Andamento Transferencia
			xmlUltAndTrf = WFAndTrf.WFObtemAndTrf(paramAtdUs);
			
			if (xmlUltAndTrf)
				txtUltAnd = "<AtendimentoTransferenciaVO>\n";
				txtUltAnd += "<idAndamento>" + xmlUltAndTrf:idAndamento + "</idAndamento>\n";
				txtUltAnd += "<dtFinTransferencia>" + DATAATUAL + "</dtFinTransferencia>\n";
				txtUltAnd += "</AtendimentoTransferenciaVO>\n";
				
				paramUltAnd = txtUltAnd;
				xmlAltAndTrf = WFAndTrf.WFAndTrfAlterar(paramUltAnd);
			fi;
		
		else
			AtdActUsrAt = WFAtdUsuAtual.WFAtdUsAIncluir(paramAtdUs);
		fi;
				
	fi;
else
	// Gerando Entrada Inclusao;
	Clean(txt);
	txt = "<AtendimentoUsuarioAtualVO>\n";
	txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
	txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
	txt += "</AtendimentoUsuarioAtualVO>\n";
		
	paramAtdUsEx = txt;
	// Inclui o Atendimento Usuario Atual;
	AtdUsrAtEx = WFAtdUsuAtual.WFAtdUsAExcluir(paramAtdUsEx);
fi;

// Atualizando Grupo Atual;
Clean(txt);

int idNovoGrupo;
idNovoGrupo = domGrupo:idGrupo;

// Gerando Entrada Inclusao;
txt = "<AtendimentoGrupoAtualVO>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idGrupo>" + domGrupo:idGrupo + "</idGrupo>\n";
txt += "<dtEntradaFila>" + domAgendamento:dtContato + " " + domAgendamento:hrContato + "</dtEntradaFila>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>";
txt += "</AtendimentoGrupoAtualVO>\n";

println(txt);
paramAtdGr = txt;

// Inclui o Atendimento Transferencia;
AtdGrpAt = WFAtdGrupoAtual.WFAtdGrAAlterar(paramAtdGr);


// Obteniendo Grupo Atual;
Clean(txt);

// Gerando Entrada Inclusao;
txt = "<AtendimentoGrupoAtualVO>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "</AtendimentoGrupoAtualVO>\n";

parametro = txt;

XMLGen xmlObtemAtGrAt;

xmlObtemAtGrAt=WFAtdGrupoAtual.WFAtdGrAConsultar(parametro);

int idGrupoAtual;
idGrupoAtual = xmlObtemAtGrAt:idGrupo;

if (idGrupoAtual != idNovoGrupo)

	//********************** Grava Nivel Historico **********************
	Clean(txt);
	txt = "<GravaNivelEncaminhamento>\n" +
		      "<idAtendimento>" + idAtendimento + "</idAtendimento>\n" +
		      "<idGrupo>" + idGrupoAtual + "</idGrupo>\n" +
		      "<idFase>idFase</idFase>\n" +
		      "<idAtividade>" + idAtividade + "</idAtividade>\n" +
		      "<nrNivel>nrNivel</nrNivel>\n" +
		      "<dtNivel>" + DATAANDAMENTO + "</dtNivel>\n" +
		      "<idUsuarioAlteracao>" + usuario + "</idUsuarioAlteracao>\n" +
		      "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n" +
	      "</GravaNivelEncaminhamento>\n";
	
	parametro = txt;
	
	println("Vai incluir o nivel historico...");
	grupoAtual = WFAtdNivel.WFAtdNivIncluir(parametro);

fi;
// Eliminando Marcacao Suspeito;
Clean(txt);

// Gerando Entrada Inclusao;
txt = "<AtendimentoSuspeitoVO>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "</AtendimentoSuspeitoVO>\n";

paramSusp = txt;

// Inclui o Atendimento Transferencia;
ExcSusp = WFAtdSuspeito.WFAtdSuspExcluir(paramSusp);

//;
//************* Inclusao do Andamento ********************;
//;
Clean(txt);

// Gerando Parametro de Entrada para Metodo de Inclusao;
txt = "<AndamentoVO>\n";
txt += "<idAtividade>" + idAtividade + "</idAtividade>\n";
txt += "<idAgrupamentoEstadoTpProc>" + idAgrEstTPrFt + "</idAgrupamentoEstadoTpProc>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idPessoaUsuario>" + UsuarioAtual + "</idPessoaUsuario>\n";
txt += "<dtAndamento>" + DATAANDAMENTO + "</dtAndamento>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoVO>\n";

parametroAnd = txt;

// Inclui o atendimento;
AndamentoIns = WFAndamento.WFAndameIncluir(parametroAnd);
idAndamentoIns = AndamentoIns:idAndamento;

//;
//************* Atualiza Andamento Atual ********************;
//;
Clean(txt);

// Entrada para Alteracao;
txt = "<AndamentoAtualVO>";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoAtualVO>\n";

parametroAndAt = txt;

// Inclui o atendimento;
AndAtual = WFAtdAndAtual.WFAtdAnAAlterar(parametroAndAt);

//;
//********** Inclusao do Andamento Observacao *************;
//;
Clean(txt);

// Gerando Entrada Inclusao;
txt = "<AndamentoObservacaoVO>";
txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
txt += "<dsAndamentoObservacao>" + domWorkflow:dsObservacao + "</dsAndamentoObservacao>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoObservacaoVO>";

parametroAndOb = txt;

// Inclui o Atendimento Observacao;
Observacao = WFAndObservacao.WFAndObsIncluir(parametroAndOb);

// Atualizando Agendamento;
Clean(txt);

// Gerando Entrada Inclusao;
txt = "<AtendimentoAgendamentoVO>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<dtAtendimentoAgendamento>" + domAgendamento:dtContato + " " + domAgendamento:hrContato + "</dtAtendimentoAgendamento>\n";
txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "</AtendimentoAgendamentoVO>\n";

paramAtdAg = txt;

// Inclui o Atendimento Transferencia;
AtdAgendamento = WFAtdAge.WFAtdAgeIncluir(paramAtdAg);

if (proxAndamento > 0)
	//;
	//********** Inclusao do Andamento Transferencia *************;
	//;
	Clean(txt);
	
	// Gerando Entrada Inclusao;
	txt = "<AndamentoTransferenciaVO>\n";
	txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
	txt += "<idPessoaUsuario>" + UsuarioAtual + "</idPessoaUsuario>\n";
	txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
	txt += "<dtInicioTransferencia>" + domAgendamento:dtContato + " " + domAgendamento:hrContato + "</dtInicioTransferencia>\n";
	txt += "</AndamentoTransferenciaVO>\n";
	
	paramTrf = txt;
	
	// Inclui o Atendimento Transferencia;
	AndTrfInc = WFAndTrf.WFAndTrfIncluir(paramTrf);
fi;

//;
//********** Inclusao do Andamento Motivo *************;
//;
int idMotivo;
idMotivo = domMotivo:idMotivo;
if (idMotivo > 0)
	Clean(txt);
	
	// Gerando Entrada Inclusao;
	txt = "<AndamentoMotivoVO>";
	txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
	txt += "<idMotivo>" + domMotivo:idMotivo + "</idMotivo>\n";
	txt += "<idFase>" + idFase + "</idFase>\n";
	txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
	txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
	txt += "</AndamentoMotivoVO>";
	
	paramAndMot = txt;
	
	// Inclui o Atendimento Observacao;
	Motivo = WFAndMotivo.WFAndMotIncluir(paramAndMot);
fi;

//;
//*** FIM DE PROCESSO ***;
//;
Clean(txt);


//Retorna processamento;
txt = "<WFAcaoRetornoVO xmlns=\"workflow.fo.vivo.com.br/vo\">\n";
txt += "<acaoExecucao>S</acaoExecucao>\n";
txt += "<mensagem>Usuário Disponível</mensagem>\n";
txt += "<urlDestino>" + urlDestino + "</urlDestino>\n";
txt += "</WFAcaoRetornoVO>\n";


return txt;
                        
			