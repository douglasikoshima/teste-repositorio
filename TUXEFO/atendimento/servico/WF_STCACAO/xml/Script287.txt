
                        
//Imports;
#import WFAndamento:WFAndameIncluir;
#import WFAtdAndAtual:WFAtdAnAAlterar;
#import WFAndObservacao:WFAndObsIncluir;
#import WFCancSolic:WFCanSolIncluir;
#import WFCancSolic:WFCanSolAlterar;
#import WFCancSolic:WFCanSolConsultar;
#import WFAtdMensagem:WFAtdMsgIncluir;
#import WFAtdMensagem:WFObterAtdMsg;

//Definições;
DOMNODE domScript;
DOMNODE domWorkflow;
DOMNODE domTratWf;
DOMNODE parametro;
DOMNODE paramAlerta;
DOMNODE parametroAnd;
DOMNODE parametroAndAt;
DOMNODE parametroAndOb;

XMLGen AndAtual;
XMLGen AndamentoIns;
XMLGen Observacao;
XMLGen xmlCancelSol;
XMLGen xmlCancelAlt;
XMLGen xmlCancelIns;
XMLGen xmlAlerta;
XMLGen xmlAlertaAtiv;

string txt;
string urlDestino;
int UsuarioAtual;
int idAgrEstTPrAt;
int idAgrEstTPrFt;
int idAtividade;
int idAtendimento;
int idAtdCancel;
int idAndamentoIns;

SQL SELECT TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI') DATAATUAL FROM DUAL;
SQL SELECT TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI:SS') DATAANDAMENTO FROM DUAL;

domScript = XML:ScriptExecucaoVO;

UsuarioAtual = domScript:idPessoaUsuario;
idAtendimento = domScript:idAtendimento;
idAgrEstTPrFt = domScript:idAgrupamentoEstadoTProcFut;
idAgrEstTPrAt = domScript:idAgrupamentoEstadoTProcAt;
idAtividade = domScript:idAtividade;
urlDestino = domScript:nmUrlDestino;

domTratWf = XML:AtendimentoWorkflowVO;
domWorkflow = domTratWf:AtendimentoWorkflowComumVO;

txt = "<CancelamentoSolicitadoVO>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<dtSolicitacaoCancelamento>" + DATAATUAL + "</dtSolicitacaoCancelamento>\n";
txt += "<idPessoaUsuario>" + UsuarioAtual + "</idPessoaUsuario>\n";
txt += "</CancelamentoSolicitadoVO>\n";
parametro = txt;

// Inserendo cancelamento solicitado;
xmlCancelSol=WFCancSolic.WFCanSolConsultar(parametro); 
if (xmlCancelSol)
	idAtdCancel = xmlCancelSol:idAtendimento;
	if (idAtdCancel > 0)
		xmlCancelAlt=WFCancSolic.WFCanSolAlterar(parametro);
	else
		xmlCancelIns=WFCancSolic.WFCanSolIncluir(parametro);
	fi;
else
	xmlCancelIns=WFCancSolic.WFCanSolIncluir(parametro);
fi;

// Obtenemos la Aletra Asociada a la Atividade;
Clean(txt);
txt = "<AlertaAtividadeVO>\n";
txt += "<idAtividade>" + idAtividade + "</idAtividade>\n";
txt += "</AlertaAtividadeVO>\n";
parametro = txt;

// Se obtiene la Alerta;

xmlAlertaAtiv=WFAtdMensagem.WFObterAtdMsg(parametro);

txt = "<AtendimentoAlertaVO>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idMensagemAtendimento>" + xmlAlertaAtiv:idAlerta + "</idMensagemAtendimento>\n";
txt += "<dtAlerta>" + DATAATUAL + "</dtAlerta>\n";
txt += "<idPessoaUsuario>" + UsuarioAtual + "</idPessoaUsuario>\n";
txt += "</AtendimentoAlertaVO>\n";
paramAlerta = txt;

// Inserendo alerta;

xmlAlerta=WFAtdMensagem.WFAtdMsgIncluir(paramAlerta);

//;
//************* Inclusao do Andamento ********************;
//;
Clean(txt);

// Gerando Parametro de Entrada para Metodo de Inclusao;
txt = "<AndamentoVO>\n";
txt += "<idAtividade>" + idAtividade + "</idAtividade>\n";
txt += "<idAgrupamentoEstadoTpProc>" + idAgrEstTPrFt + "</idAgrupamentoEstadoTpProc>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idPessoaUsuario>" + UsuarioAtual + "</idPessoaUsuario>\n";
txt += "<dtAndamento>" + DATAANDAMENTO + "</dtAndamento>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoVO>\n";

parametroAnd = txt;

// Inclui o atendimento;
AndamentoIns = WFAndamento.WFAndameIncluir(parametroAnd);
idAndamentoIns = AndamentoIns:idAndamento;

//;
//************* Atualiza Andamento Atual ********************;
//;
Clean(txt);

// Entrada para Alteracao;
txt = "<AndamentoAtualVO>";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoAtualVO>\n";

parametroAndAt = txt;

// Inclui o atendimento;
AndAtual = WFAtdAndAtual.WFAtdAnAAlterar(parametroAndAt);

//;
//********** Inclusao do Andamento Observacao *************;
//;
Clean(txt);

// Gerando Entrada Inclusao;
txt = "<AndamentoObservacaoVO>";
txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
txt += "<dsAndamentoObservacao>" + domWorkflow:dsObservacao + "</dsAndamentoObservacao>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoObservacaoVO>";

parametroAndOb = txt;

// Inclui o Atendimento Observacao;
Observacao = WFAndObservacao.WFAndObsIncluir(parametroAndOb);

//;
//*** FIM DE PROCESSO ***;
//;
Clean(txt);


//Retorna processamento;
txt = "<WFAcaoRetornoVO xmlns=\"workflow.fo.vivo.com.br/vo\">\n";
txt += "<acaoExecucao>S</acaoExecucao>\n";
txt += "<mensagem>Solicitação de Cancelamento Concluída</mensagem>\n";
txt += "<urlDestino>" + urlDestino + "</urlDestino>\n";
txt += "</WFAcaoRetornoVO>\n";


return txt;
 
			