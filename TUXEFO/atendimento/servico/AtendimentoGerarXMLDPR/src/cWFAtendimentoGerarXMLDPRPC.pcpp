/**
 * @author  Cassio M Garcia
 * @version $Revision: 1.1 $
 * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:33:28 $
 **/

#undef SQLCA
#define SQLCA_NONE
#include<sqlca.h>
#include<sqlda.h>

#include "../../../commons/queryMacro.h"
//#include"../../../commons/msgPadrao.h"

#include "../include/cWFAtendimentoGerarXMLDPR.h"
#include "../include/stWFAtendimentoGerarXMLDPR.h"

void sql_error_WFAndamentoProcessoFODPR(sqlca*sqlca);

// Declara as estruturas compatíveis ao ProC.
EXEC SQL BEGIN DECLARE SECTION;
//    #include "../include/stWFAndamentoProcessoFODPR.h"
EXEC SQL END DECLARE SECTION;

int proCIncluirWFAndamentoProcFODPR(st_AndamentoProcFODPR* dados, st_AndamentoProcFODPR* status)
{
    ULOG_START( "proCIncluirWFAndamentoProcFODPR()" );

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;

        struct st_AndamentoProcFODPR *oDados = dados;
        struct st_AndamentoProcFODPR *oStatus = status;
        int idAndamentoProcessoFODPR;

    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO sql_error_WFAndamentoProcessoFODPR(&sqlca);

    EXEC SQL 
        SELECT 
            TIBCO_OW.ANDAMENTOPROCESSOFODPRSQ.NEXTVAL
        INTO
            :idAndamentoProcessoFODPR 
        FROM
            DUAL;

    EXEC SQL 
        INSERT INTO
            TIBCO_OW.ANDAMENTOPROCESSOFODPR
            (
                XML,
                IDUSUARIOALTERACAO,
                DTULTIMAALTERACAO
            )
            VALUES
            (
                SUBSTR(:oDados->xml,1,4000),
                DECODE(:oStatus->idUsuarioAlteracao,-1,1,:oDados->idUsuarioAlteracao),
                SYSDATE
            );

    ULOG_END( "proCIncluirWFAndamentoProcFODPR()" );

    return idAndamentoProcessoFODPR;
}

void sql_error_WFAndamentoProcessoFODPR(sqlca*sqlca)
{
    throw new TuxBasicOraException(sqlca->sqlcode
                                  ,sqlca->sqlerrm.sqlerrmc
                                  ,sqlca->sqlerrm.sqlerrml);
}
