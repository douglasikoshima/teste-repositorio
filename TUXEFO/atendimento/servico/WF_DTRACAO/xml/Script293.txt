// Devolver a Tratamento - Script 293
                        
//Imports;
#import WFAndamento:WFAndameIncluir;		// Atendimento.andamento
#import WFAtdAndAtual:WFAtdAnAAlterar;		// Atendimento.andamentoAtual
#import WFAndMotivo:WFAndMotIncluir;		// Atendimento.andamentoMotivo
#import WFAndObservacao:WFAndObsIncluir;	// Atendimento.andamentoObservacao
#import WFAtdSuspeito:WFAtdSuspExcluir;		// Atendimento.AtendimentoSuspeito
#import WFAtdBaixaAtual:WFAtdBxAExcluir;	// Atendimento.AtendimentoBaixaAtual
#import WFAtendimento:WFAtendiAlterar;		// Atendimento.Atendimento

//Definições;
DOMNODE domScript;
DOMNODE domWorkflow;
DOMNODE domTratWf;
DOMNODE domMotivo;
DOMNODE parametroAnd;
DOMNODE parametroAndAt;
DOMNODE parametroAndOb;
DOMNODE paramSusp;
DOMNODE parametroAndMt;
DOMNODE paramAtd;

XMLGen AndAtual;
XMLGen AndamentoIns;
XMLGen Observacao;
XMLGen ExcSusp;
XMLGen Motivo;
XMLGen AtdBxaAt;
XMLGen xmlAtendimento;

string txt;
string urlDestino;


int UsuarioAtual;
int idAgrEstTPrAt;
int idAgrEstTPrFt;
int idAtividade;
int idAtendimento;
int idAndamentoIns;
int idFase;

SQL SELECT TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI') DATAATUAL FROM DUAL;
SQL SELECT TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI:SS') DATAANDAMENTO FROM DUAL;

domScript = XML:ScriptExecucaoVO;

UsuarioAtual	= domScript:idPessoaUsuario;
idAtendimento	= domScript:idAtendimento;
idAgrEstTPrFt	= domScript:idAgrupamentoEstadoTProcFut;
idAgrEstTPrAt	= domScript:idAgrupamentoEstadoTProcAt;
idAtividade		= domScript:idAtividade;
idFase			= domScript:idFase;
urlDestino		= domScript:nmUrlDestino;

domTratWf		= XML:AtendimentoWorkflowVO;
domWorkflow		= domTratWf:AtendimentoWorkflowComumVO;
domMotivo		= domWorkflow:WFMotivoVO;

// Eliminando Marcacao Suspeito;
// Gerando Entrada Inclusao;
txt = "<AtendimentoSuspeitoVO>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "</AtendimentoSuspeitoVO>\n";

paramSusp = txt;

// Inclui o Atendimento Transferencia;
ExcSusp = WFAtdSuspeito.WFAtdSuspExcluir(paramSusp);

// Exclui o Atendimento Baixa Atual;
AtdBxaAt = WFAtdBaixaAtual.WFAtdBxAExcluir(paramSusp);

// Atualizando Atendimento;
Clean(txt);

// Gerando Entrada Inclusao;
txt = "<AtendimentoVO>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idFase>2</idFase>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "</AtendimentoVO>\n";

paramAtd = txt;

// Atualizando Atendimento;
xmlAtendimento = WFAtendimento.WFAtendiAlterar(paramAtd);

//;
//************* Inclusao do Andamento ********************;
//;
Clean(txt);

// Gerando Parametro de Entrada para Metodo de Inclusao;
txt = "<AndamentoVO>\n";
txt += "<idAtividade>" + idAtividade + "</idAtividade>\n";
txt += "<idAgrupamentoEstadoTpProc>" + idAgrEstTPrFt + "</idAgrupamentoEstadoTpProc>\n";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idPessoaUsuario>" + UsuarioAtual + "</idPessoaUsuario>\n";
txt += "<dtAndamento>" + DATAANDAMENTO + "</dtAndamento>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoVO>\n";

parametroAnd = txt;

// Inclui o atendimento;
AndamentoIns = WFAndamento.WFAndameIncluir(parametroAnd);
idAndamentoIns = AndamentoIns:idAndamento;

//;
//************* Atualiza Andamento Atual ********************;
//;
Clean(txt);

// Entrada para Alteracao;
txt = "<AndamentoAtualVO>";
txt += "<idAtendimento>" + idAtendimento + "</idAtendimento>\n";
txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoAtualVO>\n";

parametroAndAt = txt;

// Inclui o atendimento;
AndAtual = WFAtdAndAtual.WFAtdAnAAlterar(parametroAndAt);

//;
//********** Inclusao do Andamento Observacao *************;
//;
Clean(txt);

// Gerando Entrada Inclusao;
txt = "<AndamentoObservacaoVO>";
txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
txt += "<dsAndamentoObservacao>" + domWorkflow:dsObservacao + "</dsAndamentoObservacao>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoObservacaoVO>";

parametroAndOb = txt;

// Inclui o Atendimento Observacao;
Observacao = WFAndObservacao.WFAndObsIncluir(parametroAndOb);

//;
//********** Inclusao do Andamento Motivo *************;
//;
Clean(txt);

// Gerando Entrada Inclusao;
txt = "<AndamentoMotivoVO>";
txt += "<idAndamento>" + idAndamentoIns + "</idAndamento>\n";
txt += "<idMotivo>" + domMotivo:idMotivo + "</idMotivo>\n";
txt += "<idFase>" + idFase + "</idFase>\n";
txt += "<idUsuarioAlteracao>" + UsuarioAtual + "</idUsuarioAlteracao>\n";
txt += "<dtUltimaAlteracao>" + DATAATUAL + "</dtUltimaAlteracao>\n";
txt += "</AndamentoMotivoVO>";

parametroAndMt = txt;

// Inclui o Atendimento Observacao;
Motivo = WFAndMotivo.WFAndMotIncluir(parametroAndMt);

//;
//*** FIM DE PROCESSO ***;
//;
Clean(txt);


//Retorna processamento;
txt = "<WFAcaoRetornoVO xmlns=\"workflow.fo.vivo.com.br/vo\">\n";
txt += "<acaoExecucao>S</acaoExecucao>\n";
txt += "<mensagem>Devolução a Tratamento Concluída</mensagem>\n";
txt += "<urlDestino>" + urlDestino + "</urlDestino>\n";
txt += "</WFAcaoRetornoVO>\n";


return txt; 
			