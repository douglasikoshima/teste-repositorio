 /**
 * @modulo  Atendimento
 * @author  Unknowed
 * @version $Revision: 1.1 $
 * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:34:06 $
 **/

#undef SQLCA
#define SQLCA_NONE
#include<sqlca.h>
#include<sqlda.h>

#include <tuxfw.h>

#include"../../../commons/queryMacro.h"

void sql_error_WFPesquisaTabelaTipoSequencia(sqlca*sqlca);

bool proCPesquisaTabelaTipoSequencia( DOMNode*entrada,XMLGen* saida )
{
	TuxHelper tx;
    char *p = entrada ? tx.walkTree( entrada, "idTabelaTipoSequencia", 0 ) : 0;
	struct sqlca sqlca;

   EXEC SQL BEGIN DECLARE SECTION;

		int idTabelaTipoSequencia = 0;

		int idTipoSequencia;
		VARCHAR dsTipoSequencia[256];

		short i_idTipoSequencia;
		short i_dsTipoSequencia;
		
      char query[1025];

   EXEC SQL END DECLARE SECTION;

   if ( p )
   {
     idTabelaTipoSequencia = atoi(p);
     XMLString::release(&p);
   }

   if ( idTabelaTipoSequencia > 0 )
   {
      strcpy( query, "SELECT idTipoSequencia, nmTipoSequencia "
                       "FROM ContatoAdm.TipoSequencia "
                      "WHERE idTipoSequencia = :idTabelaTipoSequencia ");
   }
   else
   {
      strcpy( query, "SELECT idTipoSequencia, nmTipoSequencia "
                       "FROM ContatoAdm.TipoSequencia "
                      "WHERE idTipoSequencia > 0" );
   }
   
   EXEC SQL WHENEVER SQLERROR  DO sql_error_WFPesquisaTabelaTipoSequencia(&sqlca);
   EXEC SQL WHENEVER NOT FOUND DO BREAK;

   EXEC SQL PREPARE consultaTipoSequencia FROM :query;
   EXEC SQL DECLARE consulta CURSOR FOR consultaTipoSequencia;
   
   EXEC SQL OPEN consulta;
   while (true)
	{
		EXEC SQL FETCH consulta INTO idTipoSequencia:i_idTipoSequencia, 
		                             dsTipoSequencia:i_dsTipoSequencia;

      CONVIND( dsTipoSequencia,i_dsTipoSequencia );
      
      saida->createTag("WFEstadoVO");
      	saida->addItem( "idEstado",idTipoSequencia );
      	saida->addItem( "dsEstado",(char *)dsTipoSequencia.arr );
      saida->closeTag();

   }
   EXEC SQL CLOSE consulta;
      
	return true;

}


void sql_error_WFPesquisaTabelaTipoSequencia(sqlca*sqlca)
{
    ULOGE("sql_error_WFAtdInBoxAdq:sqlcode=%d,sqlerrmc=%.70s"
                            ,sqlca->sqlcode
                            ,sqlca->sqlerrm.sqlerrmc);

	throw new TuxBasicOraException(sqlca->sqlcode,sqlca->sqlerrm.sqlerrmc,sqlca->sqlerrm.sqlerrml);
}
