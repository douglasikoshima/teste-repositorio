 /**
 * @modulo  Atendimento
 * @author  Unknowed
 * @version $Revision: 1.1 $
 * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:34:23 $
 **/

#undef SQLCA
#define SQLCA_NONE
#include<sqlca.h>
#include<sqlda.h>

#include <tuxfw.h>

#include"../../../commons/queryMacro.h"

void sql_error_WFPesquisaTabelaTipoCarteira(sqlca*sqlca);



bool proCPesquisaTabelaTipoCarteira( DOMNode*entrada,XMLGen* saida )
{
	TuxHelper tx;
    char *p = entrada ? tx.walkTree( entrada, "idTabelaTipoCarteira", 0 ) : 0;
	struct sqlca sqlca;

   EXEC SQL BEGIN DECLARE SECTION;

		int idTabelaTipoCarteira = 0;

		int idTipoCarteira;
		VARCHAR dsTipoCarteira[256];

		short i_idTipoCarteira;
		short i_dsTipoCarteira;
		
      char query[1025];

   EXEC SQL END DECLARE SECTION;

   if ( p )
   {
      idTabelaTipoCarteira = atoi(p);
      XMLString::release(&p);
   }

   if ( idTabelaTipoCarteira > 0 )
    {
        strcpy(query, "SELECT idTipoCarteira, dsTipoCarteira "
                      "FROM Apoio.TipoCarteira "
                     "WHERE idTipoCarteira = :idTabelaTipoCarteira "
                     "ORDER BY UPPER(dsTipoCarteira)");
    }
   else
    {
      strcpy(query, "SELECT idTipoCarteira, dsTipoCarteira "
                      "FROM Apoio.TipoCarteira "
                     "WHERE idTipoCarteira > 0 "
                     "ORDER BY UPPER(dsTipoCarteira)");
    }
   
   EXEC SQL WHENEVER SQLERROR  DO sql_error_WFPesquisaTabelaTipoCarteira(&sqlca);
   EXEC SQL WHENEVER NOT FOUND DO BREAK;

   EXEC SQL PREPARE consultaTipoCarteira FROM :query;
   EXEC SQL DECLARE consulta CURSOR FOR consultaTipoCarteira;
   
   EXEC SQL OPEN consulta;

   while (true)
	{
		EXEC SQL FETCH consulta INTO idTipoCarteira:i_idTipoCarteira, 
		                             dsTipoCarteira:i_dsTipoCarteira;

      CONVIND( dsTipoCarteira,i_dsTipoCarteira );
      
      saida->createTag("WFRelatoriosFiltroCarteiraVO");
      	saida->addItem( "idCarteira",idTipoCarteira );
      	saida->addItem( "dsCarteira",(char *)dsTipoCarteira.arr );
      saida->closeTag();
   }
   EXEC SQL CLOSE consulta;
      
	return true;

}


void sql_error_WFPesquisaTabelaTipoCarteira(sqlca*sqlca)
{
    ULOGE("sql_error_WFAtdInBoxAdq:sqlcode=%d,sqlerrmc=%.70s"
                            ,sqlca->sqlcode
                            ,sqlca->sqlerrm.sqlerrmc);

	throw new TuxBasicOraException(sqlca->sqlcode,sqlca->sqlerrm.sqlerrmc,sqlca->sqlerrm.sqlerrml);
}
