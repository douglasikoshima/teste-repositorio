/**
 * 
 * @modulo  Atendimento
 * @usecase Protocolo
 * @author  Cassio Garcia
 * @version $Revision: 1.1 $
 * @CVS     $Author: a5110702 $ - $Date: 2009/07/31 15:33:42 $
 **/

#include "../include/cWfAtdFechaProtPC.h"
#include "../../../commons/cWfAtdProtocoloException.h"
#include "../../../commons/queryMacro.h"
#include "../../../commons/definesAtendimento.h"

EXEC SQL BEGIN DECLARE SECTION;
    #include "../include/stWfAtdFechaProt.h"
EXEC SQL END DECLARE SECTION;

void cWfAtdFechaProtPC::FecharProtocolo(st_DadosEntrada *dados,st_StatusEntrada *status)
{
    ULOG_START("cWfAtdFechaProtPC::FecharProtocolo(st_DadosEntrada *dados,st_StatusEntrada *status)");

    EXEC SQL BEGIN DECLARE SECTION;
        struct st_DadosEntrada *pOraDados = dados;
        struct st_StatusEntrada *pOraStatus = status;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO sql_error_WfAtdFechaProtPC();
    EXEC SQL WHENEVER NOT FOUND CONTINUE;

    ULOG("idAtendimentoProtocolo=%s",pOraDados->idAtendimentoProtocolo);

    EXEC SQL
        UPDATE
            ATENDIMENTO.ATENDIMENTOPROTOCOLO
        SET
            DTENCERRAMENTO = SYSTIMESTAMP,
            IDUSUARIOALTERACAO = :pOraDados->idUsuarioAlteracao,
            DTULTIMAALTERACAO = SYSDATE
        WHERE
            IDATENDIMENTOPROTOCOLO = 
                :pOraDados->idAtendimentoProtocolo:pOraStatus->idAtendimentoProtocolo;

    EXEC SQL
        UPDATE
            ATENDIMENTO.FILASMSPROTOCOLO
        SET
            DTENCERRAMENTO = SYSTIMESTAMP,
            IDUSUARIOALTERACAO = :pOraDados->idUsuarioAlteracao,
            DTULTIMAALTERACAO = SYSTIMESTAMP
        WHERE
            IDATENDIMENTOPROTOCOLO = 
                :pOraDados->idAtendimentoProtocolo:pOraStatus->idAtendimentoProtocolo;

    ULOG_END("cWfAtdFechaProtPC::FecharProtocolo(st_DadosEntrada *dados,st_StatusEntrada *status)");
}

void cWfAtdFechaProtPC::sql_error_WfAtdFechaProtPC()
{
    throw new TuxBasicOraException(sqlca.sqlcode
                                  ,sqlca.sqlerrm.sqlerrmc
                                  ,sqlca.sqlerrm.sqlerrml);
}
