/**
 * 
 * @modulo  Workflow
 * @usecase Workflow
 * @author  Cassio M Garcia
 * @version $Revision: 1.1.2.2 $
 * @CVS     $Author: a5116174 $ - $Date: 2011/08/12 17:11:35 $
 **/

#undef SQLCA
#define SQLCA_NONE
#include <sqlca.h>
#include <sqlda.h>

#include "../../../commons/queryMacro.h"
#include "../../../commons/msgPadrao.h"
#include "../include/cWFCoreWorkflow.h"

void WFCoreWorkflowErro(sqlca*sqlca);

bool proCIsGrupoUsuarioMC(long _idAtendimento,unsigned long _idPessoaUsuarioWeb)
{
    ULOG_START("proCIsGrupoUsuarioMC()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        long idAtendimento = _idAtendimento;
        unsigned long idPessoaUsuarioWeb = _idPessoaUsuarioWeb;
        int varOraCount=1;

        VARCHAR varOraIdGrupoAtual[39];
        short statOraIdGrupoAtual=-1;

    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);
    EXEC SQL WHENEVER NOT FOUND CONTINUE;

    EXEC SQL 
        SELECT
            IDGRUPOATUAL
        INTO
            :varOraIdGrupoAtual:statOraIdGrupoAtual
        FROM
            Atendimento.Atendimento
        WHERE
            idAtendimento = :idAtendimento
        AND sgRegraEncaminhamento = 'MC';

    if ( sqlca.sqlcode==0 )
    {
        CONVIND(varOraIdGrupoAtual,statOraIdGrupoAtual);

        EXEC SQL 
            SELECT
                COUNT(1)
            INTO
                :varOraCount
            FROM
                ACESSO.USUARIOGRUPO
            WHERE
                IDPESSOAUSUARIO = :idPessoaUsuarioWeb
            AND IDGRUPO = :varOraIdGrupoAtual;
    }

    ULOG_END("proCIsGrupoUsuarioMC()");

    return (bool)varOraCount;
}

bool proCAtendimentoCri(long _idAtendimento)
{
    ULOG_START("proCAtendimentoCri()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        long idAtendimento = _idAtendimento;
        int isCri;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);

    EXEC SQL 
        SELECT COUNT(1) 
          INTO :isCri
          FROM Atendimento.GrupoCri 
         WHERE idAtendimento = :idAtendimento;

    ULOG_END("proCAtendimentoCri()");

    return isCri == 0 ? false : true;
}

int proCObterInSupervisor( int _idGrupo,int _idUsuario )
{
    ULOG_START("proCObterInSupervisor()");

    int statusUsuario;

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idGrupo = _idGrupo;
        int idPessoaUsuario = _idUsuario;

        int inSupervisor;
        short i_inSupervisor = -1;
    EXEC SQL END DECLARE SECTION;
   
    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);

    ULOG("SELECT INSUPERVISOR "
           "FROM ACESSO.USUARIOGRUPO "
          "WHERE IDPESSOAUSUARIO=%d "
            "AND IDGRUPO=%d",idPessoaUsuario,idGrupo);
   EXEC SQL 
        SELECT
            INSUPERVISOR
        INTO
            inSupervisor:i_inSupervisor
        FROM
            ACESSO.USUARIOGRUPO
        WHERE
            IDPESSOAUSUARIO = :idPessoaUsuario
        AND
            IDGRUPO = :idGrupo;

    if ( sqlca.sqlcode == 1403 )
    {
        statusUsuario = STU_USUARIO_ESTRANHO_AO_GRUPO;
    }
    else if ( inSupervisor )
    {
        statusUsuario = STU_USUARIO_SUPERVISOR;
    }
    else
    {
        statusUsuario = STU_USUARIO_COMUM;
    }

    ULOG_END("proCObterInSupervisor()");

    return statusUsuario;
}

bool proCObterGrupoFase( int _idContato, int _idGrupo, int _idFase )
{
    ULOG_START("proCObterGrupoFase()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idContato = _idContato;
        int idGrupo = _idGrupo;
        int idFase = _idFase;

        int inTotal = 0;
        short i_inTotal = -1;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);

    ULOG("SELECT "
           "COUNT(1) "
         "FROM "
             "ATENDIMENTO.SEQUENCIAV01 "
         "WHERE "
             "IDCONTATO = :%d "
         "AND "
             "IDGRUPO = %d "
         "AND "
             "IDTIPOSEQUENCIA = %d "
         "AND "
             "DTEXCLUSAOSEQ IS NULL "
         "AND "
             "DTEXCLUSAOGRP IS NULL",idContato,idGrupo,idFase);

    EXEC SQL
    SELECT
        COUNT(1)
    INTO
        inTotal:i_inTotal
    FROM
        ATENDIMENTO.SEQUENCIAV01
    WHERE
        IDCONTATO = :idContato
    AND
        IDGRUPO = :idGrupo
    AND
        IDTIPOSEQUENCIA = :idFase
    AND
        DTEXCLUSAOSEQ IS NULL
    AND
        DTEXCLUSAOGRP IS NULL;

    ULOG_END("proCObterGrupoFase()");

    return inTotal == 0 ? false : true;
}


bool proCObterGrupoCri( int _idContato, int _idGrupo )
{
    ULOG_START("proCObterGrupoCri()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
            int idContato = _idContato;
            int idGrupo = _idGrupo;
    
            int inTotal = 0;
        short i_inTotal = -1;
    EXEC SQL END DECLARE SECTION;
   
    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);


    EXEC SQL SELECT
        COUNT(CP.IDCONTATOPERFIL)
    INTO
        inTotal:i_inTotal
    FROM
        CONTATOADM.CONTATOPERFIL CP,
        CONTATOADM.GRUPOPERFIL PG
    WHERE
        CP.IDGRUPOPERFIL = PG.IDGRUPOPERFIL
    AND
        CP.IDCONTATO = :idContato
    AND
        PG.IDGRUPO = :idGrupo;
        
    ULOG_END("proCObterGrupoCri()");

    return inTotal == 0 ? false : true;
}

bool proCGrupoEmFaseTratamentoSimNao( int _idGrupo, int _idContato )
{
    ULOG_START("proCGrupoEmFaseTratamentoSimNao()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idContato = _idContato;
        int idGrupo = _idGrupo;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);

    EXEC SQL
        SELECT 
             TIPOSEQUENCIA.IDTIPOSEQUENCIA
        FROM
             CONTATOADM.CONTATOGRUPO CONTATOGRUPO
            ,CONTATOADM.SEQUENCIA SEQUENCIA
            ,CONTATOADM.TIPOSEQUENCIA TIPOSEQUENCIA
        WHERE
             CONTATOGRUPO.IDCONTATO = :idContato
        AND
             CONTATOGRUPO.IDGRUPO = :idGrupo
        AND
             CONTATOGRUPO.IDCONTATOGRUPO = SEQUENCIA.IDCONTATOGRUPO
        AND
             SEQUENCIA.IDTIPOSEQUENCIA = TIPOSEQUENCIA.IDTIPOSEQUENCIA
        AND      
             TIPOSEQUENCIA.IDTIPOSEQUENCIA = 2; // 2=FASE TRATAMENTO

    ULOG_END("proCGrupoEmFaseTratamentoSimNao()");

    return sqlca.sqlcode == 0 ? true : false;
}

bool proCGrupoEmFaseRetornoSimNao( int _idGrupo, int _idContato )
{
    ULOG_START("proCGrupoEmFaseRetornoSimNao()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idContato = _idContato;
        int idGrupo = _idGrupo;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);

    EXEC SQL
        SELECT 
             TIPOSEQUENCIA.IDTIPOSEQUENCIA
        FROM
             CONTATOADM.CONTATOGRUPO CONTATOGRUPO
            ,CONTATOADM.SEQUENCIA SEQUENCIA
            ,CONTATOADM.TIPOSEQUENCIA TIPOSEQUENCIA
        WHERE
             CONTATOGRUPO.IDCONTATO = :idContato
        AND
             CONTATOGRUPO.IDGRUPO = :idGrupo
        AND
             CONTATOGRUPO.IDCONTATOGRUPO = SEQUENCIA.IDCONTATOGRUPO
        AND
             SEQUENCIA.IDTIPOSEQUENCIA = TIPOSEQUENCIA.IDTIPOSEQUENCIA
        AND      
             TIPOSEQUENCIA.IDTIPOSEQUENCIA = 3; // 3=FASE RETORNO
    
    ULOG_END("proCGrupoEmFaseRetornoSimNao()");

    return sqlca.sqlcode == 0 ? true : false;
}

bool proCGrupoEmFaseTratRetornoSimNao( int _idGrupo, int _idContato )
{
    ULOG_START("proCGrupoEmFaseTratRetornoSimNao()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idContato = _idContato;
        int idGrupo = _idGrupo;
        int nLin;
        short i_nLin;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);
    EXEC SQL
        SELECT 
             COUNT(1)
        INTO
             nLin:i_nLin
        FROM
             CONTATOADM.CONTATOGRUPO CONTATOGRUPO
            ,CONTATOADM.SEQUENCIA SEQUENCIA
            ,CONTATOADM.TIPOSEQUENCIA TIPOSEQUENCIA
        WHERE
             CONTATOGRUPO.IDCONTATO = :idContato
        AND
             CONTATOGRUPO.IDGRUPO = :idGrupo
        AND
             CONTATOGRUPO.IDCONTATOGRUPO = SEQUENCIA.IDCONTATOGRUPO
        AND
             SEQUENCIA.IDTIPOSEQUENCIA = TIPOSEQUENCIA.IDTIPOSEQUENCIA
        AND      
             TIPOSEQUENCIA.IDTIPOSEQUENCIA IN (2,3);

    ULOG_END("proCGrupoEmFaseTratRetornoSimNao()");

    return ( sqlca.sqlcode == 0 && nLin == 2 ) ? true : false;
}

bool proCGrupoCRISimNao(int _idGrupo)
{
    ULOG_START("proCGrupoCRISimNao()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idGrupo = _idGrupo;
        int isCRI;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);
    EXEC SQL
        SELECT 
             COUNT(1)
        INTO
            :isCRI
        FROM
             ACESSO.GRUPO GRUPO
            ,APOIO.TIPOGRUPO TIPOGRUPO
        WHERE
             GRUPO.IDGRUPO = :idGrupo
        AND
             GRUPO.IDTIPOGRUPO = TIPOGRUPO.IDTIPOGRUPO
        AND
             TIPOGRUPO.CDTIPOGRUPO = 'CRI';

    ULOG_END("proCGrupoCRISimNao()");

    return ( sqlca.sqlcode == 0 && isCRI == 1 ) ? true : false;
}

bool proCAtividadeDisponivelCRISimNao(int _idAtividade,int _idAgrupamentoEstadoTpProc)
{
    ULOG_START("proCAtividadeDisponivelCRISimNao()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idAtividade = _idAtividade;
        int idAgrupamentoEstadoTpProc = _idAgrupamentoEstadoTpProc;
        int numAtividade;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);
    EXEC SQL
        SELECT
            COUNT(1)
        INTO
            :numAtividade
        FROM 
            WORKFLOW.FLUXOACOESBKOV01
        WHERE           
            IDATIVIDADE = :idAtividade
        AND 
            IDAGRUPAMENTOESTADOTPPROC = :idAgrupamentoEstadoTpProc
        /* AND IDTIPORELACIONAMENTOBKO = :idTipoRelacionamentoBko */
        AND 
            ROWNUM < 2;

    ULOG_END("proCAtividadeDisponivelCRISimNao()");

    return numAtividade ? true : false;
}

bool proCAtividadeDisponivelRCSimNao(int _idAtividade,int _idAgrupamentoEstadoTpProc)
{
    ULOG_START("proCAtividadeDisponivelRCSimNao()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idAtividade = _idAtividade;
        int idAgrupamentoEstadoTpProc = _idAgrupamentoEstadoTpProc;
        int numAtividade;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);
    EXEC SQL
        SELECT
            COUNT(1)
        INTO
            :numAtividade
        FROM 
            WORKFLOW.FLUXOACOESRCV01
        WHERE           
            IDATIVIDADE = :idAtividade
        AND 
            IDAGRUPAMENTOESTADOTPPROC = :idAgrupamentoEstadoTpProc
       /*/--AND IDTIPORELACIONAMENTOBKO = :idTipoRelacionamentoBko */
        AND 
            ROWNUM  < 2;

    ULOG_END("proCAtividadeDisponivelRCSimNao()");

    return numAtividade ? true : false;
}

bool proCIsMotivoCancelamento(int _idMotivo)
{
    ULOG_START("proCIsMotivoCancelamento()");

    static bool jaExecutou = false;
    static bool retorno = false;
    
    if ( jaExecutou )
    { // como para um lote de processos o motivo é sempre o mesmo, não há necessidade de ir ao banco
      // novamente para testar o mesmo mootivo e dá pra aproveitar o retorno anterior.
        return retorno;
    }

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idMotivo = _idMotivo;
        VARCHAR dsMotivo[256];
        short i_dsMotivo = -1;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);

    EXEC SQL
    SELECT
        UPPER(DSMOTIVO)
    INTO
        :dsMotivo:i_dsMotivo
    FROM
        ATENDIMENTO.MOTIVO
    WHERE
        IDMOTIVO = :idMotivo;

    if ( !sqlca.sqlcode )
    {
        CONVIND(dsMotivo,i_dsMotivo);

        if ( strstr((char*)dsMotivo.arr,"CANCELADO") )
        {
            retorno = true;
        }

        jaExecutou = true; // evita re-execução
    }

    ULOG_END("proCIsMotivoCancelamento()");

    return retorno;
}

bool proCAtividadeDisponivelSimNao(int _idAtividade,int _idAgrupamentoEstadoTpProc,int _idContato)
{
    ULOG_START("proCAtividadeDisponivelSimNao()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idAtividade = _idAtividade;
        int idContato = _idContato;
        int idAgrupamentoEstadoTpProc = _idAgrupamentoEstadoTpProc;
        int numAtividade;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);
    EXEC SQL
    SELECT
        COUNT(1)
    INTO
        :numAtividade
    FROM 
        WORKFLOW.FLUXOACOESBKOV01
    WHERE 
        IDCONTATO = :idContato
    AND 
        IDATIVIDADE = :idAtividade
    AND 
        IDAGRUPAMENTOESTADOTPPROC = :idAgrupamentoEstadoTpProc
    // AND IDAGRUPAMENTOESTADOTPPROCFT = :idAgrupamentoEstadoTpProcFt
    // AND IDFASE = :idFase
    // AND IDTIPORELACIONAMENTOBKO = :idTipoRelacionamento;
    AND 
        ROWNUM < 2;

    ULOG_END("proCAtividadeDisponivelSimNao()");

    return numAtividade ? true : false;
}

bool proCAtividadeDisponivelPOutSimNao(int _idAtividade,int _idAgrupamentoEstadoTpProc)
{
    ULOG_START("proCAtividadeDisponivelPOutSimNao()");

    struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
        int idAtividade = _idAtividade;
        int idAgrupamentoEstadoTpProc = _idAgrupamentoEstadoTpProc;
        int numAtividade;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFCoreWorkflowErro(&sqlca);

    EXEC SQL
        SELECT
            COUNT(1)
        INTO
            :numAtividade
        FROM 
            WORKFLOW.FLUXOACOESPOUTV01 FLUXOACOESPOUTV01,
            APOIO.TIPORELACIONAMENTOBKO TIPORELACIONAMENTOBKO
        WHERE
            FLUXOACOESPOUTV01.IDATIVIDADE = :idAtividade
        AND FLUXOACOESPOUTV01.IDAGRUPAMENTOESTADOTPPROC = :idAgrupamentoEstadoTpProc
        AND FLUXOACOESPOUTV01.IDTIPORELACIONAMENTOBKO = TIPORELACIONAMENTOBKO.IDTIPORELACIONAMENTOBKO
        AND TIPORELACIONAMENTOBKO.DSTIPORELACIONAMENTOBKO  = 'ANALISTA DE RETENÇÃO'
        AND ROWNUM < 2;

    ULOG_END("proCAtividadeDisponivelPOutSimNao()");

    return numAtividade ? true : false;
}

void WFCoreWorkflowErro(sqlca*sqlca)
{
    if ( sqlca->sqlcode == 1403 )
    {
        return;
    }

    ULOGE("WFCoreWorkflowErro:sqlcode=%d,sqlerrmc=%.70s"
                              ,sqlca->sqlcode
                              ,sqlca->sqlerrm.sqlerrmc);

    throw new TuxBasicOraException(sqlca->sqlcode
                                  ,sqlca->sqlerrm.sqlerrmc
                                  ,sqlca->sqlerrm.sqlerrml);
}
