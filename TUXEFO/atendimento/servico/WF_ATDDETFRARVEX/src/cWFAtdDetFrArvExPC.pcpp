/**
 * 
 * @modulo  Workflow
 * @usecase Workflow
 * @author  Cassio M Garcia
 * @version $Revision: 1.1.2.1 $
 * @CVS     $Author: a5116174 $ - $Date: 2011/08/12 17:11:19 $
 **/

#undef SQLCA
#define SQLCA_NONE
#include <sqlca.h>
#include <sqlda.h>

#include "../../../commons/queryMacro.h"
#include "../../../commons/msgPadrao.h"
#include "../include/cWFAtdDetFrArvEx.h"

void WFAtdDetFrArvError(sqlca*sqlca);

void obtemObservacaoAtendimento(long _idAtendimento, XMLGen*xml_g)
{
	ULOG_START("obtemObservacaoAtendimento()");
	struct sqlca sqlca;

    EXEC SQL BEGIN DECLARE SECTION;
		long idAtendimento = _idAtendimento;
		VARCHAR dsObservacao[1001];
		short i_dsObservacao = -1;
    EXEC SQL END DECLARE SECTION;

    EXEC SQL WHENEVER SQLERROR DO WFAtdDetFrArvError(&sqlca);
    EXEC SQL WHENEVER NOT FOUND CONTINUE;

	EXEC SQL
	    SELECT 
		    DSOBSERVACAO
	    INTO
		    dsObservacao:i_dsObservacao
	    FROM 
		    FOHIST_OW.ATENDIMENTO
	    WHERE
		    IDATENDIMENTO = :idAtendimento;

	CONVIND(dsObservacao,i_dsObservacao)

	xml_g->addItem( "observacao" , (char*)dsObservacao.arr);

	ULOG_END("obtemObservacaoAtendimento()");
}



void WFAtdDetFrArvError(sqlca*sqlca)
{
    ULOGE("WFAtdDetFrArv:sqlcode=%d,sqlerrmc=%.70s"
                              ,sqlca->sqlcode
                              ,sqlca->sqlerrm.sqlerrmc);

    throw new TuxBasicOraException(sqlca->sqlcode
                                  ,sqlca->sqlerrm.sqlerrmc
                                  ,sqlca->sqlerrm.sqlerrml);
}
