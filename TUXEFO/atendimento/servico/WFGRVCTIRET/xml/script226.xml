

#import WFRetWFCTI:SetUser;
#import WFGRetWFCTI:SetUser;
#import WFRetWFCTI:InsertWFRetWFCTI;
#import WFGRetWFCTI:InsertWFGRetWFCTI;
#import WFRetWFCTI:UpdateWFRetWFCTI;
#import WFRetWFCTI:DeleteWFRetWFCTI;
#import WFGRetWFCTI:DeleteWFGRetWFCTIByID;

RECORDSET rs;
int ind;
int usr;
int idg;
XMLGen xml;
XMLGen dmy;
XMLGen sub;
DOMNODE dom;
DOMNODE parm;
string str;

usr=GetHdrData("user");

WFRetWFCTI.SetUser(usr);
WFGRetWFCTI.SetUser(usr);

ind=XML:operacao;
usr=XML:inPadrao;

if(usr&&!ind||ind==1)

	//Check Type
	if(!ind)
		str="SELECT count(*) ind FROM workflow.retornowfctib00 WHERE inpadrao=1";
	else
		idg=XML:idRetornoWFCTI;
		str="SELECT count(*) ind FROM workflow.retornowfctib00 WHERE inpadrao=1 AND idretornowfcti!=:idg";
	fi;
	rs=OpenRecordset(str);
	idg=rs.RowCount();
	if(idg)
		throw("00E4567","Item padrão já existe");
	fi;

fi;

if(!ind)

	xml=WFRetWFCTI.InsertWFRetWFCTI(XML);
	str="<idRetornoWFCTI>"+xml:idRetornoWFCTI+"</idRetornoWFCTI>";
	Clean(xml);
	parm=str;
	xml=FncC(225,parm);

else if(ind==1)

	ind=XML:inPadrao;
	xml=WFRetWFCTI.UpdateWFRetWFCTI(XML);
	dmy=WFGRetWFCTI.DeleteWFGRetWFCTIByID(XML);
	ind=XML:idRetornoWFCTI;
	while(dom=XML:WFGrupoSelecionadoVO)

		idg=dom:idGrupo;
		sub="<r><idRetornoWFCTI>"+ind+"</idRetornoWFCTI>"+
			"<idUsuarioGrupo>"+idg+"</idUsuarioGrupo></r>";
		parm=sub;
		dmy=WFGRetWFCTI.InsertWFGRetWFCTI(parm);

	loop;
	str="<idRetornoWFCTI>"+xml:idRetornoWFCTI+"</idRetornoWFCTI>";
	Clean(xml);
	parm=str;
	xml=FncC(225,parm);

else

	dmy=WFGRetWFCTI.DeleteWFGRetWFCTIByID(XML);
	xml=WFRetWFCTI.DeleteWFRetWFCTI(XML);

fi;

return xml;
      

            