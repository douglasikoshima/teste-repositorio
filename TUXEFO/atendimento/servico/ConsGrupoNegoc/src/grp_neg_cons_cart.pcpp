#undef SQLCA
#define SQLCA_NONE

#include <sqlca.h>
#include <sqlda.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <tuxfw.h>

int ConsultaCarterizacao( const char *whereClause,XMLGen *Saida )
{
   ULOG_START("ConsultaCarterizacao()");
	struct sqlca sqlca;
	EXEC SQL BEGIN DECLARE SECTION;
		VARCHAR ORA_dsTpCart[256];
		int     ORA_idTpCart;
		int     ORA_where;
	EXEC SQL END DECLARE SECTION;

	sqlca.sqlcode=0;

	memset( (char *)ORA_dsTpCart.arr , 0x0 , sizeof(ORA_dsTpCart.arr) );
   ORA_where = atoi( whereClause );

    EXEC SQL DECLARE tbCart CURSOR FOR 
        Select a.dsTipoCarteira, a.idTipoCarteira
        From apoio.TipoCarteira a
        Where a.IdTipoCarteira Not In(Select IdTipoCarteira From 
        contatoadm.TipoCarteiraGrupo Where IdGrupo = :ORA_where)
        order by a.dsTipoCarteira;

	EXEC SQL OPEN tbCart;

    EXEC SQL WHENEVER SQLERROR GOTO UndefinedError;
    EXEC SQL WHENEVER NOT FOUND DO break;
   int ret = 1 ;
	if( sqlca.sqlcode )
		ret = 0;
	else
	{
		for( ;; )
		{
		   EXEC SQL FETCH tbCart INTO :ORA_dsTpCart , :ORA_idTpCart;
         Saida->createTag( "CarterizacaoVO " );
           Saida->addItem( "codigo",ORA_idTpCart );
           ORA_dsTpCart.arr[ ORA_dsTpCart.len ] = 0x0;
           Saida->addItem( "descricao",(char*)ORA_dsTpCart.arr );
		   Saida->closeTag();
		   memset( (char *)ORA_dsTpCart.arr , 0x0 , sizeof(ORA_dsTpCart.arr) );
		}
		EXEC SQL CLOSE tbCart;
	}
	
	ULOG_END("ConsultaCarterizacao()");
	return ret ;

UndefinedError:
        throw new TuxBasicOraException(sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc,sqlca.sqlerrm.sqlerrml);

}

