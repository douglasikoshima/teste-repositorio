======================================
BATCH......: meuVivoDW
Criado por.: Eder Jani Martins (11/02/2015)
Alterado por: Lucas Gomes(03/09/2015)
Funcional..: Marcia Santana Silva
======================================

====================================== 
OBJETIVO
====================================== 
	O propósito deste documento é coletar, analisar e definir os requisitos de Software
	Funcionais, não Funcionais e detalhar a Solução técnica da Base CRM, impactada na 
	demanda 129520 - Informações do Meu Vivo no DW.
====================================== 

====================================== 
ESCOPO
====================================== 
	Este documento descreve os requisitos funcionais e não funcionais de software e 
	solução necessários para disponibilizar informações da BASE CRM (Camada de 
	Apresentação Meu Vivo) no DW, para a criação de relatórios analíticos. 
====================================== 

====================================== 
SOBRE ESTE BATCH
====================================== 
	O sistema faz, de forma macro, 4 pesquisas (os números correspondem aos tópicos
	do documento funcional - 5.2 e 5.2):
	
	RS01 Disponibilizar informações da linha do cliente (Visão Meu Vivo) (RF01) - Pesquisa dos ultimos 12 meses
		1) Pesquisa com os dados dos clientes e exportar para um arquivo "meuvivo_dw_dados_cliente_12meses.txt"
		2) A mesma pesquisa, mas agora retornando os palitos e exportando para o arquivo "meuvivo_dw_ listas_trans_pcte_promos_12meses.txt"
		
		Durante estas pesquisas, o sistema irá gerar resutados em arquivos, isso porque será executado em D-1, que é zerada todos os dias.
		Desta forma o sistema irá fazer uma pesquisa por dia e gerar arquivos CSV que, ao final de 12 meses, serão importados para uma tabela,
		onde serão importados, sumarizados (DISTINCT) e processados para uma segunda faze, para gerar o arquivo final.  
		
	RS02 – Atualização periódica das informações da linha do cliente (Visão Meu Vivo) (RF02) - Pesquisa diária
		1) Pesquisa com os dados dos clientes e exportar para um arquivo "meuvivo_dw_dados_cliente_DDMMAAAA.txt" (onde o DDMMAAAA é a data de pesquisa)
		2) A mesma pesquisa, mas agora retornando os palitos e exportando para o arquivo "meuvivo_dw_ listas_trans_pcte_promos_DDMMAAAA.txt" (onde o DDMMAAAA é a data de pesquisa)
	
	O critério de busca para este relatório é uma data e uma série de palitos (códigos dos contatos), enviados pela VIVO, que são armazenadas na tabela CONTATOADM.PALITOMEUVIVODW.
	Isto irá facilitar, no futuro, alterar o critério de pesquisa em relação aos palitos.
	Este BATCH mantém o estado, conseguindo continuar de onde parou, enviando reprocessamentos e uso duplicado de recursos. Para isto ele controla a etapa em que se 
	encontra e qual o estado da execução.

	Para isto ele precisa dos seguintes parâmetros na tabela APOIO.PARAMETRO:
		MEUVIVODW_CRITERIO: Indica a ultima data processada com sucesso e/ou falha (no caso de falha retomar deste critério, em caso de sucesso inicia com o dia seguinte)
		MEUVIVODW_ETAPA...: O processo passa por 4 etapas (nesta ordem): CHECAGEM, ATENDIMENTOS, CLIENTES, GERA_ARQUIVO_CLINTE, PALITOS, GERA_ARQUIVO_PROMOS
		MEUVIVODW_ESTADO..: Pode se encontrar em uma destes estados: PROCESSANDO, ERRO, FINALIZADO

	Detalhamento de MEUVIVODW_ESTADO:
		Ao iniciar muda para PROCESSANDO, caso seja executando novamente apresenta erro informando que já está em execução. Caso termine por causa ou com erros muda o estado para ERRO.
		Numa situação normal ele encerra com sucesso e com o estado em FINALIZADO.

	Durante o processamento o parâmetro MEUVIVODW_ETAPA vai mudando, de acordo com o processamento e passa por estes valores, nesta ordem:
		CHECAGEM: Verifica se houve ou não erros e retoma de onde iniciou
		ATENDIMENTOS: Busca todos os atendimentos de um dia obedecendo os critérios que estão na demanda e que estão na tabela CONTATOADM.PALITOMEUVIVODW e armazena na tabela LOAD.MEUVIVODW_01 
		CLIENTES: Busca dados de clientes através dos dados que estão em LOAD.MEUVIVODW_01 e grava o resultado em LOAD.MEUVIVODW_02  
		GERA_ARQUIVO_CLINTE: Gera um arquivo com os dados que estão em LOAD.MEUVIVODW_02
		PALITOS: Trunca a tabela LOAD.MEUVIVODW_02 e busca os dados dos palitos, através da tabela LOAD.MEUVIVODW_01 (ele é a base)
		GERA_ARQUIVO_PROMOS: Gera um arquivo com os dados que estão em LOAD.MEUVIVODW_02

====================================== 


======================================
SCRIPT DE CRIAÇÃO DOS PARAMETROS 
====================================== 
	INSERT INTO APOIO.PARAMETRO
	    (IDPARAMETRO,
	     CDPARAMETRO,
	     DSPARAMETRO,
	     DSVALORPARAMETRO,
	     IDUSUARIOALTERACAO,
	     DTULTIMAALTERACAO
	    )
	VALUES
	    (APOIO.PARAMETROSQ.NEXTVAL,
	     'MEUVIVODW_CRITERIO',
	     'MEUVIVODW - Salva o criterio da ultima pesquisa realizada com sucesso (é uma data, pois o MEUVIVODW processa por dia. Exemplo: "27/01/2015")',
	     '14/03/2015',
	     1,
	     SYSDATE
	    );
	
	INSERT INTO APOIO.PARAMETRO
	    (IDPARAMETRO,
	     CDPARAMETRO,
	     DSPARAMETRO,
	     DSVALORPARAMETRO,
	     IDUSUARIOALTERACAO,
	     DTULTIMAALTERACAO
	    )
	VALUES
	    (APOIO.PARAMETROSQ.NEXTVAL,
	     'MEUVIVODW_ETAPA',
	     'MEUVIVODW - O processo passar por estas etapas (nesta ordem): CHECAGEM, ATENDIMENTOS, CLIENTES, GERA_ARQUIVO_CLINTE, PALITOS, GERA_ARQUIVO_PROMOS',
	     'CHECAGEM',
	     1,
	     SYSDATE
	    );
	
	INSERT INTO APOIO.PARAMETRO
	    (IDPARAMETRO,
	     CDPARAMETRO,
	     DSPARAMETRO,
	     DSVALORPARAMETRO,
	     IDUSUARIOALTERACAO,
	     DTULTIMAALTERACAO
	    )
	VALUES
	    (APOIO.PARAMETROSQ.NEXTVAL,
	     'MEUVIVODW_ESTADO',
	     'MEUVIVODW - O processo pode se encontrar em um destes estados: PROCESSANDO, FINALIZADO e ERRO.',
	     'FINALIZADO',
	     1,
	     SYSDATE
	    );
	
	DELETE FROM APOIO.PARAMETRO WHERE CDPARAMETRO IN ('MEUVIVODW_CRITERIO','MEUVIVODW_ETAPA','MEUVIVODW_ESTADO')


======================================
SCRIPT DE CRIAÇÃO E PREENCHIMENTO DA TABELA DE APOIO COM OS PALITOS 
====================================== 
	CREATE TABLE CONTATOADM.PALITOMEUVIVODW
	(
		IDCONTATO NUMBER        NOT NULL,
		SGSERVICO VARCHAR2(255) NOT NULL,
		DTULTIMAALTERACAO       DATE
	);
	
	DROP TABLE CONTATOADM.PALITOMEUVIVODW;
	
	INSERT INTO CONTATOADM.PALITOMEUVIVODW
	    (IDCONTATO, SGSERVICO, DTULTIMAALTERACAO)
	SELECT 
	       IDCONTATO,
	       SGSERVICO,
	       SYSDATE
	  FROM CONTATOADM.CONFIGURAPALITAGEM CP
	 WHERE ( CP.SGSERVICO IN ('001', '012', '036', '018', '038', '045', '047', '049', '051', '0862', '0962', '1062', '1162', 'ContatoConsultaFatura', 'ContatoConsultaFaturaGIF', 
	          'ContatoDownloadConta', 'AceiteOfertaOtimizacao', 'RecusaOfertaOtimizacao', 'ContatoVivoAgenda', 'ContatoConsultaAtendimentoAgendado', 'ContatoAtendimentoAgendado', 
	          'ContatoCancAtendimentoAgendado', 'ContatoConsultaAtendimentoAgendado', 'ContatoFalhaCancAgendamento', 'ContatoAlteracaoAlertaAgendamento', 'ContatoFalhaAlteracaoAgendamento', 
	          'ContatoConsultaAtendimentoAgendado', 'ContatoAtendimentoAgendado', 'ContatoAlteracaoAtendimentoAgendado', 'ContatoAlteracaoAlertaAgendamento', 'ContatoFalhaAlteracaoAgendamento', 
	          'ContatoConsultaAtendimentoAgendado', 'ContatoAtendimentoAgendado', 'ContatoFalhaAgendamento', 'ContatoCancAtendimentoAgendado', 'ContatoFalhaCancAgendamento', 'ContatoVOLRecargaWEB', 
	          'ContatoAlterarMensagensFaturaOnline', 'ContatoAtivarFaturaOnline', 'ContatoRecargaCreditos', '18MVBloqLinMP', '12MVBloqLin', 'ExcluirVinculoRecargaProgramada', 'ContatoSaldoParcial', 
	          'ContatoSMSSaldoParcial', 'ContatoSaldoParcial', 'ContatoConsultaSaldo', 'ContatoAtivarFaturaOnlineNaoAceitou', 'ContatoAlterarMensagensFaturaOnline', 'ContatoAtivarFaturaOnline', 
	          'ContatoDesativarFaturaOnline', 'ContatoTelaInicialVOL', 'ContatoAlterarAgendaEletronica', 'ContatoAlterarGrupoContato', 'ContatoExcluirAgendaEletronica', 'ContatoIncluirAgendaEletronica', 
	          'ContatoConsultaAgendaEletronica', 'ContatoDebitoAutomatico', 'ContatoDesbloqAparelho', 'ContatoComprovanteServico', 'ContatoComprovanteServicoTrinta', 
	          'ContatoAlterarDataComprovanteServicoEmail', 'ContatoAtivacaoComprovanteServicoEmail', 'ContatoAtivacaoContaEmail', 'ContatoDesativacaoComprovanteServicoEmail', 
	          'ContatoDesativacaoContaEmail', 'ContatoConsultaFavorito', 'ContatoProtocoloNaoPermitido', 'ContatoRecuperacaoGravacaoAudio', 'ContatoConsultaProtocolo', 'ContatoConsultaProtocoloDetalhe', 
	          'ContatoInformacoesAdicionais', 'ContatoInformeSucesso', 'ContatoInformeConsulta', 'sucessoTrocaPlano', 'erroTrocaPlano', 'acessoTrocaPlano', 'ContatoConsultaFaturaGIF', 
	          'ContatoPagamentoConta', 'ContatoBoletoBancoBrasil', 'ContatoBoletoBancoItau', 'ContatoBoletoBancoBradesco', 'ContatoBoletoBancoReal', 'ContatoExtratoPonto', 'ContatoSaldoPonto', 
	          'CadastrarVinculoRecargaProgramada', 'ContatoConsultaSaldo', 'ContatoConsultaFatura', 'ContatoConsultaFaturaGIF', 'TermoQuitacaoNaoDisponivel', 'ContatoAlteracaoTipoFaturaDetalhada', 
	          'ContatoAlteracaoTipoFaturaResumida', 'ContatoAlteracaoTipoFaturaSemiDetalhada', 'ContatoTorpedoWebGratuito', 'ContatoTorpedoWebGratuito', 'ConsultaTrafegoDados', 'ContatoVivoAgenda', 
	          '01MVCadPR', '04MVInfOb', '08MVCanPR')
	          OR CP.SGSERVICO LIKE ('ContatoCMP%')
	          OR CP.SGSERVICO LIKE ('%ATIVACAO')
	       )
	   AND CP.IDSISTEMAORIGEM = 9;
   

======================================
SCRIPT DE CRIAÇÃO DAS TABELAS DE CARGA TEMPORÁRIAS 
====================================== 
	CREATE TABLE LOAD.MEUVIVODW_01
	(
		SGSERVICO               VARCHAR2(255) NOT NULL,
		DSSERVICO               VARCHAR2(255) NOT NULL,
		IDCONTATO               NUMBER        NOT NULL,
		IDPESSOALINHAHISTORICO  NUMBER,
		CDAREAREGISTRO          VARCHAR2(255),
		NRTELEFONE              VARCHAR2(255),
		IDLINHATELEFONICA       NUMBER,
		IDPESSOADEPARA          NUMBER,
		IDTIPOLINHA             NUMBER,
		IDTIPOCARTEIRA          NUMBER,
		IDCANAL                 NUMBER,
		DTABERTURA              DATE,
		DTULTIMAALTERACAO       DATE
	);
	
	CREATE TABLE LOAD.MEUVIVODW_02
	(
		DSNOME                       VARCHAR2(255),
		DSEMAIL                      VARCHAR2(255),
		NRDOCUMENTO                  VARCHAR2(255),
		CDAREAREGISTRO               VARCHAR2(255),
		NRLINHA                      VARCHAR2(255),
		CDFIXOMOVEL                  VARCHAR2(255), 
		DSCANAL                      VARCHAR2(255),
		IDCANAL                      NUMBER,
		NMCANAL                      VARCHAR2(255),
		INDATIVOFB                   VARCHAR2(255),
		INSTATUS                     VARCHAR2(255),
		INATIVO                      VARCHAR2(255),
		QTERROLOGIN                  VARCHAR2(255),
		DTCADASTRO                   VARCHAR2(255),
		HHCADASTRO                   VARCHAR2(255),
		DTULTIMOACESSO               VARCHAR2(255),
		HHULTIMOACESSO               VARCHAR2(255),
		INPLATAFORMA                 VARCHAR2(255),
		DSTIPOCARTEIRA               VARCHAR2(255),
		DSSEGMENTACAO                VARCHAR2(255),
		SGSERVICO                    VARCHAR2(255),
		DSSERVICO                    VARCHAR2(255),
		INCONTATOSALDOPONTO          NUMBER,
		INCONSULTATRAFEGODADOS       NUMBER,
		INCONTATOATENDIMENTOAGENDADO NUMBER,
		DTABERTURA                   DATE,
		DTULTIMAALTERACAO            DATE
	);
	
	DROP TABLE LOAD.MEUVIVODW_01;
	DROP TABLE LOAD.MEUVIVODW_02;
	

======================================
SCRIPT DE CRIAÇÃO DA PROCEDURE QUE TRUCA AS TABELAS 
====================================== 
CREATE OR REPLACE PROCEDURE LOAD.PRC_MEUVIVODW_TRUNCA_TABELA(NUMERO_TABELA IN VARCHAR2)
IS
    V_TABELA_NOME_BASE VARCHAR2(255);
BEGIN
    V_TABELA_NOME_BASE := 'LOAD.MEUVIVODW_';
    
    DBMS_OUTPUT.PUT_LINE('TRUNCATE TABLE '||V_TABELA_NOME_BASE||NUMERO_TABELA);
    EXECUTE IMMEDIATE 'TRUNCATE TABLE '||V_TABELA_NOME_BASE||NUMERO_TABELA;
    
    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Erro ao truncar a tabela '||V_TABELA_NOME_BASE||NUMERO_TABELA||'. Verifique se a tabela existe.');
        ROLLBACK;
END PRC_MEUVIVODW_TRUNCA_TABELA;
/

DROP PROCEDURE LOAD.PRC_MEUVIVODW_TRUNCA_TABELA;

GRANT EXECUTE ON LOAD.PRC_MEUVIVODW_TRUNCA_TABELA TO HOMOLOGACAO
GRANT EXECUTE ON LOAD.PRC_MEUVIVODW_TRUNCA_TABELA TO BATCHPRO;
GRANT EXECUTE ON LOAD.PRC_MEUVIVODW_TRUNCA_TABELA TO BATCHHC;
GRANT EXECUTE ON LOAD.PRC_MEUVIVODW_TRUNCA_TABELA TO BATCHHV;
GRANT EXECUTE ON LOAD.PRC_MEUVIVODW_TRUNCA_TABELA TO BATCHDES;

