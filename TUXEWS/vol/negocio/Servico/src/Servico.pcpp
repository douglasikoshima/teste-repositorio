//---------------------------------------------------------------------------
//                         (c) Consórcio Indra/PT-SI.
//                            xxxxxxxxxxxxxxxxxxxxxxx
//                                xxxxxxxxxxxxxx
//-----------------------------------------------------------------------------
// Los contenidos de este fichero son propiedad de Telefónica Consórcio Indra/PT-SI. 
// titular del copyright. Este fichero solo podra ser copiado, distribuido y utilizado, 
// en su totalidad o en parte, con el permiso escrito de Consórcio Indra/PT-SI 
// o de acuerdo con los terminos y condiciones establecidas en el acuerdo/contrato bajo 
// el que se suministra.
//---------------------------------------------------------------------------
//*  Modulo                   : LSTSERVICOS, LSTVIGSERV
//*  Fichero                  : Servico
//*  Tipo                     : .cpp
//*  Autor                    : Aldebaran
//*  Fecha primera version    : 
//*  Version actual           : 
//*//---------------------------------------------------------------------------
//*  Proposito:
//*
//*  Implementar os negocios referentes aos servicos disponiveis as linhas 
//*  telefonicas ou ao sistema
//*//---------------------------------------------------------------------------
//*  Dependencias:
//*
//*  Linha.hpp
//*//---------------------------------------------------------------------------
//*  Consideraciones de portabilidad:
//*
//*  
////---------------------------------------------------------------------------

#undef SQLCA
#define SQLCA_NONE

#include <sqlca.h>
#include <tuxfw/tuxfw.h>
#include <Defines/Defines.h>
#include <Util/Util.hpp>
#include <Servico/Servico.hpp>


EXEC SQL INCLUDE SQLCA;

//////////////////////////////////////////////////////////////////////
// Construction/Destruction
//////////////////////////////////////////////////////////////////////

//---------------------------------------------------------------------------
CServico::CServico() {
	m_iIdServico = -1;
	strcpy( this->m_cSgServico, "" );
	strcpy( this->m_cNmServico, "" );
	strcpy( this->m_cIdServicoSistemaOrigem, "");
	strcpy( this->m_cDtVigenciaInicio, "");
	strcpy( this->m_cDtVigenciaFinal, "");
	m_iInHabilitado = -1;
}

//---------------------------------------------------------------------------
CServico::CServico( const CServico & value )
	               : m_iIdServico( value.m_iIdServico )
{
	strcpy( this->m_cSgServico, value.m_cSgServico );
	strcpy( this->m_cNmServico, value.m_cNmServico );
	strcpy( this->m_cDtVigenciaInicio, value.m_cDtVigenciaInicio);
	strcpy( this->m_cDtVigenciaFinal, value.m_cDtVigenciaFinal);
	strcpy( this->m_cIdServicoSistemaOrigem, value.m_cIdServicoSistemaOrigem );
	m_iInHabilitado = value.m_iInHabilitado;
}

//---------------------------------------------------------------------------
CServico::~CServico() {
}

//---------------------------------------------------------------------------
CServico & CServico::operator =( const CServico & value ) {
	this->m_iIdServico = value.m_iIdServico;
	strcpy( this->m_cSgServico, value.m_cSgServico );
	strcpy( this->m_cNmServico, value.m_cNmServico );
	strcpy( this->m_cDtVigenciaInicio, value.m_cDtVigenciaInicio);
	strcpy( this->m_cDtVigenciaFinal, value.m_cDtVigenciaFinal);
	strcpy( this->m_cIdServicoSistemaOrigem, value.m_cIdServicoSistemaOrigem );
	this->m_iInHabilitado = value.m_iInHabilitado;
	return *this;
}

//---------------------------------------------------------------------------
bool CServico::operator==( const CServico & s ) { 
 //(this->m_cSgServico == s.m_cSgServico) &&  
 //(this->m_cDtVigenciaInicio == s.m_cDtVigenciaInicio) &&
 //(this->m_cDtVigenciaFinal == s.m_cDtVigenciaFinal) &&
 //(this->m_iInHabilitado == s.m_iInHabilitado) 
 //(this->m_cNmServico == s.m_cNmServico)
  //(this->m_cNmServico == s.m_cNmServico))
 
  return (this->m_iIdServico == s.m_iIdServico);
 
}


//Interface da Classe CServico:

// Operações da classe

//---------------------------------------------------------------------------
//*  Especificacion
//*  
//*  consultarServicosLinha
//* 
//*  <-  CServico        - lista de retorno com todos os servicos existentes
//*  
//---------------------------------------------------------------------------
//*  Proposito
//*
//*  Montar lista com todos os servicos existentes
//*
//---------------------------------------------------------------------------
//*  Proceso
//*
//*  
//*
//---------------------------------------------------------------------------

void CServico::consultarServicosLinha(int iCdAreaRegistro, int iNrLinha, list< CServico > & listaServico ) {
	 CServico::consultarDadosServicosLinhaDB( iCdAreaRegistro, iNrLinha, listaServico );
}

//---------------------------------------------------------------------------
//*  Especificacion
//*  
//*  consultarVigServicosLinha
//*
//*  ->  iCdAreaRegistro - codigo de area da linha
//*  ->  iNrLinha        - numero da linha
//*  <-  CServico        - lista de retorno com todos os servicos disponiveis
//*                        para a linha
//*
//---------------------------------------------------------------------------
//*  Proposito
//*
//*  Consultar a vigencia dos servicos da linha em questao
//*
//---------------------------------------------------------------------------
//*  Proceso
//*
//*  
//*
//---------------------------------------------------------------------------

void CServico::consultarVigServicosLinha( int iCdAreaRegistro, int iNrLinha, list< CServico > & listaServico ) {
	CServico::carregarDadosVigServicosLinhaDB( iCdAreaRegistro, iNrLinha, listaServico );
}


//---------------------------------------------------------------------------
//*  Especificacion
//*  
//*  consultarServicos
//*
//*  <-  CServico        - lista de retorno com todos os servicos disponiveis
//*                        para a linha
//*
//---------------------------------------------------------------------------
//*  Proposito
//*
//*  Consultar todos os serviços disponíveis
//*
//---------------------------------------------------------------------------
//*  Proceso
//*
//*  
//*
//---------------------------------------------------------------------------

void CServico::consultarServicos( list< CServico > & listaServico ) {
	CServico::consultarServicosDB( listaServico );
}




/*

  GETs

*/

//---------------------------------------------------------------------------
int CServico::getIdServico() {
	return this->m_iIdServico;
}

//---------------------------------------------------------------------------
char * CServico::getSgServico() {
	return this->m_cSgServico;
}

//---------------------------------------------------------------------------
char * CServico::getNmServico() {
	return this->m_cNmServico;
}

//---------------------------------------------------------------------------
char * CServico::getDtVigenciaInicio() {	
	return this->m_cDtVigenciaInicio;
}

//---------------------------------------------------------------------------
char * CServico::getDtVigenciaFinal() {
	return this->m_cDtVigenciaFinal;
}

//---------------------------------------------------------------------------
int CServico::getInHabilitado() {
	return this->m_iInHabilitado;
}

//---------------------------------------------------------------------------
char * CServico::getIdServicoSistemaOrigem() {
	return this->m_cIdServicoSistemaOrigem;
}

/*
 
   SETs

*/

//---------------------------------------------------------------------------
void CServico::setIdServico(int value) {
	this->m_iIdServico = value;
}

//---------------------------------------------------------------------------
void CServico::setSgServico(char *value) {
	strcpy(this->m_cSgServico,value); 
}

//---------------------------------------------------------------------------
void CServico::setNmServico(char *value) {
	strcpy(this->m_cNmServico,value); 
}

//---------------------------------------------------------------------------
void CServico::setDtVigenciaInicio(char *value) {
	strcpy(this->m_cDtVigenciaInicio,value); 
}

//---------------------------------------------------------------------------
void CServico::setDtVigenciaFinal(char *value) {
	strcpy(this->m_cDtVigenciaFinal,value); 
}

//---------------------------------------------------------------------------
void CServico::setInHabilitado(int value) {
	this->m_iInHabilitado = value;
}

//---------------------------------------------------------------------------
void CServico::setIdServicoSistemaOrigem(char *value) {
	strcpy(this->m_cIdServicoSistemaOrigem,value); 
}

// PRIVATE
// Métodos de acesso a banco de dados

//---------------------------------------------------------------------------
//*  Especificacion
//*  
//*  consultarLstServicosDB
//* 
//*  <-  CServico        - lista de retorno com todos os servicos existentes e 
//*						   ativos para a linha.
//*  
//---------------------------------------------------------------------------
//*  Proposito
//*
//*  Montar, a partir do banco, lista com todos os servicos existentes
//*
//---------------------------------------------------------------------------
//*  Proceso
//*
//*  
//*
//---------------------------------------------------------------------------

void CServico::consultarDadosServicosLinhaDB(int iCdAreaRegistro,
                                             int iNrLinha, 
											 list< CServico > & listaServico ) {

	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
 	int  iIdServico;
	char cSgServico[ 256 ];
	char cNmServico[ 256 ];
	char cIdServicoSistemaOrigem[ 256 ];
	int iInHabilidato;
	int  iCdAreaRegistroAux;
	int  iNrLinhaAux;
 	EXEC SQL END DECLARE SECTION;

	CServico	oServico;


	// valores das chaves da consulta SQL
    iCdAreaRegistroAux = iCdAreaRegistro;
    iNrLinhaAux = iNrLinha;

	// garante que a lista esta vazia
	listaServico.clear();

	// Marca ponto de controle de erro
	EXEC SQL WHENEVER SQLERROR GOTO sqlErrorConstrutor;
     
	EXEC SQL DECLARE LSTSERVICO CURSOR FOR

/*		SELECT
			  e.idServico
			, e.sgServico
			, e.nmServico
			, b.nrLinha
		FROM
			linha.LinhaTelefonica   a ,
			linha.LinhaBase         b , 
			apoio.AreaRegistro      c ,
			linha.PlanoServicoLinha d ,
			linha.PlanoServico      e   
		WHERE
			c.cdAreaRegistro = :iCdAreaRegistroAux
		And	b.nrLinha = :iNrLinhaAux
		And (e.inPlano = 0 OR e.inPlano is Null)
		And a.idLinhaBase = b.idLinhaBase 
		And b.idAreaRegistro =  c.idAreaRegistro  
		And a.idLinhaTelefonica = d.idLinhaTelefonica
		And a.idLinhaTelefonica = d.idLinhaTelefonica         
		And d.idServico(+) = e.idServico; 
*/

		SELECT Distinct
			  NVL(idServico,0) as idServico
			, NVL(sgServico,' ') as sgServico
			, NVL(nmServico,' ') as nmServico
			, NVL(idServicoSistemaOrigem,' ') as idServicoSistemaOrigem
			, NVL(nrLinha,0) as nrLinha
		FROM
			linha.PlanoServicoLinhaV01
		WHERE
			cdAreaRegistro	= :iCdAreaRegistroAux
		And	nrLinha			= :iNrLinhaAux; 


	EXEC SQL WHENEVER NOT FOUND DO break;

	EXEC SQL OPEN LSTSERVICO;

	for( ;; ) {
		EXEC SQL FETCH LSTSERVICO INTO
			  :iIdServico
			, :cSgServico
			, :cNmServico
			, :cIdServicoSistemaOrigem
			, :iInHabilidato;

		oServico.m_iIdServico = iIdServico;
		CUtil::trim(cSgServico);
        CUtil::trim(cNmServico);
		strcpy( oServico.m_cSgServico, cSgServico ); 
		strcpy( oServico.m_cNmServico, cNmServico ); 
		strcpy( oServico.m_cIdServicoSistemaOrigem, cIdServicoSistemaOrigem ); 

		if (iInHabilidato > 0)
			oServico.m_iInHabilitado = 1;
		else
			oServico.m_iInHabilitado = 0;

		listaServico.push_back( oServico );
	}

	EXEC SQL CLOSE LSTSERVICO;

	return;

	sqlErrorConstrutor:
		throw TuxBasicOraException( sqlca.sqlcode );
}

//---------------------------------------------------------------------------
//*  Especificacion
//*  
//*  carregarDadosVigServicosLinhaDB
//*
//*  ->  iCdAreaRegistro - codigo de area da linha
//*  ->  iNrLinha        - numero da linha
//*  <-  CServico        - lista de retorno com todos os servicos disponiveis
//*                        para a linha
//*
//---------------------------------------------------------------------------
//*  Proposito
//*
//*  Consultar no banco a vigencia dos servicos da linha em questao
//*
//---------------------------------------------------------------------------
//*  Proceso
//*
//*  
//*
//---------------------------------------------------------------------------

void CServico::carregarDadosVigServicosLinhaDB( int iCdAreaRegistro,
                                                int iNrLinha,
												list< CServico > & listaServico ) {
	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
 	int  iIdServico;
	char cNmServico[ 256 ];
	char cDtVigenciaInicio[ 32 ];
	char cDtVigenciaFinal[ 32 ];
	int  iCdAreaRegistroAux;
	int  iNrLinhaAux;
 	EXEC SQL END DECLARE SECTION;
	
	CServico	oServico;
	
	// valores das chaves da consulta SQL
    iCdAreaRegistroAux = iCdAreaRegistro;
    iNrLinhaAux = iNrLinha;

	// garante que a lista esta vazia
	listaServico.clear();

	// marca ponto de controle de erro
	EXEC SQL WHENEVER SQLERROR GOTO sqlErrorConstrutor;
    
	EXEC SQL DECLARE LSTVIGSERV CURSOR FOR

		SELECT
			idServico
			, NVL(nmServico, ' ')
			, NVL(TO_CHAR(dtVigenciaInicio, 'dd/mm/yyyy'), ' ')
			, NVL(TO_CHAR(dtVigenciaFinal, 'dd/mm/yyyy'), ' ')
		FROM
			linha.PlanoServicoLinhaV01
		WHERE
            cdAreaRegistro = :iCdAreaRegistroAux
            AND nrLinha = :iNrLinhaAux;

	EXEC SQL WHENEVER NOT FOUND DO break;
	
	EXEC SQL OPEN LSTVIGSERV;

	for( ;; ) {

		// varre todos os registros para criar a lista com os servicos

		EXEC SQL FETCH LSTVIGSERV INTO
			:iIdServico
			, :cNmServico
			, :cDtVigenciaInicio
			, :cDtVigenciaFinal;

		oServico.setIdServico( iIdServico );
		oServico.setNmServico( CUtil::trim( cNmServico ) ); 

		//FormatDate(cDate, cDtVigenciaInicio, DATE_TIME_FULL);
		oServico.setDtVigenciaInicio( CUtil::trim( cDtVigenciaInicio ) ); 
		
		//FormatDate(cDate, cDtVigenciaFinal, DATE_TIME_FULL);
		//CUtilOra::FormatDate( cDate, cDtVigenciaFinal, CUtilOra.DATE_TIME_FULL );
		oServico.setDtVigenciaFinal( CUtil::trim( cDtVigenciaFinal ) ); 

		listaServico.push_back( oServico );
	}

	EXEC SQL CLOSE LSTVIGSERV;

	return;
 
	sqlErrorConstrutor:
		throw TuxBasicOraException( sqlca.sqlcode ); 
	
}


//---------------------------------------------------------------------------
//*  Especificacion
//*  
//*  carregarServicosDB
//*
//*  <-  CServico        - lista de retorno com todos os servicos disponiveis
//*                        para a linha
//*
//---------------------------------------------------------------------------
//*  Proposito
//*
//*  Consultar todos os serviços disponíveis
//*
//---------------------------------------------------------------------------
//*  Proceso
//*
//*  
//*
//---------------------------------------------------------------------------

void CServico::consultarServicosDB( list< CServico > & listaServico ) {
	struct sqlca sqlca;

	EXEC SQL BEGIN DECLARE SECTION;
 	int  iIdServico;
	char cSgServico[ 256 ];
	char cNmServico[ 256 ];
 	EXEC SQL END DECLARE SECTION;
	
	CServico	oServico;
	
	// garante que a lista esta vazia
	listaServico.clear();

	// marca ponto de controle de erro
	EXEC SQL WHENEVER SQLERROR GOTO sqlErrorConstrutor;
    
	EXEC SQL DECLARE LSTSERVICOS CURSOR FOR

		SELECT
			idServico,
			NVL(nmServico, ' '),
			NVL(sgServico, ' ')
		FROM
			linha.PlanoServico
		WHERE
			NVL(inPlano,0) = 0
		And	NVL(dtExpiracao, sysdate) >= sysdate;

	EXEC SQL WHENEVER NOT FOUND DO break;
	
	EXEC SQL OPEN LSTSERVICOS;

	for( ;; ) {

		// varre todos os registros para criar a lista com os servicos

		EXEC SQL FETCH LSTSERVICOS INTO
			:iIdServico,
			:cSgServico,
			:cNmServico;

		oServico.setIdServico( iIdServico );
		oServico.setSgServico( CUtil::trim( cSgServico ) ); 
		oServico.setNmServico( CUtil::trim( cNmServico ) ); 

		listaServico.push_back( oServico );
	}

	EXEC SQL CLOSE LSTSERVICOS;

	return;
 
	sqlErrorConstrutor:
		throw TuxBasicOraException( sqlca.sqlcode ); 
	
}

